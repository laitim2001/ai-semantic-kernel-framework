# =============================================================================
# Staging Environment Deployment
# =============================================================================
# æœ¬ Workflow åœ¨ä»¥ä¸‹æƒ…æ³è§¸ç™¼:
# - Push åˆ° main åˆ†æ”¯
# - æ‰‹å‹•è§¸ç™¼

name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ENVIRONMENT: staging
  AZURE_RESOURCE_GROUP: rg-skagentic-staging
  AKS_CLUSTER: aks-skagentic-staging
  ACR_NAME: skagentic.azurecr.io
  NAMESPACE: skagentic-staging

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure (Bicep)
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging-api.skagentic.example.com

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Install Bicep
        run: az bicep install

      - name: Validate Bicep Template
        working-directory: infrastructure/bicep
        run: |
          if [ -f "main.bicep" ]; then
            echo "ðŸ” Validating Bicep template..."
            az deployment sub validate \
              --location eastus \
              --template-file main.bicep \
              --parameters parameters/prod.bicepparam \
              --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD_STAGING }}'
            echo "âœ… Template validation passed"
          fi

      - name: Deploy Infrastructure
        working-directory: infrastructure/bicep
        run: |
          if [ ! -f "main.bicep" ]; then
            echo "âš ï¸ main.bicep not found - skipping infrastructure deployment"
            exit 0
          fi

          DEPLOYMENT_NAME="skagentic-staging-$(date +%Y%m%d-%H%M%S)"

          echo "ðŸš€ Deploying infrastructure: $DEPLOYMENT_NAME"

          az deployment sub create \
            --name $DEPLOYMENT_NAME \
            --location eastus \
            --template-file main.bicep \
            --parameters parameters/prod.bicepparam \
            --parameters environment=staging \
            --parameters postgresAdminPassword='${{ secrets.POSTGRES_ADMIN_PASSWORD_STAGING }}' \
            --output json > deployment-output.json

          echo "âœ… Infrastructure deployment completed"

      - name: Save Deployment Output
        uses: actions/upload-artifact@v4
        with:
          name: staging-infrastructure-output
          path: infrastructure/bicep/deployment-output.json
        continue-on-error: true

  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: deploy-infrastructure

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

      - name: Get AKS Credentials
        run: |
          if az aks show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER }} 2>/dev/null; then
            az aks get-credentials \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AKS_CLUSTER }} \
              --overwrite-existing
            echo "âœ… AKS credentials retrieved"
          else
            echo "âš ï¸ AKS cluster not found - skipping application deployment"
            exit 0
          fi

      - name: Deploy to Kubernetes
        run: |
          if [ ! -d "k8s" ]; then
            echo "âš ï¸ k8s directory not found - skipping Kubernetes deployment"
            exit 0
          fi

          export IMAGE_TAG=${{ github.sha }}
          export ENVIRONMENT=${{ env.ENVIRONMENT }}

          if [ -d "k8s/overlays/staging" ]; then
            kubectl apply -k k8s/overlays/staging
            echo "âœ… Kubernetes resources applied"
          else
            echo "âš ï¸ k8s/overlays/staging not found - using production config"
            if [ -d "k8s/overlays/production" ]; then
              kubectl apply -k k8s/overlays/production
            fi
          fi

      - name: Wait for Rollout
        run: |
          if kubectl get namespace ${{ env.NAMESPACE }} 2>/dev/null; then
            echo "â³ Waiting for deployment rollout..."

            for deployment in api-deployment worker-deployment web-deployment; do
              if kubectl get deployment $deployment -n ${{ env.NAMESPACE }} 2>/dev/null; then
                kubectl rollout status deployment/$deployment -n ${{ env.NAMESPACE }} --timeout=10m
              fi
            done
            echo "âœ… All deployments completed"
          fi
        continue-on-error: true

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-application

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION || '20.x' }}

      - name: Install Test Dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Run E2E Tests
        env:
          BASE_URL: https://staging-api.skagentic.example.com
        run: |
          if [ -f "package.json" ] && grep -q "test:e2e" package.json; then
            npm run test:e2e
            echo "âœ… E2E tests passed"
          else
            echo "âš ï¸ No E2E tests configured - skipping"
          fi
        continue-on-error: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
        continue-on-error: true

  performance-tests:
    name: Run Performance Tests
    runs-on: ubuntu-latest
    needs: deploy-application

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run Load Tests
        env:
          BASE_URL: https://staging-api.skagentic.example.com
        run: |
          if [ -d "tests/performance" ]; then
            k6 run tests/performance/load-test.js --out json=performance-results.json
            echo "âœ… Performance tests completed"
          else
            echo "âš ï¸ No performance tests found - skipping"
          fi
        continue-on-error: true

      - name: Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json
        continue-on-error: true

  security-tests:
    name: Run Security Tests
    runs-on: ubuntu-latest
    needs: deploy-application
    permissions:
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'https://staging-api.skagentic.example.com'
          allow_issue_writing: false
        continue-on-error: true

  deployment-summary:
    name: Generate Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-application, integration-tests, performance-tests, security-tests]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.deploy-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Application | ${{ needs.deploy-application.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://staging-api.skagentic.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- Web: https://staging.skagentic.example.com" >> $GITHUB_STEP_SUMMARY
