# 模組 04: Multi-Agent 協作

**Semantic Kernel Agentic Framework - User Stories**

**模組**: Module 04
**User Stories**: US 4.1-4.3
**版本**: 2.0.0
**日期**: 2025-10-28

[返回總覽](../user-stories.md)

---

### 📦 模組 4: Multi-Agent 協作

#### Epic 4: Agent 編排與工作流

**目標**: 提供可視化的工作流編輯器，支援複雜的 Multi-Agent 協作場景

---

#### US 4.1 - 可視化工作流編輯器（類似 n8n, Dify）⭐ 關鍵 UX

**作為** 業務分析師
**我想要** 使用拖拽方式設計 Multi-Agent 工作流
**以便** 無需寫代碼即可編排複雜業務流程

**背景**:
這是提升產品易用性的關鍵功能。通過可視化編輯器，非技術用戶也能設計複雜的 Multi-Agent 協作流程。

**驗收標準**:

✅ 必須項（畫布功能）:
- [ ] 無限畫布（可縮放、移動）
- [ ] 縮放控制（25% - 200%）
- [ ] 網格對齊（Snap to Grid）
- [ ] 小地圖導航（Overview）
- [ ] 撤銷/重做（Undo/Redo，至少 20 步）
- [ ] 快捷鍵支援（Ctrl+Z, Ctrl+C, Ctrl+V 等）

✅ 必須項（節點類型）:

**1. Agent 節點**
- [ ] 從 Agent 列表拖拽到畫布
- [ ] 配置 Agent 輸入變量
- [ ] 設定超時時間
- [ ] 錯誤處理策略（重試、跳過、終止）

**2. 判斷節點（Condition）**
- [ ] If-Else 分支
- [ ] 支援條件表達式（變量比較、正則匹配）
- [ ] 多分支判斷（Switch-Case）

**3. 合併節點（Merge）**
- [ ] 等待所有分支完成
- [ ] 取第一個完成的分支
- [ ] 數據合併策略

**4. 迴圈節點（Loop）**
- [ ] For-Each 迭代
- [ ] While 條件迴圈
- [ ] 迴圈次數限制（防止無限迴圈）

**5. 延遲節點（Delay）**
- [ ] 固定延遲（秒/分鐘）
- [ ] 等待特定時間點

**6. 自定義代碼節點（Script）**
- [ ] JavaScript/Python 代碼執行
- [ ] 訪問工作流變量
- [ ] 轉換數據格式

✅ 必須項（連線功能）:
- [ ] 拖拽連線（從輸出點到輸入點）
- [ ] 自動路由（避免節點重疊）
- [ ] 連線標籤（顯示數據流）
- [ ] 條件分支標註（True/False）
- [ ] 刪除連線（點擊連線 → Delete）

✅ 必須項（節點配置）:
- [ ] 點擊節點打開配置面板（右側 Panel）
- [ ] 配置 Agent 參數
- [ ] 變量映射（將上游輸出映射到當前節點輸入）
- [ ] 配置驗證（必填欄位、類型檢查）
- [ ] 配置預覽（即時顯示配置效果）

✅ 必須項（工作流管理）:
- [ ] 工作流命名和描述
- [ ] 儲存工作流（自動儲存 + 手動儲存）
- [ ] 工作流版本歷史
- [ ] 工作流發佈（Draft → Published）
- [ ] 工作流測試執行（Debug 模式）

✅ 必須項（自動佈局）:
- [ ] 自動排列節點（水平/垂直）
- [ ] 自動對齊（左對齊、居中、右對齊）
- [ ] 分組功能（選中多個節點分組）

**UI 設計參考**:
- n8n Workflow Editor
- Dify Workflow Canvas
- Node-RED Flow Editor
- Microsoft Power Automate

**UI 示例**:
```
┌─────────────────────────────────────────────────────────┐
│ 工作流: 客戶服務流程                    [儲存] [發佈]    │
├────┬────────────────────────────────────────────────────┤
│節點│                                                     │
│列表│  ┌───────┐                                         │
│    │  │ Start │                                         │
│🤖  │  └───┬───┘                                         │
│Agent│      │                                             │
│    │      ▼                                              │
│⚙️  │  ┌────────────┐                                    │
│判斷│  │  分類Agent │ ← 配置面板打開                     │
│    │  └─────┬──────┘                                    │
│🔄  │        │                                            │
│迴圈│   ┌────┴────┐                                      │
│    │   │         │                                       │
│⏱️  │   ▼         ▼                                       │
│延遲│ ┌──────┐ ┌──────┐                                  │
│    │ │退款? │ │技術?│                                   │
│📝  │ └──┬───┘ └───┬──┘                                  │
│代碼│    │         │                                      │
│    │    ▼         ▼                                       │
│    │ ┌──────┐ ┌──────┐                                  │
│    │ │退款   │ │技術  │                                  │
│    │ │Agent │ │Agent │                                  │
│    │ └──────┘ └──────┘                                  │
│    │                                                     │
└────┴─────────────────────────────────────────────────────┘
```

**技術實現**:
- React Flow 或 ReactFlow
- Canvas API
- WebSocket 即時協作（Phase 2）

**📊 優先級**: P0 (MVP 必須)
**🎯 UX 目標**: 業務分析師 1 小時內學會使用
**⏱️ 開發工期**: 4-5 週
**🔗 相關**: US 4.2 (配置文件), US 4.3 (執行監控)

---

#### US 4.2 - 工作流配置文件匯出/匯入

**作為** IT 開發者
**我想要** 將工作流匯出為 YAML/JSON 配置文件
**以便** 版本控制和批量部署

**驗收標準**:

✅ 必須項（匯出功能）:
- [ ] 匯出為 YAML 格式（推薦，更可讀）
- [ ] 匯出為 JSON 格式（機器友好）
- [ ] 配置文件包含完整工作流定義
- [ ] 包含節點配置、連線關係、變量定義
- [ ] 人類可讀（帶註解、縮排）

✅ 必須項（匯入功能）:
- [ ] 匯入 YAML/JSON 文件建立工作流
- [ ] 自動驗證配置文件正確性
- [ ] 檢查引用的 Agent 是否存在
- [ ] 檢查變量類型匹配
- [ ] 匯入錯誤友好提示（行號、錯誤原因）

✅ 必須項（配置文件格式）:
- [ ] 支援變量替換（環境變量、參數化）
- [ ] 支援註解（# 或 //）
- [ ] Git 友好（合併衝突少）
- [ ] Schema 驗證（JSON Schema）

**YAML 範例**:
```yaml
workflow:
  name: "客戶服務流程"
  version: "1.0.0"
  description: "自動分類客戶問題並路由到對應 Agent"

  variables:
    # 全局變量
    max_retries: 3
    timeout_seconds: 30

  nodes:
    - id: "start"
      type: "start"

    - id: "classifier"
      type: "agent"
      config:
        agent_id: "${CLASSIFIER_AGENT_ID}" # 環境變量
        timeout: "${timeout_seconds}"

    - id: "is_refund"
      type: "condition"
      config:
        expression: "classifier.output.intent == 'refund'"

    - id: "refund_agent"
      type: "agent"
      config:
        agent_id: "agent-refund-001"
        input:
          user_message: "${start.input.message}"
          classification: "${classifier.output}"

  edges:
    - from: "start"
      to: "classifier"

    - from: "classifier"
      to: "is_refund"

    - from: "is_refund"
      to: "refund_agent"
      condition: "true"

    - from: "is_refund"
      to: "tech_agent"
      condition: "false"
```

**技術要求**:
- YAML Parser: YamlDotNet (.NET)
- JSON Schema Validation
- 環境變量替換

**📊 優先級**: P1 (MVP 高優先)
**🎯 驗收方式**: 可在 Git 中追蹤工作流變更
**🔗 相關**: US 4.1 (編輯器), CI/CD 整合

---

#### US 4.3 - 工作流執行與監控

**作為** IT 開發者
**我想要** 查看工作流的即時執行狀態
**以便** 診斷問題和優化流程

**驗收標準**:

✅ 必須項（即時執行可視化）:
- [ ] 工作流執行時在畫布上即時高亮當前節點
- [ ] 已完成節點顯示綠色邊框
- [ ] 執行中節點顯示藍色動畫邊框
- [ ] 失敗節點顯示紅色邊框
- [ ] 顯示每個節點的執行耗時

✅ 必須項（節點執行詳情）:
- [ ] 點擊節點查看輸入/輸出數據
- [ ] 顯示節點執行日誌
- [ ] 顯示錯誤堆疊（如果失敗）
- [ ] 支援重新執行單個節點（Debug）

✅ 必須項（執行歷史）:
- [ ] 執行歷史列表（最近 50 筆）
- [ ] 執行狀態篩選（成功/失敗/執行中）
- [ ] 執行時間篩選（今天/本週/本月）
- [ ] 執行詳情可重播（查看執行過程）

✅ 必須項（性能分析）:
- [ ] 每個節點的平均執行時間
- [ ] 工作流總執行時間分佈（P50, P95, P99）
- [ ] 瓶頸節點識別（耗時最長的節點）
- [ ] 失敗率統計（每個節點的失敗率）

✅ 必須項（告警功能）:
- [ ] 工作流執行失敗時 Email 通知
- [ ] 執行時間超過閾值時告警
- [ ] 失敗率超過 10% 時告警

**UI 示例**:
```
┌─────────────────────────────────────────┐
│ 執行監控: 客戶服務流程                   │
├─────────────────────────────────────────┤
│ 當前執行: #12345                         │
│ 狀態: 執行中 ⏳ | 耗時: 5.2s             │
│                                          │
│ [畫布 - 即時更新]                        │
│  ┌───────┐                               │
│  │ Start │ ✅ 0.1s                       │
│  └───┬───┘                               │
│      │                                    │
│  ┌───▼─────┐                             │
│  │分類Agent│ 🔵執行中 3.2s...            │
│  └─────────┘                             │
│                                          │
│ [右側面板 - 分類Agent 執行詳情]          │
│ 輸入:                                    │
│ {                                        │
│   "message": "我要退款"                  │
│ }                                        │
│                                          │
│ 輸出: (執行中...)                        │
└─────────────────────────────────────────┘
```

**技術要求**:
- WebSocket 即時更新
- 執行日誌串流
- 時序數據存儲

**📊 優先級**: P1 (MVP 高優先)
**🎯 驗收方式**: 可在 30 秒內定位工作流瓶頸
**🔗 相關**: US 4.1 (編輯器), US 1.4 (Agent 監控)

---