# 附錄 B: 技術架構詳細設計

**返回**: [Product Brief 主文檔](./product-brief.md)

**日期**: 2025-11-17  
**版本**: v1.0

---

## 🏗️ 整體架構設計

基於決策 1-6（SCAMPER S 維度），完整的技術架構如下：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用戶界面層 (UI Layer)                         │
├─────────────────────────────────────────────────────────────────────┤
│  React 18 + TypeScript + Ant Design                                 │
│  ┌────────────┬──────────────┬──────────────┬──────────────┐       │
│  │ Dashboard  │ Agent 管理   │ 審批處理     │ Marketplace  │       │
│  │ (執行監控) │ (創建/編輯)  │ (Checkpoint) │ (模板瀏覽)   │       │
│  └────────────┴──────────────┴──────────────┴──────────────┘       │
│  • 現代化、友好、時尚的 UI（決策 20: 不可妥協）                      │
│  • 響應式設計（Desktop 優先，MVP 不做 Mobile）                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ REST API (HTTPS)
┌─────────────────────────────────────────────────────────────────────┐
│                       應用服務層 (Application Layer)                  │
├─────────────────────────────────────────────────────────────────────┤
│  Python FastAPI 3.11+                                                │
│  ┌────────────┬──────────────┬──────────────┬──────────────┐       │
│  │ Agent API  │ Workflow API │ Checkpoint   │ Marketplace  │       │
│  │ (CRUD)     │ (執行/監控)  │ API (審批)   │ API (模板)   │       │
│  └────────────┴──────────────┴──────────────┴──────────────┘       │
│  • 用戶認證和授權 (JWT Token)                                        │
│  • Agent 生命週期管理 (創建/部署/停止/刪除)                          │
│  • Checkpoint 狀態管理 (保存/載入/審批)                              │
│  • 審計日誌記錄 (Append-only)                                        │
│  • REST API 端點 (OpenAPI 3.0)                                      │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│              核心編排引擎層 (Orchestration Engine - 主導)             │
├─────────────────────────────────────────────────────────────────────┤
│  Microsoft Agent Framework (Preview)                                 │
│  ┌────────────────────────────────────────────────────────┐         │
│  │  Sequential Agent 編排 (決策 1, 2)                      │         │
│  │  • 純 Python 代碼定義工作流                             │         │
│  │  • 支持順序執行、條件分支、循環、異步並發                │         │
│  │  • 完整 IDE 支持（代碼提示、調試、重構）                │         │
│  └────────────────────────────────────────────────────────┘         │
│  ┌────────────────────────────────────────────────────────┐         │
│  │  Checkpointing 支持 (決策 4)                            │         │
│  │  • Human-in-the-loop 審批機制                           │         │
│  │  • 狀態保存和恢復                                        │         │
│  │  • 工作流斷點和繼續執行                                  │         │
│  └────────────────────────────────────────────────────────┘         │
│  ┌────────────────────────────────────────────────────────┐         │
│  │  Agent 協作和通信                                       │         │
│  │  • Agent 間消息傳遞                                     │         │
│  │  • 跨場景協作（CS ↔ IT）                               │         │
│  │  • 事件驅動架構                                         │         │
│  └────────────────────────────────────────────────────────┘         │
│                                                                       │
│  核心 Agents (示例):                                                 │
│  • Ticket Analyzer Agent (工單分析)                                 │
│  • Customer Data Agent (客戶數據查詢)                               │
│  • Solution Generator Agent (解決方案生成)                          │
│  • Action Executor Agent (操作執行)                                 │
│  • Cross-System Correlation Agent (跨系統關聯分析)                  │
└─────────────────────────────────────────────────────────────────────┘
          ↓                    ↓                    ↓
┌───────────────────┐  ┌──────────────────┐  ┌─────────────────────┐
│  State Manager    │  │  Prompt Manager  │  │  n8n (輔助觸發)     │
│  (自行實現)       │  │  (YAML 模板)     │  │  (決策 1: 輔助)     │
├───────────────────┤  ├──────────────────┤  ├─────────────────────┤
│  PostgreSQL       │  │  YAML 配置文件   │  │  • Cron Schedule    │
│  • Checkpoint     │  │  • Prompt 模板   │  │  • Webhook Listener │
│    States         │  │  • LLM 追蹤      │  │  • 錯誤處理         │
│  • 執行歷史       │  │  • 成本監控      │  │  • 自動重試 (3次)   │
│  • 審計日誌       │  │  • Token 統計    │  │  • Teams 告警       │
│  (決策 4)         │  │  (決策 9, 13)    │  │  (決策 8, 12)       │
└───────────────────┘  └──────────────────┘  └─────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         數據和緩存層 (Data Layer)                     │
├─────────────────────────────────────────────────────────────────────┤
│  PostgreSQL 14+ (主數據庫)         Redis 7+ (緩存 - 決策 25)         │
│  ┌──────────────────────────┐    ┌──────────────────────────┐      │
│  │ • Agent 配置和代碼        │    │ • LLM 響應緩存 (TTL 1天) │      │
│  │ • Workflow 定義           │    │ • 系統查詢結果緩存       │      │
│  │ • 執行記錄和歷史          │    │ • Session 數據           │      │
│  │ • Checkpoint 狀態         │    │ • 緩存命中率目標: ≥60%   │      │
│  │ • 審計日誌 (Append-only)  │    │ • 性能提升: 3-5 倍       │      │
│  │ • 用戶和權限管理          │    │ • 成本降低: 20%+         │      │
│  │ • Learning Cases (Few-shot)│   └──────────────────────────┘      │
│  └──────────────────────────┘                                        │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                     企業系統整合層 (Integration Layer)                │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┬──────────────────┬──────────────────┐            │
│  │ ServiceNow   │ Dynamics 365 API │ SharePoint API   │            │
│  │ REST API     │ (Web API v9.2)   │ (Search API)     │            │
│  ├──────────────┼──────────────────┼──────────────────┤            │
│  │ • 工單 CRUD  │ • 客戶數據查詢   │ • 文檔搜索       │            │
│  │ • 變更記錄   │ • 案例管理       │ • 知識庫查詢     │            │
│  │ • 資產信息   │ • 銷售數據       │ • 協作空間       │            │
│  └──────────────┴──────────────────┴──────────────────┘            │
│                                                                       │
│  ┌──────────────┬──────────────────┬──────────────────┐            │
│  │ Azure Monitor│ Microsoft 365    │ 內部系統 API     │            │
│  ├──────────────┼──────────────────┼──────────────────┤            │
│  │ • 服務器監控 │ • Teams 通知     │ • 自定義整合     │            │
│  │ • 日誌查詢   │ • Outlook        │ • Legacy Systems │            │
│  └──────────────┴──────────────────┴──────────────────┘            │
│                                                                       │
│  跨系統智能關聯 (決策 7: 核心差異化):                                 │
│  • 並行查詢 3 系統（asyncio.gather）                                │
│  • 超時控制（5 秒 per API）                                          │
│  • 降級策略（單系統失敗不影響其他）                                  │
│  • 緩存策略（Redis，TTL 1 天）                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        AI 服務層 (LLM Layer)                          │
├─────────────────────────────────────────────────────────────────────┤
│  Azure OpenAI Service (GPT-4o)                                       │
│  ┌────────────────────────────────────────────────────────┐         │
│  │  智能決策和推理:                                       │         │
│  │  • 工單分析和分類                                      │         │
│  │  • 客戶問題診斷                                        │         │
│  │  • 解決方案生成                                        │         │
│  │  • 跨系統數據關聯分析                                  │         │
│  │  • Few-shot Learning (人工修改案例學習)                │         │
│  └────────────────────────────────────────────────────────┘         │
│  • 企業級數據隔離和安全                                              │
│  • Token 追蹤和成本監控                                              │
│  • 緩存優化（Redis，降低成本 20%+）                                  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                     開發和監控工具層 (DevOps Layer)                   │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────┬──────────────────────────┐            │
│  │  Microsoft DevUI         │  Monitoring Dashboard    │            │
│  │  (決策 9: 開發體驗)      │  (決策 12, 18, 19)       │            │
│  ├──────────────────────────┼──────────────────────────┤            │
│  │  • 可視化調試            │  • 執行狀態實時監控      │            │
│  │  • Agent 交互流程查看    │  • 成功率統計圖表        │            │
│  │  • LLM 調用鏈追蹤        │  • LLM 成本分析          │            │
│  │  • 斷點調試              │  • 性能指標 Dashboard    │            │
│  │  • 變量和狀態查看        │  • 人工介入率分析        │            │
│  │  • 10-30 分鐘排查問題    │  • Alert 機制 (Phase 2)  │            │
│  │    (vs 2-4 小時傳統)     │                          │            │
│  └──────────────────────────┴──────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 核心數據流設計

### 流程 1: Agent 工作流執行（含 Checkpoint）

```
┌─────────────────────────────────────────────────────────────────────┐
│  1. 用戶觸發 (UI Button 或 n8n Cron)                                 │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  2. FastAPI 接收 REST API 請求                                       │
│     POST /api/workflows/{workflow_id}/execute                        │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  3. Agent Framework 開始執行 Sequential Workflow                     │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  4. Agent 1 (Ticket Analyzer)                                        │
│     • 調用 Azure OpenAI (GPT-4o)                                     │
│     • 使用 YAML Prompt 模板                                          │
│     • 記錄 LLM 調用 (Token: 500, Cost: $0.01, Latency: 1.2s)        │
│     • Redis 緩存檢查 → Miss → 調用 LLM → 緩存結果 (TTL 1天)          │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  5. Agent 2 (Customer Data - 跨系統關聯)                             │
│     • 並行查詢 3 個系統:                                              │
│       ├─ Dynamics 365 API (客戶信息)                                 │
│       ├─ ServiceNow API (工單歷史)                                   │
│       └─ SharePoint API (文檔)                                       │
│     • Redis 緩存檢查 → Hit 60% → 性能提升 3-5 倍                     │
│     • 超時控制: 5 秒 per API                                          │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  6. Agent 3 (Solution Generator)                                     │
│     • 調用 Azure OpenAI (Few-shot Learning)                          │
│     • 動態注入 3 個人工修改案例 (Learning Cases)                      │
│     • 生成建議解決方案                                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  7. ⚠️ Checkpoint 觸發（高風險操作）                                 │
│     • 保存當前狀態到 PostgreSQL State Manager                        │
│     • 狀態: { workflow_id, step, data, status: "pending_approval" } │
│     • 發送 Teams 通知 (Adaptive Card 按鈕: 批准/拒絕)                │
│     • 記錄審計日誌 (Append-only)                                      │
│     • 工作流暫停，返回 checkpoint_id                                  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  8. 人工審批 (通過 UI 或 Teams)                                       │
│     • 用戶查看建議方案                                                │
│     • 批准/拒絕/修改參數                                              │
│     • 記錄決策和理由 → Learning Case（Few-shot 數據）                │
│     • PUT /api/checkpoints/{checkpoint_id}/approve                   │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  9. 從 Checkpoint 恢復執行                                            │
│     • 從 PostgreSQL 載入狀態                                          │
│     • Agent Framework 繼續執行（Resume from Step）                    │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  10. Agent 4 (Action Executor)                                       │
│      • 執行批准的操作（更新 ServiceNow/Dynamics）                     │
│      • 發送完成通知到 Teams                                           │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  11. 完成並記錄                                                       │
│      • 更新執行記錄 (PostgreSQL executions 表)                        │
│      • 記錄審計日誌                                                   │
│      • 更新 Dashboard 指標（成功率、成本、時間）                      │
│      • Learning Case 入庫（用於未來 Few-shot）                        │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🚀 部署架構

### 開發環境（On-Premise / Local）

**來源決策**: 決策 28（開發 On-Premise，生產 Azure）

```yaml
# docker-compose.yml
version: '3.8'

services:
  # Agent Framework Runtime
  agent-framework:
    build: ./agent-runtime
    ports:
      - "5000:5000"
    environment:
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/agentdb
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  # FastAPI Backend
  fastapi-backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/agentdb
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  # PostgreSQL Database
  postgres:
    image: postgres:14
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=agentdb
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redis Cache
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # n8n (輔助觸發)
  n8n:
    image: n8nio/n8n:latest
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=admin
    volumes:
      - n8n_data:/home/node/.n8n

  # React Dev Server
  react-ui:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=http://localhost:8000

volumes:
  postgres_data:
  redis_data:
  n8n_data:
```

**優勢**:
- ✅ 快速迭代，完整環境隔離
- ✅ 一鍵啟動：`docker-compose up -d`
- ✅ 開發者本機運行，無需雲資源

---

### 生產環境（Azure Cloud）

```
┌─────────────────────────────────────────────────────────────────────┐
│  Azure Front Door (負載均衡 + CDN + WAF)                             │
│  • 全球加速                                                           │
│  • DDoS 防護                                                          │
│  • SSL/TLS 終止                                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  Azure App Service (React UI - Static Web App)                       │
│  • 自動擴展                                                           │
│  • HTTPS 默認啟用                                                     │
│  • CI/CD 集成 (GitHub Actions)                                       │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  Azure Container Instances (Backend Services)                        │
│  ┌──────────────────────────┬──────────────────────────┐            │
│  │  FastAPI Backend         │  Agent Framework Runtime │            │
│  │  (2 vCPU, 4 GB RAM)      │  (4 vCPU, 8 GB RAM)      │            │
│  └──────────────────────────┴──────────────────────────┘            │
│  • 自動擴展（CPU > 70%）                                              │
│  • Health Check 和自動恢復                                            │
│  • Azure Monitor 集成                                                 │
└─────────────────────────────────────────────────────────────────────┘
          ↓                                       ↓
┌─────────────────────────┐         ┌──────────────────────────┐
│  Azure Database for     │         │  Azure Cache for Redis   │
│  PostgreSQL (Flexible)  │         │  (Premium Tier)          │
├─────────────────────────┤         ├──────────────────────────┤
│  • 2 vCore, 8 GB RAM    │         │  • 6 GB Cache            │
│  • 自動備份 (7 天)      │         │  • 高可用性 (99.9%)      │
│  • Geo-Replication      │         │  • TLS 加密              │
│  • 加密存儲             │         │  • Persistence (RDB)     │
└─────────────────────────┘         └──────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  Azure OpenAI Service (GPT-4o)                                       │
│  • 企業級 SLA (99.9%)                                                 │
│  • 數據隔離和安全                                                     │
│  • Token 配額管理                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**監控和日誌**:
- Azure Monitor (指標、告警)
- Application Insights (APM、追蹤)
- Log Analytics (集中日誌)

**成本估算** (月度):
- App Service: ~$50
- Container Instances: ~$150
- PostgreSQL: ~$100
- Redis: ~$80
- Azure OpenAI: ~$500 (變動，基於使用量)
- **總計**: ~$880/月

---

## 🔐 安全和可靠性設計

### 數據安全
- ✅ Azure OpenAI（企業級數據隔離）
- ✅ PostgreSQL 加密存儲（TDE）
- ✅ Redis TLS 連接
- ✅ API 認證（JWT Token）
- ⏸️ MVP 暫不實施: GDPR/SOC 2 合規（Phase 2）

### 可靠性保證
- ✅ Checkpointing 確保工作流可恢復（決策 4）
- ✅ n8n 自動重試 3 次（指數退避）
- ✅ PostgreSQL 事務一致性（ACID）
- ✅ Redis 故障轉移配置（Azure Cache Premium）
- ✅ 審計日誌 Append-only（不可篡改）

### 錯誤處理
- ✅ Agent 執行失敗自動重試 3 次
- ✅ LLM 調用超時處理（30 秒）
- ✅ 系統 API 調用失敗降級策略
- ✅ Teams 通知錯誤告警
- ✅ DevUI 實時錯誤追蹤

---

**返回**: [Product Brief 主文檔](./product-brief.md)
