# F4. è·¨å ´æ™¯å”ä½œ

**åˆ†é¡**: æ•´åˆèˆ‡æ™ºèƒ½  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰ - æ ¸å¿ƒèƒ½åŠ›)  
**é–‹ç™¼æ™‚é–“**: 2 é€±  
**è¤‡é›œåº¦**: â­â­â­â­ (é«˜)  
**ä¾è³´é …**: F1 (é †åºå¼ç·¨æ’), F2 (æª¢æŸ¥é»), F3 (è·¨ç³»çµ±é—œè¯), Event Bus (RabbitMQ/Azure Service Bus)  
**é¢¨éšªç´šåˆ¥**: ä¸­ (è·¨åœ˜éšŠå”èª¿, ç•°æ­¥é€šä¿¡è¤‡é›œæ€§)

---

## ğŸ“‘ å°èˆª

- [â† åŠŸèƒ½æ¦‚è¦½](../prd-appendix-a-features-overview.md)
- [â† F3: è·¨ç³»çµ±é—œè¯](./feature-03-correlation.md)
- **F4: è·¨å ´æ™¯å”ä½œ** â† æ‚¨åœ¨é€™è£¡
- [â†’ F5: åŸºæ–¼å­¸ç¿’çš„å”ä½œ](./feature-05-learning.md)

---

## 4.1 åŠŸèƒ½æ¦‚è¿°

**ä»€éº¼æ˜¯è·¨å ´æ™¯å”ä½œ?**

è·¨å ´æ™¯å”ä½œä½¿ä¸åŒæ¥­å‹™å ´æ™¯çš„ Agent (ä¾‹å¦‚: å®¢æœ â†’ IT æ”¯æ´, éŠ·å”® â†’ è²¡å‹™) èƒ½å¤ ä½¿ç”¨äº‹ä»¶é©…å‹•æ¶æ§‹**ç•°æ­¥è§¸ç™¼å½¼æ­¤**ã€‚é€™æ¶ˆé™¤äº†æ‰‹å‹•äº¤æ¥ï¼Œæ¸›å°‘å»¶é²ï¼Œä¸¦å‰µå»ºè·¨éƒ¨é–€çš„ç„¡ç¸«ç«¯åˆ°ç«¯è‡ªå‹•åŒ–ã€‚

**ç‚ºä»€éº¼é€™å¾ˆé‡è¦**:
- **æ¶ˆé™¤å­¤å³¶**: é€šéå•Ÿç”¨è‡ªå‹•è·¨åœ˜éšŠå·¥ä½œæµæ‰“ç ´éƒ¨é–€éšœç¤™
- **æ¸›å°‘äº¤æ¥æ™‚é–“**: è‡ªå‹•è§¸ç™¼å°‡å»¶é²å¾å°æ™‚/å¤©æ¸›å°‘åˆ°ç§’/åˆ†é˜
- **å®Œæ•´è‡ªå‹•åŒ–**: å¯¦ç¾è·¨å¤šå€‹æ¥­å‹™æµç¨‹çš„çœŸæ­£ç«¯åˆ°ç«¯è‡ªå‹•åŒ–
- **å¯©è¨ˆè¿½è¹¤**: è¨˜éŒ„æ¯å€‹è·¨å ´æ™¯èª¿ç”¨ä»¥æ»¿è¶³åˆè¦æ€§å’Œèª¿è©¦éœ€æ±‚
- **å½ˆæ€§**: ç•°æ­¥æ¶æ§‹ç¢ºä¿æ•…éšœä¸æœƒè·¨å ´æ™¯ç´šè¯

**æ ¸å¿ƒèƒ½åŠ›**:
1. **äº‹ä»¶é©…å‹•è§¸ç™¼**: CS Agent å®Œæˆ â†’ é€šéäº‹ä»¶ç¸½ç·šè‡ªå‹•è§¸ç™¼ IT Agent
2. **ç•°æ­¥å›èª¿**: è§¸ç™¼çš„ Agent åœ¨å¾Œå°é‹è¡Œï¼Œå®Œæˆæ™‚ç™¼é€çµæœ
3. **ç‹€æ…‹è·Ÿè¸ª**: ç™¼èµ· Agent å¯ä»¥æª¢æŸ¥ç‹€æ…‹ä¸¦æª¢ç´¢è§¸ç™¼ Agent çš„çµæœ
4. **æ¢ä»¶è§¸ç™¼**: å®šç¾©ä½•æ™‚è§¸ç™¼çš„è¦å‰‡ (ä¾‹å¦‚: åƒ…ç•¶å·¥å–®åš´é‡ç¨‹åº¦ â‰¥ é«˜)
5. **éŒ¯èª¤è™•ç†**: é‡è©¦é‚è¼¯ï¼Œå¤±æ•—è§¸ç™¼çš„æ­»ä¿¡éšŠåˆ—
6. **è·¨å ´æ™¯ä¸Šä¸‹æ–‡**: å‘è§¸ç™¼çš„ Agent å‚³éè±å¯Œçš„ä¸Šä¸‹æ–‡ (å®¢æˆ¶æ•¸æ“šï¼Œå·¥å–®ä¿¡æ¯)

**æ¥­å‹™åƒ¹å€¼**:
- **æ›´å¿«è§£æ±º**: éœ€è¦ IT å‡ç´šçš„å®¢æˆ¶å•é¡Œè§£æ±ºé€Ÿåº¦æé«˜ 60%
- **æ¸›å°‘æ‰‹å‹•å·¥ä½œ**: æ¶ˆé™¤ 80% çš„æ‰‹å‹•äº¤æ¥éƒµä»¶/æ¶ˆæ¯
- **æ›´å¥½å”èª¿**: IT åœ˜éšŠè‡ªå‹•ç²å¾—å®Œæ•´ä¸Šä¸‹æ–‡ (ç„¡ä¿¡æ¯ä¸Ÿå¤±)
- **åˆè¦æ€§**: è·¨åœ˜éšŠäº’å‹•çš„å®Œæ•´å¯©è¨ˆè¿½è¹¤
- **å¯æ“´å±•æ€§**: æ¯å¤©è™•ç† 1000+ è·¨å ´æ™¯è§¸ç™¼

**çœŸå¯¦ä¸–ç•Œç¤ºä¾‹**:

```
å‚³çµ±æµç¨‹ (æ‰‹å‹•äº¤æ¥):
1. CS Agent è§£æ±ºå®¢æˆ¶å·¥å–®
2. CS Agent è­˜åˆ¥éœ€è¦ IT å‡ç´š (VPN å•é¡Œ)
3. CS Agent çµ¦ IT åœ˜éšŠå¯«éƒµä»¶é™„ä¸Šå®¢æˆ¶è©³æƒ…
4. IT åœ˜éšŠæ”¶åˆ°éƒµä»¶ (å¯èƒ½åœ¨ä¸‹ç­å¾Œï¼Œæ’éšŠç­‰å¾…)
5. IT Agent æ‰‹å‹•é–±è®€éƒµä»¶ï¼ŒæŸ¥æ‰¾å®¢æˆ¶ä¿¡æ¯
6. IT Agent å‰µå»ºæ–° IT å·¥å–®
7. IT Agent èª¿æŸ¥ VPN å•é¡Œ
8. IT Agent é€šééƒµä»¶å›å¾© CS Agent
9. CS Agent æ›´æ–°å®¢æˆ¶

ç¸½æ™‚é–“: 4-8 å°æ™‚ (æˆ–ä¸‹ä¸€å€‹å·¥ä½œæ—¥)

ä½¿ç”¨è·¨å ´æ™¯å”ä½œ (è‡ªå‹•åŒ–):
1. CS Agent å®Œæˆå·¥å–®è§£æ±º
2. ç³»çµ±æª¢æ¸¬è§¸ç™¼æ¢ä»¶: "æåˆ° VPN å•é¡Œ"
3. CS Agent é€šéäº‹ä»¶è‡ªå‹•è§¸ç™¼ IT Agent
4. IT Agent æ¥æ”¶å®Œæ•´ä¸Šä¸‹æ–‡ (å®¢æˆ¶ ID, å·¥å–®, VPN æ—¥èªŒ)
5. IT Agent è‡ªå‹•é‹è¡Œèª¿æŸ¥å·¥ä½œæµ
6. IT Agent é€šéå›èª¿ç™¼é€çµæœ
7. CS Agent æ¥æ”¶çµæœï¼Œæ›´æ–°å®¢æˆ¶å·¥å–®

ç¸½æ™‚é–“: 5-10 åˆ†é˜ (è‡ªå‹•åŒ–)
```

**æ¶æ§‹æ¦‚è¦½**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Event          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CS Agent   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Event Bus   â”‚
â”‚  (Trigger)  â”‚    "IT.VPN.Check"     â”‚ (RabbitMQ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ Subscribe
                                             â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  IT Agent    â”‚
                                      â”‚  (Listener)  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ Async Process
                                             â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  Results     â”‚
                                      â”‚  Callback    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ POST /callback
                                             â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚  CS Agent    â”‚
                                      â”‚  (Receives)  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4.2 ç”¨æˆ¶æ•…äº‹ (å®Œæ•´)

### **US-F4-001: å¾ CS å·¥ä½œæµè§¸ç™¼ IT Agent**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 4 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** å®¢æœ Agent å·¥ä½œæµé–‹ç™¼è€… (Emily Zhang)
- **æˆ‘æƒ³è¦** é…ç½®æˆ‘çš„ CS å·¥ä½œæµåœ¨æ»¿è¶³ç‰¹å®šæ¢ä»¶æ™‚è‡ªå‹•è§¸ç™¼ IT Agent (ä¾‹å¦‚: æª¢æ¸¬åˆ° VPN å•é¡Œ)
- **ä»¥ä¾¿** IT å‡ç´šç«‹å³ç™¼ç”Ÿï¼Œç„¡éœ€æ‰‹å‹•äº¤æ¥ï¼Œå°‡è§£æ±ºæ™‚é–“å¾å°æ™‚æ¸›å°‘åˆ°åˆ†é˜

**é©—æ”¶æ¨™æº–**:
1. âœ… **YAML é…ç½®**: åœ¨å·¥ä½œæµ YAML ä¸­å®šç¾©è§¸ç™¼è¦å‰‡
   ```yaml
   steps:
     - name: "Resolve Customer Issue"
       agent: "CS.IssueResolution"
       on_complete:
         - condition: "output.category == 'VPN' AND output.severity >= 3"
           trigger:
             scenario: "IT"
             agent: "IT.VPNTroubleshoot"
             event_type: "IT.VPN.Check"
             context:
               customer_id: "${input.customer_id}"
               ticket_id: "${output.ticket_id}"
               issue_details: "${output.summary}"
   ```
2. âœ… **äº‹ä»¶ç™¼å¸ƒ**: ç•¶è§¸ç™¼æ¢ä»¶æ»¿è¶³æ™‚ï¼Œç³»çµ±å‘äº‹ä»¶ç¸½ç·šç™¼å¸ƒäº‹ä»¶
3. âœ… **ä¸Šä¸‹æ–‡å‚³é**: è§¸ç™¼çš„ Agent æ¥æ”¶å®Œæ•´ä¸Šä¸‹æ–‡ (å®¢æˆ¶ ID, å·¥å–® ID, å•é¡Œè©³æƒ…)
4. âœ… **ç‹€æ…‹è·Ÿè¸ª**: ç™¼èµ·å·¥ä½œæµå¯ä»¥æŸ¥è©¢è§¸ç™¼ Agent çš„ç‹€æ…‹
5. âœ… **å›èª¿è¨»å†Š**: å¯é¸çš„å›èª¿ URLï¼Œåœ¨è§¸ç™¼çš„ Agent å®Œæˆæ™‚æ¥æ”¶çµæœ
6. âœ… **å¯©è¨ˆæ—¥èªŒ**: è¨˜éŒ„æ‰€æœ‰è§¸ç™¼äº‹ä»¶ï¼ŒåŒ…å«æ™‚é–“æˆ³ã€æºã€ç›®æ¨™ã€ä¸Šä¸‹æ–‡

**å·¥ä½œæµ YAML ç¤ºä¾‹ (å®Œæ•´)**:

```yaml
workflow:
  id: "CS-CustomerIssueResolution"
  name: "å®¢æœ - å•é¡Œè§£æ±º"
  version: "1.0"
  trigger: "manual"
  
  steps:
    # æ­¥é©Ÿ 1: æ”¶é›†å®¢æˆ¶ä¸Šä¸‹æ–‡
    - id: "step_1"
      name: "ç²å–å®¢æˆ¶ 360 åº¦è¦–åœ–"
      agent: "CS.Customer360"
      input:
        customer_id: "${workflow.input.customer_id}"
      output_mapping:
        customer_data: "${output}"
    
    # æ­¥é©Ÿ 2: ä½¿ç”¨ AI åˆ†æå•é¡Œ
    - id: "step_2"
      name: "åˆ†æå•é¡Œé¡åˆ¥"
      agent: "CS.IssueClassifier"
      input:
        ticket_description: "${workflow.input.description}"
        customer_history: "${step_1.output.customer_data}"
      output_mapping:
        issue_category: "${output.category}"
        severity: "${output.severity}"
        recommended_action: "${output.action}"
    
    # æ­¥é©Ÿ 3: è§£æ±ºå•é¡Œ
    - id: "step_3"
      name: "åŸ·è¡Œè§£æ±ºæ–¹æ¡ˆ"
      agent: "CS.IssueResolution"
      input:
        customer_id: "${workflow.input.customer_id}"
        category: "${step_2.output.issue_category}"
        action: "${step_2.output.recommended_action}"
      
      # è·¨å ´æ™¯è§¸ç™¼é…ç½®
      on_complete:
        # è§¸ç™¼ 1: VPN å•é¡Œçš„ IT å‡ç´š
        - condition: "${step_2.output.issue_category} == 'VPN' AND ${step_2.output.severity} >= 3"
          trigger:
            scenario: "IT"
            agent: "IT.VPNTroubleshoot"
            event_type: "IT.VPN.Check"
            priority: "high"
            context:
              customer_id: "${workflow.input.customer_id}"
              ticket_id: "${step_3.output.ticket_id}"
              issue_details: "${step_3.output.summary}"
              vpn_logs: "${step_3.output.vpn_logs}"
            callback:
              url: "${workflow.callback_base_url}/cs/tickets/${step_3.output.ticket_id}/it-results"
              method: "POST"
              auth: "bearer_token"
          
        # è§¸ç™¼ 2: é€€æ¬¾è«‹æ±‚çš„è²¡å‹™åœ˜éšŠ
        - condition: "${step_2.output.issue_category} == 'Refund' AND ${step_3.output.amount} > 100"
          trigger:
            scenario: "Finance"
            agent: "Finance.RefundApproval"
            event_type: "Finance.Refund.Request"
            priority: "medium"
            context:
              customer_id: "${workflow.input.customer_id}"
              order_id: "${step_3.output.order_id}"
              amount: "${step_3.output.amount}"
              reason: "${step_3.output.refund_reason}"
            callback:
              url: "${workflow.callback_base_url}/cs/tickets/${step_3.output.ticket_id}/refund-status"
              method: "POST"
    
    # æ­¥é©Ÿ 4: æ›´æ–°å·¥å–®ä¸¦é€šçŸ¥å®¢æˆ¶
    - id: "step_4"
      name: "é—œé–‰å·¥å–®"
      agent: "CS.TicketUpdate"
      input:
        ticket_id: "${step_3.output.ticket_id}"
        status: "Resolved"
        resolution_notes: "${step_3.output.summary}"
```

**äº‹ä»¶æ¶ˆæ¯æ ¼å¼ (ç™¼å¸ƒåˆ°äº‹ä»¶ç¸½ç·š)**:

```json
{
  "event_id": "evt_abc123",
  "event_type": "IT.VPN.Check",
  "timestamp": "2025-11-18T10:30:00Z",
  "source": {
    "scenario": "CS",
    "workflow_id": "CS-CustomerIssueResolution",
    "execution_id": "exec_xyz789",
    "step_id": "step_3"
  },
  "target": {
    "scenario": "IT",
    "agent": "IT.VPNTroubleshoot"
  },
  "priority": "high",
  "context": {
    "customer_id": "CUST-5678",
    "ticket_id": "CS-1234",
    "issue_details": "å®¢æˆ¶ç„¡æ³•é€£æ¥åˆ°å…¬å¸ VPN",
    "vpn_logs": "é€£æ¥ 30 ç§’å¾Œè¶…æ™‚..."
  },
  "callback": {
    "url": "https://api.example.com/cs/tickets/CS-1234/it-results",
    "method": "POST",
    "auth": "bearer_token"
  },
  "metadata": {
    "retry_count": 0,
    "expires_at": "2025-11-18T12:30:00Z"
  }
}
```

**API: è§¸ç™¼ç‹€æ…‹æŸ¥è©¢**:

```bash
GET /api/triggers/{trigger_id}/status

éŸ¿æ‡‰:
{
  "trigger_id": "trg_abc123",
  "event_id": "evt_abc123",
  "status": "running",  // pending | running | completed | failed
  "source_workflow": "CS-CustomerIssueResolution",
  "target_agent": "IT.VPNTroubleshoot",
  "triggered_at": "2025-11-18T10:30:00Z",
  "started_at": "2025-11-18T10:30:15Z",
  "target_execution": {
    "execution_id": "exec_it_456",
    "progress": 65,
    "current_step": "åˆ†æ VPN æ—¥èªŒ"
  },
  "estimated_completion": "2025-11-18T10:35:00Z"
}
```

**å®Œæˆå®šç¾©**:
- [ ] YAML `on_complete.trigger` èªæ³•è§£æå’Œé©—è­‰
- [ ] ç•¶è§¸ç™¼æ¢ä»¶æ»¿è¶³æ™‚å‘äº‹ä»¶ç¸½ç·šç™¼å¸ƒäº‹ä»¶
- [ ] è§¸ç™¼çš„ Agent é€šéäº‹ä»¶æ¶ˆæ¯æ¥æ”¶å®Œæ•´ä¸Šä¸‹æ–‡
- [ ] ç‹€æ…‹ API è¿”å›è§¸ç™¼åŸ·è¡Œçš„å¯¦æ™‚ç‹€æ…‹
- [ ] è§¸ç™¼çš„ Agent å®Œæˆæ™‚èª¿ç”¨å›èª¿ URL
- [ ] æ‰€æœ‰è§¸ç™¼äº‹ä»¶è¨˜éŒ„åˆ° `cross_scenario_triggers` è¡¨
- [ ] æ¢ä»¶è©•ä¼°é‚è¼¯çš„å–®å…ƒæ¸¬è©¦

---

### **US-F4-002: å¾è§¸ç™¼çš„ Agent æ¥æ”¶å›èª¿çµæœ**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** å®¢æœå·¥ä½œæµ (ç³»çµ±)
- **æˆ‘æƒ³è¦** ç•¶èª¿æŸ¥å®Œæˆæ™‚é€šéå›èª¿å¾è§¸ç™¼çš„ IT Agent æ¥æ”¶çµæœ
- **ä»¥ä¾¿** æˆ‘å¯ä»¥è‡ªå‹•ä½¿ç”¨ IT ç™¼ç¾æ›´æ–°å®¢æˆ¶å·¥å–®ï¼Œç„¡éœ€æ‰‹å‹•å¹²é 

**é©—æ”¶æ¨™æº–**:
1. âœ… **å›èª¿è¨»å†Š**: ç™¼èµ·å·¥ä½œæµåœ¨è§¸ç™¼æ™‚æä¾›å›èª¿ URL
2. âœ… **ç•°æ­¥åŸ·è¡Œ**: è§¸ç™¼çš„ Agent åœ¨å¾Œå°é‹è¡Œï¼Œä¸é˜»å¡ç™¼èµ·å·¥ä½œæµ
3. âœ… **å›èª¿èª¿ç”¨**: ç•¶è§¸ç™¼çš„ Agent å®Œæˆæ™‚ï¼Œç³»çµ± POST çµæœåˆ°å›èª¿ URL
4. âœ… **çµæœæ ¼å¼**: å›èª¿æœ‰æ•ˆè² è¼‰åŒ…æ‹¬åŸ·è¡Œç‹€æ…‹ã€è¼¸å‡ºæ•¸æ“šã€éŒ¯èª¤ (å¦‚æœæœ‰)
5. âœ… **å®‰å…¨æ€§**: å›èª¿è«‹æ±‚é€šé bearer token æˆ– HMAC ç°½åèªè­‰
6. âœ… **é‡è©¦é‚è¼¯**: å¤±æ•—çš„å›èª¿é‡è©¦ 3 æ¬¡ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿
7. âœ… **è¶…æ™‚è™•ç†**: å¦‚æœè§¸ç™¼çš„ Agent è¶…éè¶…æ™‚æ™‚é–“ï¼Œå›èª¿æ¥æ”¶è¶…æ™‚éŒ¯èª¤

**å›èª¿æœ‰æ•ˆè² è¼‰ç¤ºä¾‹ (æˆåŠŸ)**:

```json
POST https://api.example.com/cs/tickets/CS-1234/it-results
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "trigger_id": "trg_abc123",
  "event_id": "evt_abc123",
  "status": "completed",
  "triggered_at": "2025-11-18T10:30:00Z",
  "completed_at": "2025-11-18T10:34:23Z",
  "duration_seconds": 263,
  "execution": {
    "execution_id": "exec_it_456",
    "agent": "IT.VPNTroubleshoot",
    "output": {
      "root_cause": "é˜²ç«ç‰†è¦å‰‡é˜»æ­¢ VPN ç«¯å£ 1194",
      "resolution_action": "ç‚ºå®¢æˆ¶ IP æ·»åŠ é˜²ç«ç‰†ä¾‹å¤–",
      "status": "å·²è§£æ±º",
      "customer_impacted": false,
      "follow_up_required": false
    },
    "steps_completed": 5,
    "logs_url": "https://api.example.com/executions/exec_it_456/logs"
  },
  "context": {
    "customer_id": "CUST-5678",
    "ticket_id": "CS-1234"
  }
}
```

**å›èª¿æœ‰æ•ˆè² è¼‰ç¤ºä¾‹ (å¤±æ•—)**:

```json
{
  "trigger_id": "trg_abc123",
  "event_id": "evt_abc123",
  "status": "failed",
  "triggered_at": "2025-11-18T10:30:00Z",
  "failed_at": "2025-11-18T10:35:00Z",
  "duration_seconds": 300,
  "execution": {
    "execution_id": "exec_it_456",
    "agent": "IT.VPNTroubleshoot",
    "error": {
      "code": "TIMEOUT",
      "message": "Agent åŸ·è¡Œè¶…é 5 åˆ†é˜è¶…æ™‚",
      "step_failed": "step_3",
      "details": "VPN æ—¥èªŒæŸ¥è©¢è¶…æ™‚"
    },
    "steps_completed": 2
  },
  "context": {
    "customer_id": "CUST-5678",
    "ticket_id": "CS-1234"
  }
}
```

**CS å·¥ä½œæµå›èª¿è™•ç†å™¨ (ç¤ºä¾‹)**:

```python
@router.post("/cs/tickets/{ticket_id}/it-results")
async def receive_it_results(
    ticket_id: str,
    callback_data: CallbackPayload,
    db: Session = Depends(get_db)
):
    """
    å¾ IT Agent æ¥æ”¶å›èª¿çµæœ
    
    æ­¤ç«¯é»åœ¨ IT Agent èª¿æŸ¥å®Œæˆæ™‚è¢«èª¿ç”¨
    """
    logger.info(f"æ”¶åˆ°å·¥å–® {ticket_id} çš„ IT å›èª¿ï¼Œç‹€æ…‹: {callback_data.status}")
    
    # 1. é©—è­‰è§¸ç™¼ ID å­˜åœ¨
    trigger = db.query(CrossScenarioTrigger).filter_by(
        trigger_id=callback_data.trigger_id
    ).first()
    
    if not trigger:
        raise HTTPException(status_code=404, detail="è§¸ç™¼æœªæ‰¾åˆ°")
    
    # 2. æ›´æ–°è§¸ç™¼è¨˜éŒ„
    trigger.status = callback_data.status
    trigger.completed_at = callback_data.completed_at
    trigger.callback_received_at = datetime.utcnow()
    trigger.result_data = callback_data.execution.output
    db.commit()
    
    # 3. ä½¿ç”¨ IT ç™¼ç¾æ›´æ–° CS å·¥å–®
    if callback_data.status == "completed":
        ticket = db.query(Ticket).filter_by(ticket_id=ticket_id).first()
        
        it_output = callback_data.execution.output
        ticket.internal_notes += f"\n\n[IT èª¿æŸ¥çµæœ - {callback_data.completed_at}]\n"
        ticket.internal_notes += f"æ ¹æœ¬åŸå› : {it_output['root_cause']}\n"
        ticket.internal_notes += f"è§£æ±ºæ–¹æ¡ˆ: {it_output['resolution_action']}\n"
        ticket.internal_notes += f"ç‹€æ…‹: {it_output['status']}\n"
        
        if it_output.get("follow_up_required"):
            ticket.status = "å¾… IT è·Ÿé€²"
        else:
            ticket.status = "å·²è§£æ±º"
        
        db.commit()
        
        logger.info(f"å·¥å–® {ticket_id} å·²ä½¿ç”¨ IT çµæœæ›´æ–°")
    
    elif callback_data.status == "failed":
        # è™•ç†å¤±æ•— - ç‚º CS Agent å‰µå»ºæ‰‹å‹•ä»»å‹™
        ticket = db.query(Ticket).filter_by(ticket_id=ticket_id).first()
        ticket.status = "å·²å‡ç´š - IT å¤±æ•—"
        ticket.internal_notes += f"\n\n[IT èª¿æŸ¥å¤±æ•— - {callback_data.failed_at}]\n"
        ticket.internal_notes += f"éŒ¯èª¤: {callback_data.execution.error['message']}\n"
        db.commit()
        
        logger.error(f"å·¥å–® {ticket_id} çš„ IT èª¿æŸ¥å¤±æ•—")
    
    return {"message": "å›èª¿è™•ç†æˆåŠŸ"}
```

**UI é€šçŸ¥ (å¯¦æ™‚æ›´æ–°)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥å–® CS-1234: VPN é€£æ¥å•é¡Œ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ç‹€æ…‹: å·²è§£æ±º âœ“                                              â”‚
â”‚                                                              â”‚
â”‚ ğŸ”” IT èª¿æŸ¥å®Œæˆ (2 åˆ†é˜å‰)                                   â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ ¹æœ¬åŸå› :                                              â”‚ â”‚
â”‚ â”‚ é˜²ç«ç‰†è¦å‰‡é˜»æ­¢ VPN ç«¯å£ 1194                           â”‚ â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚ è§£æ±ºæ–¹æ¡ˆ:                                              â”‚ â”‚
â”‚ â”‚ ç‚ºå®¢æˆ¶ IP æ·»åŠ é˜²ç«ç‰†ä¾‹å¤–                              â”‚ â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚ IT ç‹€æ…‹: å·²è§£æ±º                                        â”‚ â”‚
â”‚ â”‚ éœ€è¦è·Ÿé€²: å¦                                           â”‚ â”‚
â”‚ â”‚                                                        â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹å®Œæ•´ IT æ—¥èªŒ] [é€šçŸ¥å®¢æˆ¶]                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæˆå®šç¾©**:
- [ ] è§¸ç™¼è·¨å ´æ™¯ Agent æ™‚è¨»å†Šå›èª¿ URL
- [ ] è§¸ç™¼çš„ Agent å®Œæˆæ™‚ POST çµæœåˆ°å›èª¿ URL
- [ ] å›èª¿æœ‰æ•ˆè² è¼‰åŒ…æ‹¬åŸ·è¡Œç‹€æ…‹ã€è¼¸å‡ºã€éŒ¯èª¤
- [ ] å¤±æ•—çš„å›èª¿é‡è©¦ 3 æ¬¡ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿ (1s, 2s, 4s)
- [ ] CS å·¥ä½œæµè™•ç†å™¨æ ¹æ“šå›èª¿è‡ªå‹•æ›´æ–°å·¥å–®
- [ ] UI åœ¨æ”¶åˆ°å›èª¿æ™‚é¡¯ç¤ºå¯¦æ™‚é€šçŸ¥
- [ ] å›èª¿æˆåŠŸå’Œå¤±æ•—å ´æ™¯çš„é›†æˆæ¸¬è©¦

---

### **US-F4-003: ç›£æ§è·¨å ´æ™¯è§¸ç™¼å„€è¡¨æ¿**

**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç³»çµ±ç®¡ç†å“¡ (Michael Wong)
- **æˆ‘æƒ³è¦** æŸ¥çœ‹é¡¯ç¤ºæ‰€æœ‰è·¨å ´æ™¯è§¸ç™¼ã€å…¶ç‹€æ…‹å’Œæ€§èƒ½æŒ‡æ¨™çš„å„€è¡¨æ¿
- **ä»¥ä¾¿** æˆ‘å¯ä»¥ç›£æ§ç³»çµ±å¥åº·ï¼Œè­˜åˆ¥ç“¶é ¸ï¼Œä¸¦æ’æŸ¥å¤±æ•—çš„è§¸ç™¼

**é©—æ”¶æ¨™æº–**:
1. âœ… **è§¸ç™¼åˆ—è¡¨**: é¡¯ç¤ºæ‰€æœ‰è§¸ç™¼ï¼Œå¸¶éæ¿¾å™¨ (å ´æ™¯ã€ç‹€æ…‹ã€æ—¥æœŸç¯„åœ)
2. âœ… **ç‹€æ…‹åˆ†è§£**: é¡¯ç¤ºæŒ‰ç‹€æ…‹åŠƒåˆ†çš„è¨ˆæ•¸ (å¾…è™•ç†ã€é‹è¡Œä¸­ã€å·²å®Œæˆã€å¤±æ•—)
3. âœ… **æ€§èƒ½æŒ‡æ¨™**: å¹³å‡è§¸ç™¼åˆ°å›èª¿æ™‚é–“ã€æˆåŠŸç‡ã€é‡è©¦æ¬¡æ•¸
4. âœ… **å¤±æ•—è§¸ç™¼**: çªå‡ºé¡¯ç¤ºå¤±æ•—çš„è§¸ç™¼åŠéŒ¯èª¤è©³æƒ…
5. âœ… **æ·±å…¥æŸ¥çœ‹**: é»æ“Šè§¸ç™¼æŸ¥çœ‹å®Œæ•´åŸ·è¡Œè·Ÿè¸ªå’Œæ—¥èªŒ
6. âœ… **å¯¦æ™‚æ›´æ–°**: å„€è¡¨æ¿æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°

**å„€è¡¨æ¿ UI æ¨¡å‹**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·¨å ´æ™¯å”ä½œ - ç›£æ§å„€è¡¨æ¿                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ“Š æ¦‚è¦½ (éå» 24 å°æ™‚)                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ â”‚ ç¸½è¨ˆ         â”‚ å·²å®Œæˆ       â”‚ é‹è¡Œä¸­       â”‚ å¤±æ•—         â”‚               â”‚
â”‚ â”‚ 1,247        â”‚ 1,189 (95%)  â”‚ 43 (3%)      â”‚ 15 (2%)      â”‚               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                               â”‚
â”‚ â±ï¸  æ€§èƒ½æŒ‡æ¨™                                                                  â”‚
â”‚   å¹³å‡è§¸ç™¼åˆ°å›èª¿æ™‚é–“: 3.2 åˆ†é˜                                                â”‚
â”‚   æˆåŠŸç‡: 95.4%  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ (ç›®æ¨™: â‰¥95%)                           â”‚
â”‚   å¹³å‡é‡è©¦æ¬¡æ•¸: 0.3 (æ¯å€‹è§¸ç™¼çš„é‡è©¦æ¬¡æ•¸)                                     â”‚
â”‚                                                                               â”‚
â”‚ ğŸ”¥ æœ€å¸¸è§¸ç™¼çš„ Agent (æŒ‰é‡)                                                   â”‚
â”‚   1. IT.VPNTroubleshoot: 456 å€‹è§¸ç™¼ (37%)                                    â”‚
â”‚   2. Finance.RefundApproval: 234 å€‹è§¸ç™¼ (19%)                                â”‚
â”‚   3. IT.PasswordReset: 189 å€‹è§¸ç™¼ (15%)                                      â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“‹ æœ€è¿‘è§¸ç™¼                                                                   â”‚
â”‚ [ç¯©é¸: æ‰€æœ‰å ´æ™¯ â–¼] [ç‹€æ…‹: å…¨éƒ¨ â–¼] [éå» 24h â–¼]           [ğŸ”„ åˆ·æ–°]         â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ è§¸ç™¼ ID    â”‚ æº â†’ ç›®æ¨™    â”‚ ç‹€æ…‹   â”‚ è§¸ç™¼æ™‚é–“       â”‚ æŒçºŒæ™‚é–“ â”‚ æ“ä½œ   â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ trg_abc123 â”‚ CS â†’ IT      â”‚ âœ“ å®Œæˆ â”‚ 10:30:00       â”‚ 4m 23s   â”‚ [æŸ¥çœ‹] â”‚â”‚
â”‚ â”‚ trg_def456 â”‚ CS â†’ Finance â”‚ â³ é‹è¡Œâ”‚ 10:35:12       â”‚ 1m 34s   â”‚ [æŸ¥çœ‹] â”‚â”‚
â”‚ â”‚ trg_ghi789 â”‚ Sales â†’ IT   â”‚ âŒ å¤±æ•—â”‚ 10:28:45       â”‚ 5m 00s   â”‚ [é‡è©¦] â”‚â”‚
â”‚ â”‚ trg_jkl012 â”‚ CS â†’ IT      â”‚ âœ“ å®Œæˆ â”‚ 10:25:30       â”‚ 3m 12s   â”‚ [æŸ¥çœ‹] â”‚â”‚
â”‚ â”‚ trg_mno345 â”‚ HR â†’ IT      â”‚ âœ“ å®Œæˆ â”‚ 10:20:15       â”‚ 2m 45s   â”‚ [æŸ¥çœ‹] â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                               â”‚
â”‚ âš ï¸  å¤±æ•—çš„è§¸ç™¼ (éå» 24 å°æ™‚): 15                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ è§¸ç™¼ ID    â”‚ æº â†’ ç›®æ¨™    â”‚ éŒ¯èª¤                                        â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ trg_ghi789 â”‚ Sales â†’ IT   â”‚ è¶…æ™‚: ç›®æ¨™ Agent è¶…é 5 åˆ†é˜è¶…æ™‚           â”‚â”‚
â”‚ â”‚ trg_pqr678 â”‚ CS â†’ Finance â”‚ èªè­‰éŒ¯èª¤: ç„¡æ•ˆçš„å›èª¿ bearer token          â”‚â”‚
â”‚ â”‚ trg_stu901 â”‚ HR â†’ IT      â”‚ æ­»ä¿¡: è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸ (3)                 â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ·±å…¥æŸ¥çœ‹ (é»æ“Šè§¸ç™¼)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§¸ç™¼è©³æƒ…: trg_abc123                                      [é—œé–‰] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ ç‹€æ…‹: âœ“ å·²å®Œæˆ                                                  â”‚
â”‚                                                                  â”‚
â”‚ æº:                                                              â”‚
â”‚   å ´æ™¯: CS                                                       â”‚
â”‚   å·¥ä½œæµ: CS-CustomerIssueResolution                             â”‚
â”‚   åŸ·è¡Œ ID: exec_xyz789                                           â”‚
â”‚   æ­¥é©Ÿ: step_3 (åŸ·è¡Œè§£æ±ºæ–¹æ¡ˆ)                                    â”‚
â”‚                                                                  â”‚
â”‚ ç›®æ¨™:                                                            â”‚
â”‚   å ´æ™¯: IT                                                       â”‚
â”‚   Agent: IT.VPNTroubleshoot                                      â”‚
â”‚   åŸ·è¡Œ ID: exec_it_456                                           â”‚
â”‚                                                                  â”‚
â”‚ æ™‚é–“ç·š:                                                          â”‚
â”‚   â–¶ è§¸ç™¼: 2025-11-18 10:30:00                                   â”‚
â”‚   â–¶ äº‹ä»¶ç™¼å¸ƒ: 10:30:01 (1s)                                     â”‚
â”‚   â–¶ Agent å•Ÿå‹•: 10:30:15 (14s éšŠåˆ—æ™‚é–“)                         â”‚
â”‚   â–¶ Agent å®Œæˆ: 10:34:23 (4m 8s åŸ·è¡Œ)                           â”‚
â”‚   â–¶ å›èª¿ç™¼é€: 10:34:24 (1s)                                     â”‚
â”‚   â–¶ å›èª¿æ¥æ”¶: 10:34:25 (1s)                                     â”‚
â”‚   ç¸½æŒçºŒæ™‚é–“: 4m 25s                                             â”‚
â”‚                                                                  â”‚
â”‚ å‚³éçš„ä¸Šä¸‹æ–‡:                                                    â”‚
â”‚   {                                                              â”‚
â”‚     "customer_id": "CUST-5678",                                  â”‚
â”‚     "ticket_id": "CS-1234",                                      â”‚
â”‚     "issue_details": "å®¢æˆ¶ç„¡æ³•é€£æ¥åˆ° VPN",                       â”‚
â”‚     "vpn_logs": "é€£æ¥ 30 ç§’å¾Œè¶…æ™‚..."                           â”‚
â”‚   }                                                              â”‚
â”‚                                                                  â”‚
â”‚ æ¥æ”¶çš„çµæœ:                                                      â”‚
â”‚   {                                                              â”‚
â”‚     "root_cause": "é˜²ç«ç‰†è¦å‰‡é˜»æ­¢ VPN ç«¯å£ 1194",                â”‚
â”‚     "resolution_action": "æ·»åŠ é˜²ç«ç‰†ä¾‹å¤–",                       â”‚
â”‚     "status": "å·²è§£æ±º"                                           â”‚
â”‚   }                                                              â”‚
â”‚                                                                  â”‚
â”‚ [æŸ¥çœ‹æºåŸ·è¡Œ] [æŸ¥çœ‹ç›®æ¨™åŸ·è¡Œ] [æŸ¥çœ‹äº‹ä»¶]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API: åˆ—å‡ºå¸¶éæ¿¾å™¨çš„è§¸ç™¼**:

```bash
GET /api/triggers?scenario=CS&status=completed&date_from=2025-11-17&date_to=2025-11-18

éŸ¿æ‡‰:
{
  "total": 456,
  "page": 1,
  "page_size": 20,
  "triggers": [
    {
      "trigger_id": "trg_abc123",
      "event_type": "IT.VPN.Check",
      "source_scenario": "CS",
      "target_scenario": "IT",
      "target_agent": "IT.VPNTroubleshoot",
      "status": "completed",
      "triggered_at": "2025-11-18T10:30:00Z",
      "completed_at": "2025-11-18T10:34:25Z",
      "duration_seconds": 265,
      "retry_count": 0
    }
  ]
}
```

**å®Œæˆå®šç¾©**:
- [ ] å„€è¡¨æ¿é¡¯ç¤ºæ‰€æœ‰è§¸ç™¼ï¼Œå¸¶éæ¿¾å™¨
- [ ] ç‹€æ…‹åˆ†è§£é¡¯ç¤ºæŒ‰ç‹€æ…‹åŠƒåˆ†çš„è¨ˆæ•¸ (å¾…è™•ç†ã€é‹è¡Œä¸­ã€å·²å®Œæˆã€å¤±æ•—)
- [ ] è¨ˆç®—æ€§èƒ½æŒ‡æ¨™ (å¹³å‡æ™‚é–“ã€æˆåŠŸç‡ã€é‡è©¦æ¬¡æ•¸)
- [ ] å¤±æ•—çš„è§¸ç™¼çªå‡ºé¡¯ç¤ºä¸¦é™„å¸¶éŒ¯èª¤è©³æƒ…
- [ ] é»æ“Šè§¸ç™¼æ‰“é–‹æ·±å…¥æŸ¥çœ‹ï¼Œé¡¯ç¤ºå®Œæ•´æ™‚é–“ç·š
- [ ] å„€è¡¨æ¿æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
- [ ] ç®¡ç†å“¡å¯ä»¥æ‰‹å‹•é‡è©¦å¤±æ•—çš„è§¸ç™¼

---

### **US-F4-004: ç‚ºå¤±æ•—çš„è§¸ç™¼é…ç½®æ­»ä¿¡éšŠåˆ—**

**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç¶²ç«™å¯é æ€§å·¥ç¨‹å¸« (SRE)
- **æˆ‘æƒ³è¦** å°‡å¤±æ•—çš„è§¸ç™¼ (é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸å¾Œ) ç™¼é€åˆ°æ­»ä¿¡éšŠåˆ— (DLQ) ä»¥ä¾›æ‰‹å‹•æª¢æŸ¥
- **ä»¥ä¾¿** æˆ‘å€‘å¯ä»¥åˆ†æå¤±æ•—ï¼Œä¿®å¾©å•é¡Œï¼Œä¸¦é‡æ”¾æ¶ˆæ¯è€Œä¸ä¸Ÿå¤±æ•¸æ“š

**é©—æ”¶æ¨™æº–**:
1. âœ… **DLQ é…ç½®**: é…ç½®æœ€å¤§é‡è©¦æ¬¡æ•¸ (é»˜èª: 3) å¾Œç™¼é€åˆ° DLQ
2. âœ… **è‡ªå‹• DLQ**: å¤±æ•—çš„è§¸ç™¼åœ¨æœ€å¤§é‡è©¦æ¬¡æ•¸å¾Œè‡ªå‹•ç™¼é€åˆ° DLQ
3. âœ… **DLQ æª¢æŸ¥**: ç®¡ç†å“¡å¯ä»¥åœ¨å„€è¡¨æ¿ä¸­æŸ¥çœ‹ DLQ æ¶ˆæ¯
4. âœ… **æ‰‹å‹•é‡æ”¾**: ç®¡ç†å“¡å¯ä»¥é‡æ”¾ DLQ æ¶ˆæ¯ (é‡æ–°è§¸ç™¼ Agent)
5. âœ… **éŒ¯èª¤åˆ†é¡**: DLQ æ¶ˆæ¯æ¨™è¨˜éŒ¯èª¤é¡åˆ¥ (è¶…æ™‚ã€èªè­‰ã€é©—è­‰)
6. âœ… **è­¦å ±**: ç•¶ DLQ å¤§å°è¶…éé–¾å€¼æ™‚å‘é‹ç¶­åœ˜éšŠç™¼é€è­¦å ± (ä¾‹å¦‚: >50 æ¢æ¶ˆæ¯)

**DLQ é…ç½® (YAML)**:

```yaml
event_bus:
  provider: "rabbitmq"  # æˆ– "azure_service_bus"
  connection: "amqp://localhost:5672"
  
  dead_letter_queue:
    enabled: true
    max_retries: 3
    retry_delay_seconds: [10, 30, 60]  # æŒ‡æ•¸é€€é¿
    dlq_name: "cross_scenario_dlq"
    alert_threshold: 50
    alert_recipients:
      - "ops-team@example.com"
      - "sre-team@example.com"
```

**DLQ å„€è¡¨æ¿ UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­»ä¿¡éšŠåˆ— - å¤±æ•—çš„è§¸ç™¼                                     [æ¸…é™¤] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ âš ï¸  DLQ å¤§å°: 15 æ¢æ¶ˆæ¯ (è­¦å ±é–¾å€¼: 50)                         â”‚
â”‚                                                                  â”‚
â”‚ ğŸ“Š éŒ¯èª¤é¡åˆ¥:                                                    â”‚
â”‚   â€¢ è¶…æ™‚: 8 (53%)                                               â”‚
â”‚   â€¢ èªè­‰éŒ¯èª¤: 4 (27%)                                           â”‚
â”‚   â€¢ é©—è­‰éŒ¯èª¤: 2 (13%)                                           â”‚
â”‚   â€¢ æœªçŸ¥: 1 (7%)                                                â”‚
â”‚                                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚ [ç¯©é¸: æ‰€æœ‰éŒ¯èª¤ â–¼] [æ—¥æœŸ: éå» 7 å¤© â–¼]                         â”‚
â”‚                                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ è§¸ç™¼ ID      â”‚ æº       â”‚ éŒ¯èª¤  â”‚ å¤±æ•—æ™‚é–“    â”‚ æ“ä½œ        â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ trg_ghi789   â”‚ CS â†’ IT  â”‚ è¶…æ™‚  â”‚ 10:28:45    â”‚ [é‡æ”¾][X]   â”‚â”‚
â”‚ â”‚ trg_pqr678   â”‚ CS â†’ Fin â”‚ èªè­‰  â”‚ 09:15:30    â”‚ [é‡æ”¾][X]   â”‚â”‚
â”‚ â”‚ trg_stu901   â”‚ HR â†’ IT  â”‚ è¶…æ™‚  â”‚ 08:45:12    â”‚ [é‡æ”¾][X]   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚ [å…¨é¸] [æ‰¹é‡é‡æ”¾] [æ‰¹é‡åˆªé™¤] [å°å‡º CSV]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡æ”¾ DLQ æ¶ˆæ¯ (API)**:

```bash
POST /api/dlq/{message_id}/replay

éŸ¿æ‡‰:
{
  "message": "DLQ æ¶ˆæ¯é‡æ”¾æˆåŠŸ",
  "original_trigger_id": "trg_ghi789",
  "new_trigger_id": "trg_xyz999",
  "status": "pending",
  "replayed_at": "2025-11-18T11:00:00Z"
}
```

**å®Œæˆå®šç¾©**:
- [ ] å¤±æ•—çš„è§¸ç™¼åœ¨ 3 æ¬¡é‡è©¦å¾Œç™¼é€åˆ° DLQ
- [ ] DLQ æ¶ˆæ¯åœ¨ç®¡ç†å„€è¡¨æ¿ä¸­é¡¯ç¤º
- [ ] ç®¡ç†å“¡å¯ä»¥é‡æ”¾å–®å€‹æˆ–æ‰¹é‡ DLQ æ¶ˆæ¯
- [ ] è¨ˆç®—éŒ¯èª¤é¡åˆ¥ (è¶…æ™‚ã€èªè­‰ã€é©—è­‰)
- [ ] DLQ å¤§å°è¶…éé–¾å€¼æ™‚ç™¼é€è­¦å ±
- [ ] DLQ é‡è©¦å’Œé‡æ”¾é‚è¼¯çš„é›†æˆæ¸¬è©¦

---

## 4.3 æŠ€è¡“å¯¦ç¾ (è©³ç´°)

### 4.3.1 CrossScenarioTriggerService é¡

```python
import asyncio
import json
import logging
from datetime import datetime, timedelta
from typing import Dict, Any, Optional, List
from dataclasses import dataclass
from enum import Enum

logger = logging.getLogger(__name__)

class TriggerStatus(str, Enum):
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"

@dataclass
class TriggerContext:
    """å‚³éçµ¦è§¸ç™¼ Agent çš„ä¸Šä¸‹æ–‡"""
    customer_id: Optional[str] = None
    ticket_id: Optional[str] = None
    order_id: Optional[str] = None
    additional_data: Dict[str, Any] = None

@dataclass
class TriggerConfig:
    """è·¨å ´æ™¯è§¸ç™¼çš„é…ç½®"""
    scenario: str
    agent: str
    event_type: str
    priority: str = "medium"
    context: Dict[str, Any] = None
    callback: Optional[Dict[str, Any]] = None

class CrossScenarioTriggerService:
    """
    ç®¡ç†é€šéäº‹ä»¶ç¸½ç·šçš„è·¨å ´æ™¯ Agent è§¸ç™¼çš„æœå‹™
    """
    
    def __init__(
        self,
        event_bus_client,
        callback_client,
        db_session,
        config: Dict[str, Any]
    ):
        self.event_bus = event_bus_client
        self.callback_client = callback_client
        self.db = db_session
        self.config = config
        
        # é…ç½®
        self.max_retries = config.get("max_retries", 3)
        self.retry_delays = config.get("retry_delay_seconds", [10, 30, 60])
        self.callback_timeout = config.get("callback_timeout_seconds", 30)
    
    async def trigger_agent(
        self,
        source_workflow_id: str,
        source_execution_id: str,
        source_step_id: str,
        trigger_config: TriggerConfig
    ) -> str:
        """
        é€šéäº‹ä»¶ç¸½ç·šè§¸ç™¼è·¨å ´æ™¯ Agent
        
        Args:
            source_workflow_id: ç™¼èµ·è§¸ç™¼çš„å·¥ä½œæµ ID
            source_execution_id: å·¥ä½œæµåŸ·è¡Œ ID
            source_step_id: è§¸ç™¼çš„æ­¥é©Ÿ ID
            trigger_config: ç›®æ¨™ Agent çš„é…ç½®
            
        Returns:
            trigger_id: ç”¨æ–¼è·Ÿè¸ªæ­¤è§¸ç™¼çš„å”¯ä¸€ ID
        """
        trigger_id = self._generate_trigger_id()
        event_id = self._generate_event_id()
        
        logger.info(
            f"è§¸ç™¼è·¨å ´æ™¯ Agent: "
            f"{trigger_config.scenario}.{trigger_config.agent} "
            f"å¾ {source_workflow_id}"
        )
        
        # 1. æ§‹å»ºäº‹ä»¶æ¶ˆæ¯
        event_message = {
            "event_id": event_id,
            "event_type": trigger_config.event_type,
            "timestamp": datetime.utcnow().isoformat(),
            "source": {
                "scenario": self._extract_scenario(source_workflow_id),
                "workflow_id": source_workflow_id,
                "execution_id": source_execution_id,
                "step_id": source_step_id
            },
            "target": {
                "scenario": trigger_config.scenario,
                "agent": trigger_config.agent
            },
            "priority": trigger_config.priority,
            "context": trigger_config.context or {},
            "callback": trigger_config.callback,
            "metadata": {
                "trigger_id": trigger_id,
                "retry_count": 0,
                "expires_at": (datetime.utcnow() + timedelta(hours=2)).isoformat()
            }
        }
        
        # 2. ä¿å­˜è§¸ç™¼è¨˜éŒ„åˆ°æ•¸æ“šåº«
        trigger_record = CrossScenarioTrigger(
            trigger_id=trigger_id,
            event_id=event_id,
            source_workflow_id=source_workflow_id,
            source_execution_id=source_execution_id,
            target_scenario=trigger_config.scenario,
            target_agent=trigger_config.agent,
            event_type=trigger_config.event_type,
            status=TriggerStatus.PENDING,
            context_data=trigger_config.context,
            callback_config=trigger_config.callback,
            triggered_at=datetime.utcnow()
        )
        self.db.add(trigger_record)
        self.db.commit()
        
        # 3. å‘äº‹ä»¶ç¸½ç·šç™¼å¸ƒäº‹ä»¶
        try:
            await self.event_bus.publish(
                exchange=f"scenario.{trigger_config.scenario}",
                routing_key=trigger_config.event_type,
                message=json.dumps(event_message),
                priority=self._map_priority(trigger_config.priority)
            )
            
            logger.info(f"äº‹ä»¶ç™¼å¸ƒæˆåŠŸ: {event_id}")
            
        except Exception as e:
            logger.error(f"ç™¼å¸ƒäº‹ä»¶å¤±æ•—: {e}", exc_info=True)
            
            # æ›´æ–°è§¸ç™¼ç‹€æ…‹ç‚ºå¤±æ•—
            trigger_record.status = TriggerStatus.FAILED
            trigger_record.error_message = str(e)
            self.db.commit()
            
            raise
        
        return trigger_id
    
    async def handle_callback(
        self,
        trigger_id: str,
        callback_data: Dict[str, Any]
    ):
        """
        è™•ç†ä¾†è‡ªè§¸ç™¼ Agent çš„å›èª¿
        
        Args:
            trigger_id: ç™¼èµ·åŸ·è¡Œçš„è§¸ç™¼ ID
            callback_data: ä¾†è‡ªè§¸ç™¼ Agent çš„çµæœ
        """
        logger.info(f"æ”¶åˆ°è§¸ç™¼ {trigger_id} çš„å›èª¿")
        
        # 1. åŠ è¼‰è§¸ç™¼è¨˜éŒ„
        trigger = self.db.query(CrossScenarioTrigger).filter_by(
            trigger_id=trigger_id
        ).first()
        
        if not trigger:
            logger.error(f"è§¸ç™¼æœªæ‰¾åˆ°: {trigger_id}")
            return
        
        # 2. æ›´æ–°è§¸ç™¼è¨˜éŒ„
        trigger.status = callback_data["status"]
        trigger.completed_at = datetime.fromisoformat(callback_data["completed_at"])
        trigger.callback_received_at = datetime.utcnow()
        trigger.result_data = callback_data.get("execution", {}).get("output")
        trigger.duration_seconds = callback_data.get("duration_seconds")
        
        if callback_data["status"] == "failed":
            trigger.error_message = callback_data.get("execution", {}).get("error", {}).get("message")
        
        self.db.commit()
        
        logger.info(
            f"è§¸ç™¼ {trigger_id} å›èª¿è™•ç†å®Œæˆ: "
            f"ç‹€æ…‹={callback_data['status']}, "
            f"æŒçºŒæ™‚é–“={callback_data.get('duration_seconds')}s"
        )
```

### 4.3.2 äº‹ä»¶ç¸½ç·šç›£è½å™¨ (æ¶ˆè²»è€…)

```python
import pika
import json
from typing import Callable

class RabbitMQEventListener:
    """
    ç”¨æ–¼æ¥æ”¶è·¨å ´æ™¯è§¸ç™¼çš„äº‹ä»¶ç¸½ç·šç›£è½å™¨
    """
    
    def __init__(
        self,
        connection_url: str,
        scenario: str,
        workflow_engine,
        callback_service
    ):
        self.connection_url = connection_url
        self.scenario = scenario
        self.workflow_engine = workflow_engine
        self.callback_service = callback_service
        
        self.connection = None
        self.channel = None
    
    def start_listening(self):
        """
        é–‹å§‹ç›£è½é‡å°æ­¤å ´æ™¯çš„äº‹ä»¶
        """
        logger.info(f"å•Ÿå‹•å ´æ™¯çš„äº‹ä»¶ç›£è½å™¨: {self.scenario}")
        
        # 1. é€£æ¥åˆ° RabbitMQ
        self.connection = pika.BlockingConnection(
            pika.URLParameters(self.connection_url)
        )
        self.channel = self.connection.channel()
        
        # 2. è²æ˜äº¤æ›æ©Ÿ (ä¸»é¡Œäº¤æ›æ©Ÿç”¨æ–¼è·¯ç”±)
        exchange_name = f"scenario.{self.scenario}"
        self.channel.exchange_declare(
            exchange=exchange_name,
            exchange_type="topic",
            durable=True
        )
        
        # 3. è²æ˜éšŠåˆ—
        queue_name = f"{self.scenario}_triggers"
        self.channel.queue_declare(
            queue=queue_name,
            durable=True,
            arguments={
                "x-max-priority": 10,  # æ”¯æŒå„ªå…ˆç´šæ¶ˆæ¯
                "x-message-ttl": 7200000  # 2 å°æ™‚ TTL
            }
        )
        
        # 4. å°‡éšŠåˆ—ç¶å®šåˆ°äº¤æ›æ©Ÿ (ç›£è½æ­¤å ´æ™¯çš„æ‰€æœ‰äº‹ä»¶)
        self.channel.queue_bind(
            exchange=exchange_name,
            queue=queue_name,
            routing_key=f"{self.scenario}.#"  # é€šé…ç¬¦: IT.* åŒ¹é… IT.VPN.Check, IT.Password.Reset
        )
        
        # 5. è¨­ç½® QoS (æ¯æ¬¡é å– 1 æ¢æ¶ˆæ¯ä»¥å¯¦ç¾å…¬å¹³åˆ†é…)
        self.channel.basic_qos(prefetch_count=1)
        
        # 6. é–‹å§‹æ¶ˆè²»
        self.channel.basic_consume(
            queue=queue_name,
            on_message_callback=self._handle_message
        )
        
        logger.info(f"æ­£åœ¨ç›£è½éšŠåˆ—: {queue_name}")
        self.channel.start_consuming()
    
    def _handle_message(self, ch, method, properties, body):
        """
        è™•ç†æ¥æ”¶åˆ°çš„äº‹ä»¶æ¶ˆæ¯
        """
        try:
            event = json.loads(body)
            logger.info(f"æ”¶åˆ°äº‹ä»¶: {event['event_id']}, é¡å‹: {event['event_type']}")
            
            # 1. æå–ç›®æ¨™ Agent
            target_agent = event["target"]["agent"]
            context = event["context"]
            callback_config = event.get("callback")
            trigger_id = event["metadata"]["trigger_id"]
            
            # 2. è§¸ç™¼å·¥ä½œæµåŸ·è¡Œ
            execution_id = self.workflow_engine.execute_agent(
                agent_id=target_agent,
                input_data=context,
                metadata={
                    "trigger_id": trigger_id,
                    "source_workflow": event["source"]["workflow_id"]
                }
            )
            
            logger.info(f"Agent {target_agent} å·²è§¸ç™¼ï¼ŒåŸ·è¡Œ: {execution_id}")
            
            # 3. è¨»å†Šå›èª¿è™•ç†å™¨ (ç•°æ­¥)
            if callback_config:
                asyncio.create_task(
                    self._wait_and_callback(
                        execution_id=execution_id,
                        trigger_id=trigger_id,
                        callback_config=callback_config
                    )
                )
            
            # 4. ç¢ºèªæ¶ˆæ¯
            ch.basic_ack(delivery_tag=method.delivery_tag)
            
        except Exception as e:
            logger.error(f"è™•ç†äº‹ä»¶å¤±æ•—: {e}", exc_info=True)
            
            # æ‹’çµ•æ¶ˆæ¯ä¸¦é‡æ–°æ’éšŠ (å°‡é‡è©¦ç›´åˆ° max_retries)
            retry_count = properties.headers.get("x-retry-count", 0) if properties.headers else 0
            
            if retry_count < 3:
                # é‡æ–°æ’éšŠï¼Œå¢åŠ é‡è©¦è¨ˆæ•¸
                ch.basic_reject(delivery_tag=method.delivery_tag, requeue=True)
                logger.warning(f"æ¶ˆæ¯é‡æ–°æ’éšŠï¼Œé‡è©¦è¨ˆæ•¸: {retry_count + 1}")
            else:
                # è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œç™¼é€åˆ° DLQ
                ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)
                logger.error(f"æ¶ˆæ¯åœ¨ {retry_count} æ¬¡é‡è©¦å¾Œç™¼é€åˆ° DLQ")
```

---

## 4.4 æ•¸æ“šåº«æ¶æ§‹

```sql
CREATE TABLE cross_scenario_triggers (
    id SERIAL PRIMARY KEY,
    trigger_id VARCHAR(50) UNIQUE NOT NULL,
    event_id VARCHAR(50) NOT NULL,
    
    -- æºä¿¡æ¯
    source_workflow_id VARCHAR(100) NOT NULL,
    source_execution_id VARCHAR(100) NOT NULL,
    source_scenario VARCHAR(50),
    
    -- ç›®æ¨™ä¿¡æ¯
    target_scenario VARCHAR(50) NOT NULL,
    target_agent VARCHAR(100) NOT NULL,
    target_execution_id VARCHAR(100),
    event_type VARCHAR(100) NOT NULL,
    
    -- ç‹€æ…‹
    status VARCHAR(20) NOT NULL,  -- pending | running | completed | failed
    
    -- ä¸Šä¸‹æ–‡å’Œçµæœ
    context_data JSONB,
    result_data JSONB,
    callback_config JSONB,
    
    -- éŒ¯èª¤è™•ç†
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    retried_as VARCHAR(50),  -- éˆæ¥åˆ°é‡è©¦è§¸ç™¼
    
    -- æ™‚é–“æˆ³
    triggered_at TIMESTAMP NOT NULL,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    callback_received_at TIMESTAMP,
    duration_seconds INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_trigger_status ON cross_scenario_triggers(status, triggered_at DESC);
CREATE INDEX idx_trigger_source ON cross_scenario_triggers(source_workflow_id, source_execution_id);
CREATE INDEX idx_trigger_target ON cross_scenario_triggers(target_scenario, target_agent);
CREATE INDEX idx_trigger_event_type ON cross_scenario_triggers(event_type);
```

---

## 4.5 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|---------|---------|---------|---------|
| **æ€§èƒ½** | äº‹ä»¶ç™¼å¸ƒå»¶é² | < 100ms | APM ç›£æ§ |
| | éšŠåˆ—æ¶ˆè²»å»¶é² | < 500ms | RabbitMQ æŒ‡æ¨™ |
| | å›èª¿å‚³éæ™‚é–“ | < 2 ç§’ | HTTP æ—¥èªŒ |
| **å¯æ“´å±•æ€§** | ä¸¦ç™¼è§¸ç™¼ | æ¯å¤© 1000+ | è² è¼‰æ¸¬è©¦ |
| | éšŠåˆ—æ·±åº¦ | è™•ç† 500+ å¾…è™•ç†æ¶ˆæ¯ | RabbitMQ å„€è¡¨æ¿ |
| **å¯é æ€§** | äº‹ä»¶å‚³éä¿è­‰ | è‡³å°‘ä¸€æ¬¡å‚³é | RabbitMQ ç¢ºèª |
| | å›èª¿é‡è©¦ | 3 æ¬¡å˜—è©¦ï¼ŒæŒ‡æ•¸é€€é¿ | é…ç½® |
| | æ­»ä¿¡éšŠåˆ— | 3 æ¬¡é‡è©¦å¾Œå¤±æ•—çš„æ¶ˆæ¯ | DLQ ç›£æ§ |
| **å¯è§€å¯Ÿæ€§** | è§¸ç™¼æˆåŠŸç‡ | â‰¥95% | å„€è¡¨æ¿æŒ‡æ¨™ |
| | ç«¯åˆ°ç«¯å»¶é² | P95 < 5 åˆ†é˜ | åˆ†å¸ƒå¼è·Ÿè¸ª |
| | DLQ å¤§å° | å¦‚æœ >50 æ¢æ¶ˆæ¯ç™¼å‡ºè­¦å ± | è­¦å ±ç³»çµ± |

---

## 4.6 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:
- è§¸ç™¼æ¢ä»¶è©•ä¼° (YAML è§£æ)
- äº‹ä»¶æ¶ˆæ¯åºåˆ—åŒ–
- å›èª¿æœ‰æ•ˆè² è¼‰ç”Ÿæˆ
- æŒ‡æ•¸é€€é¿çš„é‡è©¦é‚è¼¯

**é›†æˆæ¸¬è©¦**:
- ç«¯åˆ°ç«¯è§¸ç™¼æµç¨‹ (CS â†’ IT)
- å›èª¿å‚³éå’Œè™•ç†
- DLQ è™•ç†å’Œé‡æ”¾
- å¤šå€‹ä¸¦ç™¼è§¸ç™¼

**è² è¼‰æ¸¬è©¦**:
- æ¯å°æ™‚ 1000 å€‹è§¸ç™¼
- æ¸¬é‡éšŠåˆ—æ·±åº¦å’Œå»¶é²
- é©—è­‰ç„¡æ¶ˆæ¯ä¸Ÿå¤±

---

## 4.7 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£ç­–ç•¥** |
|---------|---------|---------|-------------|
| äº‹ä»¶ç¸½ç·šå®•æ©Ÿ | ä½ | é«˜ | å¥åº·æª¢æŸ¥ï¼Œç†”æ–·å™¨ï¼Œå›é€€åˆ°ç›´æ¥ HTTP |
| å›èª¿è¶…æ™‚ | ä¸­ | ä¸­ | 3 æ¬¡é‡è©¦ï¼ŒæŒ‡æ•¸é€€é¿ï¼Œå¤±æ•—é€²å…¥ DLQ |
| æ¶ˆæ¯ä¸Ÿå¤± | ä½ | é«˜ | RabbitMQ æŒä¹…åŒ–éšŠåˆ—ï¼Œç™¼å¸ƒè€…ç¢ºèªï¼Œæ¶ˆè²»è€…ç¢ºèª |
| å¾ªç’°è§¸ç™¼ | ä½ | é«˜ | æœ€å¤§è§¸ç™¼æ·±åº¦é™åˆ¶ï¼Œå¾ªç’°æª¢æ¸¬ |
| DLQ æº¢å‡º | ä¸­ | ä¸­ | 50 æ¢æ¶ˆæ¯æ™‚è­¦å ±ï¼Œè‡ªå‹•æ¸…ç†ç­–ç•¥ |

---

## 4.8 æœªä¾†å¢å¼· (Post-MVP)

1. **é›™å‘è§¸ç™¼**: IT Agent å¯ä»¥è§¸ç™¼å› CS Agent (é–‰ç’°)
2. **è§¸ç™¼ç·¨æ’**: éˆæ¥å¤šå€‹è·¨å ´æ™¯è§¸ç™¼ (CS â†’ IT â†’ Finance)
3. **æ¢ä»¶å›èª¿**: åƒ…åœ¨æ»¿è¶³ç‰¹å®šæ¢ä»¶æ™‚å›èª¿
4. **Webhook æ”¯æŒ**: å¤–éƒ¨ç³»çµ±å¯ä»¥é€šé webhook è§¸ç™¼ IPA å·¥ä½œæµ
5. **è§¸ç™¼åˆ†æ**: è·Ÿè¸ªæœ€å¸¸è¦‹çš„è§¸ç™¼æ¨¡å¼ï¼Œå„ªåŒ–è·¯ç”±
6. **GraphQL è¨‚é–±**: é€šé GraphQL è¨‚é–±å¯¦æ™‚è§¸ç™¼ç‹€æ…‹æ›´æ–°

---

**ä¸‹ä¸€å€‹åŠŸèƒ½**: [F5. åŸºæ–¼å­¸ç¿’çš„å”ä½œ â†’](./feature-05-learning.md)
