# F5. åŸºæ–¼å­¸ç¿’çš„å”ä½œ

**åˆ†é¡**: å­¸ç¿’èˆ‡æ™ºèƒ½  
**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰ - ç«¶çˆ­å„ªå‹¢)  
**é–‹ç™¼æ™‚é–“**: 1.5 é€±  
**è¤‡é›œåº¦**: â­â­â­â­ (é«˜)  
**ä¾è³´é …**: F1 (é †åºå¼ç·¨æ’), F2 (æª¢æŸ¥é»), å‘é‡æ•¸æ“šåº« (Pinecone/Qdrant), Azure OpenAI GPT-4o  
**é¢¨éšªç´šåˆ¥**: ä¸­ (LLM è³ªé‡ä¾è³´æ€§ï¼Œæ•¸æ“šéš±ç§å•é¡Œ)

---

## ğŸ“‘ å°èˆª

- [â† åŠŸèƒ½æ¦‚è¦½](../prd-appendix-a-features-overview.md)
- [â† F4: è·¨å ´æ™¯å”ä½œ](./feature-04-collaboration.md)
- **F5: åŸºæ–¼å­¸ç¿’çš„å”ä½œ** â† æ‚¨åœ¨é€™è£¡
- [â†’ F6: Agent å¸‚å ´](./feature-06-marketplace.md)

---

## 5.1 åŠŸèƒ½æ¦‚è¿°

**ä»€éº¼æ˜¯åŸºæ–¼å­¸ç¿’çš„å”ä½œ?**

åŸºæ–¼å­¸ç¿’çš„å”ä½œä½¿ Agent èƒ½å¤ **å¾éå»æˆåŠŸçš„åŸ·è¡Œä¸­å­¸ç¿’**ï¼Œä¸¦é€šé AI é©…å‹•çš„å°‘æ¨£æœ¬å­¸ç¿’**æ”¹é€²æœªä¾†æ€§èƒ½**ã€‚ç•¶ Agent é‡åˆ°ä¹‹å‰è¦‹éçš„é¡ä¼¼å ´æ™¯æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡ç›¸é—œæ­·å²ç¤ºä¾‹æ³¨å…¥åˆ° LLM æç¤ºä¸­ï¼Œå¾è€Œæé«˜æº–ç¢ºæ€§å’Œä¸€è‡´æ€§ã€‚

**ç‚ºä»€éº¼é€™å¾ˆé‡è¦**:
- **æŒçºŒæ”¹é€²**: Agent éš¨è‘—ç©ç´¯æˆåŠŸæ¡ˆä¾‹è€Œä¸æ–·é€²æ­¥
- **æ¸›å°‘éŒ¯èª¤**: å¾éå»çš„éŒ¯èª¤ä¸­å­¸ç¿’ï¼Œé˜²æ­¢é‡è¤‡å•é¡Œ
- **æ›´å¿«è§£æ±º**: åˆ©ç”¨å·²é©—è­‰çš„è§£æ±ºæ–¹æ¡ˆï¼Œè€Œä¸æ˜¯è©¦éŒ¯
- **çŸ¥è­˜è½‰ç§»**: æ•ç²å¦å‰‡æœƒä¸Ÿå¤±çš„æ©Ÿæ§‹çŸ¥è­˜
- **å€‹æ€§åŒ–**: æ ¹æ“šç‰¹å®šç”¨ä¾‹å’Œå®¢æˆ¶æ¨¡å¼èª¿æ•´ Agent è¡Œç‚º

**æ ¸å¿ƒèƒ½åŠ›**:
1. **æ¡ˆä¾‹è¨˜éŒ„**: è‡ªå‹•æ•ç²æˆåŠŸçš„ Agent åŸ·è¡Œä½œç‚ºã€Œå­¸ç¿’æ¡ˆä¾‹ã€
2. **èªç¾©æœç´¢**: ä½¿ç”¨å‘é‡åµŒå…¥æŸ¥æ‰¾ç›¸ä¼¼çš„éå»æ¡ˆä¾‹ (ä½™å¼¦ç›¸ä¼¼åº¦)
3. **å°‘æ¨£æœ¬æ³¨å…¥**: å°‡å‰ K å€‹ç›¸ä¼¼æ¡ˆä¾‹æ³¨å…¥ LLM æç¤ºä»¥æä¾›ä¸Šä¸‹æ–‡
4. **äººå·¥åé¥‹å¾ªç’°**: ç”¨æˆ¶å¯ä»¥å°‡æ¡ˆä¾‹æ¨™è¨˜ç‚ºã€Œå¥½ã€æˆ–ã€Œå£ã€ä»¥å®Œå–„å­¸ç¿’
5. **å­¸ç¿’åˆ†æ**: è·Ÿè¸ªå­¸ç¿’æ•ˆæœ (æº–ç¢ºæ€§æ”¹é€²ï¼Œæ¡ˆä¾‹é‡ç”¨ç‡)
6. **éš±ç§ä¿è­·**: åœ¨å­˜å„²æ¡ˆä¾‹ä¹‹å‰åŒ¿ååŒ–æ•æ„Ÿæ•¸æ“š (PII)

**æ¥­å‹™åƒ¹å€¼**:
- **è³ªé‡æå‡**: Agent æº–ç¢ºæ€§åœ¨ 1 å€‹æœˆå¾Œå¾ 70% æé«˜åˆ° 85%
- **æˆæœ¬é™ä½**: æ›´å°‘çš„ LLM é‡è©¦ = OpenAI æˆæœ¬é™ä½ 30%
- **æ›´å¿«å…¥è·**: æ–° Agent å¾ç¾æœ‰çŸ¥è­˜åº«å­¸ç¿’
- **å¯å¯©è¨ˆæ€§**: å½±éŸ¿æ¯å€‹æ±ºç­–çš„å®Œæ•´æ­·å²è¨˜éŒ„
- **ç«¶çˆ­å„ªå‹¢**: å°ˆæœ‰çŸ¥è­˜æˆç‚ºè­·åŸæ²³

**çœŸå¯¦ä¸–ç•Œç¤ºä¾‹**:

```
å ´æ™¯: å®¢æœé€€æ¬¾æ±ºç­–

æ²’æœ‰å­¸ç¿’ (å†·å•Ÿå‹•):
è¼¸å…¥: "å®¢æˆ¶æƒ³è¦é€€æ¬¾ï¼Œç”¢å“æœ‰ç¼ºé™·"
Agent: å¾é ­åˆ†æï¼Œæ±ºç­–ä¸ä¸€è‡´
çµæœ: 60% æ‰¹å‡†æº–ç¢ºæ€§ (å¤ªå¯¬é¬†æˆ–å¤ªåš´æ ¼)

æœ‰å­¸ç¿’ (100 å€‹æ¡ˆä¾‹å¾Œ):
è¼¸å…¥: "å®¢æˆ¶æƒ³è¦é€€æ¬¾ï¼Œ15 å¤©å‰è³¼è²·çš„ç”¢å“æœ‰ç¼ºé™·"
ç³»çµ±æ‰¾åˆ°ç›¸ä¼¼çš„éå»æ¡ˆä¾‹:
  - æ¡ˆä¾‹ #47: "ç”¢å“æœ‰ç¼ºé™·ï¼Œ10 å¤©å…§" â†’ æ‰¹å‡† (å®¢æˆ¶å¿ èª åº¦)
  - æ¡ˆä¾‹ #89: "ç”¢å“æœ‰ç¼ºé™·ï¼Œ20 å¤©å…§" â†’ æ‰¹å‡† (ç¬¦åˆæ”¿ç­–)
  - æ¡ˆä¾‹ #102: "ç”¢å“æœ‰ç¼ºé™·ï¼Œ35 å¤©å…§" â†’ æ‹’çµ• (è¶…å‡ºæ”¿ç­–)

Agent çœ‹åˆ°æ¨¡å¼: "å¦‚æœ <30 å¤©å‰‡æ‰¹å‡†ï¼Œå„ªå…ˆè€ƒæ…®é«˜ç´šå®¢æˆ¶"
çµæœ: 85% æ‰¹å‡†æº–ç¢ºæ€§ (èˆ‡å…¬å¸æ”¿ç­–ä¸€è‡´)
```

**æ¶æ§‹æ¦‚è¦½**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent åŸ·è¡Œ     â”‚
â”‚   (æ­¥é©Ÿ N)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. æå–è¼¸å…¥
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­¸ç¿’æœå‹™       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ å‘é‡æ•¸æ“šåº«   â”‚
â”‚                 â”‚         â”‚ (Pinecone)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â–²
         â”‚ 2. æŸ¥æ‰¾ç›¸ä¼¼æ¡ˆä¾‹         â”‚
         â–¼                         â”‚ 3. å­˜å„²åµŒå…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  å‰ K å€‹æ¡ˆä¾‹    â”‚                â”‚
â”‚  (å°‘æ¨£æœ¬)       â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
         â”‚                         â”‚
         â”‚ 4. æ³¨å…¥åˆ°æç¤ºä¸­         â”‚
         â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  å¢å¼·çš„ LLM     â”‚                â”‚
â”‚  æç¤º           â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
         â”‚                         â”‚
         â”‚ 5. åŸ·è¡Œä¸¦ç²å–çµæœ       â”‚
         â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  Agent è¼¸å‡º     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  (è¨˜éŒ„æ¡ˆä¾‹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5.2 ç”¨æˆ¶æ•…äº‹ (å®Œæ•´)

### **US-F5-001: è‡ªå‹•è¨˜éŒ„æˆåŠŸåŸ·è¡Œç‚ºå­¸ç¿’æ¡ˆä¾‹**

**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç³»çµ± (è‡ªå‹•åŒ–)
- **æˆ‘æƒ³è¦** è‡ªå‹•è¨˜éŒ„æˆåŠŸçš„ Agent åŸ·è¡Œ (åŒ…å«è¼¸å…¥ã€è¼¸å‡ºå’Œä¸Šä¸‹æ–‡) ä½œç‚ºå‘é‡æ•¸æ“šåº«ä¸­çš„å­¸ç¿’æ¡ˆä¾‹
- **ä»¥ä¾¿** æœªä¾†é¡ä¼¼çš„åŸ·è¡Œå¯ä»¥å¾éå»æˆåŠŸçš„æ¨¡å¼ä¸­å—ç›Š

**é©—æ”¶æ¨™æº–**:
1. âœ… **è‡ªå‹•è¨˜éŒ„**: æˆåŠŸåŸ·è¡Œå¾Œï¼Œç³»çµ±è‡ªå‹•å‰µå»ºå­¸ç¿’æ¡ˆä¾‹
2. âœ… **æ¡ˆä¾‹çµæ§‹**: æ¯å€‹æ¡ˆä¾‹åŒ…æ‹¬:
   - è¼¸å…¥æ•¸æ“š (å®¢æˆ¶æŸ¥è©¢ï¼Œå·¥å–®è©³æƒ…ç­‰)
   - è¼¸å‡ºæ•¸æ“š (Agent æ±ºç­–ï¼Œè§£æ±ºæ­¥é©Ÿç­‰)
   - åŸ·è¡Œå…ƒæ•¸æ“š (æ™‚é–“æˆ³ï¼ŒAgent IDï¼ŒåŸ·è¡Œæ™‚é–“ï¼ŒæˆåŠŸ/å¤±æ•—)
   - äººå·¥åé¥‹ (è´Š/è¸©ï¼Œå¯é¸å‚™è¨»)
3. âœ… **å‘é‡åµŒå…¥**: è¼¸å…¥æ–‡æœ¬è½‰æ›ç‚ºå‘é‡åµŒå…¥ (OpenAI ada-002 çš„ 1536 ç¶­)
4. âœ… **å­˜å„²**: æ¡ˆä¾‹ + åµŒå…¥å­˜å„²åœ¨å‘é‡æ•¸æ“šåº«ä¸­ (Pinecone/Qdrant)
5. âœ… **PII åŒ¿ååŒ–**: æ•æ„Ÿæ•¸æ“š (å®¢æˆ¶å§“åï¼Œé›»å­éƒµä»¶ï¼Œé›»è©±è™Ÿç¢¼) è‡ªå‹•ç·¨è¼¯
6. âœ… **å»é‡**: ç›¸ä¼¼æ¡ˆä¾‹ (>95% ç›¸ä¼¼åº¦) åˆä½µä»¥é¿å…å†—é¤˜
7. âœ… **TTL**: èˆŠæ¡ˆä¾‹ (>1 å¹´) è‡ªå‹•æ­¸æª”

**æ¡ˆä¾‹è¨˜éŒ„æµç¨‹**:

```python
# Agent åŸ·è¡Œå®Œæˆå¾Œ
async def record_learning_case(
    agent_id: str,
    execution_id: str,
    input_data: Dict[str, Any],
    output_data: Dict[str, Any],
    success: bool
):
    if not success:
        return  # åƒ…è¨˜éŒ„æˆåŠŸçš„æ¡ˆä¾‹
    
    # 1. åŒ¿ååŒ– PII
    input_anonymized = anonymize_pii(input_data)
    output_anonymized = anonymize_pii(output_data)
    
    # 2. å‰µå»ºæ¡ˆä¾‹æ–‡æœ¬ (ç”¨æ–¼åµŒå…¥)
    case_text = f"""
    Agent: {agent_id}
    è¼¸å…¥: {json.dumps(input_anonymized, indent=2)}
    è¼¸å‡º: {json.dumps(output_anonymized, indent=2)}
    """
    
    # 3. ç”ŸæˆåµŒå…¥
    embedding = await openai_client.embeddings.create(
        model="text-embedding-ada-002",
        input=case_text
    )
    
    # 4. å­˜å„²åœ¨å‘é‡æ•¸æ“šåº«ä¸­
    case_id = f"case_{uuid.uuid4().hex[:12]}"
    await vector_db.upsert(
        id=case_id,
        values=embedding.data[0].embedding,
        metadata={
            "agent_id": agent_id,
            "execution_id": execution_id,
            "input": input_anonymized,
            "output": output_anonymized,
            "timestamp": datetime.utcnow().isoformat(),
            "feedback": None  # ç¨å¾Œç”±äººå·¥å¡«å¯«
        }
    )
    
    logger.info(f"å­¸ç¿’æ¡ˆä¾‹å·²è¨˜éŒ„: {case_id}")
```

**æ¡ˆä¾‹çµæ§‹ (å­˜å„²åœ¨å‘é‡æ•¸æ“šåº«ä¸­)**:

```json
{
  "id": "case_a1b2c3d4e5f6",
  "vector": [0.0234, -0.0456, 0.0789, ...],  // 1536 ç¶­
  "metadata": {
    "agent_id": "CS.RefundDecision",
    "execution_id": "exec_xyz789",
    "input": {
      "customer_id": "CUST-****",  // å·²åŒ¿ååŒ–
      "product": "ç„¡ç·šè€³æ©Ÿ",
      "issue": "ç”¢å“æœ‰ç¼ºé™·",
      "purchase_date": "2025-10-15",
      "days_since_purchase": 15
    },
    "output": {
      "decision": "æ‰¹å‡†",
      "reasoning": "å®¢æˆ¶æ˜¯é«˜ç´šæœƒå“¡ï¼Œç”¢å“åœ¨ 30 å¤©æ”¿ç­–å…§æœ‰ç¼ºé™·",
      "refund_amount": 99.99,
      "follow_up_action": "ç™¼é€é€€è²¨æ¨™ç±¤"
    },
    "timestamp": "2025-11-18T10:30:00Z",
    "execution_time_ms": 2340,
    "feedback": {
      "rating": "good",  // good | bad | neutral
      "notes": "æ­£ç¢ºçš„æ±ºç­–ï¼Œå®¢æˆ¶æ»¿æ„",
      "rated_by": "sarah.martinez@example.com",
      "rated_at": "2025-11-18T11:00:00Z"
    }
  }
}
```

**PII åŒ¿ååŒ– (ç¤ºä¾‹)**:

```python
import re

def anonymize_pii(data: Dict[str, Any]) -> Dict[str, Any]:
    """
    åŒ¿ååŒ–å€‹äººå¯è­˜åˆ¥ä¿¡æ¯
    
    æ›¿æ›:
    - å®¢æˆ¶å§“åç‚º "CUST-****"
    - é›»å­éƒµä»¶ç‚º "****@example.com"
    - é›»è©±è™Ÿç¢¼ç‚º "(***) ***-****"
    - ä¿¡ç”¨å¡è™Ÿç‚º "**** **** **** 1234"
    """
    data_str = json.dumps(data)
    
    # é›»å­éƒµä»¶æ¨¡å¼
    data_str = re.sub(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', '****@example.com', data_str)
    
    # é›»è©±æ¨¡å¼ (ç¾åœ‹)
    data_str = re.sub(r'\+?1?\s*\(?(\d{3})\)?[\s.-]?(\d{3})[\s.-]?(\d{4})', '(***) ***-****', data_str)
    
    # ä¿¡ç”¨å¡æ¨¡å¼
    data_str = re.sub(r'\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?(\d{4})\b', r'**** **** **** \1', data_str)
    
    # å®¢æˆ¶ ID æ¨¡å¼ (ä¿ç•™éƒ¨åˆ†)
    data_str = re.sub(r'CUST-\d+', 'CUST-****', data_str)
    
    return json.loads(data_str)
```

**å®Œæˆå®šç¾©**:
- [ ] æˆåŠŸåŸ·è¡Œè‡ªå‹•è¨˜éŒ„ç‚ºå­¸ç¿’æ¡ˆä¾‹
- [ ] æ¯å€‹æ¡ˆä¾‹åŒ…æ‹¬è¼¸å…¥ã€è¼¸å‡ºã€å…ƒæ•¸æ“šã€åé¥‹ä½”ä½ç¬¦
- [ ] è¼¸å…¥æ–‡æœ¬è½‰æ›ç‚º 1536 ç¶­å‘é‡åµŒå…¥
- [ ] æ¡ˆä¾‹èˆ‡å…ƒæ•¸æ“šä¸€èµ·å­˜å„²åœ¨ Pinecone/Qdrant ä¸­
- [ ] PII è‡ªå‹•åŒ¿ååŒ– (é›»å­éƒµä»¶ã€é›»è©±ã€å§“å)
- [ ] é‡è¤‡æ¡ˆä¾‹ (>95% ç›¸ä¼¼åº¦) åˆä½µ
- [ ] åŒ¿ååŒ–é‚è¼¯çš„å–®å…ƒæ¸¬è©¦

---

### **US-F5-002: å°‡ç›¸ä¼¼çš„éå»æ¡ˆä¾‹æ³¨å…¥ LLM æç¤º (å°‘æ¨£æœ¬å­¸ç¿’)**

**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 4 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** Agent é–‹ç™¼è€… (Emily Zhang)
- **æˆ‘æƒ³è¦** åœ¨åŸ·è¡Œ Agent æ™‚è‡ªå‹•å°‡å‰ K å€‹ç›¸ä¼¼çš„éå»æ¡ˆä¾‹æ³¨å…¥ LLM æç¤º
- **ä»¥ä¾¿** Agent å¾éå»æˆåŠŸçš„æ¨¡å¼ä¸­å­¸ç¿’ï¼Œç”¢ç”Ÿæ›´æº–ç¢ºã€ä¸€è‡´çš„çµæœ

**é©—æ”¶æ¨™æº–**:
1. âœ… **æŸ¥è©¢è§¸ç™¼**: åœ¨åŸ·è¡Œ Agent ä¹‹å‰ï¼Œç³»çµ±æŸ¥è©¢å‘é‡æ•¸æ“šåº«å°‹æ‰¾ç›¸ä¼¼æ¡ˆä¾‹
2. âœ… **èªç¾©æœç´¢**: ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦æŸ¥æ‰¾å‰ K å€‹ (é»˜èª: 3) æœ€ç›¸ä¼¼çš„æ¡ˆä¾‹
3. âœ… **ç›¸ä¼¼åº¦é–¾å€¼**: åƒ…æ³¨å…¥ç›¸ä¼¼åº¦ â‰¥ 0.75 çš„æ¡ˆä¾‹ (å¯é…ç½®)
4. âœ… **æç¤ºå¢å¼·**: ä½¿ç”¨å°‘æ¨£æœ¬æ ¼å¼å°‡æ¡ˆä¾‹æ³¨å…¥ LLM æç¤º
5. âœ… **æ€§èƒ½**: å‘é‡æœç´¢åœ¨ <200ms å…§å®Œæˆ (P95)
6. âœ… **å›é€€**: å¦‚æœæ²’æœ‰æ‰¾åˆ°ç›¸ä¼¼æ¡ˆä¾‹ï¼Œå‰‡ç¹¼çºŒåŸ·è¡Œè€Œä¸ä½¿ç”¨å°‘æ¨£æœ¬ç¤ºä¾‹
7. âœ… **é…ç½®**: é€šé YAML ç‚ºæ¯å€‹ Agent å•Ÿç”¨/ç¦ç”¨å­¸ç¿’

**å°‘æ¨£æœ¬æç¤ºæ¨¡æ¿**:

```python
FEW_SHOT_PROMPT_TEMPLATE = """
æ‚¨æ˜¯ä¸€å€‹å¹«åŠ©å®¢æœé€€æ¬¾æ±ºç­–çš„ AI Agentã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ç›¸ä¼¼çš„éå»æ¡ˆä¾‹ä¾›åƒè€ƒ:

{few_shot_examples}

ç¾åœ¨ï¼Œåˆ†æç•¶å‰æ¡ˆä¾‹:

è¼¸å…¥:
{current_input}

ä»¥ JSON æ ¼å¼æä¾›æ‚¨çš„æ±ºç­–:
{{
  "decision": "æ‰¹å‡†" æˆ– "æ‹’çµ•",
  "reasoning": "ç°¡çŸ­è§£é‡‹",
  "refund_amount": æ•¸å­—,
  "follow_up_action": "å­—ç¬¦ä¸²"
}}
"""

FEW_SHOT_EXAMPLE_TEMPLATE = """
ç¤ºä¾‹ {index}:
è¼¸å…¥: {input}
è¼¸å‡º: {output}
æ¨ç†: {reasoning}
---
"""
```

**å¢å¼·çš„æç¤º (åŒ…å«å°‘æ¨£æœ¬ç¤ºä¾‹)**:

```
æ‚¨æ˜¯ä¸€å€‹å¹«åŠ©å®¢æœé€€æ¬¾æ±ºç­–çš„ AI Agentã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ç›¸ä¼¼çš„éå»æ¡ˆä¾‹ä¾›åƒè€ƒ:

ç¤ºä¾‹ 1:
è¼¸å…¥: {"product": "ç„¡ç·šè€³æ©Ÿ", "issue": "ç”¢å“æœ‰ç¼ºé™·", "days_since_purchase": 15}
è¼¸å‡º: {"decision": "æ‰¹å‡†", "refund_amount": 99.99}
æ¨ç†: å®¢æˆ¶æ˜¯é«˜ç´šæœƒå“¡ï¼Œç”¢å“åœ¨ 30 å¤©æ”¿ç­–å…§æœ‰ç¼ºé™·
---

ç¤ºä¾‹ 2:
è¼¸å…¥: {"product": "è—ç‰™éŸ³ç®±", "issue": "ç”¢å“æœ‰ç¼ºé™·", "days_since_purchase": 10}
è¼¸å‡º: {"decision": "æ‰¹å‡†", "refund_amount": 49.99}
æ¨ç†: é€€è²¨æœŸå…§çš„ç¼ºé™·ç”¢å“ï¼Œå®¢æˆ¶å¿ èª åº¦
---

ç¤ºä¾‹ 3:
è¼¸å…¥: {"product": "USB ç·š", "issue": "ç”¢å“æœ‰ç¼ºé™·", "days_since_purchase": 35}
è¼¸å‡º: {"decision": "æ‹’çµ•"}
æ¨ç†: ç”¢å“è³¼è²· 35 å¤©å‰ï¼Œè¶…å‡º 30 å¤©é€€è²¨æ”¿ç­–
---

ç¾åœ¨ï¼Œåˆ†æç•¶å‰æ¡ˆä¾‹:

è¼¸å…¥:
{"product": "ç„¡ç·šè€³å¡", "issue": "ç”¢å“æœ‰ç¼ºé™·", "days_since_purchase": 18}

ä»¥ JSON æ ¼å¼æä¾›æ‚¨çš„æ±ºç­–:
{
  "decision": "æ‰¹å‡†" æˆ– "æ‹’çµ•",
  "reasoning": "ç°¡çŸ­è§£é‡‹",
  "refund_amount": æ•¸å­—,
  "follow_up_action": "å­—ç¬¦ä¸²"
}
```

**å­¸ç¿’æœå‹™å¯¦ç¾**:

```python
class LearningService:
    """
    ä½¿ç”¨å°‘æ¨£æœ¬å­¸ç¿’çš„åŸºæ–¼å­¸ç¿’çš„å”ä½œæœå‹™
    """
    
    def __init__(
        self,
        vector_db_client,
        openai_client,
        config: Dict[str, Any]
    ):
        self.vector_db = vector_db_client
        self.openai = openai_client
        self.config = config
        
        # é…ç½®
        self.top_k = config.get("top_k_cases", 3)
        self.similarity_threshold = config.get("similarity_threshold", 0.75)
        self.embedding_model = config.get("embedding_model", "text-embedding-ada-002")
    
    async def enhance_prompt_with_learning(
        self,
        agent_id: str,
        current_input: Dict[str, Any],
        base_prompt: str
    ) -> str:
        """
        ä½¿ç”¨ç›¸ä¼¼çš„éå»æ¡ˆä¾‹å¢å¼· LLM æç¤º (å°‘æ¨£æœ¬å­¸ç¿’)
        
        Args:
            agent_id: æ­£åœ¨åŸ·è¡Œçš„ Agent ID
            current_input: ç•¶å‰è¼¸å…¥æ•¸æ“š
            base_prompt: åŸå§‹æç¤ºæ¨¡æ¿
            
        Returns:
            åŒ…å«å°‘æ¨£æœ¬ç¤ºä¾‹çš„å¢å¼·æç¤º
        """
        # 1. å°‡ç•¶å‰è¼¸å…¥è½‰æ›ç‚ºåµŒå…¥
        input_text = json.dumps(current_input, indent=2)
        embedding_response = await self.openai.embeddings.create(
            model=self.embedding_model,
            input=f"Agent: {agent_id}\nè¼¸å…¥: {input_text}"
        )
        query_vector = embedding_response.data[0].embedding
        
        # 2. æŸ¥è©¢å‘é‡æ•¸æ“šåº«ä»¥æŸ¥æ‰¾ç›¸ä¼¼æ¡ˆä¾‹
        similar_cases = await self.vector_db.query(
            vector=query_vector,
            top_k=self.top_k,
            filter={"agent_id": agent_id},  # åƒ…ä¾†è‡ªåŒä¸€ Agent çš„æ¡ˆä¾‹
            include_metadata=True
        )
        
        # 3. æŒ‰ç›¸ä¼¼åº¦é–¾å€¼éæ¿¾
        filtered_cases = [
            case for case in similar_cases.matches
            if case.score >= self.similarity_threshold
        ]
        
        if not filtered_cases:
            logger.info(f"æœªæ‰¾åˆ° Agent {agent_id} çš„ç›¸ä¼¼æ¡ˆä¾‹ (é–¾å€¼: {self.similarity_threshold})")
            return base_prompt  # ç„¡å°‘æ¨£æœ¬ç¤ºä¾‹
        
        logger.info(f"ç‚º Agent {agent_id} æ‰¾åˆ° {len(filtered_cases)} å€‹ç›¸ä¼¼æ¡ˆä¾‹")
        
        # 4. æ§‹å»ºå°‘æ¨£æœ¬ç¤ºä¾‹
        few_shot_examples = []
        for idx, case in enumerate(filtered_cases, start=1):
            example = f"""
ç¤ºä¾‹ {idx} (ç›¸ä¼¼åº¦: {case.score:.2f}):
è¼¸å…¥: {json.dumps(case.metadata['input'], indent=2)}
è¼¸å‡º: {json.dumps(case.metadata['output'], indent=2)}
æ¨ç†: {case.metadata['output'].get('reasoning', 'N/A')}
---
"""
            few_shot_examples.append(example)
        
        few_shot_text = "\n".join(few_shot_examples)
        
        # 5. æ³¨å…¥åˆ°æç¤ºä¸­
        enhanced_prompt = f"""
{base_prompt}

ä»¥ä¸‹æ˜¯ä¸€äº›ç›¸ä¼¼çš„éå»æ¡ˆä¾‹ä¾›åƒè€ƒ:

{few_shot_text}

ç¾åœ¨ï¼Œåˆ†æç•¶å‰æ¡ˆä¾‹:

è¼¸å…¥:
{input_text}
"""
        
        return enhanced_prompt
```

**å¸¶å­¸ç¿’çš„ Agent åŸ·è¡Œ (é›†æˆ)**:

```python
async def execute_agent_with_learning(
    agent_id: str,
    input_data: Dict[str, Any],
    learning_service: LearningService,
    enable_learning: bool = True
):
    """
    ä½¿ç”¨åŸºæ–¼å­¸ç¿’çš„å°‘æ¨£æœ¬å¢å¼·åŸ·è¡Œ Agent
    """
    # 1. åŠ è¼‰åŸºç¤æç¤º
    agent_config = load_agent_config(agent_id)
    base_prompt = agent_config["prompt_template"]
    
    # 2. ä½¿ç”¨å­¸ç¿’å¢å¼·æç¤º (å¦‚æœå•Ÿç”¨)
    if enable_learning:
        enhanced_prompt = await learning_service.enhance_prompt_with_learning(
            agent_id=agent_id,
            current_input=input_data,
            base_prompt=base_prompt
        )
    else:
        enhanced_prompt = base_prompt
    
    # 3. ä½¿ç”¨å¢å¼·çš„æç¤ºåŸ·è¡Œ Agent
    response = await openai_client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": enhanced_prompt},
            {"role": "user", "content": json.dumps(input_data)}
        ],
        temperature=0.3
    )
    
    output = json.loads(response.choices[0].message.content)
    
    # 4. è¨˜éŒ„ç‚ºå­¸ç¿’æ¡ˆä¾‹ (å¦‚æœæˆåŠŸ)
    if output.get("decision") in ["æ‰¹å‡†", "æ‹’çµ•"]:
        await learning_service.record_case(
            agent_id=agent_id,
            input_data=input_data,
            output_data=output,
            success=True
        )
    
    return output
```

**YAML é…ç½® (å•Ÿç”¨/ç¦ç”¨å­¸ç¿’)**:

```yaml
agents:
  - id: "CS.RefundDecision"
    name: "å®¢æœé€€æ¬¾æ±ºç­–"
    learning:
      enabled: true
      top_k_cases: 3
      similarity_threshold: 0.75
      auto_record: true
      anonymize_pii: true
    
  - id: "IT.PasswordReset"
    name: "IT å¯†ç¢¼é‡ç½®"
    learning:
      enabled: false  # ç‚ºæ•æ„Ÿ Agent ç¦ç”¨å­¸ç¿’
```

**å®Œæˆå®šç¾©**:
- [ ] Agent åŸ·è¡Œå‰æŸ¥è©¢å‘é‡æ•¸æ“šåº«ä»¥æŸ¥æ‰¾ç›¸ä¼¼æ¡ˆä¾‹
- [ ] æª¢ç´¢å‰ K å€‹æ¡ˆä¾‹ (é»˜èª: 3)ï¼Œç›¸ä¼¼åº¦ â‰¥ 0.75
- [ ] å°‘æ¨£æœ¬ç¤ºä¾‹æ³¨å…¥ LLM æç¤º
- [ ] å‘é‡æœç´¢åœ¨ <200ms å…§å®Œæˆ (P95)
- [ ] å¦‚æœæ²’æœ‰æ‰¾åˆ°æ¡ˆä¾‹ï¼ŒAgent åŸ·è¡Œå¯ä»¥åœ¨æ²’æœ‰å­¸ç¿’çš„æƒ…æ³ä¸‹å·¥ä½œ
- [ ] å¯ä»¥é€šé YAML ç‚ºæ¯å€‹ Agent å•Ÿç”¨/ç¦ç”¨å­¸ç¿’
- [ ] æ¯”è¼ƒæœ‰/ç„¡å­¸ç¿’çš„æº–ç¢ºæ€§çš„é›†æˆæ¸¬è©¦

---

### **US-F5-003: æ¡ˆä¾‹è³ªé‡çš„äººå·¥åé¥‹å¾ªç’°**

**å„ªå…ˆç´š**: P1 (æ‡‰è©²æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** å®¢æœç¶“ç† (Sarah Martinez)
- **æˆ‘æƒ³è¦** å°‡å­¸ç¿’æ¡ˆä¾‹è©•ç‚ºã€Œå¥½ã€æˆ–ã€Œå£ã€ä¸¦æ·»åŠ å‚™è¨»
- **ä»¥ä¾¿** ç³»çµ±å„ªå…ˆè€ƒæ…®é«˜è³ªé‡æ¡ˆä¾‹ä¸¦éæ¿¾æ‰ä¸æ­£ç¢ºçš„ç¤ºä¾‹

**é©—æ”¶æ¨™æº–**:
1. âœ… **åé¥‹ UI**: åŸ·è¡Œå¾Œï¼Œç”¨æˆ¶çœ‹åˆ°ã€Œé€™æœ‰å¹«åŠ©å—?ã€æç¤º
2. âœ… **è©•ç´šé¸é …**: è´Š (å¥½)ï¼Œè¸© (å£)ï¼Œä¸­ç«‹ (è·³é)
3. âœ… **å¯é¸å‚™è¨»**: ç”¨æˆ¶å¯ä»¥æ·»åŠ æ–‡æœ¬å‚™è¨»è§£é‡‹è©•ç´š
4. âœ… **æ¡ˆä¾‹æ›´æ–°**: åé¥‹å­˜å„²åœ¨å‘é‡æ•¸æ“šåº«å…ƒæ•¸æ“šä¸­
5. âœ… **è³ªé‡éæ¿¾**: å£æ¡ˆä¾‹ (è©•ç´š = "å£") å¾æœªä¾†æŸ¥è©¢ä¸­æ’é™¤
6. âœ… **åˆ†æ**: è·Ÿè¸ªæ¯å€‹ Agent çš„åé¥‹ç‡ã€å¥½/å£æ¯”ç‡

**åé¥‹ UI (åŸ·è¡Œå¾Œ)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent åŸ·è¡Œå®Œæˆ: CS.RefundDecision                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ æ±ºç­–: âœ“ é€€æ¬¾æ‰¹å‡† ($99.99)                                   â”‚
â”‚ æ¨ç†: å®¢æˆ¶æ˜¯é«˜ç´šæœƒå“¡ï¼Œåœ¨ 30 å¤©æ”¿ç­–å…§                        â”‚
â”‚                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                              â”‚
â”‚ ğŸ’¡ é€™å€‹æ±ºç­–æœ‰å¹«åŠ©å—?                                        â”‚
â”‚                                                              â”‚
â”‚ [ğŸ‘ å¥½æ±ºç­–]  [ğŸ‘ å£æ±ºç­–]  [è·³é]                           â”‚
â”‚                                                              â”‚
â”‚ å¯é¸: æ·»åŠ å‚™è¨» (å°å…¶ä»– CS ç¶“ç†å¯è¦‹)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ æ­£ç¢ºçš„æ±ºç­–ï¼Œå®¢æˆ¶æ»¿æ„                                     â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚ [æäº¤åé¥‹]                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API: æäº¤åé¥‹**:

```bash
POST /api/learning/cases/{case_id}/feedback
{
  "rating": "good",  // good | bad | neutral
  "notes": "æ­£ç¢ºçš„æ±ºç­–ï¼Œå®¢æˆ¶æ»¿æ„",
  "rated_by": "sarah.martinez@example.com"
}

éŸ¿æ‡‰:
{
  "message": "åé¥‹è¨˜éŒ„æˆåŠŸ",
  "case_id": "case_a1b2c3d4e5f6",
  "rating": "good",
  "total_feedback_count": 1
}
```

**è³ªé‡éæ¿¾ (æ’é™¤å£æ¡ˆä¾‹)**:

```python
# æŸ¥è©¢ç›¸ä¼¼æ¡ˆä¾‹æ™‚
similar_cases = await vector_db.query(
    vector=query_vector,
    top_k=10,  # æŸ¥è©¢æ›´å¤šï¼Œç¨å¾Œéæ¿¾
    filter={
        "agent_id": agent_id,
        "feedback.rating": {"$ne": "bad"}  # æ’é™¤å£æ¡ˆä¾‹
    }
)

# é€²ä¸€æ­¥å„ªå…ˆè€ƒæ…®å¥½æ¡ˆä¾‹
good_cases = [c for c in similar_cases.matches if c.metadata.get("feedback", {}).get("rating") == "good"]
neutral_cases = [c for c in similar_cases.matches if c.metadata.get("feedback") is None]

# é¦–å…ˆè¿”å›å¥½æ¡ˆä¾‹ï¼Œç„¶å¾Œæ˜¯ä¸­ç«‹æ¡ˆä¾‹
final_cases = (good_cases + neutral_cases)[:top_k]
```

**åé¥‹åˆ†æå„€è¡¨æ¿**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­¸ç¿’åˆ†æ: CS.RefundDecision                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ“Š æ¡ˆä¾‹è³ªé‡æŒ‡æ¨™                                             â”‚
â”‚   ç¸½æ¡ˆä¾‹æ•¸: 234                                              â”‚
â”‚   æœ‰åé¥‹: 89 (38%)                                           â”‚
â”‚   å¥½æ¡ˆä¾‹: 67 (75%)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘                    â”‚
â”‚   å£æ¡ˆä¾‹: 22 (25%)  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                    â”‚
â”‚                                                              â”‚
â”‚ ğŸ¯ å­¸ç¿’æ•ˆæœ                                                 â”‚
â”‚   æº–ç¢ºæ€§ (ç„¡å­¸ç¿’): 70%                                       â”‚
â”‚   æº–ç¢ºæ€§ (æœ‰å­¸ç¿’): 85%  (+15% æ”¹é€²)                         â”‚
â”‚   æ¡ˆä¾‹é‡ç”¨: 156 æ¬¡ (å¹³å‡æ¯å€‹æ¡ˆä¾‹ 0.67 æ¬¡é‡ç”¨)               â”‚
â”‚                                                              â”‚
â”‚ ğŸ‘¥ æœ€ä½³åé¥‹è²¢ç»è€…                                           â”‚
â”‚   1. Sarah Martinez: 45 å€‹è©•ç´š                               â”‚
â”‚   2. John Smith: 23 å€‹è©•ç´š                                   â”‚
â”‚   3. Emma Wilson: 21 å€‹è©•ç´š                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæˆå®šç¾©**:
- [ ] åŸ·è¡Œå¾Œ UI é¡¯ç¤ºåé¥‹æç¤º (è´Š/è¸©)
- [ ] ç”¨æˆ¶å¯ä»¥æ·»åŠ å¯é¸å‚™è¨»å’Œè©•ç´š
- [ ] åé¥‹å­˜å„²åœ¨å‘é‡æ•¸æ“šåº«æ¡ˆä¾‹å…ƒæ•¸æ“šä¸­
- [ ] å£æ¡ˆä¾‹å¾æœªä¾†ç›¸ä¼¼æ€§æŸ¥è©¢ä¸­æ’é™¤
- [ ] å¥½æ¡ˆä¾‹å„ªå…ˆæ–¼ä¸­ç«‹æ¡ˆä¾‹
- [ ] åˆ†æå„€è¡¨æ¿è·Ÿè¸ªåé¥‹ç‡å’Œè³ªé‡

---

### **US-F5-004: å­¸ç¿’åˆ†æå’Œæ•ˆæœè·Ÿè¸ª**

**å„ªå…ˆç´š**: P2 (å¾ˆå¥½æ“æœ‰)  
**é ä¼°é–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç”¢å“ç¶“ç† (David Chen)
- **æˆ‘æƒ³è¦** æŸ¥çœ‹é¡¯ç¤ºå­¸ç¿’æ•ˆæœçš„åˆ†æ (æº–ç¢ºæ€§æ”¹é€²ï¼Œæ¡ˆä¾‹é‡ç”¨ç‡ï¼Œæˆæœ¬ç¯€çœ)
- **ä»¥ä¾¿** æˆ‘å¯ä»¥è¡¡é‡å­¸ç¿’ç³»çµ±çš„ ROI ä¸¦è­˜åˆ¥å—ç›Šæœ€å¤šçš„ Agent

**é©—æ”¶æ¨™æº–**:
1. âœ… **æº–ç¢ºæ€§è·Ÿè¸ª**: æ¯”è¼ƒæœ‰å­¸ç¿’èˆ‡ç„¡å­¸ç¿’çš„ Agent æº–ç¢ºæ€§
2. âœ… **æ¡ˆä¾‹é‡ç”¨ç‡**: è·Ÿè¸ªæ¯å€‹æ¡ˆä¾‹åœ¨å°‘æ¨£æœ¬æç¤ºä¸­ä½¿ç”¨çš„é »ç‡
3. âœ… **æˆæœ¬ç¯€çœ**: è¨ˆç®—å¾æ›´å°‘é‡è©¦ä¸­ç¯€çœçš„ OpenAI æˆæœ¬
4. âœ… **Agent æ¯”è¼ƒ**: è­˜åˆ¥å“ªäº› Agent å¾å­¸ç¿’ä¸­å—ç›Šæœ€å¤š
5. âœ… **è¶¨å‹¢åˆ†æ**: é¡¯ç¤ºéš¨æ™‚é–“ (æ¯é€±/æ¯æœˆ) çš„æº–ç¢ºæ€§æ”¹é€²
6. âœ… **å°å‡º**: å°‡åˆ†æä¸‹è¼‰ç‚º CSV/PDF

**åˆ†ææŒ‡æ¨™**:

```json
{
  "agent_id": "CS.RefundDecision",
  "period": "2025-11-01 to 2025-11-30",
  "metrics": {
    "accuracy": {
      "without_learning": 0.70,
      "with_learning": 0.85,
      "improvement": 0.15,
      "improvement_percentage": 21.4
    },
    "case_stats": {
      "total_cases": 234,
      "good_cases": 67,
      "bad_cases": 22,
      "neutral_cases": 145,
      "avg_similarity_score": 0.82
    },
    "reuse_stats": {
      "total_executions": 1247,
      "executions_with_learning": 1089,
      "learning_usage_rate": 0.87,
      "avg_cases_per_execution": 2.8,
      "total_case_reuses": 3049
    },
    "cost_savings": {
      "avg_retry_count_without_learning": 1.8,
      "avg_retry_count_with_learning": 0.4,
      "retry_reduction": 1.4,
      "cost_per_execution_usd": 0.05,
      "monthly_savings_usd": 87.29
    },
    "performance": {
      "avg_vector_search_time_ms": 145,
      "p95_vector_search_time_ms": 198,
      "prompt_token_increase": 456  // å°‘æ¨£æœ¬ç¤ºä¾‹æ·»åŠ çš„ token
    }
  }
}
```

**è¶¨å‹¢åœ– (éš¨æ™‚é–“çš„æº–ç¢ºæ€§)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent æº–ç¢ºæ€§è¶¨å‹¢: CS.RefundDecision                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ 100%â”‚                                              â—â”€â”€â—      â”‚
â”‚     â”‚                                         â—â”€â”€â”€â—           â”‚
â”‚  90%â”‚                                    â—â”€â”€â”€â—                â”‚
â”‚     â”‚                               â—â”€â”€â”€â—                     â”‚
â”‚  80%â”‚                          â—â”€â”€â”€â—                          â”‚
â”‚     â”‚                     â—â”€â”€â”€â—                               â”‚
â”‚  70%â”‚ â—â”€â”€â—â”€â”€â—â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â—  (åœ¨æ­¤è™•å•Ÿç”¨å­¸ç¿’)                  â”‚
â”‚     â”‚                    â†‘                                    â”‚
â”‚  60%â”‚                    ç¬¬ 2 é€±                              â”‚
â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€            â”‚
â”‚         W1   W2   W3   W4   W5   W6   W7   W8                â”‚
â”‚                                                              â”‚
â”‚ â— ç„¡å­¸ç¿’ (åŸºç·š: 70%)                                        â”‚
â”‚ â— æœ‰å­¸ç¿’ (ç•¶å‰: 85%, +15% æ”¹é€²)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæˆå®šç¾©**:
- [ ] åˆ†æ API è¿”å›æº–ç¢ºæ€§ã€é‡ç”¨ç‡ã€æˆæœ¬ç¯€çœ
- [ ] å„€è¡¨æ¿é¡¯ç¤ºè¶¨å‹¢åœ– (éš¨æ™‚é–“çš„æº–ç¢ºæ€§)
- [ ] Agent æ¯”è¼ƒè¡¨é¡¯ç¤ºå“ªäº› Agent å—ç›Šæœ€å¤š
- [ ] å°‡åˆ†æå°å‡ºç‚º CSV/PDF
- [ ] æ¯é€±å‘åˆ©ç›Šç›¸é—œè€…ç™¼é€è¨ˆåŠƒå ±å‘Š

---

## 5.3 æŠ€è¡“å¯¦ç¾ (è©³ç´°)

### 5.3.1 å‘é‡æ•¸æ“šåº«è¨­ç½® (Pinecone)

```python
import pinecone
from pinecone import Pinecone

# åˆå§‹åŒ– Pinecone å®¢æˆ¶ç«¯
pc = Pinecone(api_key="your-api-key")

# ç‚ºå­¸ç¿’æ¡ˆä¾‹å‰µå»ºç´¢å¼•
index_name = "learning-cases"
if index_name not in pc.list_indexes().names():
    pc.create_index(
        name=index_name,
        dimension=1536,  # OpenAI ada-002 åµŒå…¥å¤§å°
        metric="cosine",  # ä½™å¼¦ç›¸ä¼¼åº¦
        spec={
            "pod": {
                "environment": "us-east-1",
                "pod_type": "p1.x1"
            }
        }
    )

index = pc.Index(index_name)

# æ’å…¥å­¸ç¿’æ¡ˆä¾‹
index.upsert(
    vectors=[
        {
            "id": "case_a1b2c3d4e5f6",
            "values": embedding_vector,  # 1536 ç¶­åˆ—è¡¨
            "metadata": {
                "agent_id": "CS.RefundDecision",
                "input": {...},
                "output": {...},
                "timestamp": "2025-11-18T10:30:00Z",
                "feedback": None
            }
        }
    ]
)

# æŸ¥è©¢ç›¸ä¼¼æ¡ˆä¾‹
results = index.query(
    vector=query_embedding,
    top_k=3,
    filter={"agent_id": "CS.RefundDecision"},
    include_metadata=True
)
```

---

## 5.4 æ•¸æ“šåº«æ¶æ§‹

```sql
CREATE TABLE learning_cases (
    id SERIAL PRIMARY KEY,
    case_id VARCHAR(50) UNIQUE NOT NULL,
    agent_id VARCHAR(100) NOT NULL,
    execution_id VARCHAR(100),
    
    -- æ¡ˆä¾‹æ•¸æ“š (å·²åŒ¿ååŒ–)
    input_data JSONB NOT NULL,
    output_data JSONB NOT NULL,
    
    -- åµŒå…¥
    embedding_vector VECTOR(1536),  -- pgvector æ“´å±•
    
    -- å…ƒæ•¸æ“š
    similarity_score FLOAT,
    reuse_count INTEGER DEFAULT 0,
    
    -- åé¥‹
    feedback_rating VARCHAR(20),  -- good | bad | neutral
    feedback_notes TEXT,
    feedback_by VARCHAR(100),
    feedback_at TIMESTAMP,
    
    -- æ™‚é–“æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    archived_at TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_learning_agent ON learning_cases(agent_id, created_at DESC);
CREATE INDEX idx_learning_feedback ON learning_cases(feedback_rating);
CREATE INDEX idx_learning_reuse ON learning_cases(reuse_count DESC);

-- å‘é‡ç›¸ä¼¼æ€§æœç´¢ (éœ€è¦ pgvector æ“´å±•)
CREATE INDEX idx_learning_embedding ON learning_cases USING ivfflat (embedding_vector vector_cosine_ops);
```

---

## 5.5 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|---------|---------|---------|---------|
| **æ€§èƒ½** | å‘é‡æœç´¢å»¶é² | P95 < 200ms | APM ç›£æ§ |
| | åµŒå…¥ç”Ÿæˆ | < 500ms | OpenAI API æ—¥èªŒ |
| | æ¡ˆä¾‹è¨˜éŒ„ | < 1 ç§’ (ç•°æ­¥) | å¾Œå°ä½œæ¥­ç›£æ§ |
| **å¯æ“´å±•æ€§** | ç¸½æ¡ˆä¾‹æ•¸ | æ¯å€‹ Agent æ”¯æŒ 100K+ æ¡ˆä¾‹ | å‘é‡æ•¸æ“šåº«å®¹é‡ |
| | ä¸¦ç™¼æŸ¥è©¢ | æ¯ç§’ 500+ | è² è¼‰æ¸¬è©¦ |
| **è³ªé‡** | æº–ç¢ºæ€§æ”¹é€² | 1 å€‹æœˆå¾Œ +10-20% | A/B æ¸¬è©¦ |
| | æ¡ˆä¾‹é‡ç”¨ç‡ | â‰¥60% åŸ·è¡Œä½¿ç”¨å­¸ç¿’ | åˆ†æ |
| | ç›¸ä¼¼åº¦é–¾å€¼ | â‰¥0.75 ç”¨æ–¼æœ‰ç”¨æ¡ˆä¾‹ | èª¿æ•´ |
| **éš±ç§** | PII åŒ¿ååŒ– | 100% æ•æ„Ÿæ•¸æ“šç·¨è¼¯ | è‡ªå‹•åŒ–æ¸¬è©¦ |
| | æ•¸æ“šä¿ç•™ | 1 å¹´å¾Œæ­¸æª”æ¡ˆä¾‹ | TTL ç­–ç•¥ |
| **æˆæœ¬** | å‘é‡æ•¸æ“šåº«æˆæœ¬ | 100K æ¡ˆä¾‹ <$200/æœˆ | Pinecone è¨ˆè²» |
| | åµŒå…¥æˆæœ¬ | <$50/æœˆ (1M æŸ¥è©¢) | OpenAI è¨ˆè²» |

---

## 5.6 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:
- PII åŒ¿ååŒ– (é›»å­éƒµä»¶ã€é›»è©±ã€å§“å)
- å‘é‡åµŒå…¥ç”Ÿæˆ
- ç›¸ä¼¼åº¦åˆ†æ•¸è¨ˆç®—
- åé¥‹è©•ç´šå­˜å„²

**é›†æˆæ¸¬è©¦**:
- ç«¯åˆ°ç«¯æ¡ˆä¾‹è¨˜éŒ„æµç¨‹
- å°‘æ¨£æœ¬æç¤ºå¢å¼·
- å¸¶éæ¿¾çš„å‘é‡æœç´¢
- åé¥‹å¾ªç’° (æäº¤ + æª¢ç´¢)

**A/B æ¸¬è©¦**:
- A çµ„: ç„¡å­¸ç¿’çš„ Agent (åŸºç·š)
- B çµ„: æœ‰å­¸ç¿’çš„ Agent (è™•ç†)
- æ¸¬é‡: æº–ç¢ºæ€§ã€é‡è©¦æ¬¡æ•¸ã€æ¯æ¬¡åŸ·è¡Œæˆæœ¬

---

## 5.7 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£ç­–ç•¥** |
|---------|---------|---------|-------------|
| ä½è³ªé‡æ¡ˆä¾‹é™ä½æ€§èƒ½ | ä¸­ | é«˜ | äººå·¥åé¥‹å¾ªç’°ï¼Œå£æ¡ˆä¾‹éæ¿¾ï¼Œç›¸ä¼¼åº¦é–¾å€¼ |
| å­¸ç¿’æ¡ˆä¾‹ä¸­çš„ PII æ´©æ¼ | ä½ | é—œéµ | è‡ªå‹•åŒ– PII åŒ¿ååŒ–ï¼Œå®šæœŸå¯©è¨ˆï¼Œéœæ…‹åŠ å¯† |
| å‘é‡æ•¸æ“šåº«æˆæœ¬çˆ†ç‚¸ | ä¸­ | ä¸­ | TTL ç­–ç•¥ (1 å¹´æ­¸æª”)ï¼Œæ¡ˆä¾‹å»é‡ï¼Œä½¿ç”¨ç›£æ§ |
| LLM ä¸Šä¸‹æ–‡çª—å£æº¢å‡º | ä½ | ä¸­ | é™åˆ¶å°‘æ¨£æœ¬ç¤ºä¾‹ç‚ºå‰ 3 å€‹ï¼Œtoken é ç®—ç›£æ§ |
| ä¸å¹³è¡¡æ•¸æ“šçš„å­¸ç¿’åå·® | ä¸­ | ä¸­ | å¹³è¡¡æ¡æ¨£ï¼Œå¤šæ¨£æ€§è©•åˆ†ï¼Œå®šæœŸé‡æ–°è¨“ç·´ |

---

## 5.8 æœªä¾†å¢å¼· (Post-MVP)

1. **ä¸»å‹•å­¸ç¿’**: ç³»çµ±å»ºè­°å“ªäº›æ¡ˆä¾‹éœ€è¦äººå·¥å¯©æŸ¥
2. **å¤š Agent å­¸ç¿’**: åœ¨ç›¸é—œ Agent ä¹‹é–“å…±äº«æ¡ˆä¾‹ (ä¾‹å¦‚: CS â†” éŠ·å”®)
3. **è² é¢ç¤ºä¾‹**: æ³¨å…¥ã€Œä¸æ‡‰è©²åšä»€éº¼ã€ç¤ºä¾‹ä»¥å½¢æˆå°æ¯”
4. **å‹•æ…‹ K èª¿æ•´**: æ ¹æ“š Agent è¤‡é›œæ€§è‡ªå‹•èª¿æ•´å‰ K å€‹
5. **å­¸ç¿’å¯è§£é‡‹æ€§**: é¡¯ç¤ºå“ªå€‹éå»æ¡ˆä¾‹å½±éŸ¿äº†ç•¶å‰æ±ºç­–
6. **è¯é‚¦å­¸ç¿’**: å¾å¤šå€‹éƒ¨ç½²ä¸­å­¸ç¿’è€Œä¸å…±äº«åŸå§‹æ•¸æ“š

---

**ä¸‹ä¸€å€‹åŠŸèƒ½**: [F6. Agent å¸‚å ´ â†’](./feature-06-marketplace.md)
