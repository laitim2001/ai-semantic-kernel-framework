# PRD é™„éŒ„ B: Features 8-14 è©³ç´°è¦ç¯„

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-11-19  
**ç‹€æ…‹**: è‰ç¨¿

---

## ğŸ“‘ æ–‡æª”å°èˆª

- [PRD ä¸»æ–‡æª”](./prd-main.md)
- [PRD é™„éŒ„ A: Features 1-7](./prd-appendix-a-features-1-7.md)
- **[PRD é™„éŒ„ B: Features 8-14](./prd-appendix-b-features-8-14.md)** â† æ‚¨åœ¨é€™è£¡
- [PRD é™„éŒ„ C: API è¦ç¯„](./prd-appendix-c-api-specs.md)

---

## ç›®éŒ„

- [F8. n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†](#f8-n8n-triggering-error-handling)
- [F9. æç¤ºç®¡ç†ï¼ˆYAML æ¨¡æ¿ï¼‰](#f9-prompt-management)
- [F10. å¯©è¨ˆè¿½è¹¤ï¼ˆè¿½åŠ å¼æ—¥èªŒï¼‰](#f10-audit-trail)
- [F11. Teams é€šçŸ¥](#f11-teams-notification)
- [F12. ç›£æ§å„€è¡¨æ¿](#f12-monitoring-dashboard)
- [F13. ç¾ä»£ Web UI](#f13-modern-web-ui)
- [F14. Redis ç·©å­˜](#f14-redis-caching)

---

## é™„éŒ„ B æ¦‚è¿°

æœ¬é™„éŒ„åŒ…å« **Features 8-14** çš„è©³ç´°æŠ€è¡“è¦ç¯„ï¼Œæ¶µè“‹å¹³å°çš„**å¯é æ€§ã€å¯è§€å¯Ÿæ€§ã€UI/UX å’Œæ€§èƒ½**å±¤ã€‚é€™äº›åŠŸèƒ½æ˜¯ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²çš„åŸºç¤è¨­æ–½ï¼Œç¢ºä¿ç³»çµ±ç©©å®šã€å¯ç›£æ§ä¸”é«˜æ€§èƒ½ã€‚

### åŠŸèƒ½åˆ†é¡

| é¡åˆ¥ | åŠŸèƒ½ | å„ªå…ˆç´š | é–‹ç™¼æ™‚é–“ |
|------|------|--------|----------|
| **å¯é æ€§** | F8. n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç† | P0 | 2 é€± |
| **å¯é æ€§** | F9. æç¤ºç®¡ç†ï¼ˆYAML æ¨¡æ¿ï¼‰| P0 | 1 é€± |
| **å¯è§€å¯Ÿæ€§** | F10. å¯©è¨ˆè¿½è¹¤ | P0 | 1 é€± |
| **å¯è§€å¯Ÿæ€§** | F11. Teams é€šçŸ¥ | P0 | 1 é€± |
| **å¯è§€å¯Ÿæ€§** | F12. ç›£æ§å„€è¡¨æ¿ | P0 | 2 é€± |
| **UI/UX** | F13. ç¾ä»£ Web UI | P0 | 4 é€± |
| **æ€§èƒ½** | F14. Redis ç·©å­˜ | P0 | 1 é€± |

**ç¸½é–‹ç™¼æ™‚é–“**: 12 é€±ï¼ˆåŸå§‹ï¼‰ | **ä¸¦è¡ŒåŒ–å¾Œ**: 6-7 é€±

### èˆ‡é™„éŒ„ A çš„é—œä¿‚

```
é™„éŒ„ A (Features 1-7)          é™„éŒ„ B (Features 8-14)
æ ¸å¿ƒæ¥­å‹™é‚è¼¯å±¤                  åŸºç¤è¨­æ–½å±¤
â”œâ”€ F1-F3: æ ¸å¿ƒå¼•æ“       â†’     ä¾è³´ F8 è§¸ç™¼ã€F14 ç·©å­˜
â”œâ”€ F4-F5: å‰µæ–°åŠŸèƒ½       â†’     ä¾è³´ F10 å¯©è¨ˆã€F11 é€šçŸ¥
â””â”€ F6-F7: é–‹ç™¼è€…é«”é©—     â†’     ä¾è³´ F13 UIã€F12 ç›£æ§
```

---

<a id="f8-n8n-triggering-error-handling"></a>
## F8. n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†

**åˆ†é¡**: å¯é æ€§  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰ - è§¸ç™¼æ©Ÿåˆ¶)  
**é–‹ç™¼æ™‚é–“**: 2 é€±  
**è¤‡é›œåº¦**: â­â­â­â­ (é«˜)  
**ä¾è³´é …**: n8n (self-hosted), RabbitMQ/Azure Service Bus, PostgreSQL  
**é¢¨éšªç­‰ç´š**: ä¸­ç­‰ï¼ˆn8n æ•´åˆè¤‡é›œåº¦ã€éŒ¯èª¤è™•ç†ç­–ç•¥ï¼‰

---

### 8.1 åŠŸèƒ½æ¦‚è¿°

**ä»€éº¼æ˜¯ n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†ï¼Ÿ**

n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†æ˜¯å¹³å°çš„**äº‹ä»¶é©…å‹•å…¥å£å±¤**ï¼Œè² è²¬ï¼š
1. **å®šæ™‚è§¸ç™¼**ï¼ˆCronï¼‰ï¼šæŒ‰è¨ˆåŠƒåŸ·è¡Œå·¥ä½œæµï¼ˆä¾‹å¦‚æ¯å°æ™‚æª¢æŸ¥æœå‹™å™¨å¥åº·ç‹€æ³ï¼‰
2. **äº‹ä»¶è§¸ç™¼**ï¼ˆWebhookï¼‰ï¼šéŸ¿æ‡‰å¤–éƒ¨äº‹ä»¶ï¼ˆä¾‹å¦‚ ServiceNow æ–°å·¥å–®ã€Teams æ¶ˆæ¯ï¼‰
3. **éŒ¯èª¤è™•ç†**ï¼šé‡è©¦é‚è¼¯ã€æ­»ä¿¡éšŠåˆ—ï¼ˆDLQï¼‰ã€å„ªé›…é™ç´š

**ç‚ºä»€éº¼é€™å¾ˆé‡è¦**ï¼š
- **æ¥­å‹™é€£çºŒæ€§**: è‡ªå‹•åŒ–å·¥ä½œæµéœ€è¦å¯é çš„è§¸ç™¼æ©Ÿåˆ¶ï¼ˆä¸èƒ½éºæ¼äº‹ä»¶ï¼‰
- **å®¹éŒ¯æ€§**: å¤–éƒ¨ API å¯èƒ½å¤±æ•—ï¼ˆServiceNow è¶…æ™‚ã€LLM é™æµï¼‰ï¼Œéœ€è¦æ™ºèƒ½é‡è©¦
- **å¯è§€å¯Ÿæ€§**: éŒ¯èª¤æ‡‰è©²è¢«æ•ç²ã€è¨˜éŒ„ä¸¦é€šçŸ¥ç›¸é—œäººå“¡

**é—œéµèƒ½åŠ›**ï¼š
1. **Cron è§¸ç™¼å™¨**: å®šæ™‚åŸ·è¡Œå·¥ä½œæµï¼ˆæ”¯æŒæ¨™æº– Cron è¡¨é”å¼ï¼‰
2. **Webhook è§¸ç™¼å™¨**: HTTP POST æ¥æ”¶å¤–éƒ¨äº‹ä»¶
3. **æŒ‡æ•¸é€€é¿é‡è©¦**: æ™ºèƒ½é‡è©¦ç­–ç•¥ï¼ˆé¿å…é›ªå´©ï¼‰
4. **æ­»ä¿¡éšŠåˆ—ï¼ˆDLQï¼‰**: å¤šæ¬¡å¤±æ•—å¾Œå°‡æ¶ˆæ¯ç§»è‡³ DLQï¼Œæ‰‹å‹•å¹²é 
5. **éŒ¯èª¤é€šçŸ¥**: é—œéµéŒ¯èª¤é€šé Teams é€šçŸ¥ç®¡ç†å“¡
6. **å¹‚ç­‰æ€§ä¿è­‰**: åŒä¸€äº‹ä»¶ä¸æœƒé‡è¤‡åŸ·è¡Œ

**å•†æ¥­åƒ¹å€¼**ï¼š
- **å¯é æ€§**: 99.5%+ è§¸ç™¼æˆåŠŸç‡ï¼ˆå³ä½¿å¤–éƒ¨ç³»çµ±ä¸ç©©å®šï¼‰
- **æ¸›å°‘äººå·¥å¹²é **: 80% çš„éŒ¯èª¤è‡ªå‹•é‡è©¦æˆåŠŸ
- **å¿«é€Ÿæ¢å¾©**: å¹³å‡æ•…éšœæ¢å¾©æ™‚é–“ï¼ˆMTTRï¼‰< 15 åˆ†é˜
- **åˆè¦æ€§**: å®Œæ•´çš„äº‹ä»¶è¿½è¹¤ç”¨æ–¼å¯©è¨ˆ

**çœŸå¯¦ä¸–ç•Œç¤ºä¾‹**ï¼š

```
å ´æ™¯: ServiceNow æ–°å·¥å–®è‡ªå‹•è§¸ç™¼å®¢æœ Agent

ç„¡å®¹éŒ¯æ©Ÿåˆ¶ï¼ˆå‚³çµ±æ–¹å¼ï¼‰:
1. ServiceNow webhook èª¿ç”¨æˆ‘å€‘çš„ API
2. API èª¿ç”¨ LLM å¤±æ•—ï¼ˆé™æµ 429 éŒ¯èª¤ï¼‰
3. å·¥å–®è¢«éºæ¼ï¼Œæ²’æœ‰ Agent è™•ç†
4. å®¢æˆ¶æŠ•è¨´ï¼Œæ‰‹å‹•è£œæ•‘ï¼ˆ2 å°æ™‚å¾Œï¼‰
æˆåŠŸç‡: 60-70%ï¼ˆå¤–éƒ¨ API ä¸ç©©å®šæ™‚ï¼‰

ä½¿ç”¨ n8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†:
1. ServiceNow webhook â†’ n8n æ¥æ”¶äº‹ä»¶
2. n8n å°‡äº‹ä»¶æ”¾å…¥æ¶ˆæ¯éšŠåˆ—ï¼ˆRabbitMQï¼‰
3. Worker å¾éšŠåˆ—å–å‡ºäº‹ä»¶ï¼Œèª¿ç”¨ LLM
4. LLM é™æµ 429 â†’ è‡ªå‹•é‡è©¦ï¼ˆæŒ‡æ•¸é€€é¿: 1s, 2s, 4s, 8sï¼‰
5. ç¬¬ 3 æ¬¡é‡è©¦æˆåŠŸï¼Œå·¥å–®è¢«è™•ç†
6. å¦‚æœ 5 æ¬¡é‡è©¦å…¨å¤±æ•— â†’ ç§»è‡³ DLQï¼Œé€šçŸ¥ç®¡ç†å“¡
æˆåŠŸç‡: 95%+ï¼ˆå³ä½¿å¤–éƒ¨ API ä¸ç©©å®šï¼‰
```

**æ¶æ§‹æ¦‚è¦½**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨è§¸ç™¼æº          â”‚
â”‚  - ServiceNow       â”‚
â”‚  - Dynamics 365     â”‚
â”‚  - Microsoft Teams  â”‚
â”‚  - Cron Scheduler   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1. è§¸ç™¼äº‹ä»¶
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  æ¶ˆæ¯éšŠåˆ—        â”‚
â”‚  (è§¸ç™¼å±¤)           â”‚         â”‚  (RabbitMQ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚ 2. æ¶ˆè²»æ¶ˆæ¯
                                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Workflow Executor (Worker)    â”‚
                    â”‚  - é‡è©¦é‚è¼¯ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰        â”‚
                    â”‚  - å¹‚ç­‰æ€§æª¢æŸ¥                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æˆåŠŸ   â”‚ å¤±æ•—   â”‚
                    â–¼        â–¼        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚åŸ·è¡Œå®Œæˆ  â”‚  â”‚é‡è©¦éšŠåˆ—  â”‚  â”‚æ­»ä¿¡éšŠåˆ—  â”‚
         â”‚(çµæœå­˜å„²)â”‚  â”‚(è‡ªå‹•é‡è©¦)â”‚  â”‚(æ‰‹å‹•å¹²é )â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚Teams é€šçŸ¥    â”‚
                                    â”‚(F11)         â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8.2 ç”¨æˆ¶æ•…äº‹ï¼ˆå®Œæ•´ï¼‰

### **US-F8-001: é…ç½® Cron å®šæ™‚è§¸ç™¼å™¨**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆAlex Chenï¼‰
- **æˆ‘æƒ³è¦** é…ç½®å®šæ™‚è§¸ç™¼å™¨ï¼ŒæŒ‰è¨ˆåŠƒåŸ·è¡Œå·¥ä½œæµï¼ˆä¾‹å¦‚æ¯å°æ™‚æª¢æŸ¥æœå‹™å™¨ç‹€æ…‹ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¯¦ç¾é é˜²æ€§ç›£æ§ï¼Œè€Œä¸æ˜¯è¢«å‹•éŸ¿æ‡‰æ•…éšœ

**é©—æ”¶æ¨™æº–**:
1. âœ… **Cron è¡¨é”å¼æ”¯æŒ**: æ”¯æŒæ¨™æº– Cron èªæ³•ï¼ˆåˆ†é˜ã€å°æ™‚ã€å¤©ã€æœˆã€æ˜ŸæœŸï¼‰
2. âœ… **æ™‚å€æ”¯æŒ**: æ”¯æŒæŒ‡å®šæ™‚å€ï¼ˆé»˜èª UTCï¼‰
3. âœ… **å•Ÿç”¨/ç¦ç”¨**: å¯ä»¥è‡¨æ™‚ç¦ç”¨è§¸ç™¼å™¨è€Œä¸åˆªé™¤é…ç½®
4. âœ… **ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“**: UI é¡¯ç¤ºä¸‹æ¬¡è¨ˆåŠƒåŸ·è¡Œæ™‚é–“
5. âœ… **åŸ·è¡Œæ­·å²**: é¡¯ç¤ºæœ€è¿‘ 50 æ¬¡åŸ·è¡Œè¨˜éŒ„ï¼ˆæ™‚é–“ã€ç‹€æ…‹ã€æŒçºŒæ™‚é–“ï¼‰
6. âœ… **éŒ¯èª¤è™•ç†**: Cron åŸ·è¡Œå¤±æ•—ä¸å½±éŸ¿ä¸‹æ¬¡è¨ˆåŠƒåŸ·è¡Œ

**Cron é…ç½® UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œæµé…ç½®: server_health_check                                 [ä¿å­˜] [å–æ¶ˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ• è§¸ç™¼å™¨é…ç½®                                                                 â”‚
â”‚                                                                               â”‚
â”‚ è§¸ç™¼é¡å‹: *                                                                   â”‚
â”‚ [Cron (å®šæ™‚) â–¼]                                                              â”‚
â”‚   é¸é …: Cronã€Webhookã€æ‰‹å‹•                                                  â”‚
â”‚                                                                               â”‚
â”‚ Cron è¡¨é”å¼: *                                                                â”‚
â”‚ [0 * * * *                                          ] æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡          â”‚
â”‚                                                                               â”‚
â”‚ å¸¸ç”¨æ¨¡æ¿:                                                                     â”‚
â”‚ [æ¯ 5 åˆ†é˜] [æ¯å°æ™‚] [æ¯å¤©åˆå¤œ] [æ¯é€±ä¸€ä¸Šåˆ 9 é»] [è‡ªå®šç¾©]                  â”‚
â”‚                                                                               â”‚
â”‚ æ™‚å€:                                                                         â”‚
â”‚ [Asia/Taipei (UTC+8) â–¼]                                                      â”‚
â”‚                                                                               â”‚
â”‚ ç‹€æ…‹:                                                                         â”‚
â”‚ [â—] å·²å•Ÿç”¨  [ ] å·²ç¦ç”¨                                                       â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“… åŸ·è¡Œè¨ˆåŠƒ                                                                   â”‚
â”‚   ä¸‹æ¬¡åŸ·è¡Œ: 2025-11-19 15:00:00 (UTC+8)                                      â”‚
â”‚   ä¸‹ä¸‹æ¬¡åŸ·è¡Œ: 2025-11-19 16:00:00 (UTC+8)                                    â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“Š æœ€è¿‘åŸ·è¡Œè¨˜éŒ„                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ™‚é–“                    â”‚ ç‹€æ…‹    â”‚ æŒçºŒæ™‚é–“ â”‚ è©³æƒ…                      â”‚â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚ â”‚ 2025-11-19 14:00:00     â”‚ âœ… æˆåŠŸ â”‚ 2.3s     â”‚ 3 å€‹æœå‹™å™¨å¥åº·            â”‚â”‚
â”‚ â”‚ 2025-11-19 13:00:00     â”‚ âœ… æˆåŠŸ â”‚ 2.1s     â”‚ 3 å€‹æœå‹™å™¨å¥åº·            â”‚â”‚
â”‚ â”‚ 2025-11-19 12:00:00     â”‚ âŒ å¤±æ•— â”‚ 30.0s    â”‚ æœå‹™å™¨ DB-01 ç„¡éŸ¿æ‡‰       â”‚â”‚
â”‚ â”‚ 2025-11-19 11:00:00     â”‚ âœ… æˆåŠŸ â”‚ 2.4s     â”‚ 3 å€‹æœå‹™å™¨å¥åº·            â”‚â”‚
â”‚ â”‚ 2025-11-19 10:00:00     â”‚ âœ… æˆåŠŸ â”‚ 2.2s     â”‚ 3 å€‹æœå‹™å™¨å¥åº·            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [æŸ¥çœ‹å®Œæ•´æ­·å²]                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**n8n Cron ç¯€é»é…ç½®**:

```json
{
  "nodes": [
    {
      "type": "n8n-nodes-base.cron",
      "name": "Server Health Check Trigger",
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyHour"
            }
          ]
        },
        "timezone": "Asia/Taipei"
      },
      "position": [250, 300]
    },
    {
      "type": "n8n-nodes-base.httpRequest",
      "name": "Call IPA API",
      "parameters": {
        "url": "https://ipa.example.com/api/workflows/server_health_check/execute",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "position": [450, 300]
    }
  ],
  "connections": {
    "Server Health Check Trigger": {
      "main": [
        [
          {
            "node": "Call IPA API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
```

**API: ç²å– Cron åŸ·è¡Œæ­·å²**:

```bash
GET /api/workflows/{workflow_id}/cron-history?limit=50

éŸ¿æ‡‰:
{
  "workflow_id": "server_health_check",
  "trigger_type": "cron",
  "cron_expression": "0 * * * *",
  "timezone": "Asia/Taipei",
  "next_execution": "2025-11-19T15:00:00+08:00",
  "enabled": true,
  "history": [
    {
      "execution_id": "exec_abc123",
      "scheduled_at": "2025-11-19T14:00:00+08:00",
      "started_at": "2025-11-19T14:00:01+08:00",
      "completed_at": "2025-11-19T14:00:03+08:00",
      "status": "completed",
      "duration_ms": 2300,
      "result": "3 servers healthy"
    },
    {
      "execution_id": "exec_abc122",
      "scheduled_at": "2025-11-19T13:00:00+08:00",
      "started_at": "2025-11-19T13:00:01+08:00",
      "completed_at": "2025-11-19T13:00:03+08:00",
      "status": "completed",
      "duration_ms": 2100,
      "result": "3 servers healthy"
    }
  ]
}
```

**å®Œæˆå®šç¾©**:
- [ ] æ”¯æŒæ¨™æº– Cron è¡¨é”å¼ï¼ˆåˆ†é˜ã€å°æ™‚ã€å¤©ã€æœˆã€æ˜ŸæœŸï¼‰
- [ ] UI æä¾›å¸¸ç”¨æ¨¡æ¿ï¼ˆæ¯ 5 åˆ†é˜ã€æ¯å°æ™‚ã€æ¯å¤©ç­‰ï¼‰
- [ ] æ”¯æŒæ™‚å€é¸æ“‡ï¼ˆè‡³å°‘ 10 å€‹ä¸»è¦æ™‚å€ï¼‰
- [ ] é¡¯ç¤ºä¸‹æ¬¡åŸ·è¡Œæ™‚é–“å’ŒåŸ·è¡Œæ­·å²
- [ ] å¯ä»¥å•Ÿç”¨/ç¦ç”¨è§¸ç™¼å™¨
- [ ] n8n Cron ç¯€é»é…ç½®ä¸¦æ¸¬è©¦
- [ ] API è¿”å›åŸ·è¡Œæ­·å²

---

### **US-F8-002: é…ç½® Webhook äº‹ä»¶è§¸ç™¼å™¨**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆAlex Chenï¼‰
- **æˆ‘æƒ³è¦** é…ç½® Webhook è§¸ç™¼å™¨ï¼ŒéŸ¿æ‡‰å¤–éƒ¨ç³»çµ±äº‹ä»¶ï¼ˆä¾‹å¦‚ ServiceNow æ–°å·¥å–®ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¯¦ç¾äº‹ä»¶é©…å‹•çš„è‡ªå‹•åŒ–ï¼Œè€Œä¸æ˜¯è¼ªè©¢

**é©—æ”¶æ¨™æº–**:
1. âœ… **å”¯ä¸€ Webhook URL**: æ¯å€‹å·¥ä½œæµç”Ÿæˆå”¯ä¸€çš„ Webhook URL
2. âœ… **å®‰å…¨é©—è­‰**: æ”¯æŒç°½åé©—è­‰ï¼ˆHMAC-SHA256ï¼‰æˆ– API Key
3. âœ… **è«‹æ±‚éæ¿¾**: å¯é¸çš„ JSON è·¯å¾‘éæ¿¾å™¨ï¼ˆåƒ…è™•ç†ç‰¹å®šäº‹ä»¶é¡å‹ï¼‰
4. âœ… **è«‹æ±‚æ—¥èªŒ**: è¨˜éŒ„æ‰€æœ‰ Webhook è«‹æ±‚ï¼ˆæˆåŠŸã€å¤±æ•—ã€éæ¿¾æ‰çš„ï¼‰
5. âœ… **æ¸¬è©¦å·¥å…·**: UI æä¾› Webhook æ¸¬è©¦å·¥å…·ï¼ˆç™¼é€æ¨¡æ“¬è«‹æ±‚ï¼‰
6. âœ… **å¹‚ç­‰æ€§**: åŒä¸€äº‹ä»¶ï¼ˆåŸºæ–¼ `idempotency_key`ï¼‰ä¸æœƒé‡è¤‡åŸ·è¡Œ

**Webhook é…ç½® UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œæµé…ç½®: servicenow_ticket_automation                        [ä¿å­˜] [å–æ¶ˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ”— Webhook è§¸ç™¼å™¨é…ç½®                                                         â”‚
â”‚                                                                               â”‚
â”‚ Webhook URL: (åªè®€)                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ https://ipa.example.com/webhooks/wh_abc123xyz                           â”‚ â”‚
â”‚ â”‚ [ğŸ“‹ è¤‡è£½]                                                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ” å®‰å…¨è¨­ç½®                                                                   â”‚
â”‚                                                                               â”‚
â”‚ é©—è­‰æ–¹å¼:                                                                     â”‚
â”‚ [â—] HMAC-SHA256 ç°½å  [ ] API Key  [ ] ç„¡ï¼ˆä¸æ¨è–¦ï¼‰                         â”‚
â”‚                                                                               â”‚
â”‚ Secret Key: (éš±è—)                                                            â”‚
â”‚ [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] [é‡æ–°ç”Ÿæˆ]                                â”‚
â”‚                                                                               â”‚
â”‚ ç°½åæ¨™é ­åç¨±:                                                                 â”‚
â”‚ [X-ServiceNow-Signature        ]                                             â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ¯ è«‹æ±‚éæ¿¾å™¨ï¼ˆå¯é¸ï¼‰                                                         â”‚
â”‚                                                                               â”‚
â”‚ åƒ…è™•ç†åŒ¹é…ä»¥ä¸‹æ¢ä»¶çš„è«‹æ±‚:                                                     â”‚
â”‚                                                                               â”‚
â”‚ JSON è·¯å¾‘: [$.event_type                           ]                         â”‚
â”‚ é‹ç®—ç¬¦:     [ç­‰æ–¼ â–¼                                ]                         â”‚
â”‚ å€¼:         [incident.created                      ]                         â”‚
â”‚                                                                               â”‚
â”‚ [+ æ·»åŠ æ¢ä»¶]                                                                  â”‚
â”‚                                                                               â”‚
â”‚ ç¤ºä¾‹: åƒ…è™•ç† ServiceNow æ–°å·¥å–®äº‹ä»¶ï¼Œå¿½ç•¥æ›´æ–°å’Œé—œé–‰äº‹ä»¶                       â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ§ª æ¸¬è©¦ Webhook                                                               â”‚
â”‚                                                                               â”‚
â”‚ è«‹æ±‚é«” (JSON):                                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ {                                                                        â”‚ â”‚
â”‚ â”‚   "event_type": "incident.created",                                      â”‚ â”‚
â”‚ â”‚   "incident_id": "INC0012345",                                           â”‚ â”‚
â”‚ â”‚   "priority": "2",                                                       â”‚ â”‚
â”‚ â”‚   "description": "Server DB-01 is not responding"                        â”‚ â”‚
â”‚ â”‚ }                                                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [ğŸš€ ç™¼é€æ¸¬è©¦è«‹æ±‚]                                                             â”‚
â”‚                                                                               â”‚
â”‚ æ¸¬è©¦çµæœ:                                                                     â”‚
â”‚ âœ… Webhook å·²è§¸ç™¼ï¼Œå·¥ä½œæµåŸ·è¡Œ ID: exec_test_001                               â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“Š æœ€è¿‘ Webhook è«‹æ±‚                                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ™‚é–“                    â”‚ ä¾†æº IP      â”‚ ç‹€æ…‹    â”‚ åŸ·è¡Œ ID          â”‚â”‚    â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚    â”‚
â”‚ â”‚ 2025-11-19 14:23:15     â”‚ 10.0.1.45    â”‚ âœ… å·²è§¸ç™¼â”‚ exec_abc125      â”‚â”‚    â”‚
â”‚ â”‚ 2025-11-19 14:15:03     â”‚ 10.0.1.45    â”‚ âœ… å·²è§¸ç™¼â”‚ exec_abc124      â”‚â”‚    â”‚
â”‚ â”‚ 2025-11-19 14:10:22     â”‚ 10.0.1.45    â”‚ âŠ˜ å·²éæ¿¾ â”‚ (æ›´æ–°äº‹ä»¶)       â”‚â”‚    â”‚
â”‚ â”‚ 2025-11-19 14:05:11     â”‚ 203.0.113.5  â”‚ âŒ é©—è­‰å¤±æ•—â”‚ (ç„¡æ•ˆç°½å)     â”‚â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [æŸ¥çœ‹å®Œæ•´æ—¥èªŒ]                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ServiceNow Webhook é…ç½®ç¤ºä¾‹**:

```javascript
// ServiceNow Business Rule: æ–°å·¥å–®æ™‚ç™¼é€ Webhook

(function executeRule(current, previous /*null when async*/) {
    var request = new sn_ws.RESTMessageV2();
    request.setEndpoint('https://ipa.example.com/webhooks/wh_abc123xyz');
    request.setHttpMethod('POST');
    
    // è¨ˆç®— HMAC-SHA256 ç°½å
    var secret = 'your_webhook_secret_key';
    var payload = JSON.stringify({
        event_type: 'incident.created',
        incident_id: current.number.toString(),
        priority: current.priority.toString(),
        description: current.short_description.toString(),
        assigned_to: current.assigned_to.getDisplayValue(),
        created_at: current.sys_created_on.toString()
    });
    
    var signature = new GlideDigest().getMacB64('HmacSHA256', secret, payload);
    
    request.setRequestHeader('Content-Type', 'application/json');
    request.setRequestHeader('X-ServiceNow-Signature', 'sha256=' + signature);
    request.setRequestBody(payload);
    
    var response = request.execute();
    gs.info('Webhook sent to IPA: ' + response.getStatusCode());
    
})(current, previous);
```

**Webhook è™•ç†ç«¯é»å¯¦ç¾**:

```python
from fastapi import APIRouter, Request, HTTPException, Header
import hmac
import hashlib
import json
from typing import Optional

router = APIRouter()

@router.post("/webhooks/{webhook_id}")
async def handle_webhook(
    webhook_id: str,
    request: Request,
    x_servicenow_signature: Optional[str] = Header(None)
):
    """
    è™•ç† Webhook è«‹æ±‚
    
    1. é©—è­‰ç°½å
    2. æª¢æŸ¥å¹‚ç­‰æ€§
    3. æ‡‰ç”¨éæ¿¾å™¨
    4. è§¸ç™¼å·¥ä½œæµåŸ·è¡Œ
    """
    # 1. åŠ è¼‰ Webhook é…ç½®
    webhook_config = await load_webhook_config(webhook_id)
    
    if not webhook_config:
        raise HTTPException(status_code=404, detail="Webhook not found")
    
    # 2. è®€å–è«‹æ±‚é«”
    body = await request.body()
    payload = json.loads(body)
    
    # 3. é©—è­‰ç°½åï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    if webhook_config["authentication"] == "hmac":
        if not x_servicenow_signature:
            raise HTTPException(status_code=401, detail="Missing signature")
        
        expected_signature = "sha256=" + hmac.new(
            webhook_config["secret"].encode(),
            body,
            hashlib.sha256
        ).hexdigest()
        
        if not hmac.compare_digest(x_servicenow_signature, expected_signature):
            # è¨˜éŒ„é©—è­‰å¤±æ•—
            await log_webhook_request(
                webhook_id=webhook_id,
                status="auth_failed",
                source_ip=request.client.host,
                payload=payload
            )
            raise HTTPException(status_code=401, detail="Invalid signature")
    
    # 4. æª¢æŸ¥å¹‚ç­‰æ€§
    idempotency_key = payload.get("idempotency_key") or payload.get("incident_id")
    if idempotency_key:
        existing_execution = await check_idempotency(webhook_id, idempotency_key)
        if existing_execution:
            # è¿”å›å·²æœ‰çš„åŸ·è¡Œ IDï¼ˆé¿å…é‡è¤‡åŸ·è¡Œï¼‰
            return {
                "status": "already_processed",
                "execution_id": existing_execution.execution_id,
                "message": "This event has already been processed"
            }
    
    # 5. æ‡‰ç”¨éæ¿¾å™¨ï¼ˆå¦‚æœé…ç½®ï¼‰
    if webhook_config.get("filters"):
        if not apply_filters(payload, webhook_config["filters"]):
            # è¨˜éŒ„éæ¿¾æ‰çš„è«‹æ±‚
            await log_webhook_request(
                webhook_id=webhook_id,
                status="filtered",
                source_ip=request.client.host,
                payload=payload
            )
            return {
                "status": "filtered",
                "message": "Request did not match filter criteria"
            }
    
    # 6. è§¸ç™¼å·¥ä½œæµåŸ·è¡Œ
    execution_id = await trigger_workflow_execution(
        workflow_id=webhook_config["workflow_id"],
        trigger_type="webhook",
        trigger_data=payload,
        idempotency_key=idempotency_key
    )
    
    # 7. è¨˜éŒ„æˆåŠŸçš„ Webhook è«‹æ±‚
    await log_webhook_request(
        webhook_id=webhook_id,
        status="triggered",
        source_ip=request.client.host,
        payload=payload,
        execution_id=execution_id
    )
    
    return {
        "status": "triggered",
        "execution_id": execution_id,
        "message": "Workflow execution started"
    }


async def apply_filters(payload: dict, filters: list) -> bool:
    """æ‡‰ç”¨ JSON è·¯å¾‘éæ¿¾å™¨"""
    for filter_rule in filters:
        json_path = filter_rule["json_path"]  # $.event_type
        operator = filter_rule["operator"]  # "equals"
        expected_value = filter_rule["value"]  # "incident.created"
        
        # ä½¿ç”¨ JSONPath æå–å€¼
        import jsonpath_ng
        jsonpath_expr = jsonpath_ng.parse(json_path)
        matches = jsonpath_expr.find(payload)
        
        if not matches:
            return False
        
        actual_value = matches[0].value
        
        if operator == "equals" and actual_value != expected_value:
            return False
        elif operator == "not_equals" and actual_value == expected_value:
            return False
        elif operator == "contains" and expected_value not in str(actual_value):
            return False
    
    return True
```

**å®Œæˆå®šç¾©**:
- [ ] æ¯å€‹å·¥ä½œæµç”Ÿæˆå”¯ä¸€çš„ Webhook URL
- [ ] æ”¯æŒ HMAC-SHA256 ç°½åé©—è­‰
- [ ] æ”¯æŒ JSON è·¯å¾‘éæ¿¾å™¨ï¼ˆåƒ…è™•ç†ç‰¹å®šäº‹ä»¶ï¼‰
- [ ] è¨˜éŒ„æ‰€æœ‰ Webhook è«‹æ±‚ï¼ˆæˆåŠŸã€å¤±æ•—ã€éæ¿¾ï¼‰
- [ ] UI æä¾› Webhook æ¸¬è©¦å·¥å…·
- [ ] å¹‚ç­‰æ€§æª¢æŸ¥ï¼ˆåŸºæ–¼ idempotency_keyï¼‰
- [ ] é›†æˆæ¸¬è©¦ï¼ˆæ¨¡æ“¬ ServiceNow Webhookï¼‰

---

### **US-F8-003: æ™ºèƒ½éŒ¯èª¤è™•ç†èˆ‡æŒ‡æ•¸é€€é¿é‡è©¦**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 4 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆAlex Chenï¼‰
- **æˆ‘æƒ³è¦** ç³»çµ±è‡ªå‹•é‡è©¦å¤±æ•—çš„å·¥ä½œæµåŸ·è¡Œï¼Œä½¿ç”¨æ™ºèƒ½é€€é¿ç­–ç•¥
- **ä»¥ä¾¿** æˆ‘å¯ä»¥è™•ç†æš«æ™‚æ€§æ•…éšœï¼ˆç¶²çµ¡æŠ–å‹•ã€API é™æµï¼‰ï¼Œè€Œä¸éœ€è¦æ‰‹å‹•å¹²é 

**é©—æ”¶æ¨™æº–**:
1. âœ… **å¯é…ç½®é‡è©¦ç­–ç•¥**: æ”¯æŒé…ç½®æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼ˆ1-10ï¼‰ã€åˆå§‹å»¶é²ï¼ˆç§’ï¼‰
2. âœ… **æŒ‡æ•¸é€€é¿**: é‡è©¦å»¶é²æŒ‡æ•¸å¢é•·ï¼ˆ1s â†’ 2s â†’ 4s â†’ 8s â†’ 16sï¼‰
3. âœ… **æŠ–å‹•ï¼ˆJitterï¼‰**: æ·»åŠ éš¨æ©ŸæŠ–å‹•é¿å…é›·é³´ç¾¤æ•ˆæ‡‰ï¼ˆÂ±20% éš¨æ©Ÿå»¶é²ï¼‰
4. âœ… **éŒ¯èª¤åˆ†é¡**: å€åˆ†å¯é‡è©¦éŒ¯èª¤ï¼ˆ429, 503ï¼‰å’Œä¸å¯é‡è©¦éŒ¯èª¤ï¼ˆ400, 401ï¼‰
5. âœ… **é‡è©¦ç‹€æ…‹è¿½è¹¤**: UI é¡¯ç¤ºç•¶å‰é‡è©¦æ¬¡æ•¸å’Œä¸‹æ¬¡é‡è©¦æ™‚é–“
6. âœ… **é‡è©¦æ—¥èªŒ**: è¨˜éŒ„æ¯æ¬¡é‡è©¦çš„æ™‚é–“ã€éŒ¯èª¤ã€å»¶é²

**é‡è©¦ç­–ç•¥é…ç½® UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œæµé…ç½®: customer_360_view                                   [ä¿å­˜] [å–æ¶ˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ”„ éŒ¯èª¤è™•ç†èˆ‡é‡è©¦ç­–ç•¥                                                         â”‚
â”‚                                                                               â”‚
â”‚ å•Ÿç”¨è‡ªå‹•é‡è©¦:                                                                 â”‚
â”‚ [â—] æ˜¯  [ ] å¦                                                               â”‚
â”‚                                                                               â”‚
â”‚ æœ€å¤§é‡è©¦æ¬¡æ•¸:                                                                 â”‚
â”‚ [5                  ] (1-10 æ¬¡)                                              â”‚
â”‚                                                                               â”‚
â”‚ åˆå§‹é‡è©¦å»¶é²:                                                                 â”‚
â”‚ [2                  ] ç§’                                                     â”‚
â”‚                                                                               â”‚
â”‚ é€€é¿ç­–ç•¥:                                                                     â”‚
â”‚ [â—] æŒ‡æ•¸é€€é¿ (1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s)                                       â”‚
â”‚ [ ] å›ºå®šå»¶é² (æ¯æ¬¡ç›¸åŒ)                                                      â”‚
â”‚ [ ] ç·šæ€§å¢é•· (1s â†’ 2s â†’ 3s â†’ 4s â†’ 5s)                                       â”‚
â”‚                                                                               â”‚
â”‚ æ·»åŠ éš¨æ©ŸæŠ–å‹•:                                                                 â”‚
â”‚ [â—] æ˜¯ (Â±20% éš¨æ©Ÿå»¶é²ï¼Œé¿å…é›·é³´ç¾¤)  [ ] å¦                                  â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ¯ å¯é‡è©¦éŒ¯èª¤é¡å‹                                                             â”‚
â”‚                                                                               â”‚
â”‚ HTTP ç‹€æ…‹ç¢¼:                                                                  â”‚
â”‚ â˜‘ 429 (Too Many Requests - é™æµ)                                             â”‚
â”‚ â˜‘ 500 (Internal Server Error)                                                â”‚
â”‚ â˜‘ 502 (Bad Gateway)                                                          â”‚
â”‚ â˜‘ 503 (Service Unavailable)                                                  â”‚
â”‚ â˜‘ 504 (Gateway Timeout)                                                      â”‚
â”‚                                                                               â”‚
â”‚ ç¶²çµ¡éŒ¯èª¤:                                                                     â”‚
â”‚ â˜‘ é€£æ¥è¶…æ™‚ (Connection Timeout)                                              â”‚
â”‚ â˜‘ è®€å–è¶…æ™‚ (Read Timeout)                                                    â”‚
â”‚ â˜‘ é€£æ¥é‡ç½® (Connection Reset)                                                â”‚
â”‚                                                                               â”‚
â”‚ ä¸å¯é‡è©¦éŒ¯èª¤ï¼ˆè·³éé‡è©¦ï¼Œç›´æ¥å¤±æ•—ï¼‰:                                          â”‚
â”‚ â˜‘ 400 (Bad Request - è«‹æ±‚æ ¼å¼éŒ¯èª¤)                                           â”‚
â”‚ â˜‘ 401 (Unauthorized - èªè­‰å¤±æ•—)                                              â”‚
â”‚ â˜‘ 403 (Forbidden - æ¬Šé™ä¸è¶³)                                                 â”‚
â”‚ â˜‘ 404 (Not Found - è³‡æºä¸å­˜åœ¨)                                               â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“Š é‡è©¦æ¨¡æ“¬å™¨                                                                 â”‚
â”‚                                                                               â”‚
â”‚ é è¦½é‡è©¦æ™‚é–“ç·šï¼ˆæœ€å¤§ 5 æ¬¡é‡è©¦ï¼‰:                                             â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç¬¬ 1 æ¬¡é‡è©¦: 2s å¾Œ (ç¯„åœ: 1.6s - 2.4sï¼Œå«æŠ–å‹•)                           â”‚ â”‚
â”‚ â”‚ ç¬¬ 2 æ¬¡é‡è©¦: 4s å¾Œ (ç¯„åœ: 3.2s - 4.8s)                                   â”‚ â”‚
â”‚ â”‚ ç¬¬ 3 æ¬¡é‡è©¦: 8s å¾Œ (ç¯„åœ: 6.4s - 9.6s)                                   â”‚ â”‚
â”‚ â”‚ ç¬¬ 4 æ¬¡é‡è©¦: 16s å¾Œ (ç¯„åœ: 12.8s - 19.2s)                                â”‚ â”‚
â”‚ â”‚ ç¬¬ 5 æ¬¡é‡è©¦: 32s å¾Œ (ç¯„åœ: 25.6s - 38.4s)                                â”‚ â”‚
â”‚ â”‚                                                                          â”‚ â”‚
â”‚ â”‚ ç¸½é‡è©¦æ™‚é–“çª—å£: æœ€å¤š 62 ç§’                                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ” æœ€è¿‘é‡è©¦è¨˜éŒ„                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ åŸ·è¡Œ ID       â”‚ é‡è©¦æ¬¡æ•¸ â”‚ æœ€çµ‚ç‹€æ…‹ â”‚ éŒ¯èª¤é¡å‹           â”‚ ç¸½è€—æ™‚  â”‚â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚   â”‚
â”‚ â”‚ exec_abc125   â”‚ 3/5      â”‚ âœ… æˆåŠŸ  â”‚ 429 Rate Limit     â”‚ 14.2s   â”‚â”‚   â”‚
â”‚ â”‚ exec_abc124   â”‚ 1/5      â”‚ âœ… æˆåŠŸ  â”‚ 503 Unavailable    â”‚ 2.3s    â”‚â”‚   â”‚
â”‚ â”‚ exec_abc123   â”‚ 5/5      â”‚ âŒ å¤±æ•—  â”‚ 500 Internal Error â”‚ 62.0s   â”‚â”‚   â”‚
â”‚ â”‚ exec_abc122   â”‚ 0/5      â”‚ âœ… æˆåŠŸ  â”‚ (ç„¡éŒ¯èª¤)           â”‚ 1.2s    â”‚â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [æŸ¥çœ‹è©³ç´°é‡è©¦æ—¥èªŒ]                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡è©¦é‚è¼¯å¯¦ç¾**:

```python
import asyncio
import random
from typing import Optional, Callable, Any
from datetime import datetime, timedelta

class RetryPolicy:
    """é‡è©¦ç­–ç•¥é…ç½®"""
    def __init__(
        self,
        max_retries: int = 5,
        initial_delay: float = 2.0,
        backoff_strategy: str = "exponential",  # exponential, fixed, linear
        jitter: bool = True,
        retryable_errors: list = None
    ):
        self.max_retries = max_retries
        self.initial_delay = initial_delay
        self.backoff_strategy = backoff_strategy
        self.jitter = jitter
        self.retryable_errors = retryable_errors or [429, 500, 502, 503, 504]
    
    def calculate_delay(self, attempt: int) -> float:
        """è¨ˆç®—é‡è©¦å»¶é²"""
        if self.backoff_strategy == "exponential":
            delay = self.initial_delay * (2 ** attempt)
        elif self.backoff_strategy == "linear":
            delay = self.initial_delay * (attempt + 1)
        else:  # fixed
            delay = self.initial_delay
        
        # æ·»åŠ æŠ–å‹•ï¼ˆÂ±20%ï¼‰
        if self.jitter:
            jitter_range = delay * 0.2
            delay += random.uniform(-jitter_range, jitter_range)
        
        return max(0.1, delay)  # æœ€å° 100ms
    
    def is_retryable_error(self, error: Exception) -> bool:
        """åˆ¤æ–·éŒ¯èª¤æ˜¯å¦å¯é‡è©¦"""
        if isinstance(error, HTTPException):
            return error.status_code in self.retryable_errors
        elif isinstance(error, (ConnectionError, TimeoutError)):
            return True
        return False


class WorkflowExecutor:
    """å·¥ä½œæµåŸ·è¡Œå™¨ï¼ˆå¸¶é‡è©¦ï¼‰"""
    
    def __init__(self, db_session, retry_policy: RetryPolicy):
        self.db = db_session
        self.retry_policy = retry_policy
    
    async def execute_with_retry(
        self,
        execution_id: str,
        workflow_func: Callable,
        *args,
        **kwargs
    ) -> Any:
        """
        åŸ·è¡Œå·¥ä½œæµï¼Œå¸¶è‡ªå‹•é‡è©¦
        
        è¿”å›: åŸ·è¡Œçµæœ
        æ‹‹å‡º: å¦‚æœæ‰€æœ‰é‡è©¦å¤±æ•—ï¼Œæ‹‹å‡ºæœ€å¾Œä¸€å€‹ç•°å¸¸
        """
        last_exception = None
        
        for attempt in range(self.retry_policy.max_retries + 1):
            try:
                # è¨˜éŒ„é‡è©¦é–‹å§‹
                if attempt > 0:
                    await self._log_retry_attempt(execution_id, attempt)
                
                # åŸ·è¡Œå·¥ä½œæµ
                result = await workflow_func(*args, **kwargs)
                
                # æˆåŠŸ - è¨˜éŒ„ä¸¦è¿”å›
                if attempt > 0:
                    await self._log_retry_success(execution_id, attempt)
                
                return result
                
            except Exception as error:
                last_exception = error
                
                # æª¢æŸ¥æ˜¯å¦å¯é‡è©¦
                if not self.retry_policy.is_retryable_error(error):
                    # ä¸å¯é‡è©¦éŒ¯èª¤ - ç«‹å³å¤±æ•—
                    await self._log_non_retryable_error(execution_id, error)
                    raise
                
                # æª¢æŸ¥æ˜¯å¦é‚„æœ‰é‡è©¦æ©Ÿæœƒ
                if attempt >= self.retry_policy.max_retries:
                    # é‡è©¦æ¬¡æ•¸ç”¨ç›¡ - å¤±æ•—
                    await self._log_retry_exhausted(execution_id, error, attempt)
                    raise
                
                # è¨ˆç®—å»¶é²ä¸¦ç­‰å¾…
                delay = self.retry_policy.calculate_delay(attempt)
                next_retry_time = datetime.utcnow() + timedelta(seconds=delay)
                
                # è¨˜éŒ„é‡è©¦è¨ˆåŠƒ
                await self._log_retry_scheduled(
                    execution_id=execution_id,
                    attempt=attempt + 1,
                    error=error,
                    delay=delay,
                    next_retry_time=next_retry_time
                )
                
                # æ›´æ–°åŸ·è¡Œç‹€æ…‹ç‚ºã€Œé‡è©¦ä¸­ã€
                await self._update_execution_status(
                    execution_id=execution_id,
                    status="retrying",
                    retry_count=attempt + 1,
                    next_retry_at=next_retry_time
                )
                
                # ç­‰å¾…å¾Œé‡è©¦
                await asyncio.sleep(delay)
        
        # ä¸æ‡‰åˆ°é”é€™è£¡ï¼Œä½†ä»¥é˜²è¬ä¸€
        raise last_exception
    
    async def _log_retry_attempt(self, execution_id: str, attempt: int):
        """è¨˜éŒ„é‡è©¦é–‹å§‹"""
        logger.info(f"Execution {execution_id}: Starting retry attempt {attempt}")
    
    async def _log_retry_success(self, execution_id: str, attempt: int):
        """è¨˜éŒ„é‡è©¦æˆåŠŸ"""
        logger.info(f"Execution {execution_id}: Retry succeeded on attempt {attempt}")
        
        # æ›´æ–°åŸ·è¡Œç‹€æ…‹
        await self._update_execution_status(
            execution_id=execution_id,
            status="completed",
            retry_count=attempt
        )
    
    async def _log_non_retryable_error(self, execution_id: str, error: Exception):
        """è¨˜éŒ„ä¸å¯é‡è©¦éŒ¯èª¤"""
        logger.error(
            f"Execution {execution_id}: Non-retryable error - {type(error).__name__}: {str(error)}"
        )
        
        # è¨˜éŒ„åˆ°æ•¸æ“šåº«
        retry_log = RetryLog(
            execution_id=execution_id,
            attempt=0,
            error_type=type(error).__name__,
            error_message=str(error),
            retryable=False,
            timestamp=datetime.utcnow()
        )
        self.db.add(retry_log)
        self.db.commit()
    
    async def _log_retry_exhausted(self, execution_id: str, error: Exception, attempts: int):
        """è¨˜éŒ„é‡è©¦æ¬¡æ•¸ç”¨ç›¡"""
        logger.error(
            f"Execution {execution_id}: Retry exhausted after {attempts} attempts - {str(error)}"
        )
        
        # æ›´æ–°åŸ·è¡Œç‹€æ…‹ç‚ºå¤±æ•—
        await self._update_execution_status(
            execution_id=execution_id,
            status="failed",
            retry_count=attempts,
            error=str(error)
        )
    
    async def _log_retry_scheduled(
        self,
        execution_id: str,
        attempt: int,
        error: Exception,
        delay: float,
        next_retry_time: datetime
    ):
        """è¨˜éŒ„é‡è©¦è¨ˆåŠƒ"""
        logger.warning(
            f"Execution {execution_id}: Scheduling retry {attempt} in {delay:.2f}s "
            f"(next retry at {next_retry_time.isoformat()}) - Error: {str(error)}"
        )
        
        # è¨˜éŒ„åˆ°æ•¸æ“šåº«
        retry_log = RetryLog(
            execution_id=execution_id,
            attempt=attempt,
            error_type=type(error).__name__,
            error_message=str(error),
            delay_seconds=delay,
            next_retry_at=next_retry_time,
            retryable=True,
            timestamp=datetime.utcnow()
        )
        self.db.add(retry_log)
        self.db.commit()
    
    async def _update_execution_status(
        self,
        execution_id: str,
        status: str,
        retry_count: int = 0,
        next_retry_at: Optional[datetime] = None,
        error: Optional[str] = None
    ):
        """æ›´æ–°åŸ·è¡Œç‹€æ…‹"""
        execution = self.db.query(Execution).filter_by(execution_id=execution_id).first()
        
        if execution:
            execution.status = status
            execution.retry_count = retry_count
            execution.next_retry_at = next_retry_at
            if error:
                execution.error = error
            
            self.db.commit()


# ä½¿ç”¨ç¤ºä¾‹
async def main():
    retry_policy = RetryPolicy(
        max_retries=5,
        initial_delay=2.0,
        backoff_strategy="exponential",
        jitter=True,
        retryable_errors=[429, 500, 502, 503, 504]
    )
    
    executor = WorkflowExecutor(db_session, retry_policy)
    
    try:
        result = await executor.execute_with_retry(
            execution_id="exec_abc123",
            workflow_func=run_customer_360_workflow,
            customer_id="CUST-5678"
        )
        print(f"Workflow succeeded: {result}")
    except Exception as error:
        print(f"Workflow failed after all retries: {error}")
```

**é‡è©¦æ—¥èªŒæ•¸æ“šåº«è¡¨**:

```sql
CREATE TABLE retry_logs (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(100) NOT NULL,
    attempt INTEGER NOT NULL,  -- ç¬¬å¹¾æ¬¡é‡è©¦ (0 = é¦–æ¬¡åŸ·è¡Œ)
    
    -- éŒ¯èª¤ä¿¡æ¯
    error_type VARCHAR(100),  -- HTTPException, TimeoutError, etc.
    error_message TEXT,
    error_code VARCHAR(10),  -- HTTP ç‹€æ…‹ç¢¼ (429, 503, etc.)
    retryable BOOLEAN DEFAULT true,
    
    -- é‡è©¦é…ç½®
    delay_seconds DECIMAL(10,3),  -- å»¶é²ç§’æ•¸
    next_retry_at TIMESTAMP,  -- ä¸‹æ¬¡é‡è©¦æ™‚é–“
    
    -- æ™‚é–“æˆ³
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES executions(execution_id)
);

CREATE INDEX idx_retry_execution ON retry_logs(execution_id, attempt);
CREATE INDEX idx_retry_next_retry ON retry_logs(next_retry_at) WHERE next_retry_at IS NOT NULL;
```

**å®Œæˆå®šç¾©**:
- [ ] å¯¦ç¾æŒ‡æ•¸é€€é¿é‡è©¦é‚è¼¯ï¼ˆå¸¶æŠ–å‹•ï¼‰
- [ ] éŒ¯èª¤åˆ†é¡ï¼ˆå¯é‡è©¦ vs ä¸å¯é‡è©¦ï¼‰
- [ ] é‡è©¦ç‹€æ…‹è¿½è¹¤å’Œæ—¥èªŒè¨˜éŒ„
- [ ] UI é¡¯ç¤ºé‡è©¦é…ç½®å’Œæ¨¡æ“¬å™¨
- [ ] æ•¸æ“šåº«è¡¨å­˜å„²é‡è©¦æ—¥èªŒ
- [ ] å–®å…ƒæ¸¬è©¦ï¼ˆæ¨¡æ“¬å„ç¨®éŒ¯èª¤å ´æ™¯ï¼‰

---

### **US-F8-004: æ­»ä¿¡éšŠåˆ—ï¼ˆDLQï¼‰èˆ‡æ‰‹å‹•å¹²é **

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆAlex Chenï¼‰
- **æˆ‘æƒ³è¦** å¤šæ¬¡é‡è©¦å¤±æ•—çš„åŸ·è¡Œè‡ªå‹•ç§»è‡³æ­»ä¿¡éšŠåˆ—ï¼ˆDLQï¼‰ï¼Œä¸¦å…è¨±æˆ‘æ‰‹å‹•æŸ¥çœ‹ã€ä¿®å¾©å’Œé‡æ–°åŸ·è¡Œ
- **ä»¥ä¾¿** æˆ‘å¯ä»¥è™•ç†æŒä¹…æ€§æ•…éšœï¼Œè€Œä¸æœƒä¸Ÿå¤±ä»»ä½•åŸ·è¡Œè«‹æ±‚

**é©—æ”¶æ¨™æº–**:
1. âœ… **è‡ªå‹•ç§»è‡³ DLQ**: é‡è©¦æ¬¡æ•¸ç”¨ç›¡å¾Œï¼Œè‡ªå‹•ç§»è‡³ DLQ
2. âœ… **DLQ åˆ—è¡¨**: UI é¡¯ç¤ºæ‰€æœ‰ DLQ ä¸­çš„åŸ·è¡Œï¼ˆæŒ‰æ™‚é–“æ’åºï¼‰
3. âœ… **éŒ¯èª¤è©³æƒ…**: æŸ¥çœ‹å®Œæ•´çš„éŒ¯èª¤å †æ£§ã€é‡è©¦æ­·å²ã€è¼¸å…¥æ•¸æ“š
4. âœ… **æ‰‹å‹•é‡è©¦**: ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹è¼¸å…¥ä¸¦é‡æ–°åŸ·è¡Œ
5. âœ… **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡é‡è©¦æˆ–æ‰¹é‡åˆªé™¤ DLQ æ¢ç›®
6. âœ… **é€šçŸ¥**: DLQ æ–°å¢æ¢ç›®æ™‚é€šé Teams é€šçŸ¥ç®¡ç†å“¡

**æ­»ä¿¡éšŠåˆ— UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­»ä¿¡éšŠåˆ— (DLQ)                                        [åˆ·æ–°] [æ‰¹é‡æ“ä½œ â–¼]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ” ç¯©é¸å™¨                                                                     â”‚
â”‚ [å·¥ä½œæµ: å…¨éƒ¨ â–¼] [éŒ¯èª¤é¡å‹: å…¨éƒ¨ â–¼] [æ—¥æœŸ: æœ€è¿‘ 7 å¤© â–¼]                    â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“Š æ¦‚è¦½                                                                       â”‚
â”‚   ç¸½è¨ˆ: 23 å€‹å¤±æ•—åŸ·è¡Œ | æœ€èˆŠ: 5 å¤©å‰ | æœ€æ–°: 2 å°æ™‚å‰                        â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ—‚ï¸ DLQ æ¢ç›®åˆ—è¡¨                                                              â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ åŸ·è¡Œ ID: exec_abc123                                   [é‡è©¦] [åˆªé™¤]  â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚ å·¥ä½œæµ: customer_360_view                                               â”‚ â”‚
â”‚ â”‚ å¤±æ•—æ™‚é–“: 2025-11-19 12:30:45                                           â”‚ â”‚
â”‚ â”‚ é‡è©¦æ¬¡æ•¸: 5/5 (å…¨éƒ¨å¤±æ•—)                                                â”‚ â”‚
â”‚ â”‚ æœ€å¾ŒéŒ¯èª¤: HTTPException 503 - ServiceNow API unavailable                â”‚ â”‚
â”‚ â”‚                                                                          â”‚ â”‚
â”‚ â”‚ [â–¼ å±•é–‹è©³æƒ…]                                                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ åŸ·è¡Œ ID: exec_abc122                                   [é‡è©¦] [åˆªé™¤]  â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚ å·¥ä½œæµ: refund_decision                                                 â”‚ â”‚
â”‚ â”‚ å¤±æ•—æ™‚é–“: 2025-11-19 11:15:22                                           â”‚ â”‚
â”‚ â”‚ é‡è©¦æ¬¡æ•¸: 5/5 (å…¨éƒ¨å¤±æ•—)                                                â”‚ â”‚
â”‚ â”‚ æœ€å¾ŒéŒ¯èª¤: OpenAI API Error 429 - Rate limit exceeded                    â”‚ â”‚
â”‚ â”‚                                                                          â”‚ â”‚
â”‚ â”‚ [â–¼ å±•é–‹è©³æƒ…]                                                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ åŸ·è¡Œ ID: exec_abc121                                   [é‡è©¦] [åˆªé™¤]  â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚ å·¥ä½œæµ: it_password_reset                                               â”‚ â”‚
â”‚ â”‚ å¤±æ•—æ™‚é–“: 2025-11-18 16:45:10                                           â”‚ â”‚
â”‚ â”‚ é‡è©¦æ¬¡æ•¸: 5/5 (å…¨éƒ¨å¤±æ•—)                                                â”‚ â”‚
â”‚ â”‚ æœ€å¾ŒéŒ¯èª¤: Active Directory connection timeout                           â”‚ â”‚
â”‚ â”‚                                                                          â”‚ â”‚
â”‚ â”‚ [â–¼ å±•é–‹è©³æƒ…]                                                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [è¼‰å…¥æ›´å¤š...]                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DLQ æ¢ç›®è©³æƒ…å±•é–‹è¦–åœ–**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜‘ åŸ·è¡Œ ID: exec_abc123                                   [é‡è©¦] [åˆªé™¤]  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ å·¥ä½œæµ: customer_360_view                                               â”‚
â”‚ å¤±æ•—æ™‚é–“: 2025-11-19 12:30:45                                           â”‚
â”‚ é‡è©¦æ¬¡æ•¸: 5/5 (å…¨éƒ¨å¤±æ•—)                                                â”‚
â”‚ æœ€å¾ŒéŒ¯èª¤: HTTPException 503 - ServiceNow API unavailable                â”‚
â”‚                                                                          â”‚
â”‚ [â–² æŠ˜ç–Šè©³æƒ…]                                                             â”‚
â”‚                                                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                          â”‚
â”‚ ğŸ“‹ è¼¸å…¥æ•¸æ“š                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ {                                                                    â”‚â”‚
â”‚ â”‚   "customer_id": "CUST-5678",                                        â”‚â”‚
â”‚ â”‚   "include_tickets": true,                                           â”‚â”‚
â”‚ â”‚   "include_crm": true,                                               â”‚â”‚
â”‚ â”‚   "include_documents": true                                          â”‚â”‚
â”‚ â”‚ }                                                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚ ğŸ“Š é‡è©¦æ­·å²                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ é‡è©¦ 1 (2s å¾Œ):  âŒ 503 Service Unavailable                          â”‚â”‚
â”‚ â”‚ é‡è©¦ 2 (4s å¾Œ):  âŒ 503 Service Unavailable                          â”‚â”‚
â”‚ â”‚ é‡è©¦ 3 (8s å¾Œ):  âŒ 503 Service Unavailable                          â”‚â”‚
â”‚ â”‚ é‡è©¦ 4 (16s å¾Œ): âŒ 503 Service Unavailable                          â”‚â”‚
â”‚ â”‚ é‡è©¦ 5 (32s å¾Œ): âŒ 503 Service Unavailable                          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚ ğŸ” éŒ¯èª¤è©³æƒ…                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ éŒ¯èª¤é¡å‹: HTTPException                                              â”‚â”‚
â”‚ â”‚ HTTP ç‹€æ…‹ç¢¼: 503                                                     â”‚â”‚
â”‚ â”‚ éŒ¯èª¤æ¶ˆæ¯: ServiceNow API is temporarily unavailable                  â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ å †æ£§è¿½è¹¤:                                                            â”‚â”‚
â”‚ â”‚ Traceback (most recent call last):                                  â”‚â”‚
â”‚ â”‚   File "workflow_executor.py", line 123, in execute_step            â”‚â”‚
â”‚ â”‚     response = await servicenow_client.query(...)                   â”‚â”‚
â”‚ â”‚   File "servicenow_client.py", line 45, in query                    â”‚â”‚
â”‚ â”‚     raise HTTPException(status_code=503, detail="API unavailable")  â”‚â”‚
â”‚ â”‚ HTTPException: 503 Service Unavailable                              â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚ ğŸ’¡ å»ºè­°çš„ä¿®å¾©                                                            â”‚
â”‚   â€¢ ServiceNow API å¯èƒ½æ­£åœ¨ç¶­è­·ï¼Œç¨å¾Œé‡è©¦                               â”‚
â”‚   â€¢ æª¢æŸ¥ ServiceNow æœå‹™å¥åº·ç‹€æ³                                        â”‚
â”‚   â€¢ å¦‚æœå•é¡ŒæŒçºŒï¼Œè¯ç¹« ServiceNow æ”¯æŒ                                  â”‚
â”‚                                                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                          â”‚
â”‚ ğŸ”§ æ‰‹å‹•é‡è©¦é¸é …                                                          â”‚
â”‚                                                                          â”‚
â”‚ [ ] ä½¿ç”¨åŸå§‹è¼¸å…¥é‡è©¦                                                     â”‚
â”‚ [â—] ä¿®æ”¹è¼¸å…¥å¾Œé‡è©¦ (ç·¨è¼¯ä¸‹æ–¹ JSON)                                      â”‚
â”‚                                                                          â”‚
â”‚ ä¿®æ”¹å¾Œçš„è¼¸å…¥:                                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ {                                                                    â”‚â”‚
â”‚ â”‚   "customer_id": "CUST-5678",                                        â”‚â”‚
â”‚ â”‚   "include_tickets": true,                                           â”‚â”‚
â”‚ â”‚   "include_crm": false,  â† æš«æ™‚è·³é CRM æŸ¥è©¢                         â”‚â”‚
â”‚ â”‚   "include_documents": true                                          â”‚â”‚
â”‚ â”‚ }                                                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚ [å–æ¶ˆ] [ç¢ºèªé‡è©¦]                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DLQ è™•ç†å¯¦ç¾**:

```python
from datetime import datetime
from typing import Optional, Dict, Any

class DeadLetterQueueService:
    """æ­»ä¿¡éšŠåˆ—æœå‹™"""
    
    def __init__(self, db_session, notification_service):
        self.db = db_session
        self.notification_service = notification_service
    
    async def move_to_dlq(
        self,
        execution_id: str,
        final_error: Exception,
        retry_count: int,
        retry_history: list
    ):
        """
        å°‡å¤±æ•—çš„åŸ·è¡Œç§»è‡³ DLQ
        
        åƒæ•¸:
            execution_id: åŸ·è¡Œ ID
            final_error: æœ€å¾Œä¸€æ¬¡éŒ¯èª¤
            retry_count: ç¸½é‡è©¦æ¬¡æ•¸
            retry_history: é‡è©¦æ­·å²è¨˜éŒ„
        """
        # 1. ç²å–åŸ·è¡Œè©³æƒ…
        execution = self.db.query(Execution).filter_by(
            execution_id=execution_id
        ).first()
        
        if not execution:
            raise ValueError(f"Execution not found: {execution_id}")
        
        # 2. å‰µå»º DLQ æ¢ç›®
        dlq_entry = DeadLetterQueueEntry(
            execution_id=execution_id,
            workflow_id=execution.workflow_id,
            workflow_name=execution.workflow.name,
            
            # è¼¸å…¥æ•¸æ“š
            input_data=execution.input_data,
            
            # éŒ¯èª¤ä¿¡æ¯
            error_type=type(final_error).__name__,
            error_message=str(final_error),
            error_code=getattr(final_error, 'status_code', None),
            error_stacktrace=self._get_stacktrace(final_error),
            
            # é‡è©¦ä¿¡æ¯
            retry_count=retry_count,
            retry_history=retry_history,
            
            # ç‹€æ…‹
            status="pending",  # pending, retrying, resolved, deleted
            
            # æ™‚é–“æˆ³
            failed_at=execution.completed_at or datetime.utcnow(),
            created_at=datetime.utcnow()
        )
        
        self.db.add(dlq_entry)
        self.db.commit()
        
        # 3. æ›´æ–°åŸ·è¡Œç‹€æ…‹
        execution.status = "dlq"
        execution.dlq_entry_id = dlq_entry.id
        self.db.commit()
        
        # 4. ç™¼é€ Teams é€šçŸ¥
        await self.notification_service.send_dlq_alert(
            workflow_name=execution.workflow.name,
            execution_id=execution_id,
            error_message=str(final_error),
            dlq_entry_id=dlq_entry.id
        )
        
        logger.warning(
            f"Execution {execution_id} moved to DLQ after {retry_count} retries. "
            f"DLQ Entry ID: {dlq_entry.id}"
        )
        
        return dlq_entry
    
    async def list_dlq_entries(
        self,
        workflow_id: Optional[str] = None,
        status: Optional[str] = None,
        limit: int = 50,
        offset: int = 0
    ) -> list:
        """åˆ—å‡º DLQ æ¢ç›®"""
        query = self.db.query(DeadLetterQueueEntry)
        
        if workflow_id:
            query = query.filter_by(workflow_id=workflow_id)
        
        if status:
            query = query.filter_by(status=status)
        
        # æŒ‰å¤±æ•—æ™‚é–“å€’åº
        query = query.order_by(DeadLetterQueueEntry.failed_at.desc())
        
        return query.limit(limit).offset(offset).all()
    
    async def retry_dlq_entry(
        self,
        dlq_entry_id: int,
        modified_input: Optional[Dict[str, Any]] = None,
        user_id: Optional[str] = None
    ) -> str:
        """
        æ‰‹å‹•é‡è©¦ DLQ æ¢ç›®
        
        è¿”å›: æ–°åŸ·è¡Œçš„ execution_id
        """
        # 1. ç²å– DLQ æ¢ç›®
        dlq_entry = self.db.query(DeadLetterQueueEntry).filter_by(
            id=dlq_entry_id
        ).first()
        
        if not dlq_entry:
            raise ValueError(f"DLQ entry not found: {dlq_entry_id}")
        
        if dlq_entry.status != "pending":
            raise ValueError(f"DLQ entry is not pending: {dlq_entry.status}")
        
        # 2. æ›´æ–° DLQ ç‹€æ…‹ç‚ºã€Œé‡è©¦ä¸­ã€
        dlq_entry.status = "retrying"
        dlq_entry.retry_attempted_at = datetime.utcnow()
        dlq_entry.retry_attempted_by = user_id
        self.db.commit()
        
        # 3. å‰µå»ºæ–°åŸ·è¡Œ
        input_data = modified_input or dlq_entry.input_data
        
        new_execution_id = await self._create_execution(
            workflow_id=dlq_entry.workflow_id,
            input_data=input_data,
            trigger_type="manual_dlq_retry",
            triggered_by=user_id,
            parent_dlq_entry_id=dlq_entry_id
        )
        
        # 4. è§¸ç™¼åŸ·è¡Œ
        from workflow_executor import WorkflowExecutor
        executor = WorkflowExecutor(self.db, retry_policy=None)  # ç„¡é‡è©¦ï¼ˆå·²åœ¨ DLQï¼‰
        
        try:
            result = await executor.execute(new_execution_id)
            
            # æˆåŠŸ - æ¨™è¨˜ DLQ ç‚ºå·²è§£æ±º
            dlq_entry.status = "resolved"
            dlq_entry.resolved_at = datetime.utcnow()
            dlq_entry.resolved_by = user_id
            dlq_entry.resolution_execution_id = new_execution_id
            self.db.commit()
            
            logger.info(f"DLQ entry {dlq_entry_id} resolved with execution {new_execution_id}")
            
        except Exception as error:
            # ä»ç„¶å¤±æ•— - DLQ ç‹€æ…‹å›åˆ° pending
            dlq_entry.status = "pending"
            self.db.commit()
            
            logger.error(f"DLQ retry {dlq_entry_id} failed: {error}")
            raise
        
        return new_execution_id
    
    async def delete_dlq_entry(self, dlq_entry_id: int, user_id: Optional[str] = None):
        """åˆªé™¤ DLQ æ¢ç›®ï¼ˆæ”¾æ£„é‡è©¦ï¼‰"""
        dlq_entry = self.db.query(DeadLetterQueueEntry).filter_by(
            id=dlq_entry_id
        ).first()
        
        if not dlq_entry:
            raise ValueError(f"DLQ entry not found: {dlq_entry_id}")
        
        # è»Ÿåˆªé™¤ï¼ˆæ¨™è¨˜ç‚ºå·²åˆªé™¤ï¼‰
        dlq_entry.status = "deleted"
        dlq_entry.deleted_at = datetime.utcnow()
        dlq_entry.deleted_by = user_id
        self.db.commit()
        
        logger.info(f"DLQ entry {dlq_entry_id} deleted by {user_id}")
    
    def _get_stacktrace(self, error: Exception) -> str:
        """ç²å–éŒ¯èª¤å †æ£§è¿½è¹¤"""
        import traceback
        return ''.join(traceback.format_exception(type(error), error, error.__traceback__))
```

**DLQ æ•¸æ“šåº«è¡¨**:

```sql
CREATE TABLE dead_letter_queue (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(100) UNIQUE NOT NULL,
    workflow_id VARCHAR(100) NOT NULL,
    workflow_name VARCHAR(200),
    
    -- è¼¸å…¥æ•¸æ“š
    input_data JSONB NOT NULL,
    
    -- éŒ¯èª¤ä¿¡æ¯
    error_type VARCHAR(100),
    error_message TEXT,
    error_code VARCHAR(10),
    error_stacktrace TEXT,
    
    -- é‡è©¦ä¿¡æ¯
    retry_count INTEGER DEFAULT 0,
    retry_history JSONB,  -- [{attempt: 1, error: "...", delay: 2.0}, ...]
    
    -- ç‹€æ…‹
    status VARCHAR(20) DEFAULT 'pending',  -- pending, retrying, resolved, deleted
    
    -- æ‰‹å‹•é‡è©¦
    retry_attempted_at TIMESTAMP,
    retry_attempted_by VARCHAR(100),
    resolution_execution_id VARCHAR(100),
    
    -- è§£æ±º/åˆªé™¤
    resolved_at TIMESTAMP,
    resolved_by VARCHAR(100),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(100),
    
    -- æ™‚é–“æˆ³
    failed_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES executions(execution_id),
    FOREIGN KEY (workflow_id) REFERENCES workflows(workflow_id)
);

CREATE INDEX idx_dlq_status ON dead_letter_queue(status, failed_at DESC);
CREATE INDEX idx_dlq_workflow ON dead_letter_queue(workflow_id, status);
```

**å®Œæˆå®šç¾©**:
- [ ] è‡ªå‹•ç§»è‡³ DLQï¼ˆé‡è©¦ç”¨ç›¡å¾Œï¼‰
- [ ] DLQ åˆ—è¡¨ UIï¼ˆç¯©é¸ã€æ’åºï¼‰
- [ ] DLQ æ¢ç›®è©³æƒ…è¦–åœ–ï¼ˆéŒ¯èª¤ã€é‡è©¦æ­·å²ã€è¼¸å…¥ï¼‰
- [ ] æ‰‹å‹•é‡è©¦åŠŸèƒ½ï¼ˆå¯ä¿®æ”¹è¼¸å…¥ï¼‰
- [ ] æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡é‡è©¦ã€æ‰¹é‡åˆªé™¤ï¼‰
- [ ] Teams é€šçŸ¥ï¼ˆDLQ æ–°å¢æ¢ç›®ï¼‰
- [ ] æ•¸æ“šåº«è¡¨å’Œç´¢å¼•

---

## 8.3 æ•¸æ“šåº«æ¶æ§‹

å®Œæ•´çš„ F8 æ•¸æ“šåº«æ¶æ§‹ï¼ˆæ•´åˆæ‰€æœ‰ç”¨æˆ¶æ•…äº‹ï¼‰:

```sql
-- å·¥ä½œæµè§¸ç™¼é…ç½®è¡¨
CREATE TABLE workflow_triggers (
    id SERIAL PRIMARY KEY,
    workflow_id VARCHAR(100) NOT NULL,
    
    -- è§¸ç™¼é¡å‹
    trigger_type VARCHAR(20) NOT NULL,  -- cron, webhook, manual
    
    -- Cron é…ç½®
    cron_expression VARCHAR(100),
    cron_timezone VARCHAR(50) DEFAULT 'UTC',
    cron_enabled BOOLEAN DEFAULT true,
    next_cron_execution TIMESTAMP,
    
    -- Webhook é…ç½®
    webhook_id VARCHAR(50) UNIQUE,
    webhook_secret VARCHAR(200),
    webhook_authentication VARCHAR(20),  -- hmac, api_key, none
    webhook_filters JSONB,  -- [{json_path: "$.type", operator: "equals", value: "incident"}]
    
    -- é‡è©¦ç­–ç•¥
    retry_enabled BOOLEAN DEFAULT true,
    max_retries INTEGER DEFAULT 5,
    initial_delay_seconds DECIMAL(10,3) DEFAULT 2.0,
    backoff_strategy VARCHAR(20) DEFAULT 'exponential',  -- exponential, fixed, linear
    jitter_enabled BOOLEAN DEFAULT true,
    retryable_error_codes INTEGER[],  -- [429, 500, 502, 503, 504]
    
    -- æ™‚é–“æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (workflow_id) REFERENCES workflows(workflow_id)
);

-- Webhook è«‹æ±‚æ—¥èªŒè¡¨
CREATE TABLE webhook_requests (
    id SERIAL PRIMARY KEY,
    webhook_id VARCHAR(50) NOT NULL,
    
    -- è«‹æ±‚ä¿¡æ¯
    source_ip VARCHAR(45),
    request_headers JSONB,
    request_body JSONB,
    
    -- è™•ç†çµæœ
    status VARCHAR(20),  -- triggered, filtered, auth_failed, error
    execution_id VARCHAR(100),  -- å¦‚æœè§¸ç™¼æˆåŠŸ
    error_message TEXT,
    
    -- æ™‚é–“æˆ³
    received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (webhook_id) REFERENCES workflow_triggers(webhook_id)
);

-- é‡è©¦æ—¥èªŒè¡¨ (å·²åœ¨ US-F8-003 ä¸­å®šç¾©)
CREATE TABLE retry_logs (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(100) NOT NULL,
    attempt INTEGER NOT NULL,
    error_type VARCHAR(100),
    error_message TEXT,
    error_code VARCHAR(10),
    retryable BOOLEAN DEFAULT true,
    delay_seconds DECIMAL(10,3),
    next_retry_at TIMESTAMP,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES executions(execution_id)
);

-- æ­»ä¿¡éšŠåˆ—è¡¨ (å·²åœ¨ US-F8-004 ä¸­å®šç¾©)
CREATE TABLE dead_letter_queue (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(100) UNIQUE NOT NULL,
    workflow_id VARCHAR(100) NOT NULL,
    workflow_name VARCHAR(200),
    input_data JSONB NOT NULL,
    error_type VARCHAR(100),
    error_message TEXT,
    error_code VARCHAR(10),
    error_stacktrace TEXT,
    retry_count INTEGER DEFAULT 0,
    retry_history JSONB,
    status VARCHAR(20) DEFAULT 'pending',
    retry_attempted_at TIMESTAMP,
    retry_attempted_by VARCHAR(100),
    resolution_execution_id VARCHAR(100),
    resolved_at TIMESTAMP,
    resolved_by VARCHAR(100),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(100),
    failed_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES executions(execution_id),
    FOREIGN KEY (workflow_id) REFERENCES workflows(workflow_id)
);

-- ç´¢å¼•
CREATE INDEX idx_triggers_workflow ON workflow_triggers(workflow_id);
CREATE INDEX idx_triggers_cron_next ON workflow_triggers(next_cron_execution) WHERE cron_enabled = true;
CREATE INDEX idx_webhook_requests_webhook ON webhook_requests(webhook_id, received_at DESC);
CREATE INDEX idx_retry_execution ON retry_logs(execution_id, attempt);
CREATE INDEX idx_dlq_status ON dead_letter_queue(status, failed_at DESC);
```

---

## 8.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **å¯é æ€§** | è§¸ç™¼æˆåŠŸç‡ | â‰¥99.5% | ç›£æ§ Cron/Webhook è§¸ç™¼ |
| | é‡è©¦æˆåŠŸç‡ | â‰¥80% éŒ¯èª¤è‡ªå‹•æ¢å¾© | é‡è©¦æ—¥èªŒåˆ†æ |
| **æ€§èƒ½** | Webhook éŸ¿æ‡‰æ™‚é–“ | <100msï¼ˆæ¥æ”¶ä¸¦å…¥éšŠï¼‰ | API éŸ¿æ‡‰ç›£æ§ |
| | DLQ æŸ¥è©¢æ€§èƒ½ | <500msï¼ˆåˆ—å‡º 50 æ¢ï¼‰ | æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ– |
| **å¯æ“´å±•æ€§** | Cron è§¸ç™¼å™¨æ•¸é‡ | æ”¯æŒ 1000+ å·¥ä½œæµ | n8n è² è¼‰æ¸¬è©¦ |
| | ä¸¦ç™¼ Webhook è«‹æ±‚ | 500+ req/s | è² è¼‰æ¸¬è©¦ |
| **å¯è§€å¯Ÿæ€§** | éŒ¯èª¤è¿½è¹¤ | 100% éŒ¯èª¤è¨˜éŒ„ | æ—¥èªŒå®Œæ•´æ€§æª¢æŸ¥ |
| | DLQ é€šçŸ¥å»¶é² | <30 ç§’ | Teams é€šçŸ¥ç›£æ§ |

---

## 8.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:
- Cron è¡¨é”å¼è§£æå’Œé©—è­‰
- Webhook ç°½åé©—è­‰ï¼ˆHMAC-SHA256ï¼‰
- æŒ‡æ•¸é€€é¿ç®—æ³•ï¼ˆå«æŠ–å‹•ï¼‰
- éŒ¯èª¤åˆ†é¡é‚è¼¯ï¼ˆå¯é‡è©¦ vs ä¸å¯é‡è©¦ï¼‰
- DLQ æ¢ç›®å‰µå»ºå’Œæ›´æ–°

**é›†æˆæ¸¬è©¦**:
- ç«¯åˆ°ç«¯ Cron è§¸ç™¼æµç¨‹
- ç«¯åˆ°ç«¯ Webhook è§¸ç™¼æµç¨‹ï¼ˆæ¨¡æ“¬ ServiceNowï¼‰
- é‡è©¦é‚è¼¯ï¼ˆæ¨¡æ“¬å„ç¨®éŒ¯èª¤ï¼š429, 503, timeoutï¼‰
- DLQ æ‰‹å‹•é‡è©¦æµç¨‹

**è² è¼‰æ¸¬è©¦**:
- 1000 å€‹ä¸¦ç™¼ Webhook è«‹æ±‚
- 100 å€‹å·¥ä½œæµåŒæ™‚é‡è©¦

**æ··æ²Œå·¥ç¨‹**:
- æ¨¡æ“¬ ServiceNow API é–“æ­‡æ€§æ•…éšœ
- æ¨¡æ“¬ LLM API é™æµï¼ˆ429ï¼‰
- æ¨¡æ“¬ç¶²çµ¡è¶…æ™‚

---

## 8.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| n8n å–®é»æ•…éšœ | ä¸­ | é«˜ | n8n é«˜å¯ç”¨éƒ¨ç½²ï¼ˆé›™ç¯€é»ï¼‰+ å¥åº·æª¢æŸ¥ |
| é‡è©¦é¢¨æš´ï¼ˆé›ªå´©ï¼‰ | ä½ | ä¸­ | æŠ–å‹•ï¼ˆJitterï¼‰+ æœ€å¤§ä¸¦ç™¼é‡è©¦é™åˆ¶ |
| DLQ ç„¡é™å¢é•· | ä¸­ | ä¸­ | è‡ªå‹•æ­¸æª”ï¼ˆ30 å¤©å¾Œï¼‰+ æ‰¹é‡æ¸…ç†å·¥å…· |
| Webhook ç°½åå½é€  | ä½ | é«˜ | HMAC-SHA256 + IP ç™½åå–®ï¼ˆå¯é¸ï¼‰ |

---

## 8.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **å„ªå…ˆç´šéšŠåˆ—**: é«˜å„ªå…ˆç´šåŸ·è¡Œå„ªå…ˆé‡è©¦
2. **æ™ºèƒ½éŒ¯èª¤åˆ†é¡**: ä½¿ç”¨ LLM åˆ†æéŒ¯èª¤ä¸¦å»ºè­°ä¿®å¾©
3. **DLQ è‡ªå‹•æ¢å¾©**: æª¢æ¸¬å¤–éƒ¨æœå‹™æ¢å¾©å¾Œè‡ªå‹•é‡è©¦ DLQ
4. **åˆ†ä½ˆå¼è¿½è¹¤**: é›†æˆ OpenTelemetry è¿½è¹¤è·¨æœå‹™èª¿ç”¨
5. **é›»è·¯æ–·è·¯å™¨**: æª¢æ¸¬åˆ°æœå‹™æŒçºŒæ•…éšœæ™‚è‡ªå‹•æš«åœè§¸ç™¼

---

**âœ… F8 å®Œæˆ**ï¼šn8n è§¸ç™¼èˆ‡éŒ¯èª¤è™•ç†åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f9-prompt-management"></a>F9. æç¤ºç®¡ç†ï¼ˆYAML æ¨¡æ¿ï¼‰

**åŠŸèƒ½é¡åˆ¥**: Reliability (å¯é æ€§)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1 é€±  
**è¤‡é›œåº¦**: â­â­â­

---

### 9.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F9ï¼ˆæç¤ºç®¡ç†ï¼‰æä¾›**é›†ä¸­å¼ YAML æ¨¡æ¿åº«**ä¾†ç®¡ç†æ‰€æœ‰ Agent æç¤ºï¼ˆPromptsï¼‰ï¼Œæ”¯æŒ**ç‰ˆæœ¬æ§åˆ¶ã€è®Šé‡æ›¿æ›ã€A/B æ¸¬è©¦**ã€‚ç®¡ç†å“¡å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç¢¼çš„æƒ…æ³ä¸‹æ›´æ–°æç¤ºå…§å®¹ï¼Œä¸¦è¿½è¹¤æç¤ºè®Šæ›´å° Agent è¼¸å‡ºè³ªé‡çš„å½±éŸ¿ã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **ä»£ç¢¼èˆ‡å…§å®¹åˆ†é›¢**: æç¤ºè®Šæ›´ä¸éœ€è¦é‡æ–°éƒ¨ç½²ä»£ç¢¼ï¼ˆå¾ 2 å°æ™‚é™è‡³ 2 åˆ†é˜ï¼‰
- **å¿«é€Ÿè¿­ä»£**: å¸‚å ´åœ˜éšŠå¯ä»¥ç›´æ¥å„ªåŒ–æç¤ºï¼Œç„¡éœ€é–‹ç™¼åœ˜éšŠä»‹å…¥
- **ç‰ˆæœ¬è¿½è¹¤**: å›æ»¾åˆ°æ­·å²æç¤ºç‰ˆæœ¬ï¼Œåˆ†ææç¤ºè®Šæ›´å½±éŸ¿
- **å¤šèªè¨€æ”¯æŒ**: æœªä¾†æ“´å±•è‡³å¤šèªè¨€ï¼ˆä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™æ–‡ï¼‰æ™‚ç„¡éœ€æ”¹ä»£ç¢¼

**æ ¸å¿ƒèƒ½åŠ›**:
1. **YAML æ¨¡æ¿åº«**: æ‰€æœ‰æç¤ºå­˜å„²åœ¨ Git å€‰åº«ï¼ˆ`prompts/` ç›®éŒ„ï¼‰
2. **è®Šé‡æ›¿æ›**: æ”¯æŒ `{customer_name}`, `{ticket_id}` ç­‰å‹•æ…‹è®Šé‡
3. **ç‰ˆæœ¬ç®¡ç†**: Git æäº¤æ­·å²è‡ªå‹•è¿½è¹¤æç¤ºè®Šæ›´
4. **A/B æ¸¬è©¦**: åŒä¸€æç¤ºçš„å¤šå€‹è®Šé«”ï¼ˆVariant A/B/Cï¼‰ï¼Œéš¨æ©Ÿåˆ†é…æµé‡
5. **æç¤ºé è¦½**: UI é è¦½æœ€çµ‚æ¸²æŸ“å¾Œçš„æç¤ºï¼ˆå¸¶ç¤ºä¾‹æ•¸æ“šï¼‰
6. **ç†±é‡è¼‰**: æç¤ºè®Šæ›´å¾Œ 5 ç§’å…§è‡ªå‹•ç”Ÿæ•ˆï¼ˆç„¡éœ€é‡å•Ÿæœå‹™ï¼‰

**æ¥­å‹™åƒ¹å€¼**:
- **ä¸Šå¸‚æ™‚é–“**: æç¤ºå„ªåŒ–å¾ 2 å¤©ï¼ˆä»£ç¢¼è®Šæ›´ + æ¸¬è©¦ + éƒ¨ç½²ï¼‰é™è‡³ 10 åˆ†é˜ï¼ˆYAML ç·¨è¼¯ + æäº¤ï¼‰
- **è³ªé‡æå‡**: A/B æ¸¬è©¦ç™¼ç¾æœ€å„ªæç¤ºï¼Œå®¢æˆ¶æ»¿æ„åº¦æå‡ 15%
- **é™ä½é¢¨éšª**: æç¤ºå›æ»¾èƒ½åŠ›ï¼Œé¿å…ç”Ÿç”¢ç’°å¢ƒéŒ¯èª¤æç¤º

**ç¾å¯¦ä¸–ç•Œç¤ºä¾‹**:

**å ´æ™¯**: "å®¢æœç¥¨å‹™æ‘˜è¦" Agent çš„æç¤ºå„ªåŒ–

**å‚³çµ±æ–¹å¼ï¼ˆç„¡æç¤ºç®¡ç†ï¼‰**:
```python
# ç¡¬ç·¨ç¢¼åœ¨ä»£ç¢¼ä¸­
prompt = f"""
You are a customer service analyst. Summarize the following ticket:

Ticket ID: {ticket_id}
Customer: {customer_name}
Issue: {issue_description}

Provide a concise summary in 2-3 sentences.
"""
```

**è®Šæ›´æµç¨‹**:
1. é–‹ç™¼äººå“¡ä¿®æ”¹ Python ä»£ç¢¼ä¸­çš„æç¤ºå­—ç¬¦ä¸²
2. é‹è¡Œå–®å…ƒæ¸¬è©¦ï¼ˆ30 åˆ†é˜ï¼‰
3. æäº¤ PRï¼Œç­‰å¾…å¯©æŸ¥ï¼ˆ1-2 å°æ™‚ï¼‰
4. åˆä½µå¾Œè§¸ç™¼ CI/CD éƒ¨ç½²ï¼ˆ30 åˆ†é˜ï¼‰
5. **ç¸½è€—æ™‚**: 2-3 å°æ™‚

**ä½¿ç”¨ F9 æç¤ºç®¡ç†å¾Œ**:
```yaml
# prompts/customer_service/ticket_summary.yaml
version: "1.2"
name: "Ticket Summary Prompt"
description: "Generates concise summary for CS tickets"

variants:
  - id: "control"
    weight: 50  # 50% æµé‡
    template: |
      You are a customer service analyst. Summarize the following ticket:
      
      Ticket ID: {ticket_id}
      Customer: {customer_name}
      Issue: {issue_description}
      
      Provide a concise summary in 2-3 sentences.
  
  - id: "experiment_empathy"
    weight: 50  # 50% æµé‡ï¼ˆA/B æ¸¬è©¦ï¼‰
    template: |
      You are an empathetic customer service analyst. Summarize the following ticket with a focus on the customer's emotional state:
      
      Ticket ID: {ticket_id}
      Customer: {customer_name}
      Issue: {issue_description}
      
      Provide a concise summary in 2-3 sentences, highlighting the customer's urgency level.

variables:
  ticket_id:
    type: "string"
    required: true
    example: "TICKET-1234"
  customer_name:
    type: "string"
    required: true
    example: "John Smith"
  issue_description:
    type: "string"
    required: true
    example: "Cannot access account after password reset"
```

**è®Šæ›´æµç¨‹**:
1. å¸‚å ´åœ˜éšŠåœ¨ Web UI ç·¨è¼¯ YAML æ–‡ä»¶ï¼ˆ2 åˆ†é˜ï¼‰
2. é»æ“Šã€Œæäº¤è®Šæ›´ã€ï¼ˆè‡ªå‹• Git commit + pushï¼‰
3. ç³»çµ±è‡ªå‹•é‡è¼‰æç¤ºï¼ˆ5 ç§’ï¼‰
4. **ç¸½è€—æ™‚**: 5-10 åˆ†é˜

**æ¶æ§‹åœ–**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          F9. æç¤ºç®¡ç†æ¶æ§‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Git å€‰åº«    â”‚  â† æç¤ºæ¨¡æ¿å­˜å„²ï¼ˆprompts/ ç›®éŒ„ï¼‰
   â”‚ (prompts/)   â”‚     - ticket_summary.yaml
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     - refund_decision.yaml
          â”‚              - password_reset.yaml
          â”‚ Git Pull
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æç¤ºåŠ è¼‰å™¨   â”‚  â† å•Ÿå‹•æ™‚/å®šæ™‚ï¼ˆæ¯ 5 ç§’ï¼‰æ‹‰å–æœ€æ–°æç¤º
   â”‚(Prompt Loader)â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æç¤ºç·©å­˜     â”‚  â† Redis ç·©å­˜æ¸²æŸ“å¾Œçš„æç¤ºï¼ˆTTL 5 ç§’ï¼‰
   â”‚ (Redis)      â”‚     Key: prompt:{name}:v{version}
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                       Agent åŸ·è¡Œå¼•æ“                             â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚ 1. é¸æ“‡è®Šé«”   â”‚  â”‚ 2. è®Šé‡æ›¿æ›   â”‚  â”‚ 3. èª¿ç”¨ LLM   â”‚   â”‚
   â”‚  â”‚   (A/B Test)   â”‚â†’ â”‚   (Jinja2)     â”‚â†’ â”‚   (OpenAI)     â”‚   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æç¤ºä½¿ç”¨æ—¥èªŒ â”‚  â† è¨˜éŒ„æ¯æ¬¡æç¤ºèª¿ç”¨ï¼ˆvariant, è®Šé‡, åŸ·è¡Œ IDï¼‰
   â”‚(PostgreSQL)  â”‚     ç”¨æ–¼ A/B æ¸¬è©¦åˆ†æ
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Web UI       â”‚  â† æç¤ºç·¨è¼¯å™¨ã€é è¦½ã€A/B æ¸¬è©¦çµæœå„€è¡¨æ¿
   â”‚(React)       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 9.2 ç”¨æˆ¶æ•…äº‹

#### **US-F9-001: YAML æç¤ºæ¨¡æ¿ç·¨è¼¯å™¨**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** å¸‚å ´åœ˜éšŠæˆå“¡ï¼ˆSarah Linï¼‰
- **æˆ‘æƒ³è¦** åœ¨ Web UI ä¸­ç›´æ¥ç·¨è¼¯æç¤º YAML æ–‡ä»¶
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¿«é€Ÿå„ªåŒ–æç¤ºå…§å®¹ï¼Œè€Œä¸éœ€è¦é–‹ç™¼åœ˜éšŠå”åŠ©

**é©—æ”¶æ¨™æº–**:

1. âœ… **æç¤ºåˆ—è¡¨**: é¡¯ç¤ºæ‰€æœ‰æç¤ºæ–‡ä»¶ï¼ˆæŒ‰å·¥ä½œæµåˆ†çµ„ï¼‰
2. âœ… **åœ¨ç·šç·¨è¼¯å™¨**: æ”¯æŒ YAML èªæ³•é«˜äº®å’Œé©—è­‰
3. âœ… **å³æ™‚é è¦½**: å³å´é¢æ¿å¯¦æ™‚é è¦½æ¸²æŸ“å¾Œçš„æç¤ºï¼ˆå¸¶ç¤ºä¾‹æ•¸æ“šï¼‰
4. âœ… **è®Šé‡æ ¡é©—**: æª¢æ¸¬æœªå®šç¾©çš„è®Šé‡ï¼ˆå¦‚ `{ticket_id}` æœªåœ¨ `variables` ä¸­è²æ˜ï¼‰
5. âœ… **Git é›†æˆ**: ä¿å­˜æ™‚è‡ªå‹• Git commit + pushï¼ˆæäº¤æ¶ˆæ¯è‡ªå‹•ç”Ÿæˆï¼‰
6. âœ… **ç‰ˆæœ¬æ­·å²**: æŸ¥çœ‹æç¤ºè®Šæ›´æ­·å²ï¼ˆGit logï¼‰

**æç¤ºç·¨è¼¯å™¨ UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æç¤ºç®¡ç† > customer_service/ticket_summary.yaml              [ä¿å­˜] [å–æ¶ˆ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ“ æç¤ºåˆ—è¡¨                       â”‚ ğŸ“ YAML ç·¨è¼¯å™¨                            â”‚
â”‚                                   â”‚                                           â”‚
â”‚ ğŸ“‚ customer_service (5)           â”‚ # prompts/customer_service/              â”‚
â”‚   â€¢ ticket_summary.yaml â—€         â”‚ # ticket_summary.yaml                     â”‚
â”‚   â€¢ refund_decision.yaml          â”‚                                           â”‚
â”‚   â€¢ escalation_check.yaml         â”‚ version: "1.2"                            â”‚
â”‚   â€¢ customer_sentiment.yaml       â”‚ name: "Ticket Summary Prompt"             â”‚
â”‚   â€¢ sla_priority.yaml             â”‚ description: "Generates concise summary"  â”‚
â”‚                                   â”‚                                           â”‚
â”‚ ğŸ“‚ it_support (3)                 â”‚ variants:                                 â”‚
â”‚   â€¢ password_reset.yaml           â”‚   - id: "control"                         â”‚
â”‚   â€¢ access_request.yaml           â”‚     weight: 50                            â”‚
â”‚   â€¢ incident_triage.yaml          â”‚     template: |                           â”‚
â”‚                                   â”‚       You are a customer service analyst. â”‚
â”‚ ğŸ“‚ hr (2)                         â”‚       Summarize the following ticket:     â”‚
â”‚   â€¢ leave_approval.yaml           â”‚                                           â”‚
â”‚   â€¢ onboarding_checklist.yaml     â”‚       Ticket ID: {ticket_id}              â”‚
â”‚                                   â”‚       Customer: {customer_name}           â”‚
â”‚ [+ æ–°å¢æç¤º]                      â”‚       Issue: {issue_description}          â”‚
â”‚                                   â”‚                                           â”‚
â”‚                                   â”‚       Provide a concise summary in 2-3    â”‚
â”‚                                   â”‚       sentences.                          â”‚
â”‚                                   â”‚                                           â”‚
â”‚                                   â”‚ variables:                                â”‚
â”‚                                   â”‚   ticket_id:                              â”‚
â”‚                                   â”‚     type: "string"                        â”‚
â”‚                                   â”‚     required: true                        â”‚
â”‚                                   â”‚     example: "TICKET-1234"                â”‚
â”‚                                   â”‚   customer_name:                          â”‚
â”‚                                   â”‚     type: "string"                        â”‚
â”‚                                   â”‚     required: true                        â”‚
â”‚                                   â”‚     example: "John Smith"                 â”‚
â”‚                                   â”‚                                           â”‚
â”‚                                   â”‚ [âœ“ YAML èªæ³•æ­£ç¢º]                         â”‚
â”‚                                   â”‚                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚                                           â”‚
â”‚ ğŸ“Š ç‰ˆæœ¬æ­·å²                       â”‚ ğŸ” é è¦½                                   â”‚
â”‚                                   â”‚                                           â”‚
â”‚ v1.2 (ç•¶å‰) - 2025-11-19 10:30   â”‚ è®Šé«”: [Control â–¼]                        â”‚
â”‚ ä¿®æ”¹: æ·»åŠ æƒ…æ„Ÿåˆ†æè®Šé«”            â”‚                                           â”‚
â”‚ ä½œè€…: Sarah Lin                   â”‚ ç¤ºä¾‹æ•¸æ“š:                                 â”‚
â”‚                                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ v1.1 - 2025-11-18 14:15           â”‚ â”‚ ticket_id: TICKET-1234              â”‚   â”‚
â”‚ ä¿®æ”¹: ç°¡åŒ–è¼¸å‡ºç‚º 2-3 å¥           â”‚ â”‚ customer_name: John Smith           â”‚   â”‚
â”‚ ä½œè€…: Alex Chen                   â”‚ â”‚ issue_description: Cannot access... â”‚   â”‚
â”‚                                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ v1.0 - 2025-11-10 09:00           â”‚                                           â”‚
â”‚ ä¿®æ”¹: åˆå§‹æç¤ºå‰µå»º                â”‚ æ¸²æŸ“å¾Œçš„æç¤º:                             â”‚
â”‚ ä½œè€…: Alex Chen                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                   â”‚ â”‚ You are a customer service analyst. â”‚   â”‚
â”‚ [æŸ¥çœ‹å®Œæ•´æ­·å²]                    â”‚ â”‚ Summarize the following ticket:     â”‚   â”‚
â”‚                                   â”‚ â”‚                                     â”‚   â”‚
â”‚                                   â”‚ â”‚ Ticket ID: TICKET-1234              â”‚   â”‚
â”‚                                   â”‚ â”‚ Customer: John Smith                â”‚   â”‚
â”‚                                   â”‚ â”‚ Issue: Cannot access account after  â”‚   â”‚
â”‚                                   â”‚ â”‚ password reset                      â”‚   â”‚
â”‚                                   â”‚ â”‚                                     â”‚   â”‚
â”‚                                   â”‚ â”‚ Provide a concise summary in 2-3    â”‚   â”‚
â”‚                                   â”‚ â”‚ sentences.                          â”‚   â”‚
â”‚                                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                   â”‚                                           â”‚
â”‚                                   â”‚ [è¤‡è£½åˆ°å‰ªè²¼æ¿] [æ¸¬è©¦æç¤º]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**FastAPI å¯¦ç¾**:

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import yaml
import subprocess
from pathlib import Path
from datetime import datetime

router = APIRouter(prefix="/api/prompts", tags=["prompts"])

PROMPTS_DIR = Path("prompts/")

class PromptUpdateRequest(BaseModel):
    content: str  # YAML å…§å®¹
    commit_message: str = None  # å¯é¸æäº¤æ¶ˆæ¯

@router.get("/list")
async def list_prompts():
    """åˆ—å‡ºæ‰€æœ‰æç¤ºæ–‡ä»¶"""
    prompts = []
    
    for yaml_file in PROMPTS_DIR.rglob("*.yaml"):
        relative_path = yaml_file.relative_to(PROMPTS_DIR)
        
        # è®€å– YAML å…ƒæ•¸æ“š
        with open(yaml_file, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
        
        # Git æœ€å¾Œä¿®æ”¹æ™‚é–“
        git_log = subprocess.run(
            ["git", "log", "-1", "--format=%at|%an", str(yaml_file)],
            capture_output=True,
            text=True
        ).stdout.strip().split("|")
        
        prompts.append({
            "path": str(relative_path),
            "name": data.get("name", "Unnamed"),
            "version": data.get("version", "1.0"),
            "category": str(relative_path.parent),
            "last_modified": int(git_log[0]) if git_log else None,
            "last_author": git_log[1] if len(git_log) > 1 else "Unknown"
        })
    
    return {"prompts": prompts}

@router.get("/get/{path:path}")
async def get_prompt(path: str):
    """ç²å–æç¤ºæ–‡ä»¶å…§å®¹"""
    file_path = PROMPTS_DIR / path
    
    if not file_path.exists():
        raise HTTPException(status_code=404, detail="Prompt not found")
    
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    return {"content": content}

@router.post("/save/{path:path}")
async def save_prompt(path: str, request: PromptUpdateRequest):
    """ä¿å­˜æç¤ºæ–‡ä»¶ï¼ˆè‡ªå‹• Git commitï¼‰"""
    file_path = PROMPTS_DIR / path
    
    # 1. é©—è­‰ YAML èªæ³•
    try:
        yaml.safe_load(request.content)
    except yaml.YAMLError as e:
        raise HTTPException(status_code=400, detail=f"Invalid YAML: {str(e)}")
    
    # 2. å¯«å…¥æ–‡ä»¶
    file_path.parent.mkdir(parents=True, exist_ok=True)
    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(request.content)
    
    # 3. Git commit + push
    commit_message = request.commit_message or f"Update prompt: {path}"
    
    subprocess.run(["git", "add", str(file_path)], check=True)
    subprocess.run(
        ["git", "commit", "-m", commit_message],
        check=True
    )
    subprocess.run(["git", "push"], check=True)
    
    return {"message": "Prompt saved successfully", "path": path}

@router.get("/history/{path:path}")
async def get_prompt_history(path: str, limit: int = 10):
    """ç²å–æç¤ºè®Šæ›´æ­·å²"""
    file_path = PROMPTS_DIR / path
    
    if not file_path.exists():
        raise HTTPException(status_code=404, detail="Prompt not found")
    
    # Git log
    git_log = subprocess.run(
        [
            "git", "log",
            f"-{limit}",
            "--format=%H|%at|%an|%s",
            str(file_path)
        ],
        capture_output=True,
        text=True
    ).stdout.strip().split("\n")
    
    history = []
    for line in git_log:
        if not line:
            continue
        
        commit_hash, timestamp, author, message = line.split("|", 3)
        history.append({
            "commit": commit_hash,
            "timestamp": int(timestamp),
            "author": author,
            "message": message
        })
    
    return {"history": history}

@router.post("/preview")
async def preview_prompt(yaml_content: str, variables: dict):
    """é è¦½æ¸²æŸ“å¾Œçš„æç¤º"""
    # è§£æ YAML
    data = yaml.safe_load(yaml_content)
    
    # ç²å–ç¬¬ä¸€å€‹è®Šé«”çš„æ¨¡æ¿
    template_str = data["variants"][0]["template"]
    
    # Jinja2 æ¸²æŸ“
    from jinja2 import Template
    template = Template(template_str)
    rendered = template.render(**variables)
    
    return {"rendered": rendered}
```

**å®Œæˆå®šç¾©**:

- [ ] æç¤ºåˆ—è¡¨ APIï¼ˆæŒ‰å·¥ä½œæµåˆ†çµ„ï¼‰
- [ ] YAML ç·¨è¼¯å™¨ï¼ˆèªæ³•é«˜äº®ã€é©—è­‰ï¼‰
- [ ] å¯¦æ™‚é è¦½ï¼ˆJinja2 æ¸²æŸ“ï¼‰
- [ ] Git é›†æˆï¼ˆè‡ªå‹• commit + pushï¼‰
- [ ] ç‰ˆæœ¬æ­·å²æŸ¥è©¢ï¼ˆGit logï¼‰
- [ ] è®Šé‡æ ¡é©—ï¼ˆæª¢æ¸¬æœªå®šç¾©è®Šé‡ï¼‰

---

#### **US-F9-002: è®Šé‡æ›¿æ›èˆ‡ Jinja2 æ¨¡æ¿å¼•æ“**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1.5 å¤©  
**è¤‡é›œåº¦**: â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** Agent é–‹ç™¼è€…ï¼ˆDavid Kimï¼‰
- **æˆ‘æƒ³è¦** åœ¨æç¤ºä¸­ä½¿ç”¨å‹•æ…‹è®Šé‡ï¼ˆå¦‚ `{customer_name}`ï¼‰å’Œæ¢ä»¶é‚è¼¯ï¼ˆå¦‚ `{% if urgent %}`ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å‰µå»ºéˆæ´»çš„æç¤ºæ¨¡æ¿ï¼Œé©æ‡‰ä¸åŒå ´æ™¯

**é©—æ”¶æ¨™æº–**:

1. âœ… **åŸºç¤è®Šé‡æ›¿æ›**: æ”¯æŒ `{variable_name}` èªæ³•
2. âœ… **Jinja2 èªæ³•**: æ”¯æŒ `{% if %}`, `{% for %}`, `{{ variable | filter }}`
3. âœ… **éæ¿¾å™¨**: æ”¯æŒ `upper`, `lower`, `default`, `date_format` ç­‰
4. âœ… **æ¢ä»¶æ¸²æŸ“**: æ ¹æ“šè®Šé‡å€¼å‹•æ…‹ç”Ÿæˆæç¤ºå…§å®¹
5. âœ… **éŒ¯èª¤è™•ç†**: ç¼ºå¤±å¿…éœ€è®Šé‡æ™‚æ‹‹å‡ºæ¸…æ™°éŒ¯èª¤
6. âœ… **æ€§èƒ½**: æ¨¡æ¿ç·¨è­¯å¾Œç·©å­˜ï¼Œæ¸²æŸ“æ™‚é–“ <10ms

**Jinja2 æ¨¡æ¿ç¤ºä¾‹**:

```yaml
# prompts/customer_service/ticket_summary.yaml
version: "1.3"
name: "Ticket Summary with Conditional Logic"

variants:
  - id: "control"
    weight: 100
    template: |
      You are a customer service analyst. Summarize the following ticket:
      
      Ticket ID: {{ ticket_id }}
      Customer: {{ customer_name | upper }}
      Issue: {{ issue_description }}
      
      {% if priority == "urgent" %}
      âš ï¸ URGENT: This ticket requires immediate attention!
      {% endif %}
      
      {% if previous_tickets_count > 5 %}
      Note: This is a repeat customer with {{ previous_tickets_count }} previous tickets.
      {% endif %}
      
      Provide a concise summary in 2-3 sentences{% if priority == "urgent" %}, prioritizing immediate action items{% endif %}.

variables:
  ticket_id:
    type: "string"
    required: true
    example: "TICKET-1234"
  
  customer_name:
    type: "string"
    required: true
    example: "John Smith"
  
  issue_description:
    type: "string"
    required: true
    example: "Cannot access account after password reset"
  
  priority:
    type: "string"
    required: false
    default: "normal"
    enum: ["low", "normal", "high", "urgent"]
    example: "urgent"
  
  previous_tickets_count:
    type: "integer"
    required: false
    default: 0
    example: 8
```

**Python å¯¦ç¾**:

```python
from jinja2 import Template, TemplateSyntaxError, UndefinedError
from typing import Dict, Any
import yaml

class PromptRenderer:
    """æç¤ºæ¸²æŸ“å™¨ï¼ˆJinja2ï¼‰"""
    
    def __init__(self, prompt_yaml_path: str):
        with open(prompt_yaml_path, 'r', encoding='utf-8') as f:
            self.prompt_data = yaml.safe_load(f)
        
        # é ç·¨è­¯æ‰€æœ‰è®Šé«”æ¨¡æ¿
        self.compiled_templates = {}
        for variant in self.prompt_data.get("variants", []):
            variant_id = variant["id"]
            template_str = variant["template"]
            self.compiled_templates[variant_id] = Template(template_str)
    
    def render(
        self,
        variant_id: str = None,
        variables: Dict[str, Any] = None
    ) -> str:
        """
        æ¸²æŸ“æç¤ºæ¨¡æ¿
        
        åƒæ•¸:
            variant_id: è®Šé«” IDï¼ˆNone = ä½¿ç”¨ç¬¬ä¸€å€‹è®Šé«”ï¼‰
            variables: è®Šé‡å­—å…¸
        
        è¿”å›: æ¸²æŸ“å¾Œçš„æç¤ºæ–‡æœ¬
        """
        variables = variables or {}
        
        # 1. é¸æ“‡è®Šé«”
        if not variant_id:
            variant_id = self.prompt_data["variants"][0]["id"]
        
        if variant_id not in self.compiled_templates:
            raise ValueError(f"Variant not found: {variant_id}")
        
        # 2. é©—è­‰å¿…éœ€è®Šé‡
        self._validate_variables(variables)
        
        # 3. æ‡‰ç”¨é»˜èªå€¼
        variables_with_defaults = self._apply_defaults(variables)
        
        # 4. æ¸²æŸ“æ¨¡æ¿
        try:
            template = self.compiled_templates[variant_id]
            rendered = template.render(**variables_with_defaults)
            return rendered.strip()
        
        except UndefinedError as e:
            raise ValueError(f"Missing variable: {str(e)}")
        
        except TemplateSyntaxError as e:
            raise ValueError(f"Template syntax error: {str(e)}")
    
    def _validate_variables(self, variables: Dict[str, Any]):
        """é©—è­‰å¿…éœ€è®Šé‡"""
        var_schema = self.prompt_data.get("variables", {})
        
        for var_name, var_config in var_schema.items():
            if var_config.get("required", False):
                if var_name not in variables:
                    raise ValueError(
                        f"Missing required variable: {var_name}"
                    )
    
    def _apply_defaults(self, variables: Dict[str, Any]) -> Dict[str, Any]:
        """æ‡‰ç”¨é»˜èªå€¼"""
        var_schema = self.prompt_data.get("variables", {})
        result = variables.copy()
        
        for var_name, var_config in var_schema.items():
            if var_name not in result and "default" in var_config:
                result[var_name] = var_config["default"]
        
        return result


# ä½¿ç”¨ç¤ºä¾‹
renderer = PromptRenderer("prompts/customer_service/ticket_summary.yaml")

rendered_prompt = renderer.render(
    variant_id="control",
    variables={
        "ticket_id": "TICKET-5678",
        "customer_name": "Jane Doe",
        "issue_description": "Billing error - charged twice for same service",
        "priority": "urgent",
        "previous_tickets_count": 8
    }
)

print(rendered_prompt)
# è¼¸å‡º:
# You are a customer service analyst. Summarize the following ticket:
# 
# Ticket ID: TICKET-5678
# Customer: JANE DOE
# Issue: Billing error - charged twice for same service
# 
# âš ï¸ URGENT: This ticket requires immediate attention!
# 
# Note: This is a repeat customer with 8 previous tickets.
# 
# Provide a concise summary in 2-3 sentences, prioritizing immediate action items.
```

**å®Œæˆå®šç¾©**:

- [ ] Jinja2 æ¨¡æ¿å¼•æ“é›†æˆ
- [ ] è®Šé‡é©—è­‰ï¼ˆå¿…éœ€ vs å¯é¸ï¼‰
- [ ] é»˜èªå€¼æ‡‰ç”¨
- [ ] éæ¿¾å™¨æ”¯æŒï¼ˆupper, lower, date_formatï¼‰
- [ ] æ¢ä»¶é‚è¼¯ï¼ˆ{% if %}, {% for %}ï¼‰
- [ ] éŒ¯èª¤è™•ç†ï¼ˆæ¸…æ™°éŒ¯èª¤æ¶ˆæ¯ï¼‰

---

#### **US-F9-003: A/B æ¸¬è©¦èˆ‡æµé‡åˆ†é…**

**å„ªå…ˆç´š**: P1 (é‡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç”¢å“ç¶“ç†ï¼ˆMichael Tanï¼‰
- **æˆ‘æƒ³è¦** å°åŒä¸€æç¤ºå‰µå»ºå¤šå€‹è®Šé«”ï¼ˆVariant A/B/Cï¼‰ï¼Œä¸¦è‡ªå‹•åˆ†é…æµé‡é€²è¡Œ A/B æ¸¬è©¦
- **ä»¥ä¾¿** æˆ‘å¯ä»¥æ•¸æ“šé©…å‹•åœ°å„ªåŒ–æç¤ºï¼Œæ‰¾åˆ°æœ€ä½³ç‰ˆæœ¬

**é©—æ”¶æ¨™æº–**:

1. âœ… **å¤šè®Šé«”æ”¯æŒ**: ä¸€å€‹æç¤ºæ–‡ä»¶å¯åŒ…å«å¤šå€‹è®Šé«”ï¼ˆVariantï¼‰
2. âœ… **æµé‡æ¬Šé‡**: é…ç½®æ¯å€‹è®Šé«”çš„æµé‡ç™¾åˆ†æ¯”ï¼ˆå¦‚ A=50%, B=30%, C=20%ï¼‰
3. âœ… **éš¨æ©Ÿåˆ†é…**: æ ¹æ“šæ¬Šé‡éš¨æ©Ÿé¸æ“‡è®Šé«”ï¼ˆä½¿ç”¨åŸ·è¡Œ ID ä½œç‚ºç¨®å­ï¼‰
4. âœ… **ä½¿ç”¨è¿½è¹¤**: è¨˜éŒ„æ¯æ¬¡æç¤ºèª¿ç”¨ä½¿ç”¨äº†å“ªå€‹è®Šé«”
5. âœ… **çµæœå„€è¡¨æ¿**: æ¯”è¼ƒä¸åŒè®Šé«”çš„æˆåŠŸç‡ã€åŸ·è¡Œæ™‚é–“ã€ç”¨æˆ¶è©•åˆ†
6. âœ… **è‡ªå‹•å‹å‡º**: é”åˆ°çµ±è¨ˆé¡¯è‘—æ€§å¾Œï¼Œè‡ªå‹•å°‡æµé‡åˆ‡æ›è‡³æœ€ä½³è®Šé«”

**A/B æ¸¬è©¦é…ç½®ç¤ºä¾‹**:

```yaml
# prompts/customer_service/refund_decision.yaml
version: "2.0"
name: "Refund Decision Prompt - A/B Test"
description: "Testing different approaches for refund decision making"

ab_test:
  enabled: true
  start_date: "2025-11-19"
  end_date: "2025-12-03"  # 2 é€±æ¸¬è©¦æœŸ
  minimum_samples: 100  # æ¯å€‹è®Šé«”è‡³å°‘ 100 æ¬¡èª¿ç”¨
  confidence_level: 0.95  # 95% ç½®ä¿¡åº¦

variants:
  - id: "control_strict"
    weight: 33
    description: "Baseline - strict refund policy"
    template: |
      You are a customer service analyst evaluating a refund request.
      
      Policy: Refunds are only approved if the product is defective or the order was cancelled within 24 hours.
      
      Request Details:
      - Customer: {{ customer_name }}
      - Order Date: {{ order_date }}
      - Refund Reason: {{ refund_reason }}
      - Product Condition: {{ product_condition }}
      
      Evaluate this request and respond with:
      1. Decision: APPROVE or DENY
      2. Reasoning: 1-2 sentences explaining your decision

  - id: "experiment_empathy"
    weight: 33
    description: "Experiment A - empathetic approach"
    template: |
      You are an empathetic customer service analyst evaluating a refund request.
      
      Policy: Refunds are generally approved if the customer is dissatisfied, unless there is clear evidence of abuse.
      
      Request Details:
      - Customer: {{ customer_name }}
      - Order Date: {{ order_date }}
      - Refund Reason: {{ refund_reason }}
      - Product Condition: {{ product_condition }}
      
      Consider the customer's frustration and evaluate this request with empathy.
      
      Respond with:
      1. Decision: APPROVE or DENY
      2. Reasoning: 1-2 sentences explaining your decision with a compassionate tone

  - id: "experiment_data_driven"
    weight: 34
    description: "Experiment B - data-driven approach"
    template: |
      You are a data-driven customer service analyst evaluating a refund request.
      
      Historical Data:
      - This customer's previous refund requests: {{ previous_refunds }}
      - Customer lifetime value (CLV): ${{ customer_clv }}
      - Average refund rate for this product: {{ product_refund_rate }}%
      
      Request Details:
      - Customer: {{ customer_name }}
      - Order Date: {{ order_date }}
      - Refund Reason: {{ refund_reason }}
      - Product Condition: {{ product_condition }}
      
      Use the historical data to make an informed decision that balances customer satisfaction with business profitability.
      
      Respond with:
      1. Decision: APPROVE or DENY
      2. Reasoning: 1-2 sentences explaining your decision with data points
      3. Risk Score: Low/Medium/High (likelihood of future refund abuse)

variables:
  customer_name:
    type: "string"
    required: true
  order_date:
    type: "string"
    required: true
  refund_reason:
    type: "string"
    required: true
  product_condition:
    type: "string"
    required: true
  previous_refunds:
    type: "integer"
    required: false
    default: 0
  customer_clv:
    type: "number"
    required: false
    default: 0
  product_refund_rate:
    type: "number"
    required: false
    default: 5.0

metrics:
  - name: "approval_rate"
    description: "Percentage of APPROVE decisions"
    target: 0.4  # æœŸæœ›æ‰¹å‡†ç‡ 40%
  
  - name: "customer_satisfaction"
    description: "Customer rating after refund decision (1-5)"
    target: 4.0  # æœŸæœ›è©•åˆ† 4.0+
  
  - name: "execution_time"
    description: "LLM execution time (seconds)"
    target: 3.0  # æœŸæœ› <3 ç§’
```

**Python å¯¦ç¾**:

```python
import random
import hashlib
from datetime import datetime
from typing import Dict, Any, Optional

class ABTestVariantSelector:
    """A/B æ¸¬è©¦è®Šé«”é¸æ“‡å™¨"""
    
    def __init__(self, prompt_data: dict):
        self.prompt_data = prompt_data
        self.variants = prompt_data.get("variants", [])
        self.ab_test_config = prompt_data.get("ab_test", {})
    
    def select_variant(self, execution_id: str) -> str:
        """
        é¸æ“‡è®Šé«”ï¼ˆåŸºæ–¼åŸ·è¡Œ ID çš„ç¢ºå®šæ€§éš¨æ©Ÿï¼‰
        
        åƒæ•¸:
            execution_id: åŸ·è¡Œ IDï¼ˆç”¨ä½œéš¨æ©Ÿç¨®å­ï¼‰
        
        è¿”å›: è®Šé«” ID
        """
        # 1. æª¢æŸ¥ A/B æ¸¬è©¦æ˜¯å¦å•Ÿç”¨
        if not self.ab_test_config.get("enabled", False):
            # æœªå•Ÿç”¨ A/B æ¸¬è©¦ - ä½¿ç”¨ç¬¬ä¸€å€‹è®Šé«”
            return self.variants[0]["id"]
        
        # 2. æª¢æŸ¥æ¸¬è©¦æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå…§
        start_date = datetime.fromisoformat(self.ab_test_config.get("start_date"))
        end_date = datetime.fromisoformat(self.ab_test_config.get("end_date"))
        now = datetime.utcnow()
        
        if not (start_date <= now <= end_date):
            # æ¸¬è©¦å·²çµæŸ - ä½¿ç”¨æ¬Šé‡æœ€é«˜çš„è®Šé«”
            return max(self.variants, key=lambda v: v["weight"])["id"]
        
        # 3. åŸºæ–¼åŸ·è¡Œ ID çš„ç¢ºå®šæ€§éš¨æ©Ÿé¸æ“‡
        # ä½¿ç”¨ execution_id çš„å“ˆå¸Œå€¼ä½œç‚ºéš¨æ©Ÿç¨®å­ï¼ˆç¢ºä¿åŒä¸€åŸ·è¡Œ ID ç¸½æ˜¯é¸æ“‡ç›¸åŒè®Šé«”ï¼‰
        hash_value = int(hashlib.md5(execution_id.encode()).hexdigest(), 16)
        random.seed(hash_value)
        
        # 4. æ ¹æ“šæ¬Šé‡é¸æ“‡è®Šé«”
        total_weight = sum(v["weight"] for v in self.variants)
        rand = random.randint(1, total_weight)
        
        cumulative_weight = 0
        for variant in self.variants:
            cumulative_weight += variant["weight"]
            if rand <= cumulative_weight:
                return variant["id"]
        
        # é»˜èªç¬¬ä¸€å€‹è®Šé«”ï¼ˆä¸æ‡‰åˆ°é”é€™è£¡ï¼‰
        return self.variants[0]["id"]


class PromptUsageLogger:
    """æç¤ºä½¿ç”¨æ—¥èªŒè¨˜éŒ„å™¨"""
    
    def __init__(self, db_session):
        self.db = db_session
    
    def log_usage(
        self,
        execution_id: str,
        prompt_name: str,
        variant_id: str,
        variables: Dict[str, Any],
        rendered_prompt: str
    ):
        """è¨˜éŒ„æç¤ºä½¿ç”¨"""
        log_entry = PromptUsageLog(
            execution_id=execution_id,
            prompt_name=prompt_name,
            prompt_version=prompt_data["version"],
            variant_id=variant_id,
            variables=variables,
            rendered_prompt=rendered_prompt,
            timestamp=datetime.utcnow()
        )
        
        self.db.add(log_entry)
        self.db.commit()
    
    def log_outcome(
        self,
        execution_id: str,
        outcome: str,  # "success", "error"
        execution_time: float,
        user_rating: Optional[int] = None
    ):
        """è¨˜éŒ„åŸ·è¡Œçµæœ"""
        log_entry = self.db.query(PromptUsageLog).filter_by(
            execution_id=execution_id
        ).first()
        
        if log_entry:
            log_entry.outcome = outcome
            log_entry.execution_time = execution_time
            log_entry.user_rating = user_rating
            self.db.commit()


# ä½¿ç”¨ç¤ºä¾‹
selector = ABTestVariantSelector(prompt_data)
variant_id = selector.select_variant(execution_id="exec_abc123")

renderer = PromptRenderer("prompts/customer_service/refund_decision.yaml")
rendered = renderer.render(variant_id=variant_id, variables=variables)

# è¨˜éŒ„ä½¿ç”¨
logger = PromptUsageLogger(db_session)
logger.log_usage(
    execution_id="exec_abc123",
    prompt_name="refund_decision",
    variant_id=variant_id,
    variables=variables,
    rendered_prompt=rendered
)
```

**A/B æ¸¬è©¦çµæœå„€è¡¨æ¿ UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ A/B æ¸¬è©¦: refund_decision                                    [å°å‡ºå ±å‘Š]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ“Š æ¸¬è©¦æ¦‚è¦½                                                                   â”‚
â”‚   æ¸¬è©¦æœŸé–“: 2025-11-19 è‡³ 2025-12-03 (14 å¤©)                                 â”‚
â”‚   ç‹€æ…‹: é€²è¡Œä¸­ (ç¬¬ 7 å¤©)                                                      â”‚
â”‚   ç¸½èª¿ç”¨æ¬¡æ•¸: 487                                                             â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ† è®Šé«”æ€§èƒ½æ¯”è¼ƒ                                                               â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è®Šé«”           â”‚ èª¿ç”¨æ¬¡æ•¸ â”‚ æ‰¹å‡†ç‡   â”‚ å®¢æˆ¶è©•åˆ† â”‚ åŸ·è¡Œæ™‚é–“ â”‚ å‹ç‡   â”‚   â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ â”‚
â”‚ â”‚ control_strictâ”‚ 161      â”‚ 32.3%    â”‚ 3.2 â­   â”‚ 2.8s     â”‚ 15%    â”‚   â”‚ â”‚
â”‚ â”‚ empathy       â”‚ 163      â”‚ 58.9% â†‘  â”‚ 4.5 â­â†‘  â”‚ 2.9s     â”‚ 75% ğŸ†â”‚   â”‚ â”‚
â”‚ â”‚ data_driven   â”‚ 163      â”‚ 45.4%    â”‚ 3.8 â­   â”‚ 3.1s     â”‚ 10%    â”‚   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“ˆ æ‰¹å‡†ç‡è¶¨å‹¢ï¼ˆæœ€è¿‘ 7 å¤©ï¼‰                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 60% â”‚                           â—â”€â—â”€â—                                   â”‚ â”‚
â”‚ â”‚ 50% â”‚                     â—â”€â—â”€â—                                         â”‚ â”‚
â”‚ â”‚ 40% â”‚               â—â”€â—â”€â—                                               â”‚ â”‚
â”‚ â”‚ 30% â”‚ â—â”€â—â”€â—â”€â—â”€â—â”€â—                                                       â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚       Day1  Day2  Day3  Day4  Day5  Day6  Day7                         â”‚ â”‚
â”‚ â”‚                                                                          â”‚ â”‚
â”‚ â”‚       â— control_strict  â— empathy  â— data_driven                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ ğŸ¯ çµ±è¨ˆé¡¯è‘—æ€§                                                                 â”‚
â”‚   âœ… empathy vs control_strict: p-value = 0.002 (é¡¯è‘—å·®ç•°ï¼Œ95% ç½®ä¿¡åº¦)      â”‚
â”‚   âš ï¸ data_driven vs control_strict: p-value = 0.08 (ç„¡é¡¯è‘—å·®ç•°)             â”‚
â”‚                                                                               â”‚
â”‚ ğŸ’¡ å»ºè­°                                                                       â”‚
â”‚   "empathy" è®Šé«”åœ¨æ‰¹å‡†ç‡å’Œå®¢æˆ¶è©•åˆ†ä¸Šé¡¯è‘—å„ªæ–¼å…¶ä»–è®Šé«”ã€‚å»ºè­°ï¼š                 â”‚
â”‚   1. å°‡ "empathy" æµé‡æ¬Šé‡æå‡è‡³ 80%                                         â”‚
â”‚   2. å†æ¸¬è©¦ 3-5 å¤©ä»¥ç¢ºèªçµæœç©©å®š                                             â”‚
â”‚   3. å¦‚æœçµæœæŒçºŒï¼Œè€ƒæ…®å°‡ "empathy" è¨­ç‚ºé»˜èªè®Šé«”                             â”‚
â”‚                                                                               â”‚
â”‚ [æå‡ empathy æµé‡] [çµæŸæ¸¬è©¦] [å°å‡ºè©³ç´°æ•¸æ“š]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Œæˆå®šç¾©**:

- [ ] è®Šé«”é¸æ“‡å™¨ï¼ˆåŸºæ–¼æ¬Šé‡çš„éš¨æ©Ÿåˆ†é…ï¼‰
- [ ] æç¤ºä½¿ç”¨æ—¥èªŒï¼ˆè¨˜éŒ„è®Šé«”ã€è®Šé‡ã€çµæœï¼‰
- [ ] A/B æ¸¬è©¦å„€è¡¨æ¿ï¼ˆæ€§èƒ½æ¯”è¼ƒï¼‰
- [ ] çµ±è¨ˆé¡¯è‘—æ€§æª¢é©—ï¼ˆp-value è¨ˆç®—ï¼‰
- [ ] è‡ªå‹•å‹å‡ºæ¨è–¦
- [ ] æµé‡æ¬Šé‡å‹•æ…‹èª¿æ•´

---

#### **US-F9-004: æç¤ºç†±é‡è¼‰èˆ‡ç·©å­˜**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1.5 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** é‹ç¶­å·¥ç¨‹å¸«ï¼ˆEmily Rodriguezï¼‰
- **æˆ‘æƒ³è¦** æç¤ºè®Šæ›´å¾Œç„¡éœ€é‡å•Ÿæœå‹™å³å¯è‡ªå‹•ç”Ÿæ•ˆ
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¿«é€Ÿéƒ¨ç½²æç¤ºå„ªåŒ–ï¼Œé›¶åœæ©Ÿæ™‚é–“

**é©—æ”¶æ¨™æº–**:

1. âœ… **å®šæ™‚æ‹‰å–**: æ¯ 5 ç§’å¾ Git å€‰åº«æ‹‰å–æœ€æ–°æç¤º
2. âœ… **Redis ç·©å­˜**: ç·©å­˜æ¸²æŸ“å¾Œçš„æç¤ºï¼ˆTTL 5 ç§’ï¼‰
3. âœ… **è®Šæ›´æª¢æ¸¬**: æª¢æ¸¬ Git commit è®Šæ›´ï¼Œåªé‡è¼‰è®Šæ›´çš„æ–‡ä»¶
4. âœ… **åŸå­æ›´æ–°**: æç¤ºæ›´æ–°éç¨‹ä¸­ï¼ŒèˆŠç‰ˆæœ¬ä»å¯ç”¨ï¼ˆç„¡ä¸­æ–·ï¼‰
5. âœ… **å¥åº·æª¢æŸ¥**: é©—è­‰æ–°æç¤º YAML èªæ³•æ­£ç¢ºå¾Œæ‰æ‡‰ç”¨
6. âœ… **é€šçŸ¥**: æç¤ºé‡è¼‰æˆåŠŸ/å¤±æ•—æ™‚é€šé Teams é€šçŸ¥

**Python å¯¦ç¾**:

```python
import time
import subprocess
import yaml
from pathlib import Path
from threading import Thread
from typing import Dict
from redis import Redis
import logging

logger = logging.getLogger(__name__)

class PromptHotReloader:
    """æç¤ºç†±é‡è¼‰æœå‹™"""
    
    def __init__(
        self,
        prompts_dir: Path,
        redis_client: Redis,
        reload_interval: int = 5
    ):
        self.prompts_dir = prompts_dir
        self.redis = redis_client
        self.reload_interval = reload_interval
        
        # ç•¶å‰åŠ è¼‰çš„æç¤ºï¼ˆå…§å­˜ï¼‰
        self.loaded_prompts: Dict[str, dict] = {}
        
        # æœ€å¾Œä¸€æ¬¡ Git commit hash
        self.last_commit_hash = self._get_current_commit_hash()
        
        # å•Ÿå‹•å¾Œå°é‡è¼‰ç·šç¨‹
        self.reload_thread = Thread(target=self._reload_loop, daemon=True)
        self.reload_thread.start()
    
    def _get_current_commit_hash(self) -> str:
        """ç²å–ç•¶å‰ Git commit hash"""
        result = subprocess.run(
            ["git", "rev-parse", "HEAD"],
            cwd=self.prompts_dir,
            capture_output=True,
            text=True
        )
        return result.stdout.strip()
    
    def _reload_loop(self):
        """å¾Œå°é‡è¼‰å¾ªç’°"""
        while True:
            try:
                self._check_and_reload()
            except Exception as e:
                logger.error(f"Prompt reload failed: {e}")
            
            time.sleep(self.reload_interval)
    
    def _check_and_reload(self):
        """æª¢æŸ¥ä¸¦é‡è¼‰è®Šæ›´çš„æç¤º"""
        # 1. Git pull
        subprocess.run(
            ["git", "pull"],
            cwd=self.prompts_dir,
            capture_output=True
        )
        
        # 2. æª¢æŸ¥ commit æ˜¯å¦è®Šæ›´
        current_commit = self._get_current_commit_hash()
        
        if current_commit == self.last_commit_hash:
            # æ²’æœ‰è®Šæ›´
            return
        
        logger.info(f"Detected prompt changes: {self.last_commit_hash} -> {current_commit}")
        
        # 3. ç²å–è®Šæ›´çš„æ–‡ä»¶åˆ—è¡¨
        changed_files = subprocess.run(
            [
                "git", "diff", "--name-only",
                self.last_commit_hash, current_commit
            ],
            cwd=self.prompts_dir,
            capture_output=True,
            text=True
        ).stdout.strip().split("\n")
        
        # 4. é‡è¼‰è®Šæ›´çš„ YAML æ–‡ä»¶
        reload_count = 0
        for file_path in changed_files:
            if not file_path.endswith(".yaml"):
                continue
            
            full_path = self.prompts_dir / file_path
            if not full_path.exists():
                # æ–‡ä»¶å·²åˆªé™¤
                self._unload_prompt(file_path)
                continue
            
            # é‡è¼‰æç¤º
            if self._reload_prompt(file_path):
                reload_count += 1
        
        # 5. æ›´æ–° last commit hash
        self.last_commit_hash = current_commit
        
        logger.info(f"Reloaded {reload_count} prompts successfully")
        
        # 6. ç™¼é€é€šçŸ¥ï¼ˆå¯é¸ï¼‰
        # await notification_service.send_teams_message(
        #     f"âœ… Prompts reloaded: {reload_count} files updated"
        # )
    
    def _reload_prompt(self, file_path: str) -> bool:
        """é‡è¼‰å–®å€‹æç¤ºæ–‡ä»¶"""
        full_path = self.prompts_dir / file_path
        
        try:
            # 1. è®€å–ä¸¦é©—è­‰ YAML
            with open(full_path, 'r', encoding='utf-8') as f:
                prompt_data = yaml.safe_load(f)
            
            # 2. é©—è­‰å¿…éœ€å­—æ®µ
            if "name" not in prompt_data or "variants" not in prompt_data:
                logger.error(f"Invalid prompt file: {file_path} (missing required fields)")
                return False
            
            # 3. æ›´æ–°å…§å­˜ä¸­çš„æç¤º
            self.loaded_prompts[file_path] = prompt_data
            
            # 4. æ¸…é™¤ Redis ç·©å­˜ï¼ˆå¼·åˆ¶é‡æ–°æ¸²æŸ“ï¼‰
            cache_key_pattern = f"prompt:{prompt_data['name']}:*"
            for key in self.redis.scan_iter(match=cache_key_pattern):
                self.redis.delete(key)
            
            logger.info(f"Reloaded prompt: {file_path}")
            return True
        
        except Exception as e:
            logger.error(f"Failed to reload prompt {file_path}: {e}")
            return False
    
    def _unload_prompt(self, file_path: str):
        """å¸è¼‰å·²åˆªé™¤çš„æç¤º"""
        if file_path in self.loaded_prompts:
            del self.loaded_prompts[file_path]
            logger.info(f"Unloaded deleted prompt: {file_path}")
    
    def get_prompt(self, prompt_name: str) -> dict:
        """ç²å–æç¤ºï¼ˆå¾å…§å­˜ï¼‰"""
        for prompt_data in self.loaded_prompts.values():
            if prompt_data["name"] == prompt_name:
                return prompt_data
        
        raise ValueError(f"Prompt not found: {prompt_name}")


# ä½¿ç”¨ç¤ºä¾‹
redis_client = Redis(host="localhost", port=6379, db=0)
reloader = PromptHotReloader(
    prompts_dir=Path("prompts/"),
    redis_client=redis_client,
    reload_interval=5
)

# æç¤ºæœƒè‡ªå‹•åœ¨å¾Œå°é‡è¼‰
# ç„¡éœ€æ‰‹å‹•èª¿ç”¨ä»»ä½•æ–¹æ³•
```

**Redis ç·©å­˜ç­–ç•¥**:

```python
import json
from redis import Redis
from typing import Optional

class PromptCache:
    """æç¤ºç·©å­˜ï¼ˆRedisï¼‰"""
    
    def __init__(self, redis_client: Redis, ttl: int = 5):
        self.redis = redis_client
        self.ttl = ttl  # ç·©å­˜ TTLï¼ˆç§’ï¼‰
    
    def get_cached_prompt(
        self,
        prompt_name: str,
        variant_id: str,
        variables: dict
    ) -> Optional[str]:
        """ç²å–ç·©å­˜çš„æ¸²æŸ“æç¤º"""
        cache_key = self._build_cache_key(prompt_name, variant_id, variables)
        cached = self.redis.get(cache_key)
        
        if cached:
            return cached.decode('utf-8')
        
        return None
    
    def cache_prompt(
        self,
        prompt_name: str,
        variant_id: str,
        variables: dict,
        rendered_prompt: str
    ):
        """ç·©å­˜æ¸²æŸ“å¾Œçš„æç¤º"""
        cache_key = self._build_cache_key(prompt_name, variant_id, variables)
        self.redis.setex(
            cache_key,
            self.ttl,
            rendered_prompt
        )
    
    def _build_cache_key(
        self,
        prompt_name: str,
        variant_id: str,
        variables: dict
    ) -> str:
        """æ§‹å»ºç·©å­˜éµ"""
        # ä½¿ç”¨è®Šé‡çš„å“ˆå¸Œå€¼é¿å…éµéé•·
        variables_hash = hashlib.md5(
            json.dumps(variables, sort_keys=True).encode()
        ).hexdigest()[:8]
        
        return f"prompt:{prompt_name}:{variant_id}:{variables_hash}"
```

**å®Œæˆå®šç¾©**:

- [ ] Git å®šæ™‚æ‹‰å–ï¼ˆæ¯ 5 ç§’ï¼‰
- [ ] è®Šæ›´æª¢æ¸¬ï¼ˆGit diffï¼‰
- [ ] YAML æ–‡ä»¶é©—è­‰ï¼ˆèªæ³•æª¢æŸ¥ï¼‰
- [ ] ç†±é‡è¼‰å¯¦ç¾ï¼ˆç„¡éœ€é‡å•Ÿï¼‰
- [ ] Redis ç·©å­˜ï¼ˆTTL 5 ç§’ï¼‰
- [ ] å¥åº·æª¢æŸ¥å’Œé€šçŸ¥

---

### 9.3 æ•¸æ“šåº«æ¶æ§‹

```sql
-- æç¤ºä½¿ç”¨æ—¥èªŒè¡¨
CREATE TABLE prompt_usage_logs (
    id SERIAL PRIMARY KEY,
    execution_id VARCHAR(100) NOT NULL,
    
    -- æç¤ºä¿¡æ¯
    prompt_name VARCHAR(200) NOT NULL,
    prompt_version VARCHAR(20),
    variant_id VARCHAR(50),
    
    -- è®Šé‡
    variables JSONB NOT NULL,
    rendered_prompt TEXT,
    
    -- åŸ·è¡Œçµæœ
    outcome VARCHAR(20),  -- success, error
    execution_time DECIMAL(10,3),  -- ç§’
    user_rating INTEGER,  -- 1-5 æ˜Ÿ
    
    -- æ™‚é–“æˆ³
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (execution_id) REFERENCES executions(execution_id)
);

CREATE INDEX idx_prompt_usage_prompt ON prompt_usage_logs(prompt_name, variant_id, timestamp DESC);
CREATE INDEX idx_prompt_usage_execution ON prompt_usage_logs(execution_id);

-- A/B æ¸¬è©¦çµæœçµ±è¨ˆè¡¨ï¼ˆç‰©åŒ–è¦–åœ–ï¼‰
CREATE MATERIALIZED VIEW prompt_ab_test_stats AS
SELECT
    prompt_name,
    variant_id,
    COUNT(*) as total_calls,
    
    -- æ‰¹å‡†ç‡ï¼ˆå‡è¨­æç¤ºè¼¸å‡ºåŒ…å« APPROVE/DENYï¼‰
    COUNT(*) FILTER (WHERE rendered_prompt LIKE '%APPROVE%') * 100.0 / COUNT(*) as approval_rate,
    
    -- å¹³å‡è©•åˆ†
    AVG(user_rating) as avg_rating,
    
    -- å¹³å‡åŸ·è¡Œæ™‚é–“
    AVG(execution_time) as avg_execution_time,
    
    -- æˆåŠŸç‡
    COUNT(*) FILTER (WHERE outcome = 'success') * 100.0 / COUNT(*) as success_rate,
    
    -- æ™‚é–“ç¯„åœ
    MIN(timestamp) as first_call,
    MAX(timestamp) as last_call
FROM prompt_usage_logs
GROUP BY prompt_name, variant_id;

CREATE UNIQUE INDEX idx_ab_test_stats ON prompt_ab_test_stats(prompt_name, variant_id);
```

---

### 9.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | æç¤ºæ¸²æŸ“æ™‚é–“ | <10msï¼ˆå«ç·©å­˜ï¼‰ | æ€§èƒ½ç›£æ§ |
| | Redis ç·©å­˜å‘½ä¸­ç‡ | â‰¥80% | Redis INFO çµ±è¨ˆ |
| **å¯é æ€§** | æç¤ºé‡è¼‰æˆåŠŸç‡ | â‰¥99% | é‡è¼‰æ—¥èªŒåˆ†æ |
| | YAML é©—è­‰æº–ç¢ºç‡ | 100%ï¼ˆé˜»æ­¢ç„¡æ•ˆæç¤ºï¼‰ | é©—è­‰æ¸¬è©¦ |
| **å¯ç”¨æ€§** | æç¤ºè®Šæ›´ç”Ÿæ•ˆæ™‚é–“ | <10 ç§’ï¼ˆé‡è¼‰é€±æœŸï¼‰ | ç«¯åˆ°ç«¯æ¸¬è©¦ |
| | ç†±é‡è¼‰é›¶åœæ©Ÿ | 100%ï¼ˆç„¡ä¸­æ–·ï¼‰ | å¯ç”¨æ€§ç›£æ§ |
| **å¯ç¶­è­·æ€§** | æç¤ºç‰ˆæœ¬å›æ»¾ | <5 åˆ†é˜ | Git æ“ä½œæ™‚é–“ |

---

### 9.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:

- Jinja2 è®Šé‡æ›¿æ›ï¼ˆåŒ…å«é»˜èªå€¼ã€éæ¿¾å™¨ï¼‰
- YAML é©—è­‰é‚è¼¯
- A/B æ¸¬è©¦è®Šé«”é¸æ“‡ï¼ˆæ¬Šé‡åˆ†é…ï¼‰
- Redis ç·©å­˜è®€å¯«

**é›†æˆæ¸¬è©¦**:

- ç«¯åˆ°ç«¯æç¤ºæ¸²æŸ“æµç¨‹
- Git æ‹‰å– + ç†±é‡è¼‰
- æç¤ºè®Šæ›´å¾Œç«‹å³ç”Ÿæ•ˆï¼ˆ<10 ç§’ï¼‰
- A/B æ¸¬è©¦æ—¥èªŒè¨˜éŒ„

**æ€§èƒ½æ¸¬è©¦**:

- 1000 æ¬¡/ç§’æç¤ºæ¸²æŸ“è«‹æ±‚ï¼ˆå«ç·©å­˜ï¼‰
- Redis ç·©å­˜å‘½ä¸­ç‡æ¸¬è©¦

---

### 9.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| ç„¡æ•ˆ YAML å°è‡´æœå‹™å´©æ½° | ä¸­ | é«˜ | åš´æ ¼ YAML é©—è­‰ + å¥åº·æª¢æŸ¥ |
| Git æ‹‰å–å¤±æ•— | ä½ | ä¸­ | é‡è©¦æ©Ÿåˆ¶ + ä½¿ç”¨ç·©å­˜çš„èˆŠç‰ˆæœ¬ |
| æç¤ºè®Šæ›´æœªæ¸¬è©¦å°±ä¸Šç·š | é«˜ | ä¸­ | å¼·åˆ¶ A/B æ¸¬è©¦æµç¨‹ + å¯©æŸ¥æ©Ÿåˆ¶ |
| Redis ç·©å­˜å¤±æ•ˆå°è‡´æ€§èƒ½ä¸‹é™ | ä½ | ä½ | é™ç´šè‡³ç„¡ç·©å­˜æ¨¡å¼ï¼ˆæ€§èƒ½ç¨å·®ä½†å¯ç”¨ï¼‰ |

---

### 9.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **å¤šèªè¨€æç¤º**: æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™æ–‡æç¤ºï¼ˆåŸºæ–¼ç”¨æˆ¶èªè¨€è‡ªå‹•é¸æ“‡ï¼‰
2. **æç¤ºå„ªåŒ–å»ºè­°**: ä½¿ç”¨ LLM åˆ†ææç¤ºæ•ˆæœï¼Œè‡ªå‹•å»ºè­°å„ªåŒ–
3. **æç¤ºç‰‡æ®µåº«**: å¯é‡ç”¨çš„æç¤ºç‰‡æ®µï¼ˆå¦‚ã€Œå®¢æˆ¶æœå‹™èªæ°£ã€ã€ã€ŒæŠ€è¡“æ–‡æª”æ ¼å¼ã€ï¼‰
4. **å¯è¦–åŒ–æç¤ºç·¨è¼¯å™¨**: æ‹–æ‹½å¼æç¤ºæ§‹å»ºå™¨ï¼ˆç„¡éœ€ç·¨å¯« YAMLï¼‰
5. **æç¤ºæ²™ç›’æ¸¬è©¦**: åœ¨ç”Ÿç”¢ç’°å¢ƒå‰é€²è¡Œå®‰å…¨æ¸¬è©¦

---

**âœ… F9 å®Œæˆ**ï¼šæç¤ºç®¡ç†ï¼ˆYAML æ¨¡æ¿ï¼‰åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f10-audit-trail"></a>F10. å¯©è¨ˆè¿½è¹¤ï¼ˆè¿½åŠ å¼æ—¥èªŒï¼‰

**åŠŸèƒ½é¡åˆ¥**: Observability (å¯è§€å¯Ÿæ€§)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1 é€±  
**è¤‡é›œåº¦**: â­â­â­

---

### 10.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F10ï¼ˆå¯©è¨ˆè¿½è¹¤ï¼‰æä¾›**ä¸å¯ç¯¡æ”¹çš„è¿½åŠ å¼æ—¥èªŒç³»çµ±**ï¼Œè¨˜éŒ„æ‰€æœ‰ç”¨æˆ¶æ“ä½œã€é…ç½®è®Šæ›´ã€åŸ·è¡Œçµæœï¼Œç”¨æ–¼åˆè¦å¯©è¨ˆã€å®‰å…¨èª¿æŸ¥ã€å•é¡Œæ’æŸ¥ã€‚æ‰€æœ‰æ—¥èªŒæŒ‰æ™‚é–“é †åºå­˜å„²ï¼Œæ”¯æŒå…¨æ–‡æœç´¢å’Œé«˜ç´šéæ¿¾ã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **åˆè¦è¦æ±‚**: SOXã€GDPRã€HIPAA ç­‰æ³•è¦è¦æ±‚å®Œæ•´çš„å¯©è¨ˆæ—¥èªŒ
- **å®‰å…¨èª¿æŸ¥**: å¿«é€Ÿè¿½æº¯å¯ç–‘æ“ä½œï¼ˆå¦‚æœªæˆæ¬Šè¨ªå•ã€é…ç½®ç¯¡æ”¹ï¼‰
- **å•é¡Œæ’æŸ¥**: é‡ç¾å•é¡Œç¾å ´ï¼Œåˆ†æåŸ·è¡Œå¤±æ•—çš„æ ¹æœ¬åŸå› 
- **è²¬ä»»è¿½è¹¤**: æ˜ç¢ºæ¯å€‹æ“ä½œçš„åŸ·è¡Œè€…å’Œæ™‚é–“

**æ ¸å¿ƒèƒ½åŠ›**:
1. **è¿½åŠ å¼å­˜å„²**: æ—¥èªŒåªèƒ½å¯«å…¥ï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆªé™¤ï¼ˆé˜²ç¯¡æ”¹ï¼‰
2. **å®Œæ•´è¨˜éŒ„**: æ“ä½œå‰/å¾Œç‹€æ…‹å¿«ç…§ã€ç”¨æˆ¶èº«ä»½ã€IP åœ°å€ã€æ™‚é–“æˆ³
3. **åˆ†é¡å­˜å„²**: ç”¨æˆ¶æ“ä½œã€ç³»çµ±äº‹ä»¶ã€åŸ·è¡Œæ—¥èªŒã€é…ç½®è®Šæ›´
4. **å…¨æ–‡æœç´¢**: Elasticsearch æ”¯æŒå¿«é€Ÿæœç´¢ï¼ˆé—œéµè©ã€æ™‚é–“ç¯„åœã€ç”¨æˆ¶ï¼‰
5. **è‡ªå‹•æ­¸æª”**: 90 å¤©å¾Œè‡ªå‹•æ­¸æª”è‡³å†·å­˜å„²ï¼ˆS3/Azure Blobï¼‰
6. **å®Œæ•´æ€§æ ¡é©—**: SHA-256 å“ˆå¸Œéˆç¢ºä¿æ—¥èªŒæœªè¢«ç¯¡æ”¹

**æ¥­å‹™åƒ¹å€¼**:
- **åˆè¦æˆæœ¬**: æ¸›å°‘å¯©è¨ˆæº–å‚™æ™‚é–“ 80%ï¼ˆå¾ 5 å¤©é™è‡³ 1 å¤©ï¼‰
- **å®‰å…¨äº‹ä»¶éŸ¿æ‡‰**: å¾ 4 å°æ™‚ç¸®çŸ­è‡³ 30 åˆ†é˜
- **å•é¡Œæ’æŸ¥**: å¹³å‡å®šä½æ™‚é–“å¾ 2 å°æ™‚é™è‡³ 15 åˆ†é˜

**æ¶æ§‹åœ–**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        F10. å¯©è¨ˆè¿½è¹¤æ¶æ§‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      æ‡‰ç”¨å±¤ï¼ˆæ‰€æœ‰æ“ä½œï¼‰                         â”‚
   â”‚  â€¢ ç”¨æˆ¶æ“ä½œï¼ˆç™»éŒ„ã€å‰µå»ºå·¥ä½œæµã€ä¿®æ”¹é…ç½®ï¼‰                      â”‚
   â”‚  â€¢ ç³»çµ±äº‹ä»¶ï¼ˆåŸ·è¡Œé–‹å§‹ã€åŸ·è¡Œå®Œæˆã€éŒ¯èª¤ï¼‰                        â”‚
   â”‚  â€¢ API èª¿ç”¨ï¼ˆæ‰€æœ‰ REST API è«‹æ±‚ï¼‰                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ è¨˜éŒ„å¯©è¨ˆäº‹ä»¶
                           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    å¯©è¨ˆæ—¥èªŒæœå‹™                                 â”‚
   â”‚  â€¢ é©—è­‰äº‹ä»¶æ ¼å¼                                                 â”‚
   â”‚  â€¢ æ·»åŠ å…ƒæ•¸æ“šï¼ˆIPã€User-Agentã€æ™‚é–“æˆ³ï¼‰                        â”‚
   â”‚  â€¢ è¨ˆç®—å“ˆå¸Œéˆï¼ˆé˜²ç¯¡æ”¹ï¼‰                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å¯«å…¥                       â”‚ å¯«å…¥
           â†“                            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PostgreSQL   â”‚            â”‚ Elasticsearchâ”‚
   â”‚ (çµæ§‹åŒ–å­˜å„²) â”‚            â”‚ (å…¨æ–‡æœç´¢)  â”‚
   â”‚ audit_logs   â”‚            â”‚ audit-logs-* â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                            â”‚
          â”‚ 90 å¤©å¾Œæ­¸æª”                â”‚ æŸ¥è©¢
          â†“                            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ S3 / Azure   â”‚            â”‚ Web UI       â”‚
   â”‚ Blob Storage â”‚            â”‚ (å¯©è¨ˆæŸ¥è©¢)  â”‚
   â”‚ (å†·å­˜å„²)     â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 10.2 ç”¨æˆ¶æ•…äº‹

#### **US-F10-001: ç”¨æˆ¶æ“ä½œæ—¥èªŒè¨˜éŒ„**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** å®‰å…¨ç®¡ç†å“¡ï¼ˆTom Wangï¼‰
- **æˆ‘æƒ³è¦** è¨˜éŒ„æ‰€æœ‰ç”¨æˆ¶æ“ä½œï¼ˆç™»éŒ„ã€å‰µå»º/ä¿®æ”¹/åˆªé™¤è³‡æºï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥åœ¨å®‰å…¨äº‹ä»¶ç™¼ç”Ÿæ™‚è¿½æº¯å¯ç–‘æ“ä½œ

**é©—æ”¶æ¨™æº–**:

1. âœ… **ç™»éŒ„æ—¥èªŒ**: è¨˜éŒ„æˆåŠŸ/å¤±æ•—çš„ç™»éŒ„å˜—è©¦ï¼ˆç”¨æˆ¶åã€IPã€æ™‚é–“ï¼‰
2. âœ… **CRUD æ“ä½œ**: è¨˜éŒ„æ‰€æœ‰å‰µå»º/ä¿®æ”¹/åˆªé™¤æ“ä½œï¼ˆå·¥ä½œæµã€æç¤ºã€Agentï¼‰
3. âœ… **æ“ä½œå‰/å¾Œå¿«ç…§**: ä¿å­˜è³‡æºè®Šæ›´å‰å¾Œçš„å®Œæ•´ç‹€æ…‹
4. âœ… **ç”¨æˆ¶èº«ä»½**: è¨˜éŒ„æ“ä½œè€…çš„ç”¨æˆ¶ IDã€ç”¨æˆ¶åã€è§’è‰²
5. âœ… **è«‹æ±‚ä¸Šä¸‹æ–‡**: IP åœ°å€ã€User-Agentã€è«‹æ±‚ ID
6. âœ… **æ•æ„Ÿæ•¸æ“šè„«æ•**: å¯†ç¢¼ã€API Key ç­‰æ•æ„Ÿå­—æ®µè‡ªå‹•è„«æ•

**å¯©è¨ˆæ—¥èªŒæ•¸æ“šçµæ§‹**:

```json
{
  "id": "audit_abc123",
  "timestamp": "2025-11-19T10:30:45.123Z",
  "event_type": "workflow.update",
  "category": "user_operation",
  "severity": "info",
  
  "actor": {
    "user_id": "user_001",
    "username": "sarah.lin@company.com",
    "role": "admin",
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
  },
  
  "resource": {
    "type": "workflow",
    "id": "wf_customer_360",
    "name": "Customer 360 View"
  },
  
  "action": "update",
  "result": "success",
  
  "changes": {
    "before": {
      "status": "active",
      "max_retries": 3,
      "timeout": 300
    },
    "after": {
      "status": "active",
      "max_retries": 5,
      "timeout": 600
    },
    "diff": {
      "max_retries": {"old": 3, "new": 5},
      "timeout": {"old": 300, "new": 600}
    }
  },
  
  "metadata": {
    "request_id": "req_xyz789",
    "session_id": "sess_abc456",
    "correlation_id": "corr_def789"
  },
  
  "hash": "a1b2c3d4e5f6...",
  "previous_hash": "f6e5d4c3b2a1..."
}
```

**Python å¯¦ç¾**:

```python
from fastapi import Request
from datetime import datetime
import hashlib
import json
from typing import Optional, Dict, Any

class AuditLogger:
    """å¯©è¨ˆæ—¥èªŒè¨˜éŒ„å™¨"""
    
    def __init__(self, db_session, es_client):
        self.db = db_session
        self.es = es_client
        self.last_hash = self._get_last_hash()
    
    async def log_user_operation(
        self,
        request: Request,
        event_type: str,
        resource_type: str,
        resource_id: str,
        action: str,
        result: str,
        changes: Optional[Dict[str, Any]] = None,
        error: Optional[str] = None
    ):
        """è¨˜éŒ„ç”¨æˆ¶æ“ä½œ"""
        
        # 1. æ§‹å»ºå¯©è¨ˆäº‹ä»¶
        audit_event = {
            "id": f"audit_{self._generate_id()}",
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": event_type,
            "category": "user_operation",
            "severity": "error" if result == "failure" else "info",
            
            "actor": {
                "user_id": request.state.user.id,
                "username": request.state.user.username,
                "role": request.state.user.role,
                "ip_address": request.client.host,
                "user_agent": request.headers.get("User-Agent")
            },
            
            "resource": {
                "type": resource_type,
                "id": resource_id
            },
            
            "action": action,
            "result": result,
            
            "changes": self._sanitize_sensitive_data(changes) if changes else None,
            "error": error,
            
            "metadata": {
                "request_id": request.state.request_id,
                "session_id": request.state.session_id
            }
        }
        
        # 2. è¨ˆç®—å“ˆå¸Œéˆ
        audit_event["previous_hash"] = self.last_hash
        audit_event["hash"] = self._calculate_hash(audit_event)
        self.last_hash = audit_event["hash"]
        
        # 3. å¯«å…¥ PostgreSQLï¼ˆçµæ§‹åŒ–å­˜å„²ï¼‰
        await self._write_to_postgres(audit_event)
        
        # 4. å¯«å…¥ Elasticsearchï¼ˆå…¨æ–‡æœç´¢ï¼‰
        await self._write_to_elasticsearch(audit_event)
    
    def _sanitize_sensitive_data(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """è„«æ•æ•æ„Ÿæ•¸æ“š"""
        sensitive_fields = ["password", "api_key", "secret", "token"]
        
        sanitized = data.copy()
        for key, value in sanitized.items():
            if any(field in key.lower() for field in sensitive_fields):
                sanitized[key] = "***REDACTED***"
        
        return sanitized
    
    def _calculate_hash(self, event: Dict[str, Any]) -> str:
        """è¨ˆç®—äº‹ä»¶å“ˆå¸Œ"""
        # æ’é™¤å“ˆå¸Œå­—æ®µæœ¬èº«
        event_copy = {k: v for k, v in event.items() if k not in ["hash", "previous_hash"]}
        event_json = json.dumps(event_copy, sort_keys=True)
        return hashlib.sha256(event_json.encode()).hexdigest()
```

**å®Œæˆå®šç¾©**:

- [ ] ç”¨æˆ¶æ“ä½œæ””æˆªå™¨ï¼ˆFastAPI Middlewareï¼‰
- [ ] å¯©è¨ˆäº‹ä»¶æ•¸æ“šæ¨¡å‹
- [ ] æ•æ„Ÿæ•¸æ“šè„«æ•é‚è¼¯
- [ ] PostgreSQL + Elasticsearch é›™å¯«
- [ ] å“ˆå¸Œéˆè¨ˆç®—ï¼ˆé˜²ç¯¡æ”¹ï¼‰

---

#### **US-F10-002: åŸ·è¡Œæ—¥èªŒè¿½è¹¤**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** DevOps å·¥ç¨‹å¸«ï¼ˆLisa Chenï¼‰
- **æˆ‘æƒ³è¦** è¨˜éŒ„æ‰€æœ‰å·¥ä½œæµåŸ·è¡Œçš„è©³ç´°æ—¥èªŒï¼ˆé–‹å§‹ã€æ­¥é©Ÿã€å®Œæˆã€éŒ¯èª¤ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¿«é€Ÿå®šä½åŸ·è¡Œå¤±æ•—çš„æ ¹æœ¬åŸå› 

**é©—æ”¶æ¨™æº–**:

1. âœ… **åŸ·è¡Œé–‹å§‹/çµæŸ**: è¨˜éŒ„åŸ·è¡Œ IDã€å·¥ä½œæµã€è¼¸å…¥ã€è¼¸å‡º
2. âœ… **æ­¥é©Ÿç´šæ—¥èªŒ**: è¨˜éŒ„æ¯å€‹ Agent æ­¥é©Ÿçš„é–‹å§‹/çµæŸæ™‚é–“ã€è€—æ™‚
3. âœ… **LLM èª¿ç”¨æ—¥èªŒ**: è¨˜éŒ„æç¤ºã€éŸ¿æ‡‰ã€Token æ•¸é‡ã€æˆæœ¬
4. âœ… **éŒ¯èª¤å †æ£§**: å®Œæ•´çš„éŒ¯èª¤å †æ£§è¿½è¹¤
5. âœ… **é—œè¯ ID**: æ”¯æŒè·¨æœå‹™è¿½è¹¤ï¼ˆCorrelation IDï¼‰
6. âœ… **æ€§èƒ½æŒ‡æ¨™**: æ¯å€‹æ­¥é©Ÿçš„åŸ·è¡Œæ™‚é–“ã€å…§å­˜ä½¿ç”¨

**åŸ·è¡Œæ—¥èªŒçµæ§‹**:

```json
{
  "id": "audit_exec_001",
  "timestamp": "2025-11-19T10:35:22.456Z",
  "event_type": "execution.step.completed",
  "category": "execution_log",
  "severity": "info",
  
  "execution": {
    "execution_id": "exec_abc123",
    "workflow_id": "wf_customer_360",
    "workflow_name": "Customer 360 View",
    "correlation_id": "corr_xyz789"
  },
  
  "step": {
    "step_id": "step_002",
    "step_name": "query_servicenow",
    "agent_id": "agent_servicenow_query",
    "status": "completed",
    "start_time": "2025-11-19T10:35:20.123Z",
    "end_time": "2025-11-19T10:35:22.456Z",
    "duration_ms": 2333
  },
  
  "llm_call": {
    "model": "gpt-4",
    "prompt_tokens": 450,
    "completion_tokens": 180,
    "total_tokens": 630,
    "cost_usd": 0.0189,
    "latency_ms": 1850
  },
  
  "output": {
    "ticket_count": 15,
    "high_priority_count": 3
  },
  
  "metadata": {
    "memory_mb": 128,
    "cpu_percent": 15.3
  }
}
```

**å®Œæˆå®šç¾©**:

- [ ] åŸ·è¡Œæ­¥é©Ÿæ—¥èªŒè¨˜éŒ„
- [ ] LLM èª¿ç”¨è¿½è¹¤
- [ ] éŒ¯èª¤å †æ£§æ•ç²
- [ ] æ€§èƒ½æŒ‡æ¨™æ”¶é›†
- [ ] é—œè¯ ID å‚³æ’­

---

#### **US-F10-003: å¯©è¨ˆæ—¥èªŒå…¨æ–‡æœç´¢**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** åˆè¦å¯©è¨ˆå“¡ï¼ˆRachel Kimï¼‰
- **æˆ‘æƒ³è¦** ä½¿ç”¨é—œéµè©ã€æ™‚é–“ç¯„åœã€ç”¨æˆ¶ç­‰æ¢ä»¶å¿«é€Ÿæœç´¢å¯©è¨ˆæ—¥èªŒ
- **ä»¥ä¾¿** æˆ‘å¯ä»¥åœ¨å¯©è¨ˆæ™‚å¿«é€Ÿæ‰¾åˆ°ç›¸é—œæ“ä½œè¨˜éŒ„

**é©—æ”¶æ¨™æº–**:

1. âœ… **å…¨æ–‡æœç´¢**: æ”¯æŒé—œéµè©æœç´¢ï¼ˆå¦‚ "delete workflow"ï¼‰
2. âœ… **å¤šç¶­éæ¿¾**: æŒ‰æ™‚é–“ç¯„åœã€ç”¨æˆ¶ã€è³‡æºé¡å‹ã€æ“ä½œé¡å‹éæ¿¾
3. âœ… **é«˜ç´šæŸ¥è©¢**: æ”¯æŒå¸ƒæ—é‹ç®—ï¼ˆANDã€ORã€NOTï¼‰
4. âœ… **å¿«é€ŸéŸ¿æ‡‰**: æœç´¢ 100 è¬æ¢æ—¥èªŒ <500ms
5. âœ… **çµæœé«˜äº®**: æœç´¢çµæœä¸­é—œéµè©é«˜äº®é¡¯ç¤º
6. âœ… **å°å‡ºå ±å‘Š**: æ”¯æŒå°å‡ºç‚º CSVã€JSONã€PDF

**å¯©è¨ˆæ—¥èªŒæœç´¢ UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯©è¨ˆæ—¥èªŒ                                           [å°å‡ºå ±å‘Š â–¼] [é«˜ç´šæœç´¢]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ” æœç´¢                                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ delete workflow                                             [æœç´¢]    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“… æ™‚é–“ç¯„åœ:  [æœ€è¿‘ 7 å¤© â–¼]  è‡ªå®šç¾©: [2025-11-12] è‡³ [2025-11-19]          â”‚
â”‚                                                                               â”‚
â”‚ ğŸ‘¤ ç”¨æˆ¶:      [æ‰€æœ‰ç”¨æˆ¶ â–¼]  æˆ–è¼¸å…¥: [________________]                       â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“¦ è³‡æºé¡å‹:  â˜‘ å·¥ä½œæµ  â˜‘ Agent  â˜‘ æç¤º  â˜‘ åŸ·è¡Œ  â˜ å…¶ä»–                    â”‚
â”‚                                                                               â”‚
â”‚ ğŸ¯ æ“ä½œé¡å‹:  â˜‘ å‰µå»º  â˜‘ ä¿®æ”¹  â˜‘ åˆªé™¤  â˜‘ åŸ·è¡Œ  â˜ å…¶ä»–                        â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“Š åš´é‡ç¨‹åº¦:  â˜‘ Info  â˜‘ Warning  â˜‘ Error  â˜ Critical                        â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“‹ æœç´¢çµæœ (å…± 23 æ¢)                                    æŒ‰æ™‚é–“å€’åº â–¼       â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ—‘ï¸ 2025-11-19 14:30:22                                                  â”‚ â”‚
â”‚ â”‚ sarah.lin@company.com **deleted** workflow "old_customer_sync"         â”‚ â”‚
â”‚ â”‚ IP: 192.168.1.100 | ID: wf_old_001 | çµæœ: æˆåŠŸ                        â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹è©³æƒ…]                                                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ—‘ï¸ 2025-11-18 09:15:33                                                  â”‚ â”‚
â”‚ â”‚ alex.chen@company.com **deleted** workflow "test_workflow_v1"          â”‚ â”‚
â”‚ â”‚ IP: 10.0.0.50 | ID: wf_test_v1 | çµæœ: æˆåŠŸ                            â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹è©³æƒ…]                                                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âš ï¸ 2025-11-17 16:45:10                                                   â”‚ â”‚
â”‚ â”‚ unknown.user **attempted to delete** workflow "production_workflow"    â”‚ â”‚
â”‚ â”‚ IP: 203.0.113.45 | ID: wf_prod_001 | çµæœ: å¤±æ•— (æ¬Šé™ä¸è¶³)             â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹è©³æƒ…] [æ¨™è¨˜ç‚ºå¯ç–‘]                                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ [è¼‰å…¥æ›´å¤š...]                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elasticsearch å¯¦ç¾**:

```python
from elasticsearch import Elasticsearch
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional

class AuditLogSearchService:
    """å¯©è¨ˆæ—¥èªŒæœç´¢æœå‹™"""
    
    def __init__(self, es_client: Elasticsearch):
        self.es = es_client
        self.index_pattern = "audit-logs-*"
    
    async def search(
        self,
        query: Optional[str] = None,
        start_time: Optional[datetime] = None,
        end_time: Optional[datetime] = None,
        users: Optional[List[str]] = None,
        resource_types: Optional[List[str]] = None,
        actions: Optional[List[str]] = None,
        severities: Optional[List[str]] = None,
        page: int = 1,
        page_size: int = 50
    ) -> Dict[str, Any]:
        """
        æœç´¢å¯©è¨ˆæ—¥èªŒ
        
        è¿”å›: {total: int, results: list, took_ms: int}
        """
        
        # æ§‹å»º Elasticsearch æŸ¥è©¢
        es_query = {
            "bool": {
                "must": [],
                "filter": []
            }
        }
        
        # 1. å…¨æ–‡æœç´¢
        if query:
            es_query["bool"]["must"].append({
                "multi_match": {
                    "query": query,
                    "fields": [
                        "event_type^2",
                        "action^2",
                        "actor.username",
                        "resource.name",
                        "changes.*",
                        "error"
                    ],
                    "type": "best_fields"
                }
            })
        
        # 2. æ™‚é–“ç¯„åœ
        if start_time or end_time:
            time_range = {}
            if start_time:
                time_range["gte"] = start_time.isoformat()
            if end_time:
                time_range["lte"] = end_time.isoformat()
            
            es_query["bool"]["filter"].append({
                "range": {"timestamp": time_range}
            })
        
        # 3. ç”¨æˆ¶éæ¿¾
        if users:
            es_query["bool"]["filter"].append({
                "terms": {"actor.username": users}
            })
        
        # 4. è³‡æºé¡å‹éæ¿¾
        if resource_types:
            es_query["bool"]["filter"].append({
                "terms": {"resource.type": resource_types}
            })
        
        # 5. æ“ä½œé¡å‹éæ¿¾
        if actions:
            es_query["bool"]["filter"].append({
                "terms": {"action": actions}
            })
        
        # 6. åš´é‡ç¨‹åº¦éæ¿¾
        if severities:
            es_query["bool"]["filter"].append({
                "terms": {"severity": severities}
            })
        
        # åŸ·è¡Œæœç´¢
        response = self.es.search(
            index=self.index_pattern,
            body={
                "query": es_query,
                "sort": [{"timestamp": "desc"}],
                "from": (page - 1) * page_size,
                "size": page_size,
                "highlight": {
                    "fields": {
                        "*": {}
                    }
                }
            }
        )
        
        return {
            "total": response["hits"]["total"]["value"],
            "results": [hit["_source"] for hit in response["hits"]["hits"]],
            "highlights": [hit.get("highlight", {}) for hit in response["hits"]["hits"]],
            "took_ms": response["took"]
        }
    
    async def export(
        self,
        format: str,  # csv, json, pdf
        **search_params
    ) -> bytes:
        """å°å‡ºå¯©è¨ˆæ—¥èªŒå ±å‘Š"""
        
        # æœç´¢æ‰€æœ‰çµæœï¼ˆç„¡åˆ†é é™åˆ¶ï¼‰
        results = await self.search(**search_params, page_size=10000)
        
        if format == "csv":
            return self._export_csv(results["results"])
        elif format == "json":
            return self._export_json(results["results"])
        elif format == "pdf":
            return self._export_pdf(results["results"])
        else:
            raise ValueError(f"Unsupported format: {format}")
    
    def _export_csv(self, results: List[Dict]) -> bytes:
        """å°å‡ºç‚º CSV"""
        import csv
        from io import StringIO
        
        output = StringIO()
        writer = csv.DictWriter(output, fieldnames=[
            "timestamp", "user", "action", "resource_type", 
            "resource_id", "result", "ip_address"
        ])
        
        writer.writeheader()
        for result in results:
            writer.writerow({
                "timestamp": result["timestamp"],
                "user": result["actor"]["username"],
                "action": result["action"],
                "resource_type": result["resource"]["type"],
                "resource_id": result["resource"]["id"],
                "result": result["result"],
                "ip_address": result["actor"]["ip_address"]
            })
        
        return output.getvalue().encode('utf-8')
```

**å®Œæˆå®šç¾©**:

- [ ] Elasticsearch å…¨æ–‡æœç´¢å¯¦ç¾
- [ ] å¤šç¶­éæ¿¾ï¼ˆæ™‚é–“ã€ç”¨æˆ¶ã€è³‡æºã€æ“ä½œï¼‰
- [ ] æœç´¢çµæœé«˜äº®
- [ ] å°å‡ºåŠŸèƒ½ï¼ˆCSVã€JSONã€PDFï¼‰
- [ ] æœç´¢æ€§èƒ½å„ªåŒ–ï¼ˆ<500msï¼‰

---

#### **US-F10-004: æ—¥èªŒæ­¸æª”èˆ‡å®Œæ•´æ€§æ ¡é©—**

**å„ªå…ˆç´š**: P1 (é‡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç³»çµ±ç®¡ç†å“¡ï¼ˆMark Leeï¼‰
- **æˆ‘æƒ³è¦** è‡ªå‹•æ­¸æª”èˆŠæ—¥èªŒè‡³å†·å­˜å„²ï¼Œä¸¦ç¢ºä¿æ—¥èªŒæœªè¢«ç¯¡æ”¹
- **ä»¥ä¾¿** æˆ‘å¯ä»¥é™ä½å­˜å„²æˆæœ¬ä¸¦æ»¿è¶³åˆè¦è¦æ±‚

**é©—æ”¶æ¨™æº–**:

1. âœ… **è‡ªå‹•æ­¸æª”**: 90 å¤©å¾Œè‡ªå‹•æ­¸æª”è‡³ S3/Azure Blob
2. âœ… **å£“ç¸®å­˜å„²**: æ­¸æª”å‰å£“ç¸®ï¼ˆgzipï¼‰ï¼Œæ¸›å°‘å­˜å„²æˆæœ¬ 80%
3. âœ… **å“ˆå¸Œéˆæ ¡é©—**: å®šæœŸæ ¡é©—æ—¥èªŒå®Œæ•´æ€§ï¼ˆSHA-256 å“ˆå¸Œéˆï¼‰
4. âœ… **ç¯¡æ”¹æª¢æ¸¬**: æª¢æ¸¬åˆ°ç¯¡æ”¹æ™‚è‡ªå‹•å‘Šè­¦
5. âœ… **æ­¸æª”æª¢ç´¢**: æ”¯æŒå¾æ­¸æª”ä¸­æª¢ç´¢èˆŠæ—¥èªŒï¼ˆéœ€ 5-10 åˆ†é˜ï¼‰
6. âœ… **ä¿ç•™ç­–ç•¥**: é…ç½®ä¸åŒé¡å‹æ—¥èªŒçš„ä¿ç•™æœŸï¼ˆå¦‚éŒ¯èª¤æ—¥èªŒä¿ç•™ 1 å¹´ï¼‰

**æ­¸æª”ç­–ç•¥é…ç½®**:

```yaml
# config/audit_retention_policy.yaml
retention_policies:
  - category: "user_operation"
    hot_storage_days: 90      # PostgreSQL + Elasticsearch
    warm_storage_days: 365    # S3 Standard
    cold_storage_days: 2555   # S3 Glacier (7 å¹´)
    
  - category: "execution_log"
    hot_storage_days: 30
    warm_storage_days: 180
    cold_storage_days: 730
    
  - category: "system_event"
    hot_storage_days: 60
    warm_storage_days: 365
    cold_storage_days: 1825

archive_settings:
  compression: "gzip"
  batch_size: 10000          # æ¯æ‰¹æ­¸æª” 10000 æ¢
  schedule: "0 2 * * *"      # æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œ
  
integrity_check:
  enabled: true
  schedule: "0 3 * * 0"      # æ¯é€±æ—¥å‡Œæ™¨ 3 é»
  sample_rate: 0.1           # éš¨æ©ŸæŠ½æ¨£ 10% æ—¥èªŒæª¢æŸ¥
```

**Python å¯¦ç¾**:

```python
import gzip
import boto3
from datetime import datetime, timedelta
from typing import List

class AuditLogArchiver:
    """å¯©è¨ˆæ—¥èªŒæ­¸æª”æœå‹™"""
    
    def __init__(self, db_session, s3_client: boto3.client):
        self.db = db_session
        self.s3 = s3_client
        self.bucket = "company-audit-logs"
    
    async def archive_old_logs(self, days_threshold: int = 90):
        """æ­¸æª”èˆŠæ—¥èªŒ"""
        
        cutoff_date = datetime.utcnow() - timedelta(days=days_threshold)
        
        # 1. æŸ¥è©¢éœ€è¦æ­¸æª”çš„æ—¥èªŒ
        old_logs = self.db.query(AuditLog).filter(
            AuditLog.timestamp < cutoff_date
        ).limit(10000).all()
        
        if not old_logs:
            return
        
        # 2. å£“ç¸®ä¸¦ä¸Šå‚³è‡³ S3
        archive_file = self._compress_logs(old_logs)
        s3_key = f"audit-logs/{cutoff_date.year}/{cutoff_date.month:02d}/logs_{datetime.utcnow().isoformat()}.json.gz"
        
        self.s3.upload_file(
            Filename=archive_file,
            Bucket=self.bucket,
            Key=s3_key,
            ExtraArgs={
                "StorageClass": "STANDARD_IA",  # ä½é »è¨ªå•å­˜å„²
                "ServerSideEncryption": "AES256"
            }
        )
        
        # 3. å¾ PostgreSQL åˆªé™¤ï¼ˆå·²æ­¸æª”ï¼‰
        for log in old_logs:
            self.db.delete(log)
        
        self.db.commit()
        
        logger.info(f"Archived {len(old_logs)} logs to S3: {s3_key}")
    
    def _compress_logs(self, logs: List[AuditLog]) -> str:
        """å£“ç¸®æ—¥èªŒ"""
        import json
        import tempfile
        
        # è½‰æ›ç‚º JSON
        logs_json = [log.to_dict() for log in logs]
        
        # å¯«å…¥è‡¨æ™‚æ–‡ä»¶ä¸¦å£“ç¸®
        temp_file = tempfile.NamedTemporaryFile(suffix=".json.gz", delete=False)
        with gzip.open(temp_file.name, 'wt', encoding='utf-8') as f:
            json.dump(logs_json, f)
        
        return temp_file.name
    
    async def verify_integrity(self, sample_rate: float = 0.1):
        """é©—è­‰æ—¥èªŒå®Œæ•´æ€§ï¼ˆå“ˆå¸Œéˆï¼‰"""
        
        # 1. éš¨æ©ŸæŠ½æ¨£æ—¥èªŒ
        total_count = self.db.query(AuditLog).count()
        sample_size = int(total_count * sample_rate)
        
        logs = self.db.query(AuditLog).order_by(
            AuditLog.timestamp
        ).limit(sample_size).all()
        
        # 2. é©—è­‰å“ˆå¸Œéˆ
        tampered_count = 0
        for i in range(1, len(logs)):
            current_log = logs[i]
            previous_log = logs[i - 1]
            
            # æª¢æŸ¥ç•¶å‰æ—¥èªŒçš„ previous_hash æ˜¯å¦åŒ¹é…å‰ä¸€æ¢çš„ hash
            if current_log.previous_hash != previous_log.hash:
                logger.error(
                    f"Integrity violation detected: Log {current_log.id} "
                    f"has invalid previous_hash"
                )
                tampered_count += 1
            
            # é‡æ–°è¨ˆç®—ç•¶å‰æ—¥èªŒçš„å“ˆå¸Œ
            expected_hash = self._calculate_hash(current_log)
            if current_log.hash != expected_hash:
                logger.error(
                    f"Integrity violation detected: Log {current_log.id} "
                    f"has invalid hash (possibly tampered)"
                )
                tampered_count += 1
        
        if tampered_count > 0:
            # ç™¼é€å‘Šè­¦
            await self._send_tampering_alert(tampered_count, sample_size)
        
        return {
            "checked": sample_size,
            "tampered": tampered_count,
            "integrity": "OK" if tampered_count == 0 else "VIOLATED"
        }
```

**å®Œæˆå®šç¾©**:

- [ ] è‡ªå‹•æ­¸æª”ä»»å‹™ï¼ˆå®šæ™‚ä»»å‹™ï¼‰
- [ ] S3/Azure Blob ä¸Šå‚³
- [ ] gzip å£“ç¸®å¯¦ç¾
- [ ] å“ˆå¸Œéˆå®Œæ•´æ€§æ ¡é©—
- [ ] ç¯¡æ”¹æª¢æ¸¬å‘Šè­¦
- [ ] æ­¸æª”æ—¥èªŒæª¢ç´¢

---

### 10.3 æ•¸æ“šåº«æ¶æ§‹

```sql
-- å¯©è¨ˆæ—¥èªŒè¡¨ï¼ˆPostgreSQLï¼‰
CREATE TABLE audit_logs (
    id VARCHAR(50) PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL,
    
    -- äº‹ä»¶åˆ†é¡
    event_type VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,  -- user_operation, execution_log, system_event
    severity VARCHAR(20) NOT NULL,  -- info, warning, error, critical
    
    -- æ“ä½œè€…
    actor_user_id VARCHAR(100),
    actor_username VARCHAR(200),
    actor_role VARCHAR(50),
    actor_ip_address VARCHAR(45),
    actor_user_agent TEXT,
    
    -- è³‡æº
    resource_type VARCHAR(50),
    resource_id VARCHAR(100),
    resource_name VARCHAR(200),
    
    -- æ“ä½œ
    action VARCHAR(50),
    result VARCHAR(20),  -- success, failure
    
    -- è®Šæ›´
    changes_before JSONB,
    changes_after JSONB,
    changes_diff JSONB,
    
    -- åŸ·è¡Œä¸Šä¸‹æ–‡ï¼ˆç”¨æ–¼åŸ·è¡Œæ—¥èªŒï¼‰
    execution_id VARCHAR(100),
    step_id VARCHAR(50),
    correlation_id VARCHAR(100),
    
    -- éŒ¯èª¤
    error TEXT,
    
    -- å…ƒæ•¸æ“š
    metadata JSONB,
    
    -- å®Œæ•´æ€§ï¼ˆå“ˆå¸Œéˆï¼‰
    hash VARCHAR(64) NOT NULL,
    previous_hash VARCHAR(64),
    
    -- æ­¸æª”ç‹€æ…‹
    archived BOOLEAN DEFAULT false,
    archived_at TIMESTAMP,
    archive_location VARCHAR(500)
);

-- ç´¢å¼•
CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_category ON audit_logs(category, timestamp DESC);
CREATE INDEX idx_audit_user ON audit_logs(actor_username, timestamp DESC);
CREATE INDEX idx_audit_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_execution ON audit_logs(execution_id);
CREATE INDEX idx_audit_archived ON audit_logs(archived, timestamp) WHERE NOT archived;

-- åˆ†å€è¡¨ï¼ˆæŒ‰æœˆåˆ†å€ï¼Œæå‡æŸ¥è©¢æ€§èƒ½ï¼‰
CREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

CREATE TABLE audit_logs_2025_12 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

---

### 10.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | æ—¥èªŒå¯«å…¥å»¶é² | <50ms (ç•°æ­¥å¯«å…¥) | APM ç›£æ§ |
| | æœç´¢éŸ¿æ‡‰æ™‚é–“ | <500ms (100 è¬æ¢) | Elasticsearch ç›£æ§ |
| **å®¹é‡** | æ—¥èªŒå­˜å„²é‡ | æ”¯æŒ 10 å„„æ¢+ | åˆ†å€è¡¨ + æ­¸æª” |
| | å¯«å…¥ååé‡ | 10000 æ¢/ç§’ | æ‰¹é‡å¯«å…¥ + éšŠåˆ— |
| **å¯é æ€§** | æ—¥èªŒä¸Ÿå¤±ç‡ | 0% (æŒä¹…åŒ–) | é›™å¯« PostgreSQL + ES |
| | å®Œæ•´æ€§æ ¡é©— | 100% æª¢æ¸¬ç¯¡æ”¹ | å“ˆå¸Œéˆé©—è­‰ |
| **åˆè¦** | æ—¥èªŒä¿ç•™æœŸ | 7 å¹´ï¼ˆå¯é…ç½®ï¼‰ | æ­¸æª”ç­–ç•¥ |

---

### 10.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:

- å“ˆå¸Œéˆè¨ˆç®—å’Œé©—è­‰
- æ•æ„Ÿæ•¸æ“šè„«æ•é‚è¼¯
- æ—¥èªŒå£“ç¸®å’Œè§£å£“ç¸®

**é›†æˆæ¸¬è©¦**:

- ç«¯åˆ°ç«¯æ—¥èªŒè¨˜éŒ„ï¼ˆç”¨æˆ¶æ“ä½œ â†’ å¯«å…¥ â†’ æœç´¢ï¼‰
- Elasticsearch å…¨æ–‡æœç´¢
- S3 æ­¸æª”å’Œæª¢ç´¢

**æ€§èƒ½æ¸¬è©¦**:

- 10000 æ¢/ç§’å¯«å…¥å£“åŠ›æ¸¬è©¦
- 100 è¬æ¢æ—¥èªŒæœç´¢æ€§èƒ½æ¸¬è©¦

**å®‰å…¨æ¸¬è©¦**:

- æ—¥èªŒç¯¡æ”¹æª¢æ¸¬æ¸¬è©¦
- æ•æ„Ÿæ•¸æ“šè„«æ•é©—è­‰

---

### 10.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| Elasticsearch æ•…éšœå°è‡´æœç´¢ä¸å¯ç”¨ | ä¸­ | ä¸­ | PostgreSQL é™ç´šæŸ¥è©¢ + ES é›†ç¾¤ |
| æ—¥èªŒå¯«å…¥é˜»å¡ä¸»æ¥­å‹™ | ä½ | é«˜ | ç•°æ­¥å¯«å…¥ + æ¶ˆæ¯éšŠåˆ— |
| æ­¸æª”æ—¥èªŒæª¢ç´¢ç·©æ…¢ | ä¸­ | ä½ | è¨­å®šé æœŸï¼ˆ5-10 åˆ†é˜ï¼‰+ ç·©å­˜ |
| å“ˆå¸Œéˆæ–·è£‚ | ä½ | é«˜ | å®šæœŸå®Œæ•´æ€§æª¢æŸ¥ + å‘Šè­¦ |

---

### 10.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **å¯¦æ™‚æ—¥èªŒæµ**: WebSocket å¯¦æ™‚æ¨é€æ—¥èªŒï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
2. **æ™ºèƒ½ç•°å¸¸æª¢æ¸¬**: ä½¿ç”¨ ML æª¢æ¸¬ç•°å¸¸æ“ä½œæ¨¡å¼
3. **å¯è¦–åŒ–æ™‚é–“ç·š**: æ“ä½œæ™‚é–“ç·šå¯è¦–åŒ–ï¼ˆé¡ä¼¼ Git log --graphï¼‰
4. **è·¨ç³»çµ±å¯©è¨ˆ**: é›†æˆå¤–éƒ¨ç³»çµ±æ—¥èªŒï¼ˆServiceNowã€Active Directoryï¼‰
5. **å€å¡Šéˆå­˜è­‰**: ä½¿ç”¨å€å¡ŠéˆæŠ€è¡“é€²ä¸€æ­¥å¢å¼·é˜²ç¯¡æ”¹èƒ½åŠ›

---

**âœ… F10 å®Œæˆ**ï¼šå¯©è¨ˆè¿½è¹¤ï¼ˆè¿½åŠ å¼æ—¥èªŒï¼‰åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f11-teams-notification"></a>F11. Teams é€šçŸ¥

**åŠŸèƒ½é¡åˆ¥**: Observability (å¯è§€å¯Ÿæ€§)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1 é€±  
**è¤‡é›œåº¦**: â­â­

---

### 11.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F11ï¼ˆTeams é€šçŸ¥ï¼‰æä¾›èˆ‡ **Microsoft Teams çš„æ·±åº¦é›†æˆ**ï¼Œè‡ªå‹•ç™¼é€å·¥ä½œæµåŸ·è¡Œçµæœã€éŒ¯èª¤å‘Šè­¦ã€DLQ é€šçŸ¥ã€ç³»çµ±äº‹ä»¶è‡³æŒ‡å®šçš„ Teams é »é“ï¼Œæ”¯æŒ Adaptive Cards å¯Œæ–‡æœ¬æ ¼å¼å’Œå¿«æ·æ“ä½œæŒ‰éˆ•ã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **ä¸»å‹•é€šçŸ¥**: åœ˜éšŠç„¡éœ€ä¸»å‹•æŸ¥çœ‹ç³»çµ±ï¼Œé—œéµäº‹ä»¶è‡ªå‹•æ¨é€
- **å¿«é€ŸéŸ¿æ‡‰**: éŒ¯èª¤å‘Šè­¦åœ¨ 30 ç§’å…§åˆ°é” Teamsï¼Œæ¸›å°‘éŸ¿æ‡‰æ™‚é–“ 80%
- **å”ä½œä¾¿åˆ©**: åœ¨ Teams ä¸­ç›´æ¥è¨è«–å•é¡Œï¼Œç„¡éœ€åˆ‡æ›å·¥å…·
- **ä¼æ¥­æ¨™æº–**: Teams æ˜¯ä¼æ¥­æ¨™æº–å”ä½œå·¥å…·ï¼Œç¬¦åˆ IT ç­–ç•¥

**æ ¸å¿ƒèƒ½åŠ›**:
1. **å¤šå ´æ™¯é€šçŸ¥**: åŸ·è¡ŒæˆåŠŸ/å¤±æ•—ã€DLQ å‘Šè­¦ã€ç³»çµ±äº‹ä»¶
2. **Adaptive Cards**: å¯Œæ–‡æœ¬å¡ç‰‡ï¼ŒåŒ…å«æŒ‰éˆ•ã€åœ–è¡¨ã€å¿«æ·æ“ä½œ
3. **å¯é…ç½®è·¯ç”±**: ä¸åŒäº‹ä»¶è·¯ç”±è‡³ä¸åŒé »é“ï¼ˆå¦‚éŒ¯èª¤â†’é‹ç¶­é »é“ï¼‰
4. **å¿«æ·æ“ä½œ**: ç›´æ¥åœ¨ Teams ä¸­é‡è©¦åŸ·è¡Œã€æŸ¥çœ‹è©³æƒ…ã€éœé»˜å‘Šè­¦
5. **é€šçŸ¥èšåˆ**: ç›¸åŒéŒ¯èª¤èšåˆç‚ºä¸€æ¢é€šçŸ¥ï¼ˆé¿å…åˆ·å±ï¼‰
6. **éœéŸ³è¦å‰‡**: æ”¯æŒéœéŸ³æœŸï¼ˆå¦‚éå·¥ä½œæ™‚é–“ï¼‰

**æ¥­å‹™åƒ¹å€¼**:
- **éŸ¿æ‡‰é€Ÿåº¦**: å¾ 2 å°æ™‚é™è‡³ 5 åˆ†é˜ï¼ˆä¸»å‹•é€šçŸ¥ vs è¢«å‹•æŸ¥çœ‹ï¼‰
- **å”ä½œæ•ˆç‡**: å•é¡Œè¨è«–æ™‚é–“æ¸›å°‘ 60%ï¼ˆç„¡éœ€åˆ‡æ›å·¥å…·ï¼‰
- **å‘Šè­¦ç–²å‹**: èšåˆé€šçŸ¥æ¸›å°‘ 70% æ¶ˆæ¯é‡

**æ¶æ§‹åœ–**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      F11. Teams é€šçŸ¥æ¶æ§‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      äº‹ä»¶æºï¼ˆè§¸ç™¼å™¨ï¼‰                           â”‚
   â”‚  â€¢ åŸ·è¡Œå®Œæˆï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰                                        â”‚
   â”‚  â€¢ DLQ æ–°å¢æ¢ç›®                                                 â”‚
   â”‚  â€¢ ç³»çµ±äº‹ä»¶ï¼ˆæœå‹™å•Ÿå‹•/åœæ­¢ï¼‰                                    â”‚
   â”‚  â€¢ å¯©è¨ˆå‘Šè­¦ï¼ˆå¯ç–‘æ“ä½œï¼‰                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ ç™¼å¸ƒäº‹ä»¶
                           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    é€šçŸ¥è·¯ç”±æœå‹™                                 â”‚
   â”‚  â€¢ æ ¹æ“šäº‹ä»¶é¡å‹é¸æ“‡é€šçŸ¥æ¨¡æ¿                                     â”‚
   â”‚  â€¢ æ‡‰ç”¨éœéŸ³è¦å‰‡ï¼ˆå·¥ä½œæ™‚é–“ã€é »ç‡é™åˆ¶ï¼‰                           â”‚
   â”‚  â€¢ èšåˆç›¸åŒéŒ¯èª¤ï¼ˆ5 åˆ†é˜çª—å£ï¼‰                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â†“                             â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Teams Webhookâ”‚            â”‚ é€šçŸ¥æ—¥èªŒ     â”‚
   â”‚ Connector    â”‚            â”‚ (PostgreSQL) â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      Microsoft Teams                             â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚ #ops-alerts    â”‚  â”‚ #cs-workflows  â”‚  â”‚ #it-support    â”‚   â”‚
   â”‚  â”‚ (é‹ç¶­å‘Šè­¦)     â”‚  â”‚ (å®¢æœå·¥ä½œæµ)   â”‚  â”‚ (IT æ”¯æŒ)      â”‚   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 11.2 ç”¨æˆ¶æ•…äº‹

#### **US-F11-001: åŸ·è¡Œçµæœé€šçŸ¥ï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** é‹ç¶­å·¥ç¨‹å¸«ï¼ˆLisa Chenï¼‰
- **æˆ‘æƒ³è¦** åœ¨å·¥ä½œæµåŸ·è¡Œå¤±æ•—æ™‚æ”¶åˆ° Teams é€šçŸ¥
- **ä»¥ä¾¿** æˆ‘å¯ä»¥ç«‹å³éŸ¿æ‡‰å•é¡Œï¼Œè€Œä¸æ˜¯è¢«å‹•ç­‰å¾…ç”¨æˆ¶å ±å‘Š

**é©—æ”¶æ¨™æº–**:

1. âœ… **å¤±æ•—é€šçŸ¥**: åŸ·è¡Œå¤±æ•—å¾Œ 30 ç§’å…§ç™¼é€ Teams æ¶ˆæ¯
2. âœ… **Adaptive Card**: ä½¿ç”¨ Adaptive Card æ ¼å¼ï¼ˆåŒ…å«åŸ·è¡Œ IDã€éŒ¯èª¤ã€è€—æ™‚ï¼‰
3. âœ… **å¿«æ·æ“ä½œ**: åŒ…å«ã€ŒæŸ¥çœ‹è©³æƒ…ã€ã€Œé‡è©¦åŸ·è¡Œã€ã€ŒéœéŸ³ 1 å°æ™‚ã€æŒ‰éˆ•
4. âœ… **æˆåŠŸé€šçŸ¥ï¼ˆå¯é¸ï¼‰**: å¯é…ç½®æ˜¯å¦é€šçŸ¥æˆåŠŸåŸ·è¡Œ
5. âœ… **é »é“è·¯ç”±**: æ ¹æ“šå·¥ä½œæµé…ç½®ç™¼é€è‡³æŒ‡å®šé »é“
6. âœ… **@æåŠ**: æ”¯æŒ @ç‰¹å®šç”¨æˆ¶æˆ–åœ˜éšŠ

**Teams Adaptive Card ç¤ºä¾‹ï¼ˆå¤±æ•—é€šçŸ¥ï¼‰**:

```json
{
  "type": "AdaptiveCard",
  "version": "1.4",
  "body": [
    {
      "type": "Container",
      "style": "attention",
      "items": [
        {
          "type": "ColumnSet",
          "columns": [
            {
              "type": "Column",
              "width": "auto",
              "items": [
                {
                  "type": "Image",
                  "url": "https://cdn.example.com/icons/error.png",
                  "size": "small"
                }
              ]
            },
            {
              "type": "Column",
              "width": "stretch",
              "items": [
                {
                  "type": "TextBlock",
                  "text": "å·¥ä½œæµåŸ·è¡Œå¤±æ•—",
                  "weight": "bolder",
                  "size": "large",
                  "color": "attention"
                },
                {
                  "type": "TextBlock",
                  "text": "Customer 360 View Workflow",
                  "size": "medium",
                  "spacing": "none"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "type": "FactSet",
      "facts": [
        {
          "title": "åŸ·è¡Œ ID:",
          "value": "exec_abc123"
        },
        {
          "title": "å·¥ä½œæµ:",
          "value": "customer_360_view"
        },
        {
          "title": "è§¸ç™¼æ–¹å¼:",
          "value": "Webhook (ServiceNow)"
        },
        {
          "title": "å¤±æ•—æ™‚é–“:",
          "value": "2025-11-19 14:30:45"
        },
        {
          "title": "åŸ·è¡Œè€—æ™‚:",
          "value": "12.3 ç§’"
        },
        {
          "title": "éŒ¯èª¤é¡å‹:",
          "value": "HTTPException 503"
        }
      ]
    },
    {
      "type": "TextBlock",
      "text": "**éŒ¯èª¤è©³æƒ…:**",
      "weight": "bolder",
      "spacing": "medium"
    },
    {
      "type": "TextBlock",
      "text": "ServiceNow API is temporarily unavailable. Connection timed out after 30 seconds.",
      "wrap": true,
      "color": "attention"
    },
    {
      "type": "TextBlock",
      "text": "**å½±éŸ¿ç¯„åœ:**",
      "weight": "bolder",
      "spacing": "medium"
    },
    {
      "type": "TextBlock",
      "text": "â€¢ å®¢æˆ¶ ID: CUST-5678\nâ€¢ ç›¸é—œç¥¨å‹™: TICKET-1234\nâ€¢ é‡è©¦æ¬¡æ•¸: 5/5 (å·²ç”¨ç›¡)",
      "wrap": true
    }
  ],
  "actions": [
    {
      "type": "Action.OpenUrl",
      "title": "æŸ¥çœ‹è©³æƒ…",
      "url": "https://ipa.company.com/executions/exec_abc123"
    },
    {
      "type": "Action.Http",
      "title": "é‡è©¦åŸ·è¡Œ",
      "method": "POST",
      "url": "https://ipa.company.com/api/executions/exec_abc123/retry",
      "headers": [
        {
          "name": "Authorization",
          "value": "Bearer {{TEAMS_BOT_TOKEN}}"
        }
      ]
    },
    {
      "type": "Action.Http",
      "title": "éœéŸ³ 1 å°æ™‚",
      "method": "POST",
      "url": "https://ipa.company.com/api/notifications/mute",
      "body": "{\"execution_id\": \"exec_abc123\", \"duration_hours\": 1}"
    }
  ]
}
```

**Python å¯¦ç¾**:

```python
import requests
from typing import Dict, Any, Optional

class TeamsNotificationService:
    """Teams é€šçŸ¥æœå‹™"""
    
    def __init__(self, webhook_url: str):
        self.webhook_url = webhook_url
    
    async def send_execution_failure(
        self,
        execution_id: str,
        workflow_name: str,
        trigger_type: str,
        error_type: str,
        error_message: str,
        duration_seconds: float,
        retry_count: int,
        max_retries: int,
        customer_id: Optional[str] = None
    ):
        """ç™¼é€åŸ·è¡Œå¤±æ•—é€šçŸ¥"""
        
        # æ§‹å»º Adaptive Card
        card = {
            "type": "message",
            "attachments": [
                {
                    "contentType": "application/vnd.microsoft.card.adaptive",
                    "content": {
                        "type": "AdaptiveCard",
                        "version": "1.4",
                        "body": [
                            self._build_header("å·¥ä½œæµåŸ·è¡Œå¤±æ•—", workflow_name, "attention"),
                            self._build_fact_set({
                                "åŸ·è¡Œ ID": execution_id,
                                "å·¥ä½œæµ": workflow_name,
                                "è§¸ç™¼æ–¹å¼": trigger_type,
                                "å¤±æ•—æ™‚é–“": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S"),
                                "åŸ·è¡Œè€—æ™‚": f"{duration_seconds:.1f} ç§’",
                                "éŒ¯èª¤é¡å‹": error_type
                            }),
                            {
                                "type": "TextBlock",
                                "text": f"**éŒ¯èª¤è©³æƒ…:**\n{error_message}",
                                "wrap": True,
                                "color": "attention"
                            },
                            {
                                "type": "TextBlock",
                                "text": f"**é‡è©¦ç‹€æ…‹:** {retry_count}/{max_retries}",
                                "wrap": True
                            }
                        ],
                        "actions": [
                            {
                                "type": "Action.OpenUrl",
                                "title": "æŸ¥çœ‹è©³æƒ…",
                                "url": f"https://ipa.company.com/executions/{execution_id}"
                            },
                            {
                                "type": "Action.Http",
                                "title": "é‡è©¦åŸ·è¡Œ",
                                "method": "POST",
                                "url": f"https://ipa.company.com/api/executions/{execution_id}/retry"
                            }
                        ]
                    }
                }
            ]
        }
        
        # ç™¼é€è‡³ Teams
        response = requests.post(self.webhook_url, json=card)
        
        if response.status_code != 200:
            logger.error(f"Failed to send Teams notification: {response.text}")
            raise Exception(f"Teams notification failed: {response.status_code}")
        
        # è¨˜éŒ„é€šçŸ¥æ—¥èªŒ
        await self._log_notification(
            notification_type="execution_failure",
            execution_id=execution_id,
            status="sent"
        )
    
    def _build_header(self, title: str, subtitle: str, style: str = "default") -> Dict:
        """æ§‹å»ºå¡ç‰‡é ­éƒ¨"""
        return {
            "type": "Container",
            "style": style,
            "items": [
                {
                    "type": "TextBlock",
                    "text": title,
                    "weight": "bolder",
                    "size": "large",
                    "color": "attention" if style == "attention" else "default"
                },
                {
                    "type": "TextBlock",
                    "text": subtitle,
                    "size": "medium",
                    "spacing": "none"
                }
            ]
        }
    
    def _build_fact_set(self, facts: Dict[str, str]) -> Dict:
        """æ§‹å»ºäº‹å¯¦é›†åˆ"""
        return {
            "type": "FactSet",
            "facts": [
                {"title": f"{key}:", "value": value}
                for key, value in facts.items()
            ]
        }
```

**å®Œæˆå®šç¾©**:

- [ ] Adaptive Card æ¨¡æ¿ç”Ÿæˆ
- [ ] Teams Webhook é›†æˆ
- [ ] å¿«æ·æ“ä½œæŒ‰éˆ•å¯¦ç¾
- [ ] é »é“è·¯ç”±é…ç½®
- [ ] é€šçŸ¥æ—¥èªŒè¨˜éŒ„

---

#### **US-F11-002: DLQ å‘Šè­¦é€šçŸ¥**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1 å¤©  
**è¤‡é›œåº¦**: â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** é‹ç¶­å·¥ç¨‹å¸«ï¼ˆAlex Chenï¼‰
- **æˆ‘æƒ³è¦** åœ¨åŸ·è¡Œé€²å…¥ DLQ æ™‚æ”¶åˆ° Teams å‘Šè­¦
- **ä»¥ä¾¿** æˆ‘å¯ä»¥åŠæ™‚è™•ç†æŒä¹…æ€§æ•…éšœ

**é©—æ”¶æ¨™æº–**:

1. âœ… **DLQ å‘Šè­¦**: åŸ·è¡Œç§»è‡³ DLQ å¾Œç«‹å³ç™¼é€é€šçŸ¥
2. âœ… **èšåˆå‘Šè­¦**: 5 åˆ†é˜å…§ç›¸åŒéŒ¯èª¤èšåˆç‚ºä¸€æ¢ï¼ˆé¿å…åˆ·å±ï¼‰
3. âœ… **åš´é‡ç¨‹åº¦**: ä½¿ç”¨ç´…è‰²ä¸»é¡Œæ¨™è­˜é«˜å„ªå…ˆç´š
4. âœ… **å¿«æ·æ“ä½œ**: åŒ…å«ã€ŒæŸ¥çœ‹ DLQã€ã€Œæ‰‹å‹•é‡è©¦ã€æŒ‰éˆ•
5. âœ… **@æåŠ**: è‡ªå‹• @on-call å·¥ç¨‹å¸«
6. âœ… **çµ±è¨ˆä¿¡æ¯**: é¡¯ç¤ºç•¶å‰ DLQ ç¸½æ•¸

**DLQ å‘Šè­¦ Adaptive Card**:

```json
{
  "type": "AdaptiveCard",
  "version": "1.4",
  "body": [
    {
      "type": "Container",
      "style": "attention",
      "items": [
        {
          "type": "TextBlock",
          "text": "âš ï¸ åŸ·è¡Œé€²å…¥æ­»ä¿¡éšŠåˆ— (DLQ)",
          "weight": "bolder",
          "size": "large",
          "color": "attention"
        }
      ]
    },
    {
      "type": "FactSet",
      "facts": [
        {
          "title": "åŸ·è¡Œ ID:",
          "value": "exec_abc123"
        },
        {
          "title": "å·¥ä½œæµ:",
          "value": "customer_360_view"
        },
        {
          "title": "é‡è©¦æ¬¡æ•¸:",
          "value": "5/5 (å·²ç”¨ç›¡)"
        },
        {
          "title": "æœ€å¾ŒéŒ¯èª¤:",
          "value": "ServiceNow API unavailable (503)"
        },
        {
          "title": "é€²å…¥ DLQ æ™‚é–“:",
          "value": "2025-11-19 14:35:22"
        }
      ]
    },
    {
      "type": "TextBlock",
      "text": "**ç•¶å‰ DLQ ç‹€æ…‹:**",
      "weight": "bolder"
    },
    {
      "type": "TextBlock",
      "text": "â€¢ ç¸½è¨ˆ: 12 å€‹å¤±æ•—åŸ·è¡Œ\nâ€¢ æœ€èˆŠ: 3 å¤©å‰\nâ€¢ éœ€è¦äººå·¥å¹²é ",
      "wrap": true,
      "color": "attention"
    }
  ],
  "actions": [
    {
      "type": "Action.OpenUrl",
      "title": "æŸ¥çœ‹ DLQ éšŠåˆ—",
      "url": "https://ipa.company.com/dlq"
    },
    {
      "type": "Action.OpenUrl",
      "title": "æ‰‹å‹•é‡è©¦",
      "url": "https://ipa.company.com/dlq/exec_abc123/retry"
    }
  ],
  "msteams": {
    "entities": [
      {
        "type": "mention",
        "text": "<at>Lisa Chen</at>",
        "mentioned": {
          "id": "lisa.chen@company.com",
          "name": "Lisa Chen"
        }
      }
    ]
  }
}
```

**å®Œæˆå®šç¾©**:

- [ ] DLQ äº‹ä»¶ç›£è½
- [ ] å‘Šè­¦èšåˆé‚è¼¯ï¼ˆ5 åˆ†é˜çª—å£ï¼‰
- [ ] @æåŠåŠŸèƒ½
- [ ] DLQ çµ±è¨ˆä¿¡æ¯æ”¶é›†

---

#### **US-F11-003: é€šçŸ¥è·¯ç”±èˆ‡éœéŸ³è¦å‰‡**

**å„ªå…ˆç´š**: P1 (é‡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆTom Wangï¼‰
- **æˆ‘æƒ³è¦** é…ç½®ä¸åŒé¡å‹é€šçŸ¥ç™¼é€è‡³ä¸åŒ Teams é »é“ï¼Œä¸¦è¨­ç½®éœéŸ³è¦å‰‡
- **ä»¥ä¾¿** æˆ‘å¯ä»¥é¿å…å‘Šè­¦ç–²å‹ï¼Œç¢ºä¿é€šçŸ¥åˆ°é”æ­£ç¢ºçš„åœ˜éšŠ

**é©—æ”¶æ¨™æº–**:

1. âœ… **é »é“è·¯ç”±**: ä¸åŒäº‹ä»¶é¡å‹è·¯ç”±è‡³ä¸åŒé »é“
2. âœ… **éœéŸ³æ™‚æ®µ**: é…ç½®éœéŸ³æ™‚æ®µï¼ˆå¦‚éå·¥ä½œæ™‚é–“åƒ…ç™¼é€ Criticalï¼‰
3. âœ… **é »ç‡é™åˆ¶**: ç›¸åŒå‘Šè­¦ 10 åˆ†é˜å…§æœ€å¤šç™¼é€ 3 æ¬¡
4. âœ… **å„ªå…ˆç´šéæ¿¾**: åªé€šçŸ¥ P0/P1 å·¥ä½œæµçš„éŒ¯èª¤
5. âœ… **å‹•æ…‹é…ç½®**: é€šé YAML é…ç½®æ–‡ä»¶ç®¡ç†è·¯ç”±è¦å‰‡
6. âœ… **é€šçŸ¥æ¸¬è©¦**: UI æä¾›æ¸¬è©¦æŒ‰éˆ•ï¼Œé©—è­‰é…ç½®æ­£ç¢º

**é€šçŸ¥è·¯ç”±é…ç½®**:

```yaml
# config/teams_notification_routing.yaml
notification_routing:
  - name: "é‹ç¶­å‘Šè­¦"
    webhook_url: "https://outlook.office.com/webhook/xxx/IncomingWebhook/yyy"
    channels: ["#ops-alerts"]
    event_types:
      - "execution.failed"
      - "dlq.entry_added"
      - "system.error"
    filters:
      priority: ["P0", "P1"]
      severity: ["error", "critical"]
    
  - name: "å®¢æœå·¥ä½œæµ"
    webhook_url: "https://outlook.office.com/webhook/aaa/IncomingWebhook/bbb"
    channels: ["#cs-workflows"]
    event_types:
      - "execution.completed"
      - "execution.failed"
    filters:
      workflow_category: ["customer_service"]
    
  - name: "IT æ”¯æŒ"
    webhook_url: "https://outlook.office.com/webhook/ccc/IncomingWebhook/ddd"
    channels: ["#it-support"]
    event_types:
      - "execution.completed"
    filters:
      workflow_category: ["it_support"]

mute_rules:
  - name: "éå·¥ä½œæ™‚é–“éœéŸ³"
    enabled: true
    schedule:
      timezone: "Asia/Taipei"
      mute_periods:
        - days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"]
          time_ranges: ["18:00-09:00"]  # æ™šä¸Š 6 é»è‡³æ—©ä¸Š 9 é»
        - days: ["Saturday", "Sunday"]
          time_ranges: ["00:00-23:59"]  # é€±æœ«å…¨å¤©
    exceptions:
      severity: ["critical"]  # Critical äº‹ä»¶ä»ç„¶é€šçŸ¥
  
  - name: "é »ç‡é™åˆ¶"
    enabled: true
    rate_limit:
      window_minutes: 10
      max_notifications: 3
    aggregation:
      enabled: true
      window_minutes: 5
      group_by: ["workflow_id", "error_type"]
```

**Python å¯¦ç¾**:

```python
from datetime import datetime, time
import yaml
from typing import List, Dict, Any

class NotificationRouter:
    """é€šçŸ¥è·¯ç”±å™¨"""
    
    def __init__(self, config_path: str):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        
        self.routing_rules = self.config["notification_routing"]
        self.mute_rules = self.config["mute_rules"]
    
    async def route_notification(
        self,
        event_type: str,
        event_data: Dict[str, Any]
    ):
        """è·¯ç”±é€šçŸ¥åˆ°å°æ‡‰é »é“"""
        
        # 1. æª¢æŸ¥éœéŸ³è¦å‰‡
        if self._is_muted(event_type, event_data):
            logger.info(f"Notification muted: {event_type}")
            return
        
        # 2. æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±è¦å‰‡
        for rule in self.routing_rules:
            if self._matches_rule(event_type, event_data, rule):
                # 3. ç™¼é€é€šçŸ¥
                await self._send_to_webhook(
                    webhook_url=rule["webhook_url"],
                    event_type=event_type,
                    event_data=event_data
                )
    
    def _is_muted(self, event_type: str, event_data: Dict[str, Any]) -> bool:
        """æª¢æŸ¥æ˜¯å¦è¢«éœéŸ³"""
        
        for rule in self.mute_rules:
            if not rule.get("enabled", True):
                continue
            
            # æª¢æŸ¥æ™‚æ®µéœéŸ³
            if "schedule" in rule:
                if self._is_in_mute_period(rule["schedule"]):
                    # æª¢æŸ¥ä¾‹å¤–æƒ…æ³
                    exceptions = rule.get("exceptions", {})
                    severity = event_data.get("severity")
                    
                    if severity not in exceptions.get("severity", []):
                        return True
            
            # æª¢æŸ¥é »ç‡é™åˆ¶
            if "rate_limit" in rule:
                if self._exceeds_rate_limit(event_type, event_data, rule["rate_limit"]):
                    return True
        
        return False
    
    def _is_in_mute_period(self, schedule: Dict) -> bool:
        """æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åœ¨éœéŸ³æ™‚æ®µ"""
        import pytz
        
        tz = pytz.timezone(schedule["timezone"])
        now = datetime.now(tz)
        
        current_day = now.strftime("%A")
        current_time = now.time()
        
        for period in schedule["mute_periods"]:
            if current_day in period["days"]:
                for time_range in period["time_ranges"]:
                    start_str, end_str = time_range.split("-")
                    start_time = time.fromisoformat(start_str)
                    end_time = time.fromisoformat(end_str)
                    
                    if start_time <= current_time <= end_time:
                        return True
        
        return False
```

**å®Œæˆå®šç¾©**:

- [ ] YAML é…ç½®è§£æ
- [ ] è·¯ç”±è¦å‰‡åŒ¹é…
- [ ] éœéŸ³æ™‚æ®µæª¢æŸ¥
- [ ] é »ç‡é™åˆ¶å¯¦ç¾
- [ ] é€šçŸ¥èšåˆé‚è¼¯

---

#### **US-F11-004: é€šçŸ¥çµ±è¨ˆèˆ‡å¥åº·ç›£æ§**

**å„ªå…ˆç´š**: P2 (æ¬¡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1.5 å¤©  
**è¤‡é›œåº¦**: â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** é‹ç¶­ç¶“ç†ï¼ˆMichael Tanï¼‰
- **æˆ‘æƒ³è¦** æŸ¥çœ‹é€šçŸ¥ç™¼é€çµ±è¨ˆå’Œå¤±æ•—ç‡
- **ä»¥ä¾¿** æˆ‘å¯ä»¥ç›£æ§é€šçŸ¥ç³»çµ±çš„å¥åº·ç‹€æ³

**é©—æ”¶æ¨™æº–**:

1. âœ… **ç™¼é€çµ±è¨ˆ**: æ¯æ—¥/æ¯é€±ç™¼é€é‡çµ±è¨ˆ
2. âœ… **æˆåŠŸç‡**: é€šçŸ¥ç™¼é€æˆåŠŸç‡ï¼ˆç›®æ¨™ â‰¥99%ï¼‰
3. âœ… **å»¶é²ç›£æ§**: å¾äº‹ä»¶ç™¼ç”Ÿåˆ°é€šçŸ¥ç™¼é€çš„å»¶é²
4. âœ… **å¤±æ•—é‡è©¦**: ç™¼é€å¤±æ•—è‡ªå‹•é‡è©¦ 3 æ¬¡
5. âœ… **å‘Šè­¦**: é€šçŸ¥ç³»çµ±ç•°å¸¸æ™‚é€šéå‚™ç”¨æ¸ é“å‘Šè­¦ï¼ˆEmailï¼‰
6. âœ… **å„€è¡¨æ¿**: Web UI é¡¯ç¤ºé€šçŸ¥çµ±è¨ˆ

**å®Œæˆå®šç¾©**:

- [ ] é€šçŸ¥æ—¥èªŒçµ±è¨ˆ
- [ ] æˆåŠŸç‡è¨ˆç®—
- [ ] å»¶é²ç›£æ§
- [ ] å¤±æ•—é‡è©¦é‚è¼¯
- [ ] å„€è¡¨æ¿ API

---

### 11.3 æ•¸æ“šåº«æ¶æ§‹

```sql
-- é€šçŸ¥æ—¥èªŒè¡¨
CREATE TABLE notification_logs (
    id SERIAL PRIMARY KEY,
    
    -- é€šçŸ¥ä¿¡æ¯
    notification_type VARCHAR(50) NOT NULL,  -- execution_failure, dlq_alert, etc.
    event_type VARCHAR(100) NOT NULL,
    
    -- é—œè¯è³‡æº
    execution_id VARCHAR(100),
    workflow_id VARCHAR(100),
    
    -- Teams ä¿¡æ¯
    webhook_url VARCHAR(500) NOT NULL,
    channel_name VARCHAR(100),
    
    -- ç™¼é€ç‹€æ…‹
    status VARCHAR(20) NOT NULL,  -- sent, failed, muted
    retry_count INTEGER DEFAULT 0,
    
    -- å¡ç‰‡å…§å®¹
    card_content JSONB,
    
    -- æ™‚é–“
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    
    -- éŒ¯èª¤
    error TEXT
);

CREATE INDEX idx_notification_status ON notification_logs(status, created_at DESC);
CREATE INDEX idx_notification_execution ON notification_logs(execution_id);
CREATE INDEX idx_notification_type ON notification_logs(notification_type, created_at DESC);

-- é€šçŸ¥èšåˆè¡¨ï¼ˆé˜²åˆ·å±ï¼‰
CREATE TABLE notification_aggregations (
    id SERIAL PRIMARY KEY,
    
    -- èšåˆéµ
    aggregation_key VARCHAR(200) NOT NULL,  -- workflow_id + error_type
    
    -- èšåˆçµ±è¨ˆ
    count INTEGER DEFAULT 1,
    first_occurrence TIMESTAMP NOT NULL,
    last_occurrence TIMESTAMP NOT NULL,
    
    -- æ˜¯å¦å·²é€šçŸ¥
    notified BOOLEAN DEFAULT false,
    notified_at TIMESTAMP,
    
    UNIQUE(aggregation_key)
);

CREATE INDEX idx_aggregation_key ON notification_aggregations(aggregation_key, notified);
```

---

### 11.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | é€šçŸ¥å»¶é² | <30 ç§’ï¼ˆå¾äº‹ä»¶åˆ°ç™¼é€ï¼‰ | APM ç›£æ§ |
| **å¯é æ€§** | ç™¼é€æˆåŠŸç‡ | â‰¥99% | é€šçŸ¥æ—¥èªŒçµ±è¨ˆ |
| **å¯ç”¨æ€§** | Teams æ•…éšœé™ç´š | è‡ªå‹•åˆ‡æ›è‡³ Email | å¥åº·æª¢æŸ¥ |

---

### 11.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:
- Adaptive Card ç”Ÿæˆ
- è·¯ç”±è¦å‰‡åŒ¹é…
- éœéŸ³è¦å‰‡æª¢æŸ¥

**é›†æˆæ¸¬è©¦**:
- ç«¯åˆ°ç«¯é€šçŸ¥ç™¼é€ï¼ˆæ¨¡æ“¬ Teams Webhookï¼‰
- å¿«æ·æ“ä½œæŒ‰éˆ•åŠŸèƒ½

**æ€§èƒ½æ¸¬è©¦**:
- 1000 æ¢/åˆ†é˜é€šçŸ¥ç™¼é€

---

### 11.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| Teams Webhook å¤±æ•ˆ | ä¸­ | ä¸­ | è‡ªå‹•æª¢æ¸¬ + Email é™ç´š |
| å‘Šè­¦åˆ·å± | é«˜ | ä¸­ | èšåˆ + é »ç‡é™åˆ¶ |
| é€šçŸ¥å»¶é² | ä½ | ä½ | ç•°æ­¥éšŠåˆ— + ç›£æ§ |

---

**âœ… F11 å®Œæˆ**ï¼šTeams é€šçŸ¥åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f12-monitoring-dashboard"></a>F12. ç›£æ§å„€è¡¨æ¿

**åŠŸèƒ½é¡åˆ¥**: Observability (å¯è§€å¯Ÿæ€§)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 2 é€±  
**è¤‡é›œåº¦**: â­â­â­â­

---

### 12.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F12ï¼ˆç›£æ§å„€è¡¨æ¿ï¼‰æä¾›**å¯¦æ™‚ç³»çµ±å¥åº·ç›£æ§**ï¼ŒåŒ…æ‹¬åŸ·è¡Œçµ±è¨ˆã€æ€§èƒ½æŒ‡æ¨™ã€è³‡æºä½¿ç”¨ã€éŒ¯èª¤è¶¨å‹¢ã€SLA é”æˆç‡ç­‰é—œéµæŒ‡æ¨™çš„å¯è¦–åŒ–å„€è¡¨æ¿ï¼Œæ”¯æŒè‡ªå®šç¾©å„€è¡¨æ¿å’Œå‘Šè­¦é–¾å€¼é…ç½®ã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **ä¸»å‹•ç›£æ§**: åœ¨å•é¡Œå½±éŸ¿ç”¨æˆ¶å‰æå‰ç™¼ç¾ç•°å¸¸
- **æ€§èƒ½å„ªåŒ–**: è­˜åˆ¥ç“¶é ¸ï¼Œå„ªåŒ–ç³»çµ±æ€§èƒ½
- **å®¹é‡è¦åŠƒ**: æ ¹æ“šè¶¨å‹¢é æ¸¬è³‡æºéœ€æ±‚
- **SLA ç®¡ç†**: è¿½è¹¤æœå‹™æ°´å¹³å”è­°é”æˆæƒ…æ³

**æ ¸å¿ƒèƒ½åŠ›**:
1. **å¯¦æ™‚æŒ‡æ¨™**: åŸ·è¡ŒæˆåŠŸç‡ã€å¹³å‡è€—æ™‚ã€ååé‡ã€éŒ¯èª¤ç‡
2. **è³‡æºç›£æ§**: CPUã€å…§å­˜ã€ç£ç›¤ã€æ•¸æ“šåº«é€£æ¥æ± 
3. **æ¥­å‹™æŒ‡æ¨™**: å„å·¥ä½œæµåŸ·è¡Œæ¬¡æ•¸ã€æˆæœ¬ã€ç”¨æˆ¶æ´»èºåº¦
4. **å‘Šè­¦é…ç½®**: è‡ªå®šç¾©å‘Šè­¦é–¾å€¼ï¼ˆå¦‚éŒ¯èª¤ç‡ >5%ï¼‰
5. **è¶¨å‹¢åˆ†æ**: 7 å¤©/30 å¤©è¶¨å‹¢åœ–è¡¨
6. **è‡ªå®šç¾©å„€è¡¨æ¿**: ç”¨æˆ¶å¯å‰µå»ºå€‹æ€§åŒ–å„€è¡¨æ¿

**æ¥­å‹™åƒ¹å€¼**:
- **æ•…éšœç™¼ç¾æ™‚é–“**: å¾è¢«å‹•ç­‰å¾…ï¼ˆ2 å°æ™‚ï¼‰é™è‡³ä¸»å‹•ç™¼ç¾ï¼ˆ5 åˆ†é˜ï¼‰
- **ç³»çµ±å¯ç”¨æ€§**: å¾ 95% æå‡è‡³ 99.5%
- **é‹ç¶­æ•ˆç‡**: æ¸›å°‘ 60% äººå·¥å·¡æª¢å·¥ä½œ

**æ¶æ§‹åœ–**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    F12. ç›£æ§å„€è¡¨æ¿æ¶æ§‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                      æ•¸æ“šæº                                     â”‚
   â”‚  â€¢ PostgreSQL (åŸ·è¡Œè¨˜éŒ„)                                        â”‚
   â”‚  â€¢ Redis (å¯¦æ™‚æŒ‡æ¨™)                                             â”‚
   â”‚  â€¢ Prometheus (ç³»çµ±æŒ‡æ¨™)                                        â”‚
   â”‚  â€¢ Elasticsearch (æ—¥èªŒèšåˆ)                                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æ¡é›†
                           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    æŒ‡æ¨™èšåˆæœå‹™                                 â”‚
   â”‚  â€¢ å¯¦æ™‚èšåˆï¼ˆ1 åˆ†é˜çª—å£ï¼‰                                       â”‚
   â”‚  â€¢ æ­·å²èšåˆï¼ˆ1 å°æ™‚/1 å¤©çª—å£ï¼‰                                  â”‚
   â”‚  â€¢ è¨ˆç®— SLAã€æˆåŠŸç‡ã€P95 å»¶é²                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å¯«å…¥                        â”‚ æŸ¥è©¢
           â†“                             â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TimescaleDB  â”‚            â”‚      Dashboard API               â”‚
   â”‚ (æ™‚åºæ•¸æ“šåº«) â”‚            â”‚  GET /api/metrics/realtime       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  GET /api/metrics/history        â”‚
                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ æä¾›æ•¸æ“š
                                      â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                        Web UI (React)                           â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ åŸ·è¡Œæ¦‚è¦½å„€è¡¨æ¿ â”‚  â”‚ è³‡æºç›£æ§å„€è¡¨æ¿ â”‚  â”‚ æ¥­å‹™æŒ‡æ¨™å„€è¡¨æ¿ â”‚  â”‚
   â”‚  â”‚ â€¢ æˆåŠŸç‡      â”‚  â”‚ â€¢ CPU/å…§å­˜     â”‚  â”‚ â€¢ å·¥ä½œæµæ’å  â”‚  â”‚
   â”‚  â”‚ â€¢ ååé‡      â”‚  â”‚ â€¢ æ•¸æ“šåº«é€£æ¥   â”‚  â”‚ â€¢ æˆæœ¬çµ±è¨ˆ    â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 12.2 ç”¨æˆ¶æ•…äº‹

#### **US-F12-001: åŸ·è¡Œæ¦‚è¦½å„€è¡¨æ¿**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** é‹ç¶­å·¥ç¨‹å¸«ï¼ˆLisa Chenï¼‰
- **æˆ‘æƒ³è¦** æŸ¥çœ‹å¯¦æ™‚åŸ·è¡Œçµ±è¨ˆï¼ˆæˆåŠŸç‡ã€ååé‡ã€å¹³å‡è€—æ™‚ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥å¿«é€Ÿäº†è§£ç³»çµ±å¥åº·ç‹€æ³

**é©—æ”¶æ¨™æº–**:

1. âœ… **å¯¦æ™‚æŒ‡æ¨™å¡ç‰‡**: æˆåŠŸç‡ã€ç¸½åŸ·è¡Œæ¬¡æ•¸ã€å¹³å‡è€—æ™‚ã€éŒ¯èª¤æ¬¡æ•¸
2. âœ… **è¶¨å‹¢åœ–è¡¨**: æœ€è¿‘ 24 å°æ™‚åŸ·è¡Œæ¬¡æ•¸è¶¨å‹¢ï¼ˆæ¯å°æ™‚ï¼‰
3. âœ… **éŒ¯èª¤ç‡è¶¨å‹¢**: æœ€è¿‘ 7 å¤©éŒ¯èª¤ç‡è®ŠåŒ–
4. âœ… **Top 5 æ…¢åŸ·è¡Œ**: è€—æ™‚æœ€é•·çš„ 5 å€‹åŸ·è¡Œ
5. âœ… **Top 5 å¤±æ•—å·¥ä½œæµ**: å¤±æ•—æ¬¡æ•¸æœ€å¤šçš„ 5 å€‹å·¥ä½œæµ
6. âœ… **è‡ªå‹•åˆ·æ–°**: æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°æ•¸æ“š

**å„€è¡¨æ¿ UI è¨­è¨ˆ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›£æ§å„€è¡¨æ¿ > åŸ·è¡Œæ¦‚è¦½                                     æœ€å¾Œæ›´æ–°: å‰›å‰›       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚ ğŸ“Š å¯¦æ™‚æŒ‡æ¨™ (æœ€è¿‘ 24 å°æ™‚)                                                    â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ç¸½åŸ·è¡Œæ¬¡æ•¸      â”‚  â”‚ æˆåŠŸç‡          â”‚  â”‚ å¹³å‡è€—æ™‚        â”‚  â”‚ éŒ¯èª¤æ¬¡æ•¸ â”‚â”‚
â”‚ â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚          â”‚â”‚
â”‚ â”‚   1,234         â”‚  â”‚   96.5% âœ“       â”‚  â”‚   3.2 ç§’        â”‚  â”‚   43     â”‚â”‚
â”‚ â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚          â”‚â”‚
â”‚ â”‚ â†‘ 12% vs æ˜¨å¤©   â”‚  â”‚ â†“ 0.5% vs æ˜¨å¤©  â”‚  â”‚ â†“ 0.3s vs æ˜¨å¤©  â”‚  â”‚ â†‘ 5      â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ ğŸ“ˆ åŸ·è¡Œè¶¨å‹¢ (æœ€è¿‘ 24 å°æ™‚)                          [1H] [6H] [24H] [7D]     â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 100 â”‚                                                                   â”‚ â”‚
â”‚ â”‚     â”‚                        â•­â”€â”€â”€â•®                                      â”‚ â”‚
â”‚ â”‚  80 â”‚                 â•­â”€â”€â”€â”€â”€â”€â•¯   â•°â”€â”€â•®                                  â”‚ â”‚
â”‚ â”‚     â”‚          â•­â”€â”€â”€â”€â”€â”€â•¯              â•°â”€â”€â”€â•®                             â”‚ â”‚
â”‚ â”‚  60 â”‚     â•­â”€â”€â”€â”€â•¯                          â•°â”€â•®                          â”‚ â”‚
â”‚ â”‚     â”‚ â•­â”€â”€â”€â•¯                                 â•°â”€â”€â”€â•®                      â”‚ â”‚
â”‚ â”‚  40 â”‚â”€â•¯                                         â•°â”€                     â”‚ â”‚
â”‚ â”‚     â”‚                                                                   â”‚ â”‚
â”‚ â”‚  20 â”‚                                                                   â”‚ â”‚
â”‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚ â”‚       00:00   04:00   08:00   12:00   16:00   20:00   23:59          â”‚ â”‚
â”‚ â”‚                                                                         â”‚ â”‚
â”‚ â”‚       â”€ æˆåŠŸåŸ·è¡Œ   â”€ å¤±æ•—åŸ·è¡Œ                                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                               â”‚
â”‚ âš ï¸ Top 5 æ…¢åŸ·è¡Œ                            ğŸ”¥ Top 5 å¤±æ•—å·¥ä½œæµ               â”‚
â”‚                                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. customer_360_view              â”‚    â”‚ 1. refund_decision            â”‚ â”‚
â”‚ â”‚    åŸ·è¡Œ: exec_abc123              â”‚    â”‚    å¤±æ•—æ¬¡æ•¸: 12               â”‚ â”‚
â”‚ â”‚    è€—æ™‚: 45.3 ç§’                  â”‚    â”‚    éŒ¯èª¤ç‡: 15.2%              â”‚ â”‚
â”‚ â”‚    [æŸ¥çœ‹è©³æƒ…]                     â”‚    â”‚    [æŸ¥çœ‹éŒ¯èª¤]                 â”‚ â”‚
â”‚ â”‚                                   â”‚    â”‚                               â”‚ â”‚
â”‚ â”‚ 2. it_password_reset              â”‚    â”‚ 2. customer_360_view          â”‚ â”‚
â”‚ â”‚    åŸ·è¡Œ: exec_def456              â”‚    â”‚    å¤±æ•—æ¬¡æ•¸: 8                â”‚ â”‚
â”‚ â”‚    è€—æ™‚: 38.1 ç§’                  â”‚    â”‚    éŒ¯èª¤ç‡: 6.5%               â”‚ â”‚
â”‚ â”‚    [æŸ¥çœ‹è©³æƒ…]                     â”‚    â”‚    [æŸ¥çœ‹éŒ¯èª¤]                 â”‚ â”‚
â”‚ â”‚                                   â”‚    â”‚                               â”‚ â”‚
â”‚ â”‚ 3. leave_approval                 â”‚    â”‚ 3. it_password_reset          â”‚ â”‚
â”‚ â”‚    åŸ·è¡Œ: exec_ghi789              â”‚    â”‚    å¤±æ•—æ¬¡æ•¸: 5                â”‚ â”‚
â”‚ â”‚    è€—æ™‚: 32.5 ç§’                  â”‚    â”‚    éŒ¯èª¤ç‡: 4.2%               â”‚ â”‚
â”‚ â”‚    [æŸ¥çœ‹è©³æƒ…]                     â”‚    â”‚    [æŸ¥çœ‹éŒ¯èª¤]                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**FastAPI å¯¦ç¾**:

```python
from fastapi import APIRouter
from datetime import datetime, timedelta
from typing import List, Dict, Any

router = APIRouter(prefix="/api/metrics", tags=["metrics"])

@router.get("/realtime")
async def get_realtime_metrics(hours: int = 24):
    """ç²å–å¯¦æ™‚æŒ‡æ¨™"""
    
    cutoff_time = datetime.utcnow() - timedelta(hours=hours)
    
    # 1. ç¸½åŸ·è¡Œæ¬¡æ•¸
    total_executions = db.query(Execution).filter(
        Execution.created_at >= cutoff_time
    ).count()
    
    # 2. æˆåŠŸç‡
    successful_count = db.query(Execution).filter(
        Execution.created_at >= cutoff_time,
        Execution.status == "completed"
    ).count()
    
    success_rate = (successful_count / total_executions * 100) if total_executions > 0 else 0
    
    # 3. å¹³å‡è€—æ™‚
    avg_duration = db.query(
        func.avg(Execution.duration_seconds)
    ).filter(
        Execution.created_at >= cutoff_time
    ).scalar() or 0
    
    # 4. éŒ¯èª¤æ¬¡æ•¸
    error_count = db.query(Execution).filter(
        Execution.created_at >= cutoff_time,
        Execution.status == "failed"
    ).count()
    
    return {
        "total_executions": total_executions,
        "success_rate": round(success_rate, 1),
        "avg_duration_seconds": round(avg_duration, 1),
        "error_count": error_count
    }

@router.get("/trend")
async def get_execution_trend(hours: int = 24, interval: str = "1h"):
    """ç²å–åŸ·è¡Œè¶¨å‹¢"""
    
    cutoff_time = datetime.utcnow() - timedelta(hours=hours)
    
    # æŒ‰å°æ™‚åˆ†çµ„çµ±è¨ˆ
    trend_data = db.query(
        func.date_trunc('hour', Execution.created_at).label('hour'),
        func.count(Execution.id).label('total'),
        func.count(Execution.id).filter(Execution.status == 'completed').label('success'),
        func.count(Execution.id).filter(Execution.status == 'failed').label('failed')
    ).filter(
        Execution.created_at >= cutoff_time
    ).group_by('hour').order_by('hour').all()
    
    return {
        "trend": [
            {
                "timestamp": row.hour.isoformat(),
                "total": row.total,
                "success": row.success,
                "failed": row.failed
            }
            for row in trend_data
        ]
    }

@router.get("/top-slow-executions")
async def get_top_slow_executions(limit: int = 5):
    """ç²å–æœ€æ…¢çš„åŸ·è¡Œ"""
    
    slow_executions = db.query(Execution).order_by(
        Execution.duration_seconds.desc()
    ).limit(limit).all()
    
    return {
        "slow_executions": [
            {
                "execution_id": exec.execution_id,
                "workflow_name": exec.workflow.name,
                "duration_seconds": exec.duration_seconds,
                "created_at": exec.created_at.isoformat()
            }
            for exec in slow_executions
        ]
    }

@router.get("/top-failed-workflows")
async def get_top_failed_workflows(limit: int = 5):
    """ç²å–å¤±æ•—æœ€å¤šçš„å·¥ä½œæµ"""
    
    failed_workflows = db.query(
        Workflow.workflow_id,
        Workflow.name,
        func.count(Execution.id).label('failed_count'),
        func.count(Execution.id).filter(Execution.status == 'failed') * 100.0 / func.count(Execution.id).label('error_rate')
    ).join(Execution).filter(
        Execution.status == 'failed'
    ).group_by(
        Workflow.workflow_id, Workflow.name
    ).order_by(
        func.count(Execution.id).desc()
    ).limit(limit).all()
    
    return {
        "failed_workflows": [
            {
                "workflow_id": row.workflow_id,
                "workflow_name": row.name,
                "failed_count": row.failed_count,
                "error_rate": round(row.error_rate, 1)
            }
            for row in failed_workflows
        ]
    }
```

**å®Œæˆå®šç¾©**:

- [ ] å¯¦æ™‚æŒ‡æ¨™ API
- [ ] è¶¨å‹¢åœ–è¡¨æ•¸æ“š API
- [ ] Top N æ…¢åŸ·è¡ŒæŸ¥è©¢
- [ ] Top N å¤±æ•—å·¥ä½œæµæŸ¥è©¢
- [ ] å‰ç«¯åœ–è¡¨çµ„ä»¶ï¼ˆRecharts/Chart.jsï¼‰
- [ ] è‡ªå‹•åˆ·æ–°æ©Ÿåˆ¶

---

#### **US-F12-002: è³‡æºç›£æ§å„€è¡¨æ¿**

**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** DevOps å·¥ç¨‹å¸«ï¼ˆMark Leeï¼‰
- **æˆ‘æƒ³è¦** ç›£æ§ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³ï¼ˆCPUã€å…§å­˜ã€æ•¸æ“šåº«é€£æ¥ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥åœ¨è³‡æºä¸è¶³å‰é€²è¡Œæ“´å®¹

**é©—æ”¶æ¨™æº–**:

1. âœ… **CPU/å…§å­˜ä½¿ç”¨ç‡**: å¯¦æ™‚é¡¯ç¤ºæ‡‰ç”¨æœå‹™å™¨ CPU å’Œå…§å­˜ä½¿ç”¨ç‡
2. âœ… **æ•¸æ“šåº«é€£æ¥æ± **: æ´»èºé€£æ¥æ•¸ã€ç©ºé–’é€£æ¥æ•¸ã€ç­‰å¾…éšŠåˆ—
3. âœ… **Redis ç·©å­˜**: å‘½ä¸­ç‡ã€å…§å­˜ä½¿ç”¨ã€é€£æ¥æ•¸
4. âœ… **ç£ç›¤ç©ºé–“**: æ•¸æ“šåº«å­˜å„²ã€æ—¥èªŒå­˜å„²å‰©é¤˜ç©ºé–“
5. âœ… **ç¶²çµ¡æµé‡**: å…¥ç«™/å‡ºç«™æµé‡çµ±è¨ˆ
6. âœ… **å‘Šè­¦é…ç½®**: CPU >80%ã€å…§å­˜ >85%ã€ç£ç›¤ >90% è‡ªå‹•å‘Šè­¦

**Python å¯¦ç¾ï¼ˆPrometheus é›†æˆï¼‰**:

```python
from prometheus_client import Gauge, Counter, Histogram
import psutil
from sqlalchemy import create_engine

# Prometheus æŒ‡æ¨™å®šç¾©
cpu_usage = Gauge('ipa_cpu_usage_percent', 'CPU usage percentage')
memory_usage = Gauge('ipa_memory_usage_percent', 'Memory usage percentage')
db_connections_active = Gauge('ipa_db_connections_active', 'Active database connections')
redis_hit_rate = Gauge('ipa_redis_hit_rate', 'Redis cache hit rate')

class ResourceMonitor:
    """è³‡æºç›£æ§æœå‹™"""
    
    def __init__(self, db_engine, redis_client):
        self.db = db_engine
        self.redis = redis_client
    
    async def collect_metrics(self):
        """æ”¶é›†æ‰€æœ‰è³‡æºæŒ‡æ¨™"""
        
        # 1. CPU ä½¿ç”¨ç‡
        cpu_percent = psutil.cpu_percent(interval=1)
        cpu_usage.set(cpu_percent)
        
        # 2. å…§å­˜ä½¿ç”¨ç‡
        memory = psutil.virtual_memory()
        memory_usage.set(memory.percent)
        
        # 3. æ•¸æ“šåº«é€£æ¥æ± 
        db_pool_status = self.db.pool.status()
        db_connections_active.set(db_pool_status['checked_out'])
        
        # 4. Redis ç·©å­˜å‘½ä¸­ç‡
        redis_info = self.redis.info('stats')
        hits = redis_info.get('keyspace_hits', 0)
        misses = redis_info.get('keyspace_misses', 0)
        hit_rate = hits / (hits + misses) if (hits + misses) > 0 else 0
        redis_hit_rate.set(hit_rate)
        
        return {
            "cpu_percent": cpu_percent,
            "memory_percent": memory.percent,
            "db_connections": db_pool_status,
            "redis_hit_rate": hit_rate * 100
        }

@router.get("/resources")
async def get_resource_metrics():
    """ç²å–è³‡æºæŒ‡æ¨™"""
    monitor = ResourceMonitor(db_engine, redis_client)
    return await monitor.collect_metrics()
```

**å®Œæˆå®šç¾©**:

- [ ] Prometheus æŒ‡æ¨™æ¡é›†
- [ ] è³‡æºç›£æ§ API
- [ ] å‘Šè­¦é–¾å€¼é…ç½®
- [ ] å‰ç«¯è³‡æºå„€è¡¨æ¿

---

#### **US-F12-003: æ¥­å‹™æŒ‡æ¨™å„€è¡¨æ¿**

**å„ªå…ˆç´š**: P1 (é‡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** ç”¢å“ç¶“ç†ï¼ˆMichael Tanï¼‰
- **æˆ‘æƒ³è¦** æŸ¥çœ‹æ¥­å‹™æŒ‡æ¨™ï¼ˆå„å·¥ä½œæµä½¿ç”¨é »ç‡ã€æˆæœ¬ã€ç”¨æˆ¶æ´»èºåº¦ï¼‰
- **ä»¥ä¾¿** æˆ‘å¯ä»¥è©•ä¼°ç”¢å“åƒ¹å€¼å’Œå„ªåŒ–æ–¹å‘

**é©—æ”¶æ¨™æº–**:

1. âœ… **å·¥ä½œæµæ’è¡Œ**: åŸ·è¡Œæ¬¡æ•¸æœ€å¤šçš„ Top 10 å·¥ä½œæµ
2. âœ… **æˆæœ¬çµ±è¨ˆ**: LLM API èª¿ç”¨æˆæœ¬ï¼ˆæŒ‰å·¥ä½œæµåˆ†çµ„ï¼‰
3. âœ… **ç”¨æˆ¶æ´»èºåº¦**: æ—¥æ´»èºç”¨æˆ¶ (DAU)ã€æœˆæ´»èºç”¨æˆ¶ (MAU)
4. âœ… **åŸ·è¡Œæ™‚æ®µåˆ†ä½ˆ**: 24 å°æ™‚åŸ·è¡Œç†±åŠ›åœ–
5. âœ… **SLA é”æˆç‡**: å„å·¥ä½œæµ SLA é”æˆç‡ï¼ˆç›®æ¨™ <5 ç§’ï¼‰
6. âœ… **å°å‡ºå ±å‘Š**: æ”¯æŒå°å‡ºç‚º Excel/PDF

**æ¥­å‹™æŒ‡æ¨™ API**:

```python
@router.get("/business/workflow-ranking")
async def get_workflow_ranking(days: int = 7, limit: int = 10):
    """å·¥ä½œæµåŸ·è¡Œæ’è¡Œ"""
    
    cutoff_time = datetime.utcnow() - timedelta(days=days)
    
    ranking = db.query(
        Workflow.workflow_id,
        Workflow.name,
        func.count(Execution.id).label('execution_count'),
        func.avg(Execution.duration_seconds).label('avg_duration'),
        func.sum(Execution.llm_cost_usd).label('total_cost')
    ).join(Execution).filter(
        Execution.created_at >= cutoff_time
    ).group_by(
        Workflow.workflow_id, Workflow.name
    ).order_by(
        func.count(Execution.id).desc()
    ).limit(limit).all()
    
    return {
        "ranking": [
            {
                "workflow_id": row.workflow_id,
                "workflow_name": row.name,
                "execution_count": row.execution_count,
                "avg_duration": round(row.avg_duration, 1),
                "total_cost_usd": round(row.total_cost, 2)
            }
            for row in ranking
        ]
    }

@router.get("/business/user-activity")
async def get_user_activity():
    """ç”¨æˆ¶æ´»èºåº¦çµ±è¨ˆ"""
    
    # DAU (æœ€è¿‘ 24 å°æ™‚)
    dau = db.query(
        func.count(func.distinct(Execution.triggered_by))
    ).filter(
        Execution.created_at >= datetime.utcnow() - timedelta(days=1)
    ).scalar()
    
    # MAU (æœ€è¿‘ 30 å¤©)
    mau = db.query(
        func.count(func.distinct(Execution.triggered_by))
    ).filter(
        Execution.created_at >= datetime.utcnow() - timedelta(days=30)
    ).scalar()
    
    return {
        "dau": dau,
        "mau": mau,
        "dau_mau_ratio": round(dau / mau * 100, 1) if mau > 0 else 0
    }

@router.get("/business/sla-compliance")
async def get_sla_compliance(sla_threshold_seconds: float = 5.0):
    """SLA é”æˆç‡"""
    
    compliance_by_workflow = db.query(
        Workflow.workflow_id,
        Workflow.name,
        func.count(Execution.id).label('total'),
        func.count(Execution.id).filter(
            Execution.duration_seconds <= sla_threshold_seconds
        ).label('within_sla')
    ).join(Execution).group_by(
        Workflow.workflow_id, Workflow.name
    ).all()
    
    return {
        "sla_compliance": [
            {
                "workflow_id": row.workflow_id,
                "workflow_name": row.name,
                "compliance_rate": round(row.within_sla / row.total * 100, 1) if row.total > 0 else 0,
                "total_executions": row.total
            }
            for row in compliance_by_workflow
        ]
    }
```

**å®Œæˆå®šç¾©**:

- [ ] å·¥ä½œæµæ’è¡Œ API
- [ ] æˆæœ¬çµ±è¨ˆ API
- [ ] ç”¨æˆ¶æ´»èºåº¦ API
- [ ] SLA é”æˆç‡è¨ˆç®—
- [ ] Excel/PDF å ±å‘Šå°å‡º

---

#### **US-F12-004: è‡ªå®šç¾©å„€è¡¨æ¿èˆ‡å‘Šè­¦é…ç½®**

**å„ªå…ˆç´š**: P2 (æ¬¡è¦)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 3 å¤©  
**è¤‡é›œåº¦**: â­â­â­â­

**ç”¨æˆ¶æ•…äº‹**:
- **ä½œç‚º** IT ç®¡ç†å“¡ï¼ˆTom Wangï¼‰
- **æˆ‘æƒ³è¦** å‰µå»ºè‡ªå®šç¾©å„€è¡¨æ¿ä¸¦é…ç½®å‘Šè­¦è¦å‰‡
- **ä»¥ä¾¿** æˆ‘å¯ä»¥é—œæ³¨æœ€é‡è¦çš„æŒ‡æ¨™

**é©—æ”¶æ¨™æº–**:

1. âœ… **è‡ªå®šç¾©å„€è¡¨æ¿**: ç”¨æˆ¶å¯æ·»åŠ /ç§»é™¤/æ’åˆ—æŒ‡æ¨™å¡ç‰‡
2. âœ… **å‘Šè­¦è¦å‰‡**: é…ç½®å‘Šè­¦æ¢ä»¶ï¼ˆå¦‚éŒ¯èª¤ç‡ >5%ï¼‰
3. âœ… **å‘Šè­¦æ¸ é“**: æ”¯æŒ Teamsã€Emailã€Webhook
4. âœ… **å‘Šè­¦éœéŸ³**: è‡¨æ™‚éœéŸ³ç‰¹å®šå‘Šè­¦ï¼ˆ1 å°æ™‚ã€24 å°æ™‚ï¼‰
5. âœ… **å„€è¡¨æ¿åˆ†äº«**: ç”Ÿæˆå…¬é–‹éˆæ¥ä¾›éç™»éŒ„ç”¨æˆ¶æŸ¥çœ‹
6. âœ… **å„€è¡¨æ¿æ¨¡æ¿**: æä¾›é è¨­æ¨¡æ¿ï¼ˆé‹ç¶­è¦–åœ–ã€æ¥­å‹™è¦–åœ–ï¼‰

**å‘Šè­¦é…ç½®ç¤ºä¾‹**:

```yaml
# config/alert_rules.yaml
alert_rules:
  - name: "é«˜éŒ¯èª¤ç‡å‘Šè­¦"
    enabled: true
    condition:
      metric: "error_rate"
      operator: ">"
      threshold: 5.0
      window_minutes: 5
    severity: "critical"
    channels:
      - type: "teams"
        webhook_url: "https://outlook.office.com/webhook/xxx"
      - type: "email"
        recipients: ["ops-team@company.com"]
    
  - name: "CPU éé«˜å‘Šè­¦"
    enabled: true
    condition:
      metric: "cpu_usage_percent"
      operator: ">"
      threshold: 80.0
      window_minutes: 3
    severity: "warning"
    channels:
      - type: "teams"
        webhook_url: "https://outlook.office.com/webhook/xxx"
    
  - name: "DLQ ç©å£“å‘Šè­¦"
    enabled: true
    condition:
      metric: "dlq_count"
      operator: ">"
      threshold: 10
      window_minutes: 10
    severity: "error"
    channels:
      - type: "teams"
        webhook_url: "https://outlook.office.com/webhook/xxx"
```

**å®Œæˆå®šç¾©**:

- [ ] è‡ªå®šç¾©å„€è¡¨æ¿ç·¨è¼¯å™¨
- [ ] å‘Šè­¦è¦å‰‡å¼•æ“
- [ ] å‘Šè­¦æ¸ é“é›†æˆ
- [ ] å‘Šè­¦éœéŸ³åŠŸèƒ½
- [ ] å„€è¡¨æ¿åˆ†äº«éˆæ¥

---

### 12.3 æ•¸æ“šåº«æ¶æ§‹

```sql
-- æŒ‡æ¨™æ™‚åºæ•¸æ“šè¡¨ï¼ˆTimescaleDB åˆ†å€è¡¨ï¼‰
CREATE TABLE metrics_timeseries (
    time TIMESTAMPTZ NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(20, 4) NOT NULL,
    
    -- æ¨™ç±¤ï¼ˆç”¨æ–¼éæ¿¾ï¼‰
    labels JSONB,
    
    -- èšåˆç´šåˆ¥ (raw, 1h, 1d)
    aggregation_level VARCHAR(10) DEFAULT 'raw'
);

-- è½‰æ›ç‚º TimescaleDB è¶…è¡¨
SELECT create_hypertable('metrics_timeseries', 'time');

-- ç´¢å¼•
CREATE INDEX idx_metrics_name_time ON metrics_timeseries(metric_name, time DESC);
CREATE INDEX idx_metrics_labels ON metrics_timeseries USING GIN(labels);

-- è‡ªå®šç¾©å„€è¡¨æ¿é…ç½®è¡¨
CREATE TABLE dashboards (
    id SERIAL PRIMARY KEY,
    dashboard_id VARCHAR(50) UNIQUE NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- æ‰€æœ‰è€…
    owner_user_id VARCHAR(100),
    
    -- é…ç½®
    layout JSONB NOT NULL,  -- å¡ç‰‡ä½ˆå±€é…ç½®
    widgets JSONB NOT NULL,  -- å„å¡ç‰‡é…ç½®
    
    -- åˆ†äº«
    is_public BOOLEAN DEFAULT false,
    public_token VARCHAR(100),
    
    -- æ™‚é–“
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å‘Šè­¦è¦å‰‡è¡¨
CREATE TABLE alert_rules (
    id SERIAL PRIMARY KEY,
    rule_id VARCHAR(50) UNIQUE NOT NULL,
    
    -- è¦å‰‡ä¿¡æ¯
    name VARCHAR(200) NOT NULL,
    enabled BOOLEAN DEFAULT true,
    
    -- æ¢ä»¶
    metric_name VARCHAR(100) NOT NULL,
    operator VARCHAR(10) NOT NULL,  -- >, <, >=, <=, ==
    threshold DECIMAL(20, 4) NOT NULL,
    window_minutes INTEGER DEFAULT 5,
    
    -- åš´é‡ç¨‹åº¦
    severity VARCHAR(20) NOT NULL,  -- info, warning, error, critical
    
    -- å‘Šè­¦æ¸ é“
    channels JSONB NOT NULL,
    
    -- ç‹€æ…‹
    last_triggered_at TIMESTAMP,
    trigger_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å‘Šè­¦æ­·å²è¡¨
CREATE TABLE alert_history (
    id SERIAL PRIMARY KEY,
    rule_id VARCHAR(50) NOT NULL,
    
    -- è§¸ç™¼ä¿¡æ¯
    triggered_at TIMESTAMP NOT NULL,
    metric_value DECIMAL(20, 4) NOT NULL,
    threshold DECIMAL(20, 4) NOT NULL,
    
    -- é€šçŸ¥ç‹€æ…‹
    notification_sent BOOLEAN DEFAULT false,
    notification_channels JSONB,
    
    -- æ¢å¾©
    resolved BOOLEAN DEFAULT false,
    resolved_at TIMESTAMP,
    
    FOREIGN KEY (rule_id) REFERENCES alert_rules(rule_id)
);

CREATE INDEX idx_alert_history_rule ON alert_history(rule_id, triggered_at DESC);
CREATE INDEX idx_alert_history_unresolved ON alert_history(resolved, triggered_at) WHERE NOT resolved;
```

---

### 12.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | å„€è¡¨æ¿åŠ è¼‰æ™‚é–“ | <2 ç§’ | å‰ç«¯æ€§èƒ½ç›£æ§ |
| | æŒ‡æ¨™æŸ¥è©¢å»¶é² | <500ms | API éŸ¿æ‡‰æ™‚é–“ |
| **å¯æ“´å±•æ€§** | æ”¯æŒæŒ‡æ¨™æ•¸é‡ | 1000+ æŒ‡æ¨™é¡å‹ | TimescaleDB å®¹é‡ |
| | æ•¸æ“šä¿ç•™æœŸ | 90 å¤©é«˜ç²¾åº¦ + 1 å¹´èšåˆ | è‡ªå‹•å£“ç¸®ç­–ç•¥ |
| **å¯é æ€§** | å‘Šè­¦å»¶é² | <1 åˆ†é˜ï¼ˆå¾é–¾å€¼è§¸ç™¼åˆ°é€šçŸ¥ï¼‰ | å‘Šè­¦æ—¥èªŒ |
| | å‘Šè­¦æº–ç¢ºç‡ | >99%ï¼ˆç„¡èª¤å ±ï¼‰ | å‘Šè­¦æ­·å²åˆ†æ |

---

### 12.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:

- æŒ‡æ¨™è¨ˆç®—é‚è¼¯ï¼ˆæˆåŠŸç‡ã€å¹³å‡å€¼ã€ç™¾åˆ†ä½æ•¸ï¼‰
- å‘Šè­¦è¦å‰‡åŒ¹é…
- SLA é”æˆç‡è¨ˆç®—

**é›†æˆæ¸¬è©¦**:

- ç«¯åˆ°ç«¯æŒ‡æ¨™æ¡é›† â†’ å­˜å„² â†’ æŸ¥è©¢
- å‘Šè­¦è§¸ç™¼ â†’ Teams/Email é€šçŸ¥

**æ€§èƒ½æ¸¬è©¦**:

- 100 è¬æ¢æŒ‡æ¨™æ•¸æ“šæŸ¥è©¢æ€§èƒ½
- 1000 å€‹ä¸¦ç™¼å„€è¡¨æ¿è«‹æ±‚

**å£“åŠ›æ¸¬è©¦**:

- 10000 æŒ‡æ¨™/ç§’å¯«å…¥ TimescaleDB

---

### 12.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| TimescaleDB å­˜å„²ç©ºé–“ä¸è¶³ | ä¸­ | ä¸­ | è‡ªå‹•å£“ç¸® + æ•¸æ“šæ­¸æª” |
| å‘Šè­¦é¢¨æš´ï¼ˆçŸ­æ™‚é–“å¤§é‡å‘Šè­¦ï¼‰ | é«˜ | ä¸­ | å‘Šè­¦èšåˆ + é »ç‡é™åˆ¶ |
| Prometheus æ¡é›†å¤±æ•— | ä½ | ä¸­ | é™ç´šè‡³æ•¸æ“šåº«æŸ¥è©¢ |
| å„€è¡¨æ¿åŠ è¼‰æ…¢ | ä¸­ | ä½ | Redis ç·©å­˜ + æ•¸æ“šé èšåˆ |

---

### 12.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **ç•°å¸¸æª¢æ¸¬**: ä½¿ç”¨ ML è‡ªå‹•æª¢æ¸¬æŒ‡æ¨™ç•°å¸¸ï¼ˆå¦‚çªå¢/çªé™ï¼‰
2. **é æ¸¬æ€§å‘Šè­¦**: æ ¹æ“šè¶¨å‹¢é æ¸¬è³‡æºä¸è¶³ï¼ˆæå‰ 1 å°æ™‚å‘Šè­¦ï¼‰
3. **æ ¹å› åˆ†æ**: è‡ªå‹•åˆ†æéŒ¯èª¤çš„æ ¹æœ¬åŸå› ï¼ˆé—œè¯æ—¥èªŒã€æŒ‡æ¨™ï¼‰
4. **ç§»å‹•ç«¯å„€è¡¨æ¿**: iOS/Android åŸç”Ÿæ‡‰ç”¨
5. **èªéŸ³å‘Šè­¦**: é—œéµå‘Šè­¦é€šéé›»è©±èªéŸ³é€šçŸ¥

---

**âœ… F12 å®Œæˆ**ï¼šç›£æ§å„€è¡¨æ¿åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f13-modern-web-ui"></a>13. F13: ç¾ä»£åŒ– Web UI

**åŠŸèƒ½é¡åˆ¥**: UI/UX (ç”¨æˆ¶é«”é©—)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 4 é€±  
**è¤‡é›œåº¦**: â­â­â­â­â­

---

### 13.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F13ï¼ˆç¾ä»£åŒ– Web UIï¼‰æä¾›**ç›´è§€ã€éŸ¿æ‡‰å¼çš„å‰ç«¯ç•Œé¢**ï¼Œæ¶µè“‹ 8 å€‹æ ¸å¿ƒé é¢ï¼Œè®“ç”¨æˆ¶èƒ½å¤ ç„¡ç¸«ç®¡ç† Workflowã€Agentã€Prompt ç­‰è³‡æºã€‚é‡‡ç”¨ç¾ä»£å‰ç«¯æŠ€è¡“æ£§ï¼ˆReact 18 + TypeScriptï¼‰ï¼Œæä¾›æ¡Œé¢ç´šçš„æ“ä½œé«”é©—ã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **é™ä½ä½¿ç”¨é–€æª»**: å¯è¦–åŒ–ç·¨è¼¯å™¨è®“éæŠ€è¡“ç”¨æˆ¶ä¹Ÿèƒ½æ§‹å»ºè¤‡é›œ Workflow
- **æå‡æ•ˆç‡**: æ‹–æ‹‰å¼æ“ä½œæ¯”æ‰‹å¯« YAML å¿« 5 å€
- **å¯¦æ™‚åé¥‹**: å³æ™‚é©—è­‰é…ç½®éŒ¯èª¤ï¼Œæ¸›å°‘èª¿è©¦æ™‚é–“
- **è·¨å¹³å°**: éŸ¿æ‡‰å¼è¨­è¨ˆæ”¯æŒæ¡Œé¢ã€å¹³æ¿ã€æ‰‹æ©Ÿ

**æ ¸å¿ƒé é¢**:
1. **é¦–é  Dashboard**: ç³»çµ±æ¦‚æ³ã€KPIã€å¿«é€Ÿå…¥å£
2. **Workflow Builder**: å¯è¦–åŒ–æµç¨‹ç·¨è¼¯å™¨ï¼ˆæ‹–æ‹‰ç¯€é»ï¼‰
3. **Execution List**: åŸ·è¡Œæ­·å²æŸ¥è©¢èˆ‡ç¯©é¸
4. **Agent Marketplace**: Agent ç™¼ç¾èˆ‡å®‰è£
5. **Monitoring Dashboard**: å¯¦æ™‚ç›£æ§å„€è¡¨æ¿ï¼ˆé›†æˆ F12ï¼‰
6. **Audit Logs**: å¯©è¨ˆæ—¥èªŒæŸ¥è©¢ï¼ˆé›†æˆ F10ï¼‰
7. **DLQ Management**: æ­»ä¿¡éšŠåˆ—ç®¡ç†ï¼ˆé›†æˆ F8ï¼‰
8. **Prompt Editor**: Prompt æ¨¡æ¿ç·¨è¼¯å™¨ï¼ˆé›†æˆ F9ï¼‰

**æŠ€è¡“æ£§**:
- **å‰ç«¯æ¡†æ¶**: React 18 + TypeScript
- **ç‹€æ…‹ç®¡ç†**: Redux Toolkit + RTK Query
- **UI çµ„ä»¶**: Ant Design / Material-UI
- **åœ–è¡¨åº«**: ECharts / Recharts
- **Workflow ç·¨è¼¯å™¨**: ReactFlow
- **ä»£ç¢¼ç·¨è¼¯å™¨**: Monaco Editorï¼ˆVS Code ç·¨è¼¯å™¨ï¼‰
- **è·¯ç”±**: React Router v6
- **è«‹æ±‚åº«**: Axios + interceptors

**æ¥­å‹™åƒ¹å€¼**:
- **ç”¨æˆ¶ç•™å­˜**: å‹å¥½ UI ä½¿æ–°ç”¨æˆ¶ä¸Šæ‰‹æ™‚é–“å¾ 2 å°æ™‚é™è‡³ 15 åˆ†é˜
- **éŒ¯èª¤æ¸›å°‘**: å¯¦æ™‚é©—è­‰æ¸›å°‘ 60% é…ç½®éŒ¯èª¤
- **è·¨éƒ¨é–€å”ä½œ**: å¸‚å ´åœ˜éšŠå¯ç›´æ¥ç·¨è¼¯ Promptï¼Œç„¡éœ€æŠ€è¡“æ”¯æŒ

---

### 13.2 ç”¨æˆ¶æ•…äº‹

#### **US-F13-001: é¦–é  Dashboard**

**User Story**:  
ä½œç‚ºç³»çµ±ç”¨æˆ¶ï¼Œæˆ‘å¸Œæœ›åœ¨é¦–é çœ‹åˆ°ç³»çµ±é‹è¡Œæ¦‚æ³å’Œé—œéµæŒ‡æ¨™ï¼Œä»¥ä¾¿å¿«é€ŸæŒæ¡ç³»çµ±ç‹€æ…‹ã€‚

**å ´æ™¯æè¿°**:
- ç”¨æˆ¶ç™»å…¥å¾Œé€²å…¥é¦–é  Dashboard
- é¡¯ç¤ºä»Šæ—¥åŸ·è¡Œçµ±è¨ˆã€æˆåŠŸç‡ã€å¹³å‡åŸ·è¡Œæ™‚é–“
- é¡¯ç¤ºè¿‘ 7 å¤©çš„è¶¨å‹¢åœ–è¡¨
- é¡¯ç¤ºå‘Šè­¦å’Œ DLQ æ¶ˆæ¯æ‘˜è¦
- å¿«é€Ÿå…¥å£ï¼šæ–°å»º Workflowã€æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ã€Agent å•†åº—

**Acceptance Criteria**:
1. âœ… é¡¯ç¤º 4 å€‹æ ¸å¿ƒ KPI å¡ç‰‡ï¼šä»Šæ—¥åŸ·è¡Œæ•¸ã€æˆåŠŸç‡ã€å¹³å‡åŸ·è¡Œæ™‚é–“ã€æ´»èº Agent æ•¸
2. âœ… é¡¯ç¤ºè¿‘ 7 å¤©åŸ·è¡Œè¶¨å‹¢æŠ˜ç·šåœ–ï¼ˆæˆåŠŸ/å¤±æ•—/ç¸½æ•¸ï¼‰
3. âœ… é¡¯ç¤º Top 5 ç†±é–€ Workflow æ’è¡Œæ¦œ
4. âœ… é¡¯ç¤ºæœ€æ–° 5 æ¢ DLQ å‘Šè­¦ï¼ˆåŒ…å«è·³è½‰é€£çµï¼‰
5. âœ… æä¾›å¿«é€Ÿæ“ä½œæŒ‰éˆ•ï¼š+ æ–°å»º Workflowã€æŸ¥çœ‹æ‰€æœ‰åŸ·è¡Œã€Agent å•†åº—
6. âœ… æ‰€æœ‰æ•¸æ“šæ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
7. âœ… éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œæ”¯æŒæ¡Œé¢å’Œå¹³æ¿

**UI Mockupï¼ˆReact çµ„ä»¶çµæ§‹ï¼‰**:

```tsx
// HomePage.tsx
import React, { useEffect } from 'react';
import { Row, Col, Card, Statistic, Button, Table, List } from 'antd';
import { Line } from '@ant-design/charts';
import { PlusOutlined, HistoryOutlined, AppstoreOutlined } from '@ant-design/icons';
import { useGetDashboardStatsQuery, useGetTrendDataQuery } from '@/api/dashboardApi';

export const HomePage: React.FC = () => {
  const { data: stats, refetch: refetchStats } = useGetDashboardStatsQuery();
  const { data: trendData } = useGetTrendDataQuery({ days: 7 });

  // Auto-refresh every 30 seconds
  useEffect(() => {
    const interval = setInterval(() => refetchStats(), 30000);
    return () => clearInterval(interval);
  }, [refetchStats]);

  const trendConfig = {
    data: trendData?.data || [],
    xField: 'date',
    yField: 'count',
    seriesField: 'status',
    smooth: true,
    legend: { position: 'top' },
  };

  const topWorkflowColumns = [
    { title: 'Workflow åç¨±', dataIndex: 'name', key: 'name' },
    { title: 'åŸ·è¡Œæ¬¡æ•¸', dataIndex: 'count', key: 'count', sorter: true },
    { title: 'æˆåŠŸç‡', dataIndex: 'success_rate', key: 'success_rate', render: (v: number) => `${v}%` },
  ];

  return (
    <div className="home-page">
      <h1>å„€è¡¨æ¿</h1>

      {/* KPI Cards */}
      <Row gutter={16} style={{ marginBottom: 24 }}>
        <Col span={6}>
          <Card>
            <Statistic title="ä»Šæ—¥åŸ·è¡Œæ•¸" value={stats?.today_executions || 0} />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="æˆåŠŸç‡"
              value={stats?.success_rate || 0}
              precision={2}
              suffix="%"
              valueStyle={{ color: stats?.success_rate >= 95 ? '#3f8600' : '#cf1322' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="å¹³å‡åŸ·è¡Œæ™‚é–“"
              value={stats?.avg_execution_time || 0}
              suffix="ç§’"
              precision={2}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic title="æ´»èº Agent" value={stats?.active_agents || 0} />
          </Card>
        </Col>
      </Row>

      {/* Quick Actions */}
      <Row gutter={16} style={{ marginBottom: 24 }}>
        <Col span={24}>
          <Card title="å¿«é€Ÿæ“ä½œ">
            <Button type="primary" icon={<PlusOutlined />} href="/workflows/new" style={{ marginRight: 8 }}>
              æ–°å»º Workflow
            </Button>
            <Button icon={<HistoryOutlined />} href="/executions" style={{ marginRight: 8 }}>
              æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„
            </Button>
            <Button icon={<AppstoreOutlined />} href="/agents/marketplace">
              Agent å•†åº—
            </Button>
          </Card>
        </Col>
      </Row>

      {/* Trend Chart */}
      <Row gutter={16} style={{ marginBottom: 24 }}>
        <Col span={16}>
          <Card title="è¿‘ 7 å¤©åŸ·è¡Œè¶¨å‹¢">
            <Line {...trendConfig} />
          </Card>
        </Col>
        <Col span={8}>
          <Card title="Top 5 ç†±é–€ Workflow">
            <Table
              dataSource={stats?.top_workflows || []}
              columns={topWorkflowColumns}
              pagination={false}
              size="small"
            />
          </Card>
        </Col>
      </Row>

      {/* DLQ Alerts */}
      <Row gutter={16}>
        <Col span={24}>
          <Card title="æœ€æ–° DLQ å‘Šè­¦" extra={<a href="/dlq">æŸ¥çœ‹å…¨éƒ¨</a>}>
            <List
              dataSource={stats?.recent_dlq || []}
              renderItem={(item: any) => (
                <List.Item>
                  <List.Item.Meta
                    title={<a href={`/dlq/${item.id}`}>{item.workflow_name}</a>}
                    description={`éŒ¯èª¤: ${item.error_message} | ${item.created_at}`}
                  />
                </List.Item>
              )}
            />
          </Card>
        </Col>
      </Row>
    </div>
  );
};
```

**API Endpoints**:

```python
# api/dashboard.py
from fastapi import APIRouter, Depends
from datetime import datetime, timedelta
from sqlalchemy import func
from typing import List

router = APIRouter(prefix="/api/dashboard", tags=["dashboard"])

@router.get("/stats")
async def get_dashboard_stats(db: Session = Depends(get_db)):
    """ç²å– Dashboard çµ±è¨ˆæ•¸æ“š"""
    today = datetime.now().date()
    
    # Today's executions
    today_executions = db.query(func.count(WorkflowExecution.id)).filter(
        func.date(WorkflowExecution.started_at) == today
    ).scalar()
    
    # Success rate (last 7 days)
    week_ago = datetime.now() - timedelta(days=7)
    total_executions = db.query(func.count(WorkflowExecution.id)).filter(
        WorkflowExecution.started_at >= week_ago
    ).scalar()
    successful_executions = db.query(func.count(WorkflowExecution.id)).filter(
        WorkflowExecution.started_at >= week_ago,
        WorkflowExecution.status == 'completed'
    ).scalar()
    success_rate = (successful_executions / total_executions * 100) if total_executions > 0 else 0
    
    # Average execution time
    avg_time = db.query(func.avg(
        func.extract('epoch', WorkflowExecution.completed_at - WorkflowExecution.started_at)
    )).filter(
        WorkflowExecution.started_at >= week_ago,
        WorkflowExecution.status == 'completed'
    ).scalar() or 0
    
    # Active agents
    active_agents = db.query(func.count(func.distinct(Agent.id))).filter(
        Agent.is_active == True
    ).scalar()
    
    # Top 5 workflows
    top_workflows = db.query(
        Workflow.name,
        func.count(WorkflowExecution.id).label('count'),
        (func.sum(case([(WorkflowExecution.status == 'completed', 1)], else_=0)) * 100.0 / func.count(WorkflowExecution.id)).label('success_rate')
    ).join(WorkflowExecution).filter(
        WorkflowExecution.started_at >= week_ago
    ).group_by(Workflow.id, Workflow.name).order_by(desc('count')).limit(5).all()
    
    # Recent DLQ
    recent_dlq = db.query(DLQ).order_by(desc(DLQ.created_at)).limit(5).all()
    
    return {
        "today_executions": today_executions,
        "success_rate": round(success_rate, 2),
        "avg_execution_time": round(avg_time, 2),
        "active_agents": active_agents,
        "top_workflows": [
            {"name": w.name, "count": w.count, "success_rate": round(w.success_rate, 2)}
            for w in top_workflows
        ],
        "recent_dlq": [
            {
                "id": d.id,
                "workflow_name": d.workflow.name,
                "error_message": d.error_message[:100],
                "created_at": d.created_at.isoformat()
            }
            for d in recent_dlq
        ]
    }

@router.get("/trend")
async def get_trend_data(days: int = 7, db: Session = Depends(get_db)):
    """ç²å–åŸ·è¡Œè¶¨å‹¢æ•¸æ“š"""
    start_date = datetime.now() - timedelta(days=days)
    
    trend_data = db.query(
        func.date(WorkflowExecution.started_at).label('date'),
        WorkflowExecution.status,
        func.count(WorkflowExecution.id).label('count')
    ).filter(
        WorkflowExecution.started_at >= start_date
    ).group_by('date', WorkflowExecution.status).all()
    
    # Format for chart
    formatted_data = []
    for record in trend_data:
        formatted_data.append({
            "date": record.date.isoformat(),
            "status": record.status,
            "count": record.count
        })
    
    return {"data": formatted_data}
```

**æ¸¬è©¦ç­–ç•¥**:

1. å–®å…ƒæ¸¬è©¦ï¼šæ¸¬è©¦å„ KPI è¨ˆç®—é‚è¼¯æ­£ç¢ºæ€§
2. UI æ¸¬è©¦ï¼šä½¿ç”¨ React Testing Library æ¸¬è©¦çµ„ä»¶æ¸²æŸ“å’Œäº¤äº’
3. é›†æˆæ¸¬è©¦ï¼šæ¸¬è©¦ API ç«¯é»æ•¸æ“šè¿”å›æ­£ç¢ºæ€§
4. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦ 30 ç§’è‡ªå‹•åˆ·æ–°ä¸å½±éŸ¿ç”¨æˆ¶é«”é©—
5. éŸ¿æ‡‰å¼æ¸¬è©¦ï¼šåœ¨ä¸åŒå±å¹•å°ºå¯¸ä¸‹æ¸¬è©¦ä½ˆå±€

---

#### **US-F13-002: Workflow Builderï¼ˆæµç¨‹ç·¨è¼¯å™¨ï¼‰**

**User Story**:  
ä½œç‚ºæ¥­å‹™ç”¨æˆ¶ï¼Œæˆ‘å¸Œæœ›é€šéå¯è¦–åŒ–æ‹–æ‹‰çš„æ–¹å¼ç·¨è¼¯ Workflowï¼Œä»¥ä¾¿ç„¡éœ€ç·¨ç¢¼å³å¯æ§‹å»ºè¤‡é›œæµç¨‹ã€‚

**å ´æ™¯æè¿°**:

- ç”¨æˆ¶åœ¨ Workflow Builder ä¸­æ‹–æ‹‰ç¯€é»ï¼ˆAgentã€æ¢ä»¶åˆ¤æ–·ã€å¾ªç’°ã€ä¸¦è¡Œï¼‰
- é…ç½®ç¯€é»åƒæ•¸ï¼ˆè¼¸å…¥è¼¸å‡ºæ˜ å°„ã€Prompt è®Šæ•¸ã€è¶…æ™‚è¨­ç½®ï¼‰
- é€£æ¥ç¯€é»å½¢æˆåŸ·è¡Œæµç¨‹
- å¯¦æ™‚é©—è­‰é…ç½®åˆæ³•æ€§
- ä¿å­˜ä¸¦éƒ¨ç½² Workflow

**Acceptance Criteria**:

1. âœ… æä¾›ç¯€é»é¢æ¿ï¼šAgent ç¯€é»ã€æ¢ä»¶ç¯€é»ã€å¾ªç’°ç¯€é»ã€ä¸¦è¡Œç¯€é»ã€é–‹å§‹/çµæŸç¯€é»
2. âœ… æ”¯æŒæ‹–æ‹‰ç¯€é»åˆ°ç•«å¸ƒä¸¦è‡ªå‹•å°é½Š
3. âœ… æ”¯æŒé€£ç·šç¯€é»ï¼ˆå¸¶ç®­é ­ï¼Œæ”¯æŒåˆªé™¤ï¼‰
4. âœ… é»æ“Šç¯€é»é¡¯ç¤ºå±¬æ€§é¢æ¿ï¼Œå¯é…ç½®è¼¸å…¥/è¼¸å‡º/åƒæ•¸
5. âœ… å¯¦æ™‚é©—è­‰ï¼šæª¢æŸ¥å¾ªç’°å¼•ç”¨ã€æœªé€£æ¥ç¯€é»ã€åƒæ•¸ç¼ºå¤±
6. âœ… æ”¯æŒä¿å­˜è‰ç¨¿ã€ç™¼å¸ƒç‰ˆæœ¬ã€æŸ¥çœ‹æ­·å²ç‰ˆæœ¬
7. âœ… æ”¯æŒå¿«æ·éµï¼šCtrl+S ä¿å­˜ã€Ctrl+Z æ’¤éŠ·ã€Ctrl+Y é‡åš
8. âœ… æ”¯æŒæ”¾å¤§/ç¸®å°/è‡ªå‹•ä½ˆå±€

**UI Mockupï¼ˆReactFlow å¯¦ç¾ï¼‰**:

```tsx
// WorkflowBuilder.tsx
import React, { useState, useCallback } from 'react';
import ReactFlow, {
  Node,
  Edge,
  Controls,
  Background,
  addEdge,
  Connection,
  useNodesState,
  useEdgesState,
  MiniMap,
} from 'reactflow';
import 'reactflow/dist/style.css';
import { Button, Drawer, Form, Input, Select, message } from 'antd';
import { SaveOutlined, CheckCircleOutlined } from '@ant-design/icons';
import { useCreateWorkflowMutation, useUpdateWorkflowMutation } from '@/api/workflowApi';
import { AgentNode } from './nodes/AgentNode';
import { ConditionNode } from './nodes/ConditionNode';

const nodeTypes = {
  agent: AgentNode,
  condition: ConditionNode,
  // ... other custom nodes
};

export const WorkflowBuilder: React.FC<{ workflowId?: string }> = ({ workflowId }) => {
  const [nodes, setNodes, onNodesChange] = useNodesState([]);
  const [edges, setEdges, onEdgesChange] = useEdgesState([]);
  const [selectedNode, setSelectedNode] = useState<Node | null>(null);
  const [drawerVisible, setDrawerVisible] = useState(false);
  const [createWorkflow] = useCreateWorkflowMutation();
  const [updateWorkflow] = useUpdateWorkflowMutation();

  const onConnect = useCallback(
    (params: Connection) => setEdges((eds) => addEdge(params, eds)),
    [setEdges]
  );

  const onNodeClick = useCallback((event: React.MouseEvent, node: Node) => {
    setSelectedNode(node);
    setDrawerVisible(true);
  }, []);

  const validateWorkflow = (): { valid: boolean; errors: string[] } => {
    const errors: string[] = [];
    
    // Check for disconnected nodes
    const connectedNodes = new Set(edges.flatMap(e => [e.source, e.target]));
    nodes.forEach(node => {
      if (node.type !== 'start' && node.type !== 'end' && !connectedNodes.has(node.id)) {
        errors.push(`ç¯€é» "${node.data.label}" æœªé€£æ¥`);
      }
    });
    
    // Check for circular dependencies
    const detectCycle = (nodeId: string, visited: Set<string>, stack: Set<string>): boolean => {
      if (stack.has(nodeId)) return true;
      if (visited.has(nodeId)) return false;
      
      visited.add(nodeId);
      stack.add(nodeId);
      
      const outgoingEdges = edges.filter(e => e.source === nodeId);
      for (const edge of outgoingEdges) {
        if (detectCycle(edge.target, visited, stack)) return true;
      }
      
      stack.delete(nodeId);
      return false;
    };
    
    const visited = new Set<string>();
    const stack = new Set<string>();
    for (const node of nodes) {
      if (detectCycle(node.id, visited, stack)) {
        errors.push('æª¢æ¸¬åˆ°å¾ªç’°å¼•ç”¨');
        break;
      }
    }
    
    // Check for missing required parameters
    nodes.forEach(node => {
      if (node.type === 'agent' && !node.data.agentId) {
        errors.push(`ç¯€é» "${node.data.label}" æœªé¸æ“‡ Agent`);
      }
    });
    
    return { valid: errors.length === 0, errors };
  };

  const handleSave = async (publish: boolean = false) => {
    const validation = validateWorkflow();
    if (!validation.valid) {
      message.error(`é©—è­‰å¤±æ•—: ${validation.errors.join(', ')}`);
      return;
    }
    
    const workflowData = {
      nodes: nodes.map(n => ({ id: n.id, type: n.type, data: n.data, position: n.position })),
      edges: edges.map(e => ({ source: e.source, target: e.target, label: e.label })),
      status: publish ? 'published' : 'draft'
    };
    
    try {
      if (workflowId) {
        await updateWorkflow({ id: workflowId, ...workflowData }).unwrap();
      } else {
        await createWorkflow(workflowData).unwrap();
      }
      message.success(publish ? 'Workflow å·²ç™¼å¸ƒ' : 'Workflow å·²ä¿å­˜ç‚ºè‰ç¨¿');
    } catch (err) {
      message.error('ä¿å­˜å¤±æ•—');
    }
  };

  return (
    <div style={{ height: '100vh' }}>
      <div style={{ padding: '16px', background: '#fff', borderBottom: '1px solid #f0f0f0' }}>
        <Button icon={<SaveOutlined />} onClick={() => handleSave(false)} style={{ marginRight: 8 }}>
          ä¿å­˜è‰ç¨¿
        </Button>
        <Button type="primary" icon={<CheckCircleOutlined />} onClick={() => handleSave(true)}>
          ç™¼å¸ƒ
        </Button>
      </div>

      <ReactFlow
        nodes={nodes}
        edges={edges}
        onNodesChange={onNodesChange}
        onEdgesChange={onEdgesChange}
        onConnect={onConnect}
        onNodeClick={onNodeClick}
        nodeTypes={nodeTypes}
        fitView
      >
        <Controls />
        <MiniMap />
        <Background />
      </ReactFlow>

      <Drawer
        title="ç¯€é»é…ç½®"
        placement="right"
        width={400}
        onClose={() => setDrawerVisible(false)}
        open={drawerVisible}
      >
        {selectedNode && (
          <Form layout="vertical">
            <Form.Item label="ç¯€é»åç¨±">
              <Input value={selectedNode.data.label} onChange={(e) => {
                setNodes(nds => nds.map(n => 
                  n.id === selectedNode.id ? { ...n, data: { ...n.data, label: e.target.value } } : n
                ));
              }} />
            </Form.Item>
            {selectedNode.type === 'agent' && (
              <Form.Item label="é¸æ“‡ Agent">
                <Select
                  value={selectedNode.data.agentId}
                  onChange={(value) => {
                    setNodes(nds => nds.map(n => 
                      n.id === selectedNode.id ? { ...n, data: { ...n.data, agentId: value } } : n
                    ));
                  }}
                >
                  {/* Populate with agents from API */}
                </Select>
              </Form.Item>
            )}
            {/* Add more configuration fields based on node type */}
          </Form>
        )}
      </Drawer>
    </div>
  );
};
```

**è‡ªå®šç¾©ç¯€é»ç¤ºä¾‹**:

```tsx
// nodes/AgentNode.tsx
import React, { memo } from 'react';
import { Handle, Position } from 'reactflow';
import { Card, Tag } from 'antd';
import { RobotOutlined } from '@ant-design/icons';

export const AgentNode = memo(({ data }: { data: any }) => {
  return (
    <Card
      size="small"
      style={{ width: 200, border: '2px solid #1890ff' }}
      title={
        <div>
          <RobotOutlined style={{ marginRight: 8 }} />
          {data.label || 'Agent ç¯€é»'}
        </div>
      }
    >
      <Handle type="target" position={Position.Top} />
      <div>
        {data.agentId ? (
          <Tag color="blue">{data.agentName}</Tag>
        ) : (
          <Tag color="red">æœªé…ç½®</Tag>
        )}
      </div>
      <Handle type="source" position={Position.Bottom} />
    </Card>
  );
});
```

**API Endpoints**:

```python
# api/workflow.py
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import List, Dict, Any, Optional

router = APIRouter(prefix="/api/workflows", tags=["workflows"])

class WorkflowNode(BaseModel):
    id: str
    type: str
    data: Dict[str, Any]
    position: Dict[str, float]

class WorkflowEdge(BaseModel):
    source: str
    target: str
    label: Optional[str] = None

class WorkflowCreate(BaseModel):
    name: str
    description: Optional[str] = None
    nodes: List[WorkflowNode]
    edges: List[WorkflowEdge]
    status: str = "draft"  # draft, published

@router.post("/")
async def create_workflow(workflow: WorkflowCreate, db: Session = Depends(get_db)):
    """å‰µå»ºæ–° Workflow"""
    db_workflow = Workflow(
        name=workflow.name,
        description=workflow.description,
        definition={
            "nodes": [n.dict() for n in workflow.nodes],
            "edges": [e.dict() for e in workflow.edges]
        },
        status=workflow.status,
        version=1
    )
    db.add(db_workflow)
    db.commit()
    db.refresh(db_workflow)
    return db_workflow

@router.put("/{workflow_id}")
async def update_workflow(workflow_id: str, workflow: WorkflowCreate, db: Session = Depends(get_db)):
    """æ›´æ–° Workflowï¼ˆå‰µå»ºæ–°ç‰ˆæœ¬ï¼‰"""
    old_workflow = db.query(Workflow).filter(Workflow.id == workflow_id).first()
    if not old_workflow:
        raise HTTPException(status_code=404, detail="Workflow not found")
    
    # Create new version
    new_version = old_workflow.version + 1
    db_workflow = Workflow(
        name=workflow.name,
        description=workflow.description,
        definition={
            "nodes": [n.dict() for n in workflow.nodes],
            "edges": [e.dict() for e in workflow.edges]
        },
        status=workflow.status,
        version=new_version,
        parent_id=old_workflow.id
    )
    db.add(db_workflow)
    db.commit()
    db.refresh(db_workflow)
    return db_workflow

@router.get("/{workflow_id}/versions")
async def get_workflow_versions(workflow_id: str, db: Session = Depends(get_db)):
    """ç²å– Workflow æ­·å²ç‰ˆæœ¬"""
    versions = db.query(Workflow).filter(
        (Workflow.id == workflow_id) | (Workflow.parent_id == workflow_id)
    ).order_by(desc(Workflow.version)).all()
    return versions
```

**æ¸¬è©¦ç­–ç•¥**:

1. UI æ¸¬è©¦ï¼šæ¸¬è©¦æ‹–æ‹‰ç¯€é»ã€é€£ç·šã€é…ç½®é¢æ¿äº¤äº’
2. é©—è­‰æ¸¬è©¦ï¼šæ¸¬è©¦å¾ªç’°å¼•ç”¨æª¢æ¸¬ã€æœªé€£æ¥ç¯€é»æª¢æ¸¬
3. ä¿å­˜æ¸¬è©¦ï¼šæ¸¬è©¦è‰ç¨¿ä¿å­˜ã€ç‰ˆæœ¬ç™¼å¸ƒã€æ­·å²ç‰ˆæœ¬æŸ¥è©¢
4. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦åŒ…å« 50+ ç¯€é»çš„å¤§å‹ Workflow ç·¨è¼¯æµæš¢åº¦
5. å¿«æ·éµæ¸¬è©¦ï¼šæ¸¬è©¦ Ctrl+Sã€Ctrl+Zã€Ctrl+Y åŠŸèƒ½

---

#### **US-F13-003: Execution Listï¼ˆåŸ·è¡Œæ­·å²ï¼‰èˆ‡ Agent Marketplace**

**User Story**:  
ä½œç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œæˆ‘å¸Œæœ›æŸ¥çœ‹æ‰€æœ‰ Workflow åŸ·è¡Œæ­·å²ä¸¦æŒ‰æ¢ä»¶ç¯©é¸ï¼Œä»¥ä¾¿è¿½è¹¤åŸ·è¡Œç‹€æ…‹å’Œåˆ†ææ•…éšœã€‚åŒæ™‚ï¼Œä½œç‚ºé–‹ç™¼è€…ï¼Œæˆ‘å¸Œæœ›å¾ Agent å•†åº—ç™¼ç¾å’Œå®‰è£æ–° Agentï¼Œä»¥ä¾¿å¿«é€Ÿæ“´å±•ç³»çµ±èƒ½åŠ›ã€‚

**å ´æ™¯æè¿°ï¼ˆExecution Listï¼‰**:

- ç”¨æˆ¶é€²å…¥åŸ·è¡Œæ­·å²é é¢
- é¡¯ç¤ºæ‰€æœ‰ Workflow åŸ·è¡Œè¨˜éŒ„ï¼ˆåˆ†é ï¼‰
- æ”¯æŒæŒ‰ Workflow åç¨±ã€ç‹€æ…‹ã€æ™‚é–“ç¯„åœç¯©é¸
- é»æ“ŠåŸ·è¡Œè¨˜éŒ„æŸ¥çœ‹è©³ç´°æ—¥èªŒå’Œè¼¸å…¥/è¼¸å‡º
- æ”¯æŒæ‰‹å‹•é‡è©¦å¤±æ•—çš„åŸ·è¡Œ

**å ´æ™¯æè¿°ï¼ˆAgent Marketplaceï¼‰**:

- ç”¨æˆ¶ç€è¦½ Agent å•†åº—
- é¡¯ç¤ºå®˜æ–¹å’Œç¤¾å€ Agentï¼ˆå¸¶è©•åˆ†ã€ä¸‹è¼‰é‡ã€æè¿°ï¼‰
- é»æ“Š Agent æŸ¥çœ‹è©³ç´°èªªæ˜å’Œç¤ºä¾‹ä»£ç¢¼
- ä¸€éµå®‰è£ Agent åˆ°ç³»çµ±
- æŸ¥çœ‹å·²å®‰è£ Agent åˆ—è¡¨å’Œç‰ˆæœ¬ä¿¡æ¯

**Acceptance Criteriaï¼ˆExecution Listï¼‰**:

1. âœ… é¡¯ç¤ºåŸ·è¡Œåˆ—è¡¨ï¼šWorkflow åç¨±ã€ç‹€æ…‹ã€é–‹å§‹æ™‚é–“ã€åŸ·è¡Œæ™‚é–“ã€è§¸ç™¼æ–¹å¼
2. âœ… æ”¯æŒç‹€æ…‹ç¯©é¸ï¼šAll / Running / Completed / Failed
3. âœ… æ”¯æŒæ™‚é–“ç¯„åœç¯©é¸ï¼šä»Šå¤©ã€è¿‘ 7 å¤©ã€è¿‘ 30 å¤©ã€è‡ªå®šç¾©ç¯„åœ
4. âœ… æ”¯æŒ Workflow åç¨±æ¨¡ç³Šæœç´¢
5. âœ… é»æ“Šè¨˜éŒ„é€²å…¥è©³æƒ…é ï¼šé¡¯ç¤ºå®Œæ•´æ—¥èªŒã€è¼¸å…¥åƒæ•¸ã€è¼¸å‡ºçµæœã€éŒ¯èª¤å †æ£§
6. âœ… å¤±æ•—åŸ·è¡Œæä¾›ã€Œé‡è©¦ã€æŒ‰éˆ•
7. âœ… åˆ†é åŠ è¼‰ï¼Œæ¯é  50 æ¢

**Acceptance Criteriaï¼ˆAgent Marketplaceï¼‰**:

1. âœ… é¡¯ç¤º Agent å¡ç‰‡ï¼šåç¨±ã€åœ–æ¨™ã€ç°¡çŸ­æè¿°ã€è©•åˆ†ã€ä¸‹è¼‰é‡
2. âœ… æ”¯æŒåˆ†é¡ç¯©é¸ï¼šå®¢æœã€IT é‹ç¶­ã€æ•¸æ“šåˆ†æã€è¾¦å…¬è‡ªå‹•åŒ–ã€é€šç”¨
3. âœ… æ”¯æŒæœç´¢ Agent åç¨±å’Œæ¨™ç±¤
4. âœ… é»æ“Š Agent æŸ¥çœ‹è©³æƒ…ï¼šå®Œæ•´æè¿°ã€é…ç½®ç¤ºä¾‹ã€API æ–‡æª”ã€è©•è«–
5. âœ… ä¸€éµå®‰è£ Agentï¼ˆé¡¯ç¤ºå®‰è£é€²åº¦ï¼‰
6. âœ… å·²å®‰è£ Agent é¡¯ç¤ºã€Œå·²å®‰è£ã€æ¨™ç±¤å’Œç‰ˆæœ¬è™Ÿ
7. âœ… æ”¯æŒæ›´æ–° Agent åˆ°æœ€æ–°ç‰ˆæœ¬

**UI Mockupï¼ˆExecution Listï¼‰**:

```tsx
// ExecutionList.tsx
import React, { useState } from 'react';
import { Table, Tag, Button, Input, Select, DatePicker, Drawer, Typography } from 'antd';
import { SearchOutlined, ReloadOutlined } from '@ant-design/icons';
import { useGetExecutionsQuery, useRetryExecutionMutation } from '@/api/executionApi';
import dayjs from 'dayjs';

const { RangePicker } = DatePicker;
const { Text } = Typography;

export const ExecutionList: React.FC = () => {
  const [filters, setFilters] = useState({
    status: 'all',
    workflowName: '',
    dateRange: [dayjs().subtract(7, 'day'), dayjs()],
  });
  const [selectedExecution, setSelectedExecution] = useState<any>(null);
  const [drawerVisible, setDrawerVisible] = useState(false);

  const { data, isLoading } = useGetExecutionsQuery(filters);
  const [retryExecution] = useRetryExecutionMutation();

  const columns = [
    {
      title: 'Workflow åç¨±',
      dataIndex: 'workflow_name',
      key: 'workflow_name',
      render: (text: string, record: any) => (
        <a onClick={() => { setSelectedExecution(record); setDrawerVisible(true); }}>
          {text}
        </a>
      ),
    },
    {
      title: 'ç‹€æ…‹',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const colorMap: any = {
          running: 'processing',
          completed: 'success',
          failed: 'error',
        };
        return <Tag color={colorMap[status]}>{status.toUpperCase()}</Tag>;
      },
    },
    {
      title: 'é–‹å§‹æ™‚é–“',
      dataIndex: 'started_at',
      key: 'started_at',
      render: (time: string) => dayjs(time).format('YYYY-MM-DD HH:mm:ss'),
    },
    {
      title: 'åŸ·è¡Œæ™‚é–“',
      dataIndex: 'duration',
      key: 'duration',
      render: (duration: number) => `${duration.toFixed(2)}s`,
    },
    {
      title: 'è§¸ç™¼æ–¹å¼',
      dataIndex: 'trigger_type',
      key: 'trigger_type',
    },
    {
      title: 'æ“ä½œ',
      key: 'actions',
      render: (_: any, record: any) => (
        record.status === 'failed' && (
          <Button
            size="small"
            icon={<ReloadOutlined />}
            onClick={() => retryExecution(record.id)}
          >
            é‡è©¦
          </Button>
        )
      ),
    },
  ];

  return (
    <div>
      <h1>åŸ·è¡Œæ­·å²</h1>
      <div style={{ marginBottom: 16 }}>
        <Input
          placeholder="æœç´¢ Workflow åç¨±"
          prefix={<SearchOutlined />}
          style={{ width: 300, marginRight: 8 }}
          onChange={(e) => setFilters({ ...filters, workflowName: e.target.value })}
        />
        <Select
          value={filters.status}
          style={{ width: 150, marginRight: 8 }}
          onChange={(status) => setFilters({ ...filters, status })}
        >
          <Select.Option value="all">å…¨éƒ¨ç‹€æ…‹</Select.Option>
          <Select.Option value="running">Running</Select.Option>
          <Select.Option value="completed">Completed</Select.Option>
          <Select.Option value="failed">Failed</Select.Option>
        </Select>
        <RangePicker
          value={filters.dateRange as any}
          onChange={(dates: any) => setFilters({ ...filters, dateRange: dates })}
        />
      </div>

      <Table
        columns={columns}
        dataSource={data?.executions || []}
        loading={isLoading}
        pagination={{ pageSize: 50 }}
        rowKey="id"
      />

      <Drawer
        title="åŸ·è¡Œè©³æƒ…"
        width={720}
        open={drawerVisible}
        onClose={() => setDrawerVisible(false)}
      >
        {selectedExecution && (
          <>
            <h3>è¼¸å…¥åƒæ•¸</h3>
            <pre>{JSON.stringify(selectedExecution.input, null, 2)}</pre>
            
            <h3>è¼¸å‡ºçµæœ</h3>
            <pre>{JSON.stringify(selectedExecution.output, null, 2)}</pre>
            
            <h3>åŸ·è¡Œæ—¥èªŒ</h3>
            <div style={{ maxHeight: 400, overflow: 'auto' }}>
              {selectedExecution.logs?.map((log: string, i: number) => (
                <Text key={i} code style={{ display: 'block' }}>{log}</Text>
              ))}
            </div>
            
            {selectedExecution.status === 'failed' && (
              <>
                <h3>éŒ¯èª¤å †æ£§</h3>
                <pre style={{ color: 'red' }}>{selectedExecution.error_stack}</pre>
              </>
            )}
          </>
        )}
      </Drawer>
    </div>
  );
};
```

**UI Mockupï¼ˆAgent Marketplaceï¼‰**:

```tsx
// AgentMarketplace.tsx
import React, { useState } from 'react';
import { Card, Row, Col, Tag, Button, Input, Select, Drawer, Rate, message } from 'antd';
import { SearchOutlined, DownloadOutlined, CheckCircleOutlined } from '@ant-design/icons';
import { useGetAgentsQuery, useInstallAgentMutation } from '@/api/agentApi';

export const AgentMarketplace: React.FC = () => {
  const [filters, setFilters] = useState({ category: 'all', search: '' });
  const [selectedAgent, setSelectedAgent] = useState<any>(null);
  const [drawerVisible, setDrawerVisible] = useState(false);

  const { data: agents, isLoading } = useGetAgentsQuery(filters);
  const [installAgent, { isLoading: installing }] = useInstallAgentMutation();

  const handleInstall = async (agentId: string) => {
    try {
      await installAgent(agentId).unwrap();
      message.success('Agent å®‰è£æˆåŠŸ');
    } catch (err) {
      message.error('å®‰è£å¤±æ•—');
    }
  };

  return (
    <div>
      <h1>Agent å•†åº—</h1>
      <div style={{ marginBottom: 16 }}>
        <Input
          placeholder="æœç´¢ Agent"
          prefix={<SearchOutlined />}
          style={{ width: 300, marginRight: 8 }}
          onChange={(e) => setFilters({ ...filters, search: e.target.value })}
        />
        <Select
          value={filters.category}
          style={{ width: 200 }}
          onChange={(category) => setFilters({ ...filters, category })}
        >
          <Select.Option value="all">å…¨éƒ¨åˆ†é¡</Select.Option>
          <Select.Option value="customer-service">å®¢æœ</Select.Option>
          <Select.Option value="it-ops">IT é‹ç¶­</Select.Option>
          <Select.Option value="data-analysis">æ•¸æ“šåˆ†æ</Select.Option>
          <Select.Option value="office-automation">è¾¦å…¬è‡ªå‹•åŒ–</Select.Option>
        </Select>
      </div>

      <Row gutter={[16, 16]}>
        {agents?.map((agent: any) => (
          <Col span={6} key={agent.id}>
            <Card
              hoverable
              cover={<img alt={agent.name} src={agent.icon || '/default-agent-icon.png'} />}
              onClick={() => { setSelectedAgent(agent); setDrawerVisible(true); }}
            >
              <Card.Meta
                title={agent.name}
                description={
                  <>
                    <p>{agent.short_description}</p>
                    <Rate disabled value={agent.rating} style={{ fontSize: 14 }} />
                    <span style={{ marginLeft: 8 }}>{agent.downloads} ä¸‹è¼‰</span>
                    <br />
                    {agent.installed ? (
                      <Tag color="green" icon={<CheckCircleOutlined />}>å·²å®‰è£</Tag>
                    ) : (
                      <Tag color="blue">å¯å®‰è£</Tag>
                    )}
                  </>
                }
              />
            </Card>
          </Col>
        ))}
      </Row>

      <Drawer
        title={selectedAgent?.name}
        width={720}
        open={drawerVisible}
        onClose={() => setDrawerVisible(false)}
        extra={
          !selectedAgent?.installed && (
            <Button
              type="primary"
              icon={<DownloadOutlined />}
              loading={installing}
              onClick={() => handleInstall(selectedAgent.id)}
            >
              å®‰è£
            </Button>
          )
        }
      >
        {selectedAgent && (
          <>
            <h3>ç°¡ä»‹</h3>
            <p>{selectedAgent.full_description}</p>
            
            <h3>é…ç½®ç¤ºä¾‹</h3>
            <pre>{selectedAgent.config_example}</pre>
            
            <h3>API æ–‡æª”</h3>
            <a href={selectedAgent.api_docs_url} target="_blank" rel="noopener noreferrer">
              æŸ¥çœ‹å®Œæ•´ API æ–‡æª”
            </a>
            
            <h3>è©•è«–</h3>
            {selectedAgent.reviews?.map((review: any, i: number) => (
              <div key={i} style={{ marginBottom: 8 }}>
                <Rate disabled value={review.rating} style={{ fontSize: 12 }} />
                <p>{review.comment}</p>
              </div>
            ))}
          </>
        )}
      </Drawer>
    </div>
  );
};
```

**API Endpoints**:

```python
# api/execution.py
@router.get("/executions")
async def get_executions(
    status: Optional[str] = None,
    workflow_name: Optional[str] = None,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    page: int = 1,
    page_size: int = 50,
    db: Session = Depends(get_db)
):
    """ç²å–åŸ·è¡Œæ­·å²åˆ—è¡¨"""
    query = db.query(WorkflowExecution)
    
    if status and status != 'all':
        query = query.filter(WorkflowExecution.status == status)
    if workflow_name:
        query = query.join(Workflow).filter(Workflow.name.ilike(f'%{workflow_name}%'))
    if start_date:
        query = query.filter(WorkflowExecution.started_at >= start_date)
    if end_date:
        query = query.filter(WorkflowExecution.started_at <= end_date)
    
    total = query.count()
    executions = query.order_by(desc(WorkflowExecution.started_at)).offset((page - 1) * page_size).limit(page_size).all()
    
    return {
        "executions": [
            {
                "id": e.id,
                "workflow_name": e.workflow.name,
                "status": e.status,
                "started_at": e.started_at.isoformat(),
                "duration": (e.completed_at - e.started_at).total_seconds() if e.completed_at else None,
                "trigger_type": e.trigger_type,
                "input": e.input_data,
                "output": e.output_data,
                "logs": e.logs,
                "error_stack": e.error_stack
            }
            for e in executions
        ],
        "total": total,
        "page": page,
        "page_size": page_size
    }

@router.post("/executions/{execution_id}/retry")
async def retry_execution(execution_id: str, db: Session = Depends(get_db)):
    """é‡è©¦å¤±æ•—çš„åŸ·è¡Œ"""
    execution = db.query(WorkflowExecution).filter(WorkflowExecution.id == execution_id).first()
    if not execution:
        raise HTTPException(status_code=404, detail="Execution not found")
    
    # Trigger new execution with same input
    new_execution = trigger_workflow(execution.workflow_id, execution.input_data)
    return {"new_execution_id": new_execution.id}

# api/agent.py
@router.get("/agents/marketplace")
async def get_marketplace_agents(
    category: Optional[str] = None,
    search: Optional[str] = None,
    db: Session = Depends(get_db)
):
    """ç²å– Agent å•†åº—åˆ—è¡¨"""
    query = db.query(Agent).filter(Agent.is_public == True)
    
    if category and category != 'all':
        query = query.filter(Agent.category == category)
    if search:
        query = query.filter(Agent.name.ilike(f'%{search}%') | Agent.description.ilike(f'%{search}%'))
    
    agents = query.order_by(desc(Agent.downloads)).all()
    
    return [
        {
            "id": a.id,
            "name": a.name,
            "short_description": a.short_description,
            "icon": a.icon_url,
            "rating": a.average_rating,
            "downloads": a.downloads,
            "installed": a.is_installed,
            "category": a.category
        }
        for a in agents
    ]

@router.post("/agents/{agent_id}/install")
async def install_agent(agent_id: str, db: Session = Depends(get_db)):
    """å®‰è£ Agent"""
    agent = db.query(Agent).filter(Agent.id == agent_id).first()
    if not agent:
        raise HTTPException(status_code=404, detail="Agent not found")
    
    # Mark as installed
    agent.is_installed = True
    agent.downloads += 1
    db.commit()
    
    return {"status": "installed", "agent_id": agent_id}
```

**æ¸¬è©¦ç­–ç•¥**:

1. UI æ¸¬è©¦ï¼šæ¸¬è©¦ç¯©é¸ã€æœç´¢ã€åˆ†é ã€è©³æƒ…æŠ½å±œ
2. API æ¸¬è©¦ï¼šæ¸¬è©¦åŸ·è¡Œåˆ—è¡¨æŸ¥è©¢ã€é‡è©¦åŠŸèƒ½ã€Agent å®‰è£
3. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦ 10 è¬æ¢åŸ·è¡Œè¨˜éŒ„çš„æŸ¥è©¢æ€§èƒ½
4. æ¬Šé™æ¸¬è©¦ï¼šæ¸¬è©¦éç®¡ç†å“¡ç„¡æ³•é‡è©¦ä»–äººçš„åŸ·è¡Œ

---

#### **US-F13-004: é›†æˆç›£æ§ã€å¯©è¨ˆã€DLQã€Prompt ç®¡ç†é é¢**

**User Story**:  
ä½œç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œæˆ‘å¸Œæœ›åœ¨çµ±ä¸€çš„ Web UI ä¸­è¨ªå•ç›£æ§å„€è¡¨æ¿ã€å¯©è¨ˆæ—¥èªŒã€DLQ ç®¡ç†ã€Prompt ç·¨è¼¯å™¨ï¼Œä»¥ä¾¿é›†ä¸­ç®¡ç†æ‰€æœ‰ç³»çµ±åŠŸèƒ½ã€‚

**å ´æ™¯æè¿°**:

- ç”¨æˆ¶å¾é ‚éƒ¨å°èˆªæ¬„è¨ªå•ä¸åŒåŠŸèƒ½æ¨¡å¡Š
- **Monitoring Dashboard**ï¼šå¯¦æ™‚æŸ¥çœ‹ç³»çµ±æŒ‡æ¨™ï¼ˆé›†æˆ F12ï¼‰
- **Audit Logs**ï¼šæœç´¢å’Œéæ¿¾å¯©è¨ˆæ—¥èªŒï¼ˆé›†æˆ F10ï¼‰
- **DLQ Management**ï¼šæŸ¥çœ‹æ­»ä¿¡éšŠåˆ—ä¸¦é‡è©¦ï¼ˆé›†æˆ F8ï¼‰
- **Prompt Editor**ï¼šç·¨è¼¯å’Œæ¸¬è©¦ Prompt æ¨¡æ¿ï¼ˆé›†æˆ F9ï¼‰

**Acceptance Criteria**:

1. âœ… é ‚éƒ¨å°èˆªæ¬„åŒ…å«ï¼šDashboardã€Workflowsã€Executionsã€Agentsã€Monitoringã€Audit Logsã€DLQã€Prompts
2. âœ… Monitoring Dashboard é¡¯ç¤ºå¯¦æ™‚æŒ‡æ¨™åœ–è¡¨ï¼ˆEChartsï¼‰ï¼Œæ”¯æŒè‡ªå®šç¾©æ™‚é–“ç¯„åœ
3. âœ… Audit Logs é é¢æ”¯æŒæŒ‰ç”¨æˆ¶ã€æ“ä½œé¡å‹ã€æ™‚é–“ç¯„åœç¯©é¸
4. âœ… DLQ Management é é¢é¡¯ç¤ºå¤±æ•—åŸ·è¡Œåˆ—è¡¨ï¼Œæ”¯æŒæ‰¹é‡é‡è©¦
5. âœ… Prompt Editor ä½¿ç”¨ Monaco Editor ç·¨è¼¯ YAML æ¨¡æ¿ï¼Œæä¾›èªæ³•é«˜äº®å’Œè‡ªå‹•å®Œæˆ
6. âœ… Prompt Editor æä¾›é è¦½åŠŸèƒ½ï¼ˆè¼¸å…¥ç¤ºä¾‹è®Šé‡ï¼Œå¯¦æ™‚æ¸²æŸ“çµæœï¼‰
7. âœ… æ‰€æœ‰é é¢çµ±ä¸€é¢¨æ ¼ï¼ˆAnt Design ä¸»é¡Œï¼‰ï¼ŒéŸ¿æ‡‰å¼ä½ˆå±€

**UI Mockupï¼ˆMonitoring Dashboard é›†æˆï¼‰**:

```tsx
// MonitoringPage.tsx
import React, { useState } from 'react';
import { Card, Select, DatePicker } from 'antd';
import * as echarts from 'echarts';
import { useGetMetricsQuery } from '@/api/monitoringApi';

export const MonitoringPage: React.FC = () => {
  const [timeRange, setTimeRange] = useState('1h');
  const { data: metrics } = useGetMetricsQuery({ range: timeRange });

  const chartOption = {
    title: { text: 'Workflow åŸ·è¡Œè¶¨å‹¢' },
    tooltip: { trigger: 'axis' },
    legend: { data: ['æˆåŠŸ', 'å¤±æ•—'] },
    xAxis: { type: 'category', data: metrics?.timestamps || [] },
    yAxis: { type: 'value' },
    series: [
      { name: 'æˆåŠŸ', type: 'line', data: metrics?.success_counts || [] },
      { name: 'å¤±æ•—', type: 'line', data: metrics?.failure_counts || [] },
    ],
  };

  return (
    <div>
      <h1>ç³»çµ±ç›£æ§</h1>
      <Select value={timeRange} onChange={setTimeRange} style={{ marginBottom: 16 }}>
        <Select.Option value="1h">æœ€è¿‘ 1 å°æ™‚</Select.Option>
        <Select.Option value="24h">æœ€è¿‘ 24 å°æ™‚</Select.Option>
        <Select.Option value="7d">æœ€è¿‘ 7 å¤©</Select.Option>
      </Select>
      <Card>
        <div ref={(ref) => ref && echarts.init(ref).setOption(chartOption)} style={{ height: 400 }} />
      </Card>
    </div>
  );
};
```

**UI Mockupï¼ˆAudit Logs é›†æˆï¼‰**:

```tsx
// AuditLogsPage.tsx
import React, { useState } from 'react';
import { Table, Input, Select, DatePicker } from 'antd';
import { SearchOutlined } from '@ant-design/icons';
import { useGetAuditLogsQuery } from '@/api/auditApi';

export const AuditLogsPage: React.FC = () => {
  const [filters, setFilters] = useState({ user: '', action: 'all', dateRange: null });
  const { data, isLoading } = useGetAuditLogsQuery(filters);

  const columns = [
    { title: 'æ™‚é–“', dataIndex: 'timestamp', key: 'timestamp' },
    { title: 'ç”¨æˆ¶', dataIndex: 'user', key: 'user' },
    { title: 'æ“ä½œ', dataIndex: 'action', key: 'action' },
    { title: 'è³‡æº', dataIndex: 'resource', key: 'resource' },
    { title: 'è®Šæ›´å…§å®¹', dataIndex: 'changes', key: 'changes', render: (v: any) => JSON.stringify(v) },
  ];

  return (
    <div>
      <h1>å¯©è¨ˆæ—¥èªŒ</h1>
      <div style={{ marginBottom: 16 }}>
        <Input
          placeholder="æœç´¢ç”¨æˆ¶"
          prefix={<SearchOutlined />}
          style={{ width: 200, marginRight: 8 }}
          onChange={(e) => setFilters({ ...filters, user: e.target.value })}
        />
        <Select
          value={filters.action}
          style={{ width: 150 }}
          onChange={(action) => setFilters({ ...filters, action })}
        >
          <Select.Option value="all">å…¨éƒ¨æ“ä½œ</Select.Option>
          <Select.Option value="create">å‰µå»º</Select.Option>
          <Select.Option value="update">æ›´æ–°</Select.Option>
          <Select.Option value="delete">åˆªé™¤</Select.Option>
        </Select>
      </div>
      <Table columns={columns} dataSource={data?.logs || []} loading={isLoading} rowKey="id" />
    </div>
  );
};
```

**UI Mockupï¼ˆDLQ Management é›†æˆï¼‰**:

```tsx
// DLQPage.tsx
import React from 'react';
import { Table, Button, message } from 'antd';
import { ReloadOutlined } from '@ant-design/icons';
import { useGetDLQQuery, useRetryDLQMutation } from '@/api/dlqApi';

export const DLQPage: React.FC = () => {
  const { data, isLoading } = useGetDLQQuery();
  const [retryDLQ] = useRetryDLQMutation();

  const handleRetry = async (id: string) => {
    try {
      await retryDLQ(id).unwrap();
      message.success('é‡è©¦å·²è§¸ç™¼');
    } catch (err) {
      message.error('é‡è©¦å¤±æ•—');
    }
  };

  const columns = [
    { title: 'Workflow', dataIndex: 'workflow_name', key: 'workflow_name' },
    { title: 'éŒ¯èª¤ä¿¡æ¯', dataIndex: 'error_message', key: 'error_message' },
    { title: 'å¤±æ•—æ™‚é–“', dataIndex: 'failed_at', key: 'failed_at' },
    { title: 'é‡è©¦æ¬¡æ•¸', dataIndex: 'retry_count', key: 'retry_count' },
    {
      title: 'æ“ä½œ',
      key: 'actions',
      render: (_: any, record: any) => (
        <Button icon={<ReloadOutlined />} onClick={() => handleRetry(record.id)}>
          é‡è©¦
        </Button>
      ),
    },
  ];

  return (
    <div>
      <h1>æ­»ä¿¡éšŠåˆ—ï¼ˆDLQï¼‰</h1>
      <Table columns={columns} dataSource={data?.dlq_items || []} loading={isLoading} rowKey="id" />
    </div>
  );
};
```

**UI Mockupï¼ˆPrompt Editor é›†æˆï¼‰**:

```tsx
// PromptEditorPage.tsx
import React, { useState } from 'react';
import { Row, Col, Card, Button, Form, Input, message } from 'antd';
import { SaveOutlined } from '@ant-design/icons';
import Editor from '@monaco-editor/react';
import { useGetPromptsQuery, useUpdatePromptMutation } from '@/api/promptApi';

export const PromptEditorPage: React.FC = () => {
  const { data: prompts } = useGetPromptsQuery();
  const [selectedPrompt, setSelectedPrompt] = useState<any>(null);
  const [previewVariables, setPreviewVariables] = useState<any>({});
  const [updatePrompt] = useUpdatePromptMutation();

  const handleSave = async () => {
    try {
      await updatePrompt({ id: selectedPrompt.id, content: selectedPrompt.content }).unwrap();
      message.success('Prompt å·²ä¿å­˜');
    } catch (err) {
      message.error('ä¿å­˜å¤±æ•—');
    }
  };

  const renderPreview = () => {
    // Replace variables in prompt template
    let preview = selectedPrompt?.content || '';
    Object.keys(previewVariables).forEach((key) => {
      preview = preview.replace(`{${key}}`, previewVariables[key]);
    });
    return preview;
  };

  return (
    <div>
      <h1>Prompt ç·¨è¼¯å™¨</h1>
      <Row gutter={16}>
        <Col span={6}>
          <Card title="Prompt åˆ—è¡¨">
            {prompts?.map((p: any) => (
              <div key={p.id} onClick={() => setSelectedPrompt(p)} style={{ cursor: 'pointer', marginBottom: 8 }}>
                {p.name}
              </div>
            ))}
          </Card>
        </Col>
        <Col span={12}>
          <Card
            title="ç·¨è¼¯ Prompt"
            extra={<Button icon={<SaveOutlined />} onClick={handleSave}>ä¿å­˜</Button>}
          >
            <Editor
              height="400px"
              language="yaml"
              value={selectedPrompt?.content}
              onChange={(value) => setSelectedPrompt({ ...selectedPrompt, content: value })}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card title="é è¦½">
            <Form layout="vertical">
              <Form.Item label="customer_name">
                <Input onChange={(e) => setPreviewVariables({ ...previewVariables, customer_name: e.target.value })} />
              </Form.Item>
              {/* Add more variable inputs */}
            </Form>
            <pre>{renderPreview()}</pre>
          </Card>
        </Col>
      </Row>
    </div>
  );
};
```

**è·¯ç”±é…ç½®**:

```tsx
// App.tsx
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { Layout, Menu } from 'antd';
import { HomePage } from './pages/HomePage';
import { WorkflowBuilder } from './pages/WorkflowBuilder';
import { ExecutionList } from './pages/ExecutionList';
import { AgentMarketplace } from './pages/AgentMarketplace';
import { MonitoringPage } from './pages/MonitoringPage';
import { AuditLogsPage } from './pages/AuditLogsPage';
import { DLQPage } from './pages/DLQPage';
import { PromptEditorPage } from './pages/PromptEditorPage';

const { Header, Content } = Layout;

export const App = () => {
  return (
    <BrowserRouter>
      <Layout>
        <Header>
          <Menu theme="dark" mode="horizontal" defaultSelectedKeys={['dashboard']}>
            <Menu.Item key="dashboard"><a href="/">Dashboard</a></Menu.Item>
            <Menu.Item key="workflows"><a href="/workflows">Workflows</a></Menu.Item>
            <Menu.Item key="executions"><a href="/executions">Executions</a></Menu.Item>
            <Menu.Item key="agents"><a href="/agents">Agents</a></Menu.Item>
            <Menu.Item key="monitoring"><a href="/monitoring">Monitoring</a></Menu.Item>
            <Menu.Item key="audit"><a href="/audit">Audit Logs</a></Menu.Item>
            <Menu.Item key="dlq"><a href="/dlq">DLQ</a></Menu.Item>
            <Menu.Item key="prompts"><a href="/prompts">Prompts</a></Menu.Item>
          </Menu>
        </Header>
        <Content style={{ padding: '24px' }}>
          <Routes>
            <Route path="/" element={<HomePage />} />
            <Route path="/workflows/new" element={<WorkflowBuilder />} />
            <Route path="/workflows/:id" element={<WorkflowBuilder />} />
            <Route path="/executions" element={<ExecutionList />} />
            <Route path="/agents/marketplace" element={<AgentMarketplace />} />
            <Route path="/monitoring" element={<MonitoringPage />} />
            <Route path="/audit" element={<AuditLogsPage />} />
            <Route path="/dlq" element={<DLQPage />} />
            <Route path="/prompts" element={<PromptEditorPage />} />
          </Routes>
        </Content>
      </Layout>
    </BrowserRouter>
  );
};
```

**æ¸¬è©¦ç­–ç•¥**:

1. E2E æ¸¬è©¦ï¼šä½¿ç”¨ Cypress æ¸¬è©¦å®Œæ•´ç”¨æˆ¶æµç¨‹ï¼ˆç™»å…¥ â†’ å‰µå»º Workflow â†’ åŸ·è¡Œ â†’ æŸ¥çœ‹æ—¥èªŒï¼‰
2. è·¯ç”±æ¸¬è©¦ï¼šæ¸¬è©¦æ‰€æœ‰é é¢å°èˆªå’Œæ·±å±¤é€£çµ
3. æ¬Šé™æ¸¬è©¦ï¼šæ¸¬è©¦ä¸åŒè§’è‰²è¨ªå•ä¸åŒé é¢çš„æ¬Šé™
4. éŸ¿æ‡‰å¼æ¸¬è©¦ï¼šåœ¨æ¡Œé¢ã€å¹³æ¿ã€æ‰‹æ©Ÿå°ºå¯¸ä¸‹æ¸¬è©¦æ‰€æœ‰é é¢

---

### 13.3 æ•¸æ“šåº«æ¶æ§‹ï¼ˆUI ç‰¹å®šè¡¨ï¼‰

```sql
-- ç”¨æˆ¶åå¥½è¨­ç½®è¡¨
CREATE TABLE user_preferences (
    user_id VARCHAR(100) PRIMARY KEY,
    theme VARCHAR(20) DEFAULT 'light',  -- light, dark
    language VARCHAR(10) DEFAULT 'zh-TW',  -- zh-TW, en-US, ja-JP
    dashboard_layout JSONB,  -- è‡ªå®šç¾© Dashboard å¡ç‰‡é †åº
    default_time_range VARCHAR(10) DEFAULT '7d',  -- 1h, 24h, 7d, 30d
    notifications_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è‡ªå®šç¾©è¦–åœ–è¡¨ï¼ˆä¿å­˜ç”¨æˆ¶è‡ªå®šç¾©çš„ç¯©é¸æ¢ä»¶ï¼‰
CREATE TABLE saved_views (
    view_id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    view_name VARCHAR(200) NOT NULL,
    view_type VARCHAR(50) NOT NULL,  -- executions, agents, audit_logs
    filters JSONB NOT NULL,  -- {"status": "failed", "date_range": ["2024-01-01", "2024-12-31"]}
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, view_name, view_type)
);

-- UI æ“ä½œæ—¥èªŒè¡¨ï¼ˆè¿½è¹¤ç”¨æˆ¶åœ¨ UI ä¸Šçš„æ“ä½œï¼‰
CREATE TABLE ui_activity_logs (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    page VARCHAR(100) NOT NULL,  -- dashboard, workflow_builder, executions
    action VARCHAR(100) NOT NULL,  -- view, edit, delete, retry
    resource_type VARCHAR(50),  -- workflow, agent, prompt
    resource_id VARCHAR(100),
    metadata JSONB,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ui_activity_user ON ui_activity_logs(user_id, timestamp DESC);
CREATE INDEX idx_saved_views_user ON saved_views(user_id, view_type);
```

---

### 13.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | é¦–å±åŠ è¼‰æ™‚é–“ | <2 ç§’ | Lighthouse æ€§èƒ½è©•åˆ† >90 |
| | API éŸ¿æ‡‰æ™‚é–“ | <300msï¼ˆP95ï¼‰ | APM ç›£æ§ |
| | åœ–è¡¨æ¸²æŸ“æ™‚é–“ | <500msï¼ˆ1000 æ•¸æ“šé»ï¼‰ | å‰ç«¯æ€§èƒ½ç›£æ§ |
| **å¯ç”¨æ€§** | é é¢å¯è¨ªå•æ€§ | WCAG 2.1 AA ç´š | è‡ªå‹•åŒ– a11y æ¸¬è©¦ |
| | ç€è¦½å™¨å…¼å®¹æ€§ | Chrome 90+, Firefox 88+, Safari 14+ | BrowserStack æ¸¬è©¦ |
| **å¯æ“´å±•æ€§** | ä¸¦ç™¼ç”¨æˆ¶æ•¸ | 100+ ä¸¦ç™¼ç”¨æˆ¶ | è² è¼‰æ¸¬è©¦ |
| | æ•¸æ“šè¡¨æ ¼è¡Œæ•¸ | æ”¯æŒ 10 è¬è¡Œè™›æ“¬æ»¾å‹• | å‰ç«¯æ€§èƒ½æ¸¬è©¦ |
| **å®‰å…¨æ€§** | XSS é˜²è­· | 100% ç”¨æˆ¶è¼¸å…¥è½‰ç¾© | å®‰å…¨æƒæ |
| | CSRF é˜²è­· | æ‰€æœ‰ POST è«‹æ±‚é©—è­‰ Token | æ»²é€æ¸¬è©¦ |

---

### 13.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦ï¼ˆReact Testing Libraryï¼‰**:

- æ¸¬è©¦å„çµ„ä»¶çš„æ¸²æŸ“å’Œäº¤äº’ï¼ˆæŒ‰éˆ•é»æ“Šã€è¡¨å–®æäº¤ï¼‰
- æ¸¬è©¦ Redux ç‹€æ…‹ç®¡ç†é‚è¼¯
- æ¸¬è©¦å·¥å…·å‡½æ•¸ï¼ˆæ—¥æœŸæ ¼å¼åŒ–ã€æ•¸æ“šè½‰æ›ï¼‰

**é›†æˆæ¸¬è©¦ï¼ˆRTK Queryï¼‰**:

- æ¸¬è©¦ API èª¿ç”¨å’Œæ•¸æ“šç·©å­˜
- æ¸¬è©¦éŒ¯èª¤è™•ç†å’Œé‡è©¦é‚è¼¯

**E2E æ¸¬è©¦ï¼ˆCypressï¼‰**:

- æ¸¬è©¦å®Œæ•´ç”¨æˆ¶æµç¨‹ï¼šç™»å…¥ â†’ å‰µå»º Workflow â†’ åŸ·è¡Œ â†’ æŸ¥çœ‹ç›£æ§
- æ¸¬è©¦é é¢å°èˆªå’Œæ·±å±¤é€£çµ
- æ¸¬è©¦è¡¨å–®é©—è­‰å’ŒéŒ¯èª¤æç¤º

**æ€§èƒ½æ¸¬è©¦**:

- ä½¿ç”¨ Lighthouse æ¸¬è©¦é¦–å±åŠ è¼‰æ™‚é–“
- ä½¿ç”¨ React Profiler åˆ†æçµ„ä»¶æ¸²æŸ“æ€§èƒ½
- æ¸¬è©¦å¤§æ•¸æ“šè¡¨æ ¼ï¼ˆ10 è¬è¡Œï¼‰çš„æ»¾å‹•æµæš¢åº¦

**å¯è¨ªå•æ€§æ¸¬è©¦**:

- ä½¿ç”¨ axe-core è‡ªå‹•åŒ–æ¸¬è©¦ WCAG åˆè¦æ€§
- éµç›¤å°èˆªæ¸¬è©¦ï¼ˆTabã€Enterã€Escapeï¼‰
- å±å¹•é–±è®€å™¨æ¸¬è©¦ï¼ˆNVDAã€JAWSï¼‰

**è·¨ç€è¦½å™¨æ¸¬è©¦**:

- åœ¨ Chromeã€Firefoxã€Safariã€Edge ä¸Šæ¸¬è©¦
- åœ¨ä¸åŒå±å¹•å°ºå¯¸ï¼ˆæ¡Œé¢ã€å¹³æ¿ã€æ‰‹æ©Ÿï¼‰ä¸Šæ¸¬è©¦

---

### 13.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| å¤§å‹ Workflow ç·¨è¼¯å™¨æ€§èƒ½å•é¡Œ | ä¸­ | ä¸­ | è™›æ“¬åŒ–æ¸²æŸ“ + ç¯€é»æ‡¶åŠ è¼‰ |
| å‰ç«¯åŒ…é«”ç©éå¤§ | é«˜ | ä½ | ä»£ç¢¼åˆ†å‰² + å‹•æ…‹å°å…¥ + Tree Shaking |
| å¯¦æ™‚æ•¸æ“šåˆ·æ–°å°è‡´é–ƒçˆ | ä¸­ | ä½ | ä½¿ç”¨æ¨‚è§€æ›´æ–° + é˜²æŠ– |
| ç€è¦½å™¨å…¼å®¹æ€§å•é¡Œ | ä½ | ä¸­ | Polyfill + è·¨ç€è¦½å™¨æ¸¬è©¦ |
| å®‰å…¨æ¼æ´ï¼ˆXSSã€CSRFï¼‰ | ä½ | é«˜ | è¼¸å…¥é©—è­‰ + CSP ç­–ç•¥ + å®šæœŸæƒæ |

---

### 13.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **æ·±è‰²æ¨¡å¼**: æ”¯æŒæ·±è‰²ä¸»é¡Œåˆ‡æ›
2. **å¤šèªè¨€**: æ”¯æŒè‹±æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™æ–‡
3. **ç§»å‹•ç«¯æ‡‰ç”¨**: é–‹ç™¼ iOS/Android åŸç”Ÿæ‡‰ç”¨
4. **å”ä½œåŠŸèƒ½**: å¤šäººå¯¦æ™‚ç·¨è¼¯ Workflowï¼ˆWebSocketï¼‰
5. **AI åŠ©æ‰‹**: ä½¿ç”¨ AI å»ºè­° Workflow å„ªåŒ–æ–¹æ¡ˆ
6. **é›¢ç·šæ¨¡å¼**: æ”¯æŒé›¢ç·šæŸ¥çœ‹å’Œç·¨è¼¯ï¼ˆPWAï¼‰

---

**âœ… F13 å®Œæˆ**ï¼šç¾ä»£åŒ– Web UI åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€8 å€‹æ ¸å¿ƒé é¢ã€æ•¸æ“šåº«æ¶æ§‹ã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## <a id="f14-redis-caching"></a>14. F14: Redis ç·©å­˜ç³»çµ±

**åŠŸèƒ½é¡åˆ¥**: Performance (æ€§èƒ½å„ªåŒ–)  
**å„ªå…ˆç´š**: P0 (å¿…é ˆæ“æœ‰)  
**ä¼°è¨ˆé–‹ç™¼æ™‚é–“**: 1 é€±  
**è¤‡é›œåº¦**: â­â­â­

---

### 14.1 åŠŸèƒ½æ¦‚è¿°

**å®šç¾©**:
F14ï¼ˆRedis ç·©å­˜ç³»çµ±ï¼‰æä¾›**åˆ†ä½ˆå¼å…§å­˜ç·©å­˜**ä¾†åŠ é€Ÿé »ç¹è¨ªå•çš„æ•¸æ“šï¼ˆWorkflow å®šç¾©ã€Agent é…ç½®ã€Prompt æ¨¡æ¿ï¼‰ï¼Œä¸¦æ”¯æŒ**æœƒè©±ç®¡ç†ã€åˆ†ä½ˆå¼é–ã€é€Ÿç‡é™åˆ¶**ç­‰é«˜ç´šåŠŸèƒ½ã€‚é€šé Redis æ¸›å°‘æ•¸æ“šåº«æŸ¥è©¢ï¼Œå°‡ API éŸ¿æ‡‰æ™‚é–“å¾ 500ms é™è‡³ 50msã€‚

**ç‚ºä»€éº¼é‡è¦**:
- **æ€§èƒ½æå‡**: ç·©å­˜ç†±é»æ•¸æ“šï¼Œæ¸›å°‘ 90% æ•¸æ“šåº«æŸ¥è©¢
- **å¯æ“´å±•æ€§**: æ”¯æŒæ°´å¹³æ“´å±•çš„åˆ†ä½ˆå¼ç·©å­˜
- **ä¸€è‡´æ€§**: ä½¿ç”¨ Redis åˆ†ä½ˆå¼é–ä¿è­‰æ•¸æ“šä¸€è‡´æ€§
- **å½ˆæ€§**: API é€Ÿç‡é™åˆ¶é˜²æ­¢æ¿«ç”¨å’Œ DDoS æ”»æ“Š

**æ ¸å¿ƒèƒ½åŠ›**:
1. **æ•¸æ“šç·©å­˜**: Workflow å®šç¾©ã€Agent é…ç½®ã€Prompt æ¨¡æ¿ã€ç”¨æˆ¶æœƒè©±
2. **ç·©å­˜å¤±æ•ˆç­–ç•¥**: TTLï¼ˆéæœŸæ™‚é–“ï¼‰ã€LRUï¼ˆæœ€å°‘ä½¿ç”¨æ·˜æ±°ï¼‰ã€ä¸»å‹•å¤±æ•ˆï¼ˆæ•¸æ“šæ›´æ–°æ™‚ï¼‰
3. **åˆ†ä½ˆå¼é–**: ä¿è­‰å¤šå¯¦ä¾‹ç’°å¢ƒä¸‹çš„æ“ä½œåŸå­æ€§ï¼ˆå¦‚ Workflow ç™¼å¸ƒï¼‰
4. **é€Ÿç‡é™åˆ¶**: API èª¿ç”¨é »ç‡é™åˆ¶ï¼ˆæŒ‰ç”¨æˆ¶/IPï¼‰
5. **æœƒè©±ç®¡ç†**: ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ã€æ¬Šé™ç·©å­˜
6. **ç·©å­˜é ç†±**: ç³»çµ±å•Ÿå‹•æ™‚åŠ è¼‰å¸¸ç”¨æ•¸æ“š

**æ¥­å‹™åƒ¹å€¼**:
- **ç”¨æˆ¶é«”é©—**: API éŸ¿æ‡‰æ™‚é–“å¾ 500ms é™è‡³ 50msï¼ˆ10 å€æå‡ï¼‰
- **æˆæœ¬ç¯€çœ**: æ¸›å°‘æ•¸æ“šåº«è² è¼‰ 80%ï¼Œå»¶é²æ•¸æ“šåº«æ“´å®¹
- **é«˜å¯ç”¨**: Redis Sentinel/Cluster æä¾› 99.9% å¯ç”¨æ€§

**æŠ€è¡“æ£§**:
- **Redis ç‰ˆæœ¬**: Redis 7.0+ï¼ˆæ”¯æŒ JSON æ•¸æ“šé¡å‹ï¼‰
- **Python å®¢æˆ¶ç«¯**: redis-py + aioredisï¼ˆç•°æ­¥æ”¯æŒï¼‰
- **é«˜å¯ç”¨**: Redis Sentinelï¼ˆè‡ªå‹•æ•…éšœè½‰ç§»ï¼‰
- **æŒä¹…åŒ–**: AOFï¼ˆè¿½åŠ æ—¥èªŒï¼‰+ RDBï¼ˆå¿«ç…§ï¼‰æ··åˆæŒä¹…åŒ–
- **ç›£æ§**: redis_exporter + Prometheus

**ç¾å¯¦ä¸–ç•Œç¤ºä¾‹**:

**å ´æ™¯**: "ServiceNow ç¥¨å‹™æŸ¥è©¢" Workflow çš„æ€§èƒ½å„ªåŒ–

**ç„¡ç·©å­˜ï¼ˆé¦–æ¬¡æŸ¥è©¢ï¼‰**:
```
ç”¨æˆ¶è«‹æ±‚ â†’ API â†’ æ•¸æ“šåº«æŸ¥è©¢ Workflow å®šç¾©ï¼ˆ200msï¼‰ 
         â†’ æ•¸æ“šåº«æŸ¥è©¢ Agent é…ç½®ï¼ˆ150msï¼‰
         â†’ æ•¸æ“šåº«æŸ¥è©¢ Prompt æ¨¡æ¿ï¼ˆ100msï¼‰
         â†’ åŸ·è¡Œ Workflowï¼ˆ500msï¼‰
ç¸½è€—æ™‚: 950ms
```

**æœ‰ç·©å­˜ï¼ˆå¾ŒçºŒæŸ¥è©¢ï¼‰**:
```
ç”¨æˆ¶è«‹æ±‚ â†’ API â†’ Redis ç²å– Workflow å®šç¾©ï¼ˆ5msï¼‰
         â†’ Redis ç²å– Agent é…ç½®ï¼ˆ5msï¼‰
         â†’ Redis ç²å– Prompt æ¨¡æ¿ï¼ˆ5msï¼‰
         â†’ åŸ·è¡Œ Workflowï¼ˆ500msï¼‰
ç¸½è€—æ™‚: 515msï¼ˆæ¸›å°‘ 45%ï¼‰
```

**ç·©å­˜å‘½ä¸­ç‡**: 95%ï¼ˆç†±é–€ Workflowï¼‰

---

### 14.2 ç”¨æˆ¶æ•…äº‹

#### **US-F14-001: Workflow å’Œ Agent é…ç½®ç·©å­˜**

**User Story**:  
ä½œç‚ºç³»çµ±æ¶æ§‹å¸«ï¼Œæˆ‘å¸Œæœ›ç·©å­˜ Workflow å®šç¾©å’Œ Agent é…ç½®ï¼Œä»¥ä¾¿æ¸›å°‘æ•¸æ“šåº«æŸ¥è©¢ä¸¦åŠ é€Ÿ Workflow åŸ·è¡Œã€‚

**å ´æ™¯æè¿°**:

- ç”¨æˆ¶è§¸ç™¼ Workflow åŸ·è¡Œ
- ç³»çµ±é¦–å…ˆæŸ¥è©¢ Redis ç·©å­˜
- å¦‚æœç·©å­˜å‘½ä¸­ï¼Œç›´æ¥ä½¿ç”¨ç·©å­˜æ•¸æ“š
- å¦‚æœç·©å­˜æœªå‘½ä¸­ï¼Œå¾æ•¸æ“šåº«åŠ è¼‰ä¸¦å¯«å…¥ Redis
- ç•¶ Workflow æˆ– Agent é…ç½®æ›´æ–°æ™‚ï¼Œä¸»å‹•å¤±æ•ˆç·©å­˜

**Acceptance Criteria**:

1. âœ… Workflow å®šç¾©ç·©å­˜ TTL = 1 å°æ™‚ï¼ˆå¯é…ç½®ï¼‰
2. âœ… Agent é…ç½®ç·©å­˜ TTL = 30 åˆ†é˜
3. âœ… ç·©å­˜å‘½ä¸­ç‡ >90%ï¼ˆç›£æ§æŒ‡æ¨™ï¼‰
4. âœ… æ•¸æ“šæ›´æ–°æ™‚è‡ªå‹•å¤±æ•ˆç·©å­˜ï¼ˆé€šéäº‹ä»¶æ©Ÿåˆ¶ï¼‰
5. âœ… æ”¯æŒç·©å­˜é ç†±ï¼ˆç³»çµ±å•Ÿå‹•æ™‚åŠ è¼‰ Top 100 ç†±é–€ Workflowï¼‰
6. âœ… ç·©å­˜ Key å‘½åè¦ç¯„ï¼š`workflow:{workflow_id}`, `agent:{agent_id}`
7. âœ… ä½¿ç”¨ Redis JSON å­˜å„²è¤‡é›œå°è±¡

**æŠ€è¡“å¯¦ç¾**:

```python
# core/cache.py
import redis.asyncio as redis
from redis.commands.json.path import Path
import json
from typing import Optional, Any
from datetime import timedelta

class RedisCache:
    def __init__(self, redis_url: str = "redis://localhost:6379/0"):
        self.redis = redis.from_url(redis_url, decode_responses=True)
    
    async def get_workflow(self, workflow_id: str) -> Optional[dict]:
        """ç²å– Workflow å®šç¾©ï¼ˆå„ªå…ˆå¾ç·©å­˜ï¼‰"""
        cache_key = f"workflow:{workflow_id}"
        
        # Try cache first
        cached = await self.redis.json().get(cache_key)
        if cached:
            print(f"âœ… Cache hit: {cache_key}")
            return cached
        
        # Cache miss - load from DB
        print(f"âŒ Cache miss: {cache_key}")
        workflow = await self._load_workflow_from_db(workflow_id)
        if workflow:
            # Write to cache with TTL
            await self.redis.json().set(cache_key, Path.root_path(), workflow)
            await self.redis.expire(cache_key, timedelta(hours=1))
        
        return workflow
    
    async def get_agent(self, agent_id: str) -> Optional[dict]:
        """ç²å– Agent é…ç½®ï¼ˆå„ªå…ˆå¾ç·©å­˜ï¼‰"""
        cache_key = f"agent:{agent_id}"
        
        cached = await self.redis.json().get(cache_key)
        if cached:
            return cached
        
        agent = await self._load_agent_from_db(agent_id)
        if agent:
            await self.redis.json().set(cache_key, Path.root_path(), agent)
            await self.redis.expire(cache_key, timedelta(minutes=30))
        
        return agent
    
    async def invalidate_workflow(self, workflow_id: str):
        """ä¸»å‹•å¤±æ•ˆ Workflow ç·©å­˜ï¼ˆç•¶æ•¸æ“šæ›´æ–°æ™‚ï¼‰"""
        cache_key = f"workflow:{workflow_id}"
        await self.redis.delete(cache_key)
        print(f"ğŸ—‘ï¸ Invalidated cache: {cache_key}")
    
    async def invalidate_agent(self, agent_id: str):
        """ä¸»å‹•å¤±æ•ˆ Agent ç·©å­˜"""
        cache_key = f"agent:{agent_id}"
        await self.redis.delete(cache_key)
    
    async def warm_up_cache(self):
        """ç·©å­˜é ç†±ï¼šåŠ è¼‰ Top 100 ç†±é–€ Workflow"""
        top_workflows = await self._get_top_workflows(limit=100)
        for workflow in top_workflows:
            cache_key = f"workflow:{workflow['id']}"
            await self.redis.json().set(cache_key, Path.root_path(), workflow)
            await self.redis.expire(cache_key, timedelta(hours=1))
        print(f"ğŸ”¥ Warmed up {len(top_workflows)} workflows")
    
    async def _load_workflow_from_db(self, workflow_id: str) -> Optional[dict]:
        # Database query implementation
        pass
    
    async def _load_agent_from_db(self, agent_id: str) -> Optional[dict]:
        # Database query implementation
        pass
    
    async def _get_top_workflows(self, limit: int = 100) -> list:
        # Query top workflows by execution count
        pass

# ä½¿ç”¨ç¤ºä¾‹
cache = RedisCache()

# åŸ·è¡Œ Workflow æ™‚ä½¿ç”¨ç·©å­˜
async def execute_workflow(workflow_id: str, input_data: dict):
    workflow = await cache.get_workflow(workflow_id)
    if not workflow:
        raise ValueError(f"Workflow {workflow_id} not found")
    
    # Execute workflow steps
    for step in workflow['steps']:
        agent = await cache.get_agent(step['agent_id'])
        # ... execute step
```

**ç·©å­˜å¤±æ•ˆäº‹ä»¶è™•ç†**:

```python
# api/workflow.py
from fastapi import APIRouter, Depends
from core.cache import RedisCache

router = APIRouter(prefix="/api/workflows", tags=["workflows"])
cache = RedisCache()

@router.put("/{workflow_id}")
async def update_workflow(workflow_id: str, workflow_data: dict, db: Session = Depends(get_db)):
    """æ›´æ–° Workflow ä¸¦å¤±æ•ˆç·©å­˜"""
    # Update database
    db_workflow = db.query(Workflow).filter(Workflow.id == workflow_id).first()
    if not db_workflow:
        raise HTTPException(status_code=404, detail="Workflow not found")
    
    db_workflow.definition = workflow_data['definition']
    db.commit()
    
    # Invalidate cache
    await cache.invalidate_workflow(workflow_id)
    
    return {"status": "updated", "workflow_id": workflow_id}
```

**ç·©å­˜ç›£æ§æŒ‡æ¨™**:

```python
# core/metrics.py
from prometheus_client import Counter, Histogram

cache_hits = Counter('redis_cache_hits_total', 'Total cache hits', ['cache_type'])
cache_misses = Counter('redis_cache_misses_total', 'Total cache misses', ['cache_type'])
cache_latency = Histogram('redis_cache_latency_seconds', 'Cache operation latency', ['operation'])

async def get_workflow_with_metrics(workflow_id: str):
    with cache_latency.labels(operation='get_workflow').time():
        workflow = await cache.get_workflow(workflow_id)
        if workflow:
            cache_hits.labels(cache_type='workflow').inc()
        else:
            cache_misses.labels(cache_type='workflow').inc()
        return workflow
```

**æ¸¬è©¦ç­–ç•¥**:

1. å–®å…ƒæ¸¬è©¦ï¼šæ¸¬è©¦ç·©å­˜å‘½ä¸­ã€æœªå‘½ä¸­ã€å¤±æ•ˆé‚è¼¯
2. é›†æˆæ¸¬è©¦ï¼šæ¸¬è©¦æ•¸æ“šåº«èˆ‡ Redis æ•¸æ“šä¸€è‡´æ€§
3. æ€§èƒ½æ¸¬è©¦ï¼šå°æ¯”æœ‰/ç„¡ç·©å­˜çš„ API éŸ¿æ‡‰æ™‚é–“
4. è² è¼‰æ¸¬è©¦ï¼šæ¸¬è©¦é«˜ä¸¦ç™¼ä¸‹çš„ç·©å­˜æ€§èƒ½

---

#### **US-F14-002: Prompt æ¨¡æ¿ç·©å­˜èˆ‡ç†±é‡è¼‰**

**User Story**:  
ä½œç‚ºæç¤ºå·¥ç¨‹å¸«ï¼Œæˆ‘å¸Œæœ› Prompt æ¨¡æ¿è‡ªå‹•ç·©å­˜ä¸¦æ”¯æŒç†±é‡è¼‰ï¼Œä»¥ä¾¿æ¨¡æ¿æ›´æ–°å¾Œ 5 ç§’å…§ç”Ÿæ•ˆã€‚

**å ´æ™¯æè¿°**:

- Prompt æ¨¡æ¿å­˜å„²åœ¨ Git å€‰åº«ï¼ˆYAML æ–‡ä»¶ï¼‰
- ç³»çµ±å•Ÿå‹•æ™‚åŠ è¼‰æ‰€æœ‰ Prompt åˆ° Redis
- æ¯ 5 ç§’æª¢æŸ¥ Git å€‰åº«è®Šæ›´ï¼ˆWebhook æˆ–è¼ªè©¢ï¼‰
- æª¢æ¸¬åˆ°è®Šæ›´æ™‚ï¼Œé‡æ–°åŠ è¼‰ä¸¦æ›´æ–° Redis ç·©å­˜
- Agent åŸ·è¡Œæ™‚å¾ Redis ç²å–æœ€æ–° Prompt

**Acceptance Criteria**:

1. âœ… Prompt æ¨¡æ¿ç·©å­˜ Keyï¼š`prompt:{prompt_name}:{version}`
2. âœ… æ”¯æŒå¤šç‰ˆæœ¬ Prompt å…±å­˜ï¼ˆç”¨æ–¼ A/B æ¸¬è©¦ï¼‰
3. âœ… Git å€‰åº«è®Šæ›´å¾Œ 5 ç§’å…§è‡ªå‹•æ›´æ–°ç·©å­˜
4. âœ… æä¾›æ‰‹å‹•åˆ·æ–° APIï¼ˆ`POST /api/prompts/reload`ï¼‰
5. âœ… ç·©å­˜é ç†±ï¼šç³»çµ±å•Ÿå‹•æ™‚åŠ è¼‰æ‰€æœ‰ Prompt
6. âœ… Prompt æ¨¡æ¿åŒ…å«å…ƒæ•¸æ“šï¼šç‰ˆæœ¬è™Ÿã€æ›´æ–°æ™‚é–“ã€ä½œè€…

**æŠ€è¡“å¯¦ç¾**:

```python
# core/prompt_cache.py
import asyncio
import aiofiles
import yaml
from pathlib import Path
from typing import Dict, Optional
from datetime import datetime
from core.cache import RedisCache

class PromptCacheManager:
    def __init__(self, prompts_dir: str = "./prompts", redis_cache: RedisCache = None):
        self.prompts_dir = Path(prompts_dir)
        self.cache = redis_cache or RedisCache()
        self.last_sync_time = None
    
    async def load_all_prompts(self):
        """åŠ è¼‰æ‰€æœ‰ Prompt æ¨¡æ¿åˆ° Redis"""
        prompt_files = list(self.prompts_dir.glob("**/*.yaml"))
        print(f"ğŸ“‚ Loading {len(prompt_files)} prompt templates...")
        
        for prompt_file in prompt_files:
            await self._load_prompt_file(prompt_file)
        
        self.last_sync_time = datetime.now()
        print(f"âœ… Loaded all prompts at {self.last_sync_time}")
    
    async def _load_prompt_file(self, prompt_file: Path):
        """åŠ è¼‰å–®å€‹ Prompt æ–‡ä»¶"""
        async with aiofiles.open(prompt_file, 'r', encoding='utf-8') as f:
            content = await f.read()
            prompt_data = yaml.safe_load(content)
        
        prompt_name = prompt_data.get('name')
        version = prompt_data.get('version', 'latest')
        
        # Store in Redis with metadata
        cache_key = f"prompt:{prompt_name}:{version}"
        prompt_with_metadata = {
            "name": prompt_name,
            "version": version,
            "template": prompt_data.get('template'),
            "variables": prompt_data.get('variables', []),
            "description": prompt_data.get('description', ''),
            "author": prompt_data.get('author', 'unknown'),
            "updated_at": datetime.now().isoformat(),
            "file_path": str(prompt_file)
        }
        
        await self.cache.redis.json().set(cache_key, Path.root_path(), prompt_with_metadata)
        
        # Also store under 'latest' alias
        latest_key = f"prompt:{prompt_name}:latest"
        await self.cache.redis.json().set(latest_key, Path.root_path(), prompt_with_metadata)
        
        print(f"ğŸ“ Cached prompt: {cache_key}")
    
    async def get_prompt(self, prompt_name: str, version: str = "latest") -> Optional[dict]:
        """ç²å– Prompt æ¨¡æ¿"""
        cache_key = f"prompt:{prompt_name}:{version}"
        return await self.cache.redis.json().get(cache_key)
    
    async def watch_for_changes(self):
        """ç›£æ§ Git å€‰åº«è®Šæ›´ä¸¦è‡ªå‹•é‡è¼‰"""
        while True:
            try:
                # Check for changes (simplified - in production use Git hooks)
                current_mtime = max(f.stat().st_mtime for f in self.prompts_dir.glob("**/*.yaml"))
                
                if self.last_sync_time is None or current_mtime > self.last_sync_time.timestamp():
                    print(f"ğŸ”„ Detected prompt changes, reloading...")
                    await self.load_all_prompts()
                
            except Exception as e:
                print(f"âŒ Error watching prompts: {e}")
            
            await asyncio.sleep(5)  # Check every 5 seconds
    
    async def reload_prompts(self):
        """æ‰‹å‹•é‡è¼‰æ‰€æœ‰ Prompt"""
        await self.load_all_prompts()
        return {"status": "reloaded", "timestamp": self.last_sync_time.isoformat()}

# åˆå§‹åŒ–
prompt_manager = PromptCacheManager()

# ç³»çµ±å•Ÿå‹•æ™‚åŠ è¼‰
@app.on_event("startup")
async def startup():
    await prompt_manager.load_all_prompts()
    # Start background watcher
    asyncio.create_task(prompt_manager.watch_for_changes())

# API endpoint
@router.post("/api/prompts/reload")
async def reload_prompts():
    """æ‰‹å‹•é‡è¼‰ Prompt"""
    result = await prompt_manager.reload_prompts()
    return result
```

**Prompt æ¨¡æ¿ç¤ºä¾‹**:

```yaml
# prompts/customer_service/ticket_summary.yaml
name: ticket_summary
version: v1.2
author: john.doe@company.com
description: Summarize customer support tickets
template: |
  You are a customer service analyst. Summarize the following ticket:
  
  Ticket ID: {ticket_id}
  Customer: {customer_name}
  Issue: {issue_description}
  Priority: {priority}
  
  Provide a concise summary in 2-3 sentences, focusing on:
  1. Main problem
  2. Customer impact
  3. Suggested action
variables:
  - ticket_id
  - customer_name
  - issue_description
  - priority
```

**ä½¿ç”¨ç·©å­˜çš„ Prompt**:

```python
# agents/customer_service_agent.py
async def execute_ticket_summary(ticket_data: dict):
    # Get prompt from cache
    prompt_template = await prompt_manager.get_prompt("ticket_summary", version="latest")
    
    if not prompt_template:
        raise ValueError("Prompt template not found")
    
    # Render prompt with variables
    from jinja2 import Template
    template = Template(prompt_template['template'])
    rendered_prompt = template.render(**ticket_data)
    
    # Call LLM
    response = await call_llm(rendered_prompt)
    return response
```

**æ¸¬è©¦ç­–ç•¥**:

1. å–®å…ƒæ¸¬è©¦ï¼šæ¸¬è©¦ Prompt åŠ è¼‰ã€ç·©å­˜ã€ç‰ˆæœ¬ç®¡ç†
2. é›†æˆæ¸¬è©¦ï¼šæ¸¬è©¦ Git å€‰åº«è®Šæ›´è§¸ç™¼ç†±é‡è¼‰
3. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦ Prompt ç·©å­˜å‘½ä¸­ç‡å’ŒéŸ¿æ‡‰æ™‚é–“
4. ç‰ˆæœ¬æ¸¬è©¦ï¼šæ¸¬è©¦å¤šç‰ˆæœ¬ Prompt å…±å­˜å’Œåˆ‡æ›

---

#### **US-F14-003: åˆ†ä½ˆå¼é–èˆ‡é€Ÿç‡é™åˆ¶**

**User Story**:  
ä½œç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œæˆ‘å¸Œæœ›ä½¿ç”¨ Redis åˆ†ä½ˆå¼é–ä¿è­‰æ“ä½œåŸå­æ€§ï¼Œä¸¦å¯¦ç¾ API é€Ÿç‡é™åˆ¶é˜²æ­¢æ¿«ç”¨ã€‚

**å ´æ™¯æè¿°ï¼ˆåˆ†ä½ˆå¼é–ï¼‰**:

- å¤šå€‹å¯¦ä¾‹åŒæ™‚å˜—è©¦ç™¼å¸ƒ Workflow
- ä½¿ç”¨ Redis åˆ†ä½ˆå¼é–ä¿è­‰åªæœ‰ä¸€å€‹å¯¦ä¾‹æˆåŠŸ
- é–è‡ªå‹•éæœŸï¼ˆé˜²æ­¢æ­»é–ï¼‰
- é–é‡‹æ”¾å¾Œå…¶ä»–å¯¦ä¾‹å¯ç¹¼çºŒå˜—è©¦

**å ´æ™¯æè¿°ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰**:

- ç”¨æˆ¶/IP èª¿ç”¨ API é »ç‡éé«˜
- Redis è¨˜éŒ„æ¯å€‹ç”¨æˆ¶çš„è«‹æ±‚è¨ˆæ•¸ï¼ˆæ»‘å‹•çª—å£ï¼‰
- è¶…éé™åˆ¶æ™‚è¿”å› 429 Too Many Requests
- 1 åˆ†é˜å¾Œè‡ªå‹•é‡ç½®è¨ˆæ•¸å™¨

**Acceptance Criteriaï¼ˆåˆ†ä½ˆå¼é–ï¼‰**:

1. âœ… æ”¯æŒå¯é‡å…¥é–ï¼ˆåŒä¸€ç·šç¨‹å¯å¤šæ¬¡ç²å–ï¼‰
2. âœ… é–è‡ªå‹•éæœŸæ™‚é–“ 30 ç§’ï¼ˆå¯é…ç½®ï¼‰
3. âœ… é–é‡‹æ”¾ä½¿ç”¨ Lua è…³æœ¬ä¿è­‰åŸå­æ€§
4. âœ… ç²å–é–å¤±æ•—æ™‚æ”¯æŒé‡è©¦ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰
5. âœ… ç›£æ§æŒ‡æ¨™ï¼šé–ç«¶çˆ­æ¬¡æ•¸ã€é–æŒæœ‰æ™‚é–“

**Acceptance Criteriaï¼ˆé€Ÿç‡é™åˆ¶ï¼‰**:

1. âœ… é»˜èªé€Ÿç‡é™åˆ¶ï¼š100 è«‹æ±‚/åˆ†é˜ï¼ˆæŒ‰ç”¨æˆ¶ IDï¼‰
2. âœ… IP é€Ÿç‡é™åˆ¶ï¼š500 è«‹æ±‚/åˆ†é˜ï¼ˆé˜²æ­¢æœªèªè­‰æ¿«ç”¨ï¼‰
3. âœ… ç™½åå–®ï¼šç®¡ç†å“¡å’Œç³»çµ±è³¬è™Ÿä¸å—é™åˆ¶
4. âœ… éŸ¿æ‡‰é ­åŒ…å«ï¼š`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`
5. âœ… è¶…é™æ™‚è¿”å› 429 ç‹€æ…‹ç¢¼å’Œé‡è©¦æ™‚é–“

**æŠ€è¡“å¯¦ç¾ï¼ˆåˆ†ä½ˆå¼é–ï¼‰**:

```python
# core/distributed_lock.py
import asyncio
import uuid
from typing import Optional
from redis.asyncio import Redis

class DistributedLock:
    def __init__(self, redis: Redis, lock_name: str, timeout: int = 30):
        self.redis = redis
        self.lock_name = f"lock:{lock_name}"
        self.timeout = timeout
        self.token = str(uuid.uuid4())  # Unique token for this lock holder
    
    async def acquire(self, blocking: bool = True, retry_delay: float = 0.1) -> bool:
        """ç²å–åˆ†ä½ˆå¼é–"""
        while True:
            # Try to set lock with NX (only if not exists) and EX (expiration)
            acquired = await self.redis.set(
                self.lock_name,
                self.token,
                nx=True,  # Only set if key doesn't exist
                ex=self.timeout  # Auto-expire after timeout
            )
            
            if acquired:
                print(f"ğŸ”’ Acquired lock: {self.lock_name}")
                return True
            
            if not blocking:
                return False
            
            # Exponential backoff
            await asyncio.sleep(retry_delay)
            retry_delay = min(retry_delay * 2, 1.0)  # Max 1 second
    
    async def release(self):
        """é‡‹æ”¾åˆ†ä½ˆå¼é–ï¼ˆä½¿ç”¨ Lua è…³æœ¬ä¿è­‰åŸå­æ€§ï¼‰"""
        # Lua script to check token and delete atomically
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        
        released = await self.redis.eval(lua_script, 1, self.lock_name, self.token)
        
        if released:
            print(f"ğŸ”“ Released lock: {self.lock_name}")
        else:
            print(f"âš ï¸ Lock already released or expired: {self.lock_name}")
    
    async def __aenter__(self):
        await self.acquire()
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.release()

# ä½¿ç”¨ç¤ºä¾‹
from core.cache import RedisCache

cache = RedisCache()

async def publish_workflow(workflow_id: str):
    """ç™¼å¸ƒ Workflowï¼ˆä½¿ç”¨åˆ†ä½ˆå¼é–ä¿è­‰åªæœ‰ä¸€å€‹å¯¦ä¾‹åŸ·è¡Œï¼‰"""
    lock = DistributedLock(cache.redis, f"publish_workflow:{workflow_id}", timeout=30)
    
    async with lock:
        # Critical section - only one instance can execute this
        workflow = await load_workflow_from_db(workflow_id)
        workflow['status'] = 'published'
        workflow['published_at'] = datetime.now()
        await save_workflow_to_db(workflow)
        
        # Invalidate cache
        await cache.invalidate_workflow(workflow_id)
        
        print(f"âœ… Published workflow: {workflow_id}")
```

**æŠ€è¡“å¯¦ç¾ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰**:

```python
# core/rate_limiter.py
from typing import Optional
from redis.asyncio import Redis
from datetime import datetime

class RateLimiter:
    def __init__(self, redis: Redis):
        self.redis = redis
    
    async def check_rate_limit(
        self,
        key: str,
        limit: int = 100,
        window: int = 60
    ) -> dict:
        """
        æª¢æŸ¥é€Ÿç‡é™åˆ¶ï¼ˆæ»‘å‹•çª—å£ç®—æ³•ï¼‰
        
        Args:
            key: ç”¨æˆ¶ ID æˆ– IP åœ°å€
            limit: å…è¨±çš„æœ€å¤§è«‹æ±‚æ•¸
            window: æ™‚é–“çª—å£ï¼ˆç§’ï¼‰
        
        Returns:
            {
                "allowed": bool,
                "limit": int,
                "remaining": int,
                "reset": int (timestamp)
            }
        """
        now = datetime.now().timestamp()
        window_start = now - window
        
        cache_key = f"rate_limit:{key}"
        
        # Use Redis sorted set to track requests with timestamps
        pipe = self.redis.pipeline()
        
        # Remove old requests outside the window
        pipe.zremrangebyscore(cache_key, 0, window_start)
        
        # Count requests in current window
        pipe.zcard(cache_key)
        
        # Add current request
        pipe.zadd(cache_key, {str(now): now})
        
        # Set expiration
        pipe.expire(cache_key, window)
        
        results = await pipe.execute()
        request_count = results[1]
        
        allowed = request_count < limit
        remaining = max(0, limit - request_count - 1)
        reset = int(now + window)
        
        return {
            "allowed": allowed,
            "limit": limit,
            "remaining": remaining,
            "reset": reset,
            "current_count": request_count
        }

# FastAPI middleware
from fastapi import Request, HTTPException
from starlette.middleware.base import BaseHTTPMiddleware

class RateLimitMiddleware(BaseHTTPMiddleware):
    def __init__(self, app, redis: Redis):
        super().__init__(app)
        self.rate_limiter = RateLimiter(redis)
        self.whitelist = ["admin@company.com", "system@company.com"]
    
    async def dispatch(self, request: Request, call_next):
        # Get user ID or IP
        user_id = request.state.user_id if hasattr(request.state, 'user_id') else None
        ip_address = request.client.host
        
        # Check whitelist
        if user_id in self.whitelist:
            return await call_next(request)
        
        # Check rate limit (prefer user_id, fallback to IP)
        key = user_id or ip_address
        limit_result = await self.rate_limiter.check_rate_limit(
            key=key,
            limit=100 if user_id else 500,  # Higher limit for authenticated users
            window=60
        )
        
        # Add headers
        response = await call_next(request)
        response.headers["X-RateLimit-Limit"] = str(limit_result["limit"])
        response.headers["X-RateLimit-Remaining"] = str(limit_result["remaining"])
        response.headers["X-RateLimit-Reset"] = str(limit_result["reset"])
        
        if not limit_result["allowed"]:
            raise HTTPException(
                status_code=429,
                detail=f"Rate limit exceeded. Try again in {limit_result['reset'] - int(datetime.now().timestamp())} seconds"
            )
        
        return response

# æ‡‰ç”¨ middleware
from fastapi import FastAPI
app = FastAPI()
app.add_middleware(RateLimitMiddleware, redis=cache.redis)
```

**ç›£æ§æŒ‡æ¨™**:

```python
# core/metrics.py
from prometheus_client import Counter, Histogram

lock_acquisitions = Counter('redis_lock_acquisitions_total', 'Total lock acquisitions', ['lock_name'])
lock_contentions = Counter('redis_lock_contentions_total', 'Lock contention events', ['lock_name'])
lock_hold_time = Histogram('redis_lock_hold_seconds', 'Lock hold duration', ['lock_name'])

rate_limit_hits = Counter('rate_limit_hits_total', 'Rate limit exceeded', ['endpoint', 'user_type'])
rate_limit_requests = Counter('rate_limit_requests_total', 'Total rate-limited requests', ['endpoint'])
```

**æ¸¬è©¦ç­–ç•¥**:

1. ä¸¦ç™¼æ¸¬è©¦ï¼šä½¿ç”¨ asyncio æ¨¡æ“¬å¤šå¯¦ä¾‹ç«¶çˆ­é–
2. å£“åŠ›æ¸¬è©¦ï¼šæ¸¬è©¦é«˜ä¸¦ç™¼ä¸‹çš„é€Ÿç‡é™åˆ¶æº–ç¢ºæ€§
3. æ•…éšœæ¸¬è©¦ï¼šæ¸¬è©¦ Redis ä¸å¯ç”¨æ™‚çš„é™ç´šè¡Œç‚º
4. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦åˆ†ä½ˆå¼é–å° API å»¶é²çš„å½±éŸ¿

---

#### **US-F14-004: æœƒè©±ç®¡ç†èˆ‡ç·©å­˜ç›£æ§**

**User Story**:  
ä½œç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œæˆ‘å¸Œæœ›ä½¿ç”¨ Redis ç®¡ç†ç”¨æˆ¶æœƒè©±ä¸¦ç›£æ§ç·©å­˜æ€§èƒ½ï¼Œä»¥ä¾¿å„ªåŒ–ç³»çµ±è³‡æºä½¿ç”¨ã€‚

**å ´æ™¯æè¿°ï¼ˆæœƒè©±ç®¡ç†ï¼‰**:

- ç”¨æˆ¶ç™»å…¥å¾Œç”Ÿæˆæœƒè©± Token
- æœƒè©±ä¿¡æ¯å­˜å„²åœ¨ Redisï¼ˆç”¨æˆ¶ IDã€æ¬Šé™ã€éæœŸæ™‚é–“ï¼‰
- æ¯æ¬¡ API è«‹æ±‚é©—è­‰æœƒè©±æœ‰æ•ˆæ€§
- æœƒè©±éæœŸå¾Œè‡ªå‹•æ¸…ç†

**å ´æ™¯æè¿°ï¼ˆç·©å­˜ç›£æ§ï¼‰**:

- å¯¦æ™‚ç›£æ§ç·©å­˜å‘½ä¸­ç‡ã€æœªå‘½ä¸­ç‡
- ç›£æ§ Redis å…§å­˜ä½¿ç”¨ã€é€£æ¥æ•¸
- ç›£æ§ç†±é» Keyï¼ˆæœ€å¸¸è¨ªå•çš„æ•¸æ“šï¼‰
- å‘Šè­¦ï¼šç·©å­˜å‘½ä¸­ç‡ <80% æˆ–å…§å­˜ä½¿ç”¨ >90%

**Acceptance Criteriaï¼ˆæœƒè©±ç®¡ç†ï¼‰**:

1. âœ… æœƒè©± TTL = 24 å°æ™‚ï¼ˆå¯é…ç½®ï¼‰
2. âœ… æ”¯æŒæœƒè©±çºŒæœŸï¼ˆç”¨æˆ¶æ´»å‹•æ™‚è‡ªå‹•å»¶é•·ï¼‰
3. âœ… æ”¯æŒå–®é»ç™»å‡ºï¼ˆåˆªé™¤ Redis æœƒè©±ï¼‰
4. âœ… æ”¯æŒå¤šè¨­å‚™ç™»å…¥ï¼ˆæ¯å€‹è¨­å‚™ç¨ç«‹æœƒè©±ï¼‰
5. âœ… æœƒè©±ä¿¡æ¯åŒ…å«ï¼šç”¨æˆ¶ IDã€è§’è‰²ã€æ¬Šé™åˆ—è¡¨ã€è¨­å‚™ä¿¡æ¯

**Acceptance Criteriaï¼ˆç·©å­˜ç›£æ§ï¼‰**:

1. âœ… Dashboard é¡¯ç¤ºï¼šå‘½ä¸­ç‡ã€æœªå‘½ä¸­ç‡ã€å¹³å‡éŸ¿æ‡‰æ™‚é–“
2. âœ… é¡¯ç¤º Top 10 ç†±é» Key
3. âœ… Redis INFO æŒ‡æ¨™ï¼šå…§å­˜ä½¿ç”¨ã€é€£æ¥æ•¸ã€éµæ•¸é‡
4. âœ… å‘Šè­¦è¦å‰‡ï¼šå‘½ä¸­ç‡ <80% æˆ–å…§å­˜ä½¿ç”¨ >90%
5. âœ… æ”¯æŒæ‰‹å‹•æ¸…ç†éæœŸç·©å­˜ï¼ˆ`POST /api/cache/cleanup`ï¼‰

**æŠ€è¡“å¯¦ç¾ï¼ˆæœƒè©±ç®¡ç†ï¼‰**:

```python
# core/session_manager.py
import json
from typing import Optional
from datetime import timedelta
from redis.asyncio import Redis

class SessionManager:
    def __init__(self, redis: Redis, session_ttl: int = 86400):
        self.redis = redis
        self.session_ttl = session_ttl  # 24 hours
    
    async def create_session(self, user_id: str, user_data: dict, device_id: str) -> str:
        """å‰µå»ºæ–°æœƒè©±"""
        import secrets
        session_token = secrets.token_urlsafe(32)
        
        session_key = f"session:{session_token}"
        session_data = {
            "user_id": user_id,
            "roles": user_data.get("roles", []),
            "permissions": user_data.get("permissions", []),
            "device_id": device_id,
            "created_at": datetime.now().isoformat(),
            "last_activity": datetime.now().isoformat()
        }
        
        await self.redis.setex(
            session_key,
            self.session_ttl,
            json.dumps(session_data)
        )
        
        # Track user's active sessions
        user_sessions_key = f"user_sessions:{user_id}"
        await self.redis.sadd(user_sessions_key, session_token)
        await self.redis.expire(user_sessions_key, self.session_ttl)
        
        print(f"âœ… Created session for user {user_id}: {session_token[:10]}...")
        return session_token
    
    async def get_session(self, session_token: str) -> Optional[dict]:
        """ç²å–æœƒè©±ä¿¡æ¯"""
        session_key = f"session:{session_token}"
        session_data = await self.redis.get(session_key)
        
        if not session_data:
            return None
        
        return json.loads(session_data)
    
    async def refresh_session(self, session_token: str):
        """çºŒæœŸæœƒè©±ï¼ˆç”¨æˆ¶æ´»å‹•æ™‚èª¿ç”¨ï¼‰"""
        session_key = f"session:{session_token}"
        session_data = await self.get_session(session_token)
        
        if session_data:
            session_data["last_activity"] = datetime.now().isoformat()
            await self.redis.setex(
                session_key,
                self.session_ttl,
                json.dumps(session_data)
            )
    
    async def delete_session(self, session_token: str):
        """ç™»å‡ºï¼ˆåˆªé™¤æœƒè©±ï¼‰"""
        session_data = await self.get_session(session_token)
        if session_data:
            user_id = session_data["user_id"]
            
            # Remove session
            session_key = f"session:{session_token}"
            await self.redis.delete(session_key)
            
            # Remove from user's active sessions
            user_sessions_key = f"user_sessions:{user_id}"
            await self.redis.srem(user_sessions_key, session_token)
            
            print(f"ğŸšª Logged out user {user_id}")
    
    async def get_user_sessions(self, user_id: str) -> list:
        """ç²å–ç”¨æˆ¶çš„æ‰€æœ‰æ´»èºæœƒè©±"""
        user_sessions_key = f"user_sessions:{user_id}"
        session_tokens = await self.redis.smembers(user_sessions_key)
        
        sessions = []
        for token in session_tokens:
            session_data = await self.get_session(token)
            if session_data:
                sessions.append({
                    "token": token[:10] + "...",
                    "device_id": session_data.get("device_id"),
                    "last_activity": session_data.get("last_activity")
                })
        
        return sessions

# FastAPI é›†æˆ
from fastapi import Request, HTTPException, Depends

async def get_current_user(request: Request, session_manager: SessionManager = Depends()):
    """é©—è­‰æœƒè©±ä¸¦ç²å–ç•¶å‰ç”¨æˆ¶"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Missing or invalid token")
    
    session_token = auth_header.split(" ")[1]
    session_data = await session_manager.get_session(session_token)
    
    if not session_data:
        raise HTTPException(status_code=401, detail="Invalid or expired session")
    
    # Refresh session on activity
    await session_manager.refresh_session(session_token)
    
    return session_data

# API endpoints
@router.post("/api/auth/login")
async def login(username: str, password: str, device_id: str, session_manager: SessionManager = Depends()):
    # Authenticate user (omitted)
    user_data = authenticate_user(username, password)
    
    # Create session
    session_token = await session_manager.create_session(
        user_id=user_data["user_id"],
        user_data=user_data,
        device_id=device_id
    )
    
    return {"access_token": session_token, "token_type": "bearer"}

@router.post("/api/auth/logout")
async def logout(session_token: str, session_manager: SessionManager = Depends()):
    await session_manager.delete_session(session_token)
    return {"status": "logged_out"}
```

**æŠ€è¡“å¯¦ç¾ï¼ˆç·©å­˜ç›£æ§ï¼‰**:

```python
# core/cache_monitor.py
from typing import Dict, List
from redis.asyncio import Redis

class CacheMonitor:
    def __init__(self, redis: Redis):
        self.redis = redis
    
    async def get_cache_stats(self) -> Dict:
        """ç²å–ç·©å­˜çµ±è¨ˆä¿¡æ¯"""
        info = await self.redis.info()
        
        # Calculate hit rate
        keyspace_hits = info.get('keyspace_hits', 0)
        keyspace_misses = info.get('keyspace_misses', 0)
        total_requests = keyspace_hits + keyspace_misses
        hit_rate = (keyspace_hits / total_requests * 100) if total_requests > 0 else 0
        
        return {
            "hit_rate": round(hit_rate, 2),
            "total_hits": keyspace_hits,
            "total_misses": keyspace_misses,
            "memory_used_mb": info.get('used_memory', 0) / 1024 / 1024,
            "memory_peak_mb": info.get('used_memory_peak', 0) / 1024 / 1024,
            "total_keys": info.get('db0', {}).get('keys', 0),
            "connected_clients": info.get('connected_clients', 0),
            "uptime_days": info.get('uptime_in_days', 0)
        }
    
    async def get_hot_keys(self, limit: int = 10) -> List[Dict]:
        """ç²å–ç†±é» Keyï¼ˆéœ€è¦ Redis 4.0+ çš„ OBJECT FREQ å‘½ä»¤ï¼‰"""
        # This is a simplified version - in production use Redis's built-in tracking
        all_keys = await self.redis.keys("*")
        
        hot_keys = []
        for key in all_keys[:100]:  # Sample first 100 keys
            ttl = await self.redis.ttl(key)
            memory = await self.redis.memory_usage(key) or 0
            
            hot_keys.append({
                "key": key,
                "ttl": ttl,
                "memory_bytes": memory
            })
        
        # Sort by memory usage (proxy for access frequency)
        hot_keys.sort(key=lambda x: x['memory_bytes'], reverse=True)
        return hot_keys[:limit]
    
    async def cleanup_expired_keys(self) -> int:
        """æ‰‹å‹•æ¸…ç†éæœŸ Keyï¼ˆRedis è‡ªå‹•æ¸…ç†ï¼Œé€™æ˜¯è£œå……ï¼‰"""
        # Get all keys with TTL
        all_keys = await self.redis.keys("*")
        deleted = 0
        
        for key in all_keys:
            ttl = await self.redis.ttl(key)
            if ttl == -1:  # No expiration set
                # Optionally set default expiration
                pass
        
        return deleted

# API endpoints
@router.get("/api/cache/stats")
async def get_cache_stats(monitor: CacheMonitor = Depends()):
    """ç²å–ç·©å­˜çµ±è¨ˆ"""
    return await monitor.get_cache_stats()

@router.get("/api/cache/hot-keys")
async def get_hot_keys(limit: int = 10, monitor: CacheMonitor = Depends()):
    """ç²å–ç†±é» Key"""
    return await monitor.get_hot_keys(limit)

@router.post("/api/cache/cleanup")
async def cleanup_cache(monitor: CacheMonitor = Depends()):
    """æ‰‹å‹•æ¸…ç†éæœŸç·©å­˜"""
    deleted = await monitor.cleanup_expired_keys()
    return {"deleted_keys": deleted}
```

**Grafana Dashboard é…ç½®**:

```yaml
# grafana/dashboards/redis-cache.json
{
  "dashboard": {
    "title": "Redis Cache Performance",
    "panels": [
      {
        "title": "Cache Hit Rate",
        "targets": [
          {
            "expr": "rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) * 100"
          }
        ]
      },
      {
        "title": "Memory Usage",
        "targets": [
          {
            "expr": "redis_memory_used_bytes / 1024 / 1024"
          }
        ]
      },
      {
        "title": "Connected Clients",
        "targets": [
          {
            "expr": "redis_connected_clients"
          }
        ]
      }
    ]
  }
}
```

**æ¸¬è©¦ç­–ç•¥**:

1. æœƒè©±æ¸¬è©¦ï¼šæ¸¬è©¦ç™»å…¥ã€ç™»å‡ºã€æœƒè©±éæœŸã€å¤šè¨­å‚™ç™»å…¥
2. ç›£æ§æ¸¬è©¦ï¼šé©—è­‰ç·©å­˜çµ±è¨ˆæŒ‡æ¨™æº–ç¢ºæ€§
3. æ€§èƒ½æ¸¬è©¦ï¼šæ¸¬è©¦é«˜ä¸¦ç™¼ä¸‹çš„æœƒè©±é©—è­‰æ€§èƒ½
4. å®‰å…¨æ¸¬è©¦ï¼šæ¸¬è©¦æœƒè©±åŠ«æŒé˜²è­·ã€Token æ³„éœ²é¢¨éšª

---

### 14.3 æ•¸æ“šåº«æ¶æ§‹ï¼ˆRedis æ•¸æ“šçµæ§‹ï¼‰

```text
# Redis Key å‘½åè¦ç¯„
workflow:{workflow_id}              -> JSON (Workflow å®šç¾©)
agent:{agent_id}                    -> JSON (Agent é…ç½®)
prompt:{prompt_name}:{version}      -> JSON (Prompt æ¨¡æ¿)
session:{session_token}             -> JSON (ç”¨æˆ¶æœƒè©±)
user_sessions:{user_id}             -> SET (ç”¨æˆ¶çš„æ´»èºæœƒè©±åˆ—è¡¨)
lock:{resource_name}                -> STRING (åˆ†ä½ˆå¼é–)
rate_limit:{user_id_or_ip}          -> SORTED SET (é€Ÿç‡é™åˆ¶è«‹æ±‚è¨˜éŒ„)

# TTL è¨­ç½®
workflow:*                          -> 1 hour
agent:*                             -> 30 minutes
prompt:*                            -> No expiration (æ‰‹å‹•å¤±æ•ˆ)
session:*                           -> 24 hours
lock:*                              -> 30 seconds (è‡ªå‹•éæœŸ)
rate_limit:*                        -> 60 seconds (æ»‘å‹•çª—å£)

# ç¤ºä¾‹æ•¸æ“š
SET workflow:wf-001 '{"id": "wf-001", "name": "ServiceNow Ticket", ...}' EX 3600
SET session:abc123 '{"user_id": "u-001", "roles": ["admin"], ...}' EX 86400
ZADD rate_limit:u-001 1700000000.123 "1700000000.123"
```

---

### 14.4 éåŠŸèƒ½éœ€æ±‚ (NFR)

| **é¡åˆ¥** | **éœ€æ±‚** | **ç›®æ¨™** | **æ¸¬é‡** |
|-------------|----------------|-----------|----------------|
| **æ€§èƒ½** | ç·©å­˜å‘½ä¸­ç‡ | >90% | Prometheus ç›£æ§ |
| | Redis éŸ¿æ‡‰æ™‚é–“ | <5ms (P95) | redis_exporter |
| | API éŸ¿æ‡‰æ™‚é–“æå‡ | æ¸›å°‘ 80% | APM å°æ¯”æ¸¬è©¦ |
| **å¯é æ€§** | Redis å¯ç”¨æ€§ | 99.9% | Sentinel é«˜å¯ç”¨ |
| | æ•¸æ“šæŒä¹…åŒ– | AOF + RDB æ··åˆ | å®šæœŸå‚™ä»½é©—è­‰ |
| **å¯æ“´å±•æ€§** | æ”¯æŒä½µç™¼é€£æ¥æ•¸ | 10000+ | è² è¼‰æ¸¬è©¦ |
| | å…§å­˜ä½¿ç”¨ | <16 GB | Redis INFO ç›£æ§ |
| **å®‰å…¨æ€§** | é€Ÿç‡é™åˆ¶æº–ç¢ºæ€§ | >99% | å£“åŠ›æ¸¬è©¦é©—è­‰ |
| | æœƒè©±åŠ«æŒé˜²è­· | Token ç¶å®š IP/Device | å®‰å…¨å¯©è¨ˆ |

---

### 14.5 æ¸¬è©¦ç­–ç•¥

**å–®å…ƒæ¸¬è©¦**:

- æ¸¬è©¦ç·©å­˜è®€å¯«ã€å¤±æ•ˆé‚è¼¯
- æ¸¬è©¦åˆ†ä½ˆå¼é–ç²å–/é‡‹æ”¾
- æ¸¬è©¦é€Ÿç‡é™åˆ¶è¨ˆæ•¸å™¨
- æ¸¬è©¦æœƒè©±å‰µå»º/é©—è­‰/éæœŸ

**é›†æˆæ¸¬è©¦**:

- æ¸¬è©¦ Redis èˆ‡æ•¸æ“šåº«æ•¸æ“šä¸€è‡´æ€§
- æ¸¬è©¦å¤šå¯¦ä¾‹ç’°å¢ƒä¸‹çš„åˆ†ä½ˆå¼é–
- æ¸¬è©¦ç·©å­˜å¤±æ•ˆè§¸ç™¼æ©Ÿåˆ¶

**æ€§èƒ½æ¸¬è©¦**:

- åŸºæº–æ¸¬è©¦ï¼šå°æ¯”æœ‰/ç„¡ç·©å­˜çš„ API éŸ¿æ‡‰æ™‚é–“
- è² è¼‰æ¸¬è©¦ï¼šæ¸¬è©¦ 10000 ä½µç™¼è«‹æ±‚çš„ç·©å­˜æ€§èƒ½
- å£“åŠ›æ¸¬è©¦ï¼šæ¸¬è©¦ Redis å…§å­˜ä¸è¶³æ™‚çš„é™ç´šè¡Œç‚º

**æ•…éšœæ¸¬è©¦**:

- æ¸¬è©¦ Redis ä¸å¯ç”¨æ™‚çš„é™ç´šï¼ˆç›´æ¥æŸ¥è©¢æ•¸æ“šåº«ï¼‰
- æ¸¬è©¦ Redis å…§å­˜æ»¿æ™‚çš„ LRU æ·˜æ±°ç­–ç•¥
- æ¸¬è©¦ç¶²çµ¡åˆ†å€æ™‚çš„ Sentinel æ•…éšœè½‰ç§»

---

### 14.6 é¢¨éšªå’Œç·©è§£

| **é¢¨éšª** | **æ¦‚ç‡** | **å½±éŸ¿** | **ç·©è§£** |
|---------|----------------|-----------|---------------|
| Redis å–®é»æ•…éšœ | ä¸­ | é«˜ | Redis Sentinel 3 ç¯€é»é«˜å¯ç”¨ |
| ç·©å­˜é›ªå´©ï¼ˆå¤§é‡ Key åŒæ™‚éæœŸï¼‰ | ä¸­ | é«˜ | éš¨æ©Ÿ TTL + ç·©å­˜é ç†± |
| ç·©å­˜ç©¿é€ï¼ˆæƒ¡æ„æŸ¥è©¢ä¸å­˜åœ¨çš„æ•¸æ“šï¼‰ | ä½ | ä¸­ | å¸ƒéš†éæ¿¾å™¨ + ç©ºå€¼ç·©å­˜ |
| å…§å­˜æº¢å‡º | ä¸­ | é«˜ | LRU æ·˜æ±°ç­–ç•¥ + ç›£æ§å‘Šè­¦ |
| ç†±é» Key æ€§èƒ½ç“¶é ¸ | ä½ | ä¸­ | æœ¬åœ°ç·©å­˜ï¼ˆCaffeineï¼‰+ Redis |

---

### 14.7 æœªä¾†å¢å¼·ï¼ˆMVP å¾Œï¼‰

1. **Redis Cluster**: æ”¯æŒæ•¸æ“šåˆ†ç‰‡å’Œæ°´å¹³æ“´å±•
2. **å¤šç´šç·©å­˜**: æœ¬åœ°ç·©å­˜ï¼ˆL1ï¼‰+ Redisï¼ˆL2ï¼‰+ DBï¼ˆL3ï¼‰
3. **ç·©å­˜é æ¸¬**: ä½¿ç”¨ ML é æ¸¬ç†±é»æ•¸æ“šä¸¦é åŠ è¼‰
4. **æ™ºèƒ½æ·˜æ±°**: æ ¹æ“šæ¥­å‹™åƒ¹å€¼ï¼ˆè€Œéè¨ªå•é »ç‡ï¼‰æ·˜æ±°æ•¸æ“š
5. **è·¨å€åŸŸåŒæ­¥**: Redis è·¨æ•¸æ“šä¸­å¿ƒåŒæ­¥ï¼ˆGeo-Replicationï¼‰

---

**âœ… F14 å®Œæˆ**ï¼šRedis ç·©å­˜ç³»çµ±åŠŸèƒ½è¦ç¯„å·²å®Œæ•´ç·¨å¯«ï¼ˆ4 å€‹ç”¨æˆ¶æ•…äº‹ã€æ•¸æ“šçµæ§‹è¨­è¨ˆã€NFRã€æ¸¬è©¦ç­–ç•¥ï¼‰ã€‚

---

## é™„éŒ„ B ç¸½çµ

**å·²å®ŒæˆåŠŸèƒ½**ï¼š

- âœ… **F8**: n8n Triggering + Error Handlingï¼ˆCron èª¿åº¦ã€Webhookã€é‡è©¦ã€DLQï¼‰
- âœ… **F9**: Prompt Managementï¼ˆYAML æ¨¡æ¿ã€ç‰ˆæœ¬æ§åˆ¶ã€A/B æ¸¬è©¦ã€ç†±é‡è¼‰ï¼‰
- âœ… **F10**: Audit Trailï¼ˆè¿½åŠ å¼æ—¥èªŒã€Elasticsearch æœç´¢ã€S3 æ­¸æª”ã€å®Œæ•´æ€§é©—è­‰ï¼‰
- âœ… **F11**: Teams Notificationï¼ˆAdaptive Cardsã€DLQ å‘Šè­¦ã€è·¯ç”±è¦å‰‡ã€éœéŸ³èª¿åº¦ï¼‰
- âœ… **F12**: Monitoring Dashboardï¼ˆå¯¦æ™‚æŒ‡æ¨™ã€è³‡æºç›£æ§ã€æ¥­å‹™ KPIã€è‡ªå®šç¾©å„€è¡¨æ¿ï¼‰
- âœ… **F13**: Modern Web UIï¼ˆ8 å€‹æ ¸å¿ƒé é¢ï¼šDashboardã€Workflow Builderã€åŸ·è¡Œæ­·å²ã€Agent å•†åº—ã€ç›£æ§ã€å¯©è¨ˆã€DLQã€Prompt ç·¨è¼¯å™¨ï¼‰
- âœ… **F14**: Redis Cachingï¼ˆæ•¸æ“šç·©å­˜ã€åˆ†ä½ˆå¼é–ã€é€Ÿç‡é™åˆ¶ã€æœƒè©±ç®¡ç†ã€ç·©å­˜ç›£æ§ï¼‰

**ç¸½è¨ˆ**ï¼š
- **7 å€‹æ ¸å¿ƒåŠŸèƒ½**
- **28 å€‹ç”¨æˆ¶æ•…äº‹**ï¼ˆæ¯å€‹åŠŸèƒ½ 4 å€‹ï¼‰
- **å®Œæ•´æŠ€è¡“è¦ç¯„**ï¼šæ•¸æ“šåº«æ¶æ§‹ã€API å¯¦ç¾ã€UI çµ„ä»¶ã€NFRã€æ¸¬è©¦ç­–ç•¥ã€é¢¨éšªç·©è§£

**ä¸‹ä¸€æ­¥**ï¼š
- é–‹å§‹é–‹ç™¼ F8-F14 åŠŸèƒ½
- åƒè€ƒ prd-main.md ä¸­çš„ F1-F7 åŠŸèƒ½é€²è¡Œé›†æˆæ¸¬è©¦
- æº–å‚™ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ï¼ˆRedis Sentinelã€TimescaleDBã€Elasticsearchï¼‰

---

**ğŸ“„ é™„éŒ„ Bï¼ˆFeatures 8-14ï¼‰ç·¨å¯«å®Œæˆï¼**
